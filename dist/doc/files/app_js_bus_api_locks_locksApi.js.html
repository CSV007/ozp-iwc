<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>app/js/bus/api/locks/locksApi.js - ozpIwc</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="ozpIwc" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 1.0.13</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/ozpIwc.AjaxPersistenceQueue.html">ozpIwc.AjaxPersistenceQueue</a></li>
                                <li><a href="../classes/ozpIwc.ApiBase.html">ozpIwc.ApiBase</a></li>
                                <li><a href="../classes/ozpIwc.ApiError.html">ozpIwc.ApiError</a></li>
                                <li><a href="../classes/ozpIwc.apiFilter.html">ozpIwc.apiFilter</a></li>
                                <li><a href="../classes/ozpIwc.apiFilter.Function.html">ozpIwc.apiFilter.Function</a></li>
                                <li><a href="../classes/ozpIwc.ApiNode.html">ozpIwc.ApiNode</a></li>
                                <li><a href="../classes/ozpIwc.AsyncAction.html">ozpIwc.AsyncAction</a></li>
                                <li><a href="../classes/ozpIwc.BadActionError.html">ozpIwc.BadActionError</a></li>
                                <li><a href="../classes/ozpIwc.BadContentError.html">ozpIwc.BadContentError</a></li>
                                <li><a href="../classes/ozpIwc.BadRequestError.html">ozpIwc.BadRequestError</a></li>
                                <li><a href="../classes/ozpIwc.BadResourceError.html">ozpIwc.BadResourceError</a></li>
                                <li><a href="../classes/ozpIwc.BadStateError.html">ozpIwc.BadStateError</a></li>
                                <li><a href="../classes/ozpIwc.CancelableEvent.html">ozpIwc.CancelableEvent</a></li>
                                <li><a href="../classes/ozpIwc.Client.html">ozpIwc.Client</a></li>
                                <li><a href="../classes/ozpIwc.ClientParticipant.html">ozpIwc.ClientParticipant</a></li>
                                <li><a href="../classes/ozpIwc.consensus.BaseConsensus.html">ozpIwc.consensus.BaseConsensus</a></li>
                                <li><a href="../classes/ozpIwc.consensus.Bully.html">ozpIwc.consensus.Bully</a></li>
                                <li><a href="../classes/ozpIwc.DataApi.html">ozpIwc.DataApi</a></li>
                                <li><a href="../classes/ozpIwc.DataNode.html">ozpIwc.DataNode</a></li>
                                <li><a href="../classes/ozpIwc.Endpoint.html">ozpIwc.Endpoint</a></li>
                                <li><a href="../classes/ozpIwc.EndpointRegistry.html">ozpIwc.EndpointRegistry</a></li>
                                <li><a href="../classes/ozpIwc.Event.html">ozpIwc.Event</a></li>
                                <li><a href="../classes/ozpIwc.FragmentPacket.html">ozpIwc.FragmentPacket</a></li>
                                <li><a href="../classes/ozpIwc.FragmentStore.html">ozpIwc.FragmentStore</a></li>
                                <li><a href="../classes/ozpIwc.InFlightIntentFSM.html">ozpIwc.InFlightIntentFSM</a></li>
                                <li><a href="../classes/ozpIwc.IntentsApi.html">ozpIwc.IntentsApi</a></li>
                                <li><a href="../classes/ozpIwc.IntentsInFlightNode.html">ozpIwc.IntentsInFlightNode</a></li>
                                <li><a href="../classes/ozpIwc.InternalParticipant.html">ozpIwc.InternalParticipant</a></li>
                                <li><a href="../classes/ozpIwc.KeyBroadcastLocalStorageLink.html">ozpIwc.KeyBroadcastLocalStorageLink</a></li>
                                <li><a href="../classes/ozpIwc.Lifespan.Bound.html">ozpIwc.Lifespan.Bound</a></li>
                                <li><a href="../classes/ozpIwc.Lifespan.Ephemeral.html">ozpIwc.Lifespan.Ephemeral</a></li>
                                <li><a href="../classes/ozpIwc.Lifespan.Persistent.html">ozpIwc.Lifespan.Persistent</a></li>
                                <li><a href="../classes/ozpIwc.LocksApi.html">ozpIwc.LocksApi</a></li>
                                <li><a href="../classes/ozpIwc.LocksNode.html">ozpIwc.LocksNode</a></li>
                                <li><a href="../classes/ozpIwc.log.html">ozpIwc.log</a></li>
                                <li><a href="../classes/ozpIwc.MetricsRegistry.html">ozpIwc.MetricsRegistry</a></li>
                                <li><a href="../classes/ozpIwc.metricsStats.Sample.html">ozpIwc.metricsStats.Sample</a></li>
                                <li><a href="../classes/ozpIwc.metricsStats.UniformSample.html">ozpIwc.metricsStats.UniformSample</a></li>
                                <li><a href="../classes/ozpIwc.metricStats.html">ozpIwc.metricStats</a></li>
                                <li><a href="../classes/ozpIwc.metricStats.BinaryHeap.html">ozpIwc.metricStats.BinaryHeap</a></li>
                                <li><a href="../classes/ozpIwc.metricStats.ExponentiallyDecayingSample.html">ozpIwc.metricStats.ExponentiallyDecayingSample</a></li>
                                <li><a href="../classes/ozpIwc.metricTypes.BaseMetric.html">ozpIwc.metricTypes.BaseMetric</a></li>
                                <li><a href="../classes/ozpIwc.metricTypes.Counter.html">ozpIwc.metricTypes.Counter</a></li>
                                <li><a href="../classes/ozpIwc.metricTypes.Gauge.html">ozpIwc.metricTypes.Gauge</a></li>
                                <li><a href="../classes/ozpIwc.metricTypes.Histogram.html">ozpIwc.metricTypes.Histogram</a></li>
                                <li><a href="../classes/ozpIwc.metricTypes.Meter.html">ozpIwc.metricTypes.Meter</a></li>
                                <li><a href="../classes/ozpIwc.MulticastParticipant.html">ozpIwc.MulticastParticipant</a></li>
                                <li><a href="../classes/ozpIwc.NamesApi.html">ozpIwc.NamesApi</a></li>
                                <li><a href="../classes/ozpIwc.NamesNode.html">ozpIwc.NamesNode</a></li>
                                <li><a href="../classes/ozpIwc.NetworkPacket.html">ozpIwc.NetworkPacket</a></li>
                                <li><a href="../classes/ozpIwc.NoActionError.html">ozpIwc.NoActionError</a></li>
                                <li><a href="../classes/ozpIwc.NoMatchError.html">ozpIwc.NoMatchError</a></li>
                                <li><a href="../classes/ozpIwc.NoPermissionError.html">ozpIwc.NoPermissionError</a></li>
                                <li><a href="../classes/ozpIwc.NoResourceError.html">ozpIwc.NoResourceError</a></li>
                                <li><a href="../classes/ozpIwc.packetRouter.html">ozpIwc.packetRouter</a></li>
                                <li><a href="../classes/ozpIwc.PacketRouter.html">ozpIwc.PacketRouter</a></li>
                                <li><a href="../classes/ozpIwc.Participant.html">ozpIwc.Participant</a></li>
                                <li><a href="../classes/ozpIwc.Peer.html">ozpIwc.Peer</a></li>
                                <li><a href="../classes/ozpIwc.policyAuth.PDP.html">ozpIwc.policyAuth.PDP</a></li>
                                <li><a href="../classes/ozpIwc.policyAuth.SecurityAttribute.html">ozpIwc.policyAuth.SecurityAttribute</a></li>
                                <li><a href="../classes/ozpIwc.PostMessageParticipant.html">ozpIwc.PostMessageParticipant</a></li>
                                <li><a href="../classes/ozpIwc.PostMessageParticipantListener.html">ozpIwc.PostMessageParticipantListener</a></li>
                                <li><a href="../classes/ozpIwc.Router.html">ozpIwc.Router</a></li>
                                <li><a href="../classes/ozpIwc.RouterWatchdog.html">ozpIwc.RouterWatchdog</a></li>
                                <li><a href="../classes/ozpIwc.standardApiFilters.html">ozpIwc.standardApiFilters</a></li>
                                <li><a href="../classes/ozpIwc.SystemNode.html">ozpIwc.SystemNode</a></li>
                                <li><a href="../classes/ozpIwc.Timer.html">ozpIwc.Timer</a></li>
                                <li><a href="../classes/ozpIwc.TransportPacket.html">ozpIwc.TransportPacket</a></li>
                                <li><a href="../classes/ozpIwc.TransportPacketContext.html">ozpIwc.TransportPacketContext</a></li>
                                <li><a href="../classes/ozpIwc.util.html">ozpIwc.util</a></li>
                                <li><a href="../classes/ozpIwcPolicies.html">ozpIwcPolicies</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/bus.html">bus</a></li>
                                <li><a href="../modules/bus.api.html">bus.api</a></li>
                                <li><a href="../modules/bus.api.Type.html">bus.api.Type</a></li>
                                <li><a href="../modules/bus.api.Value.html">bus.api.Value</a></li>
                                <li><a href="../modules/bus.consensus.html">bus.consensus</a></li>
                                <li><a href="../modules/bus.network.html">bus.network</a></li>
                                <li><a href="../modules/bus.network.packets.html">bus.network.packets</a></li>
                                <li><a href="../modules/bus.security.html">bus.security</a></li>
                                <li><a href="../modules/bus.service.html">bus.service</a></li>
                                <li><a href="../modules/bus.service.Type.html">bus.service.Type</a></li>
                                <li><a href="../modules/bus.service.Util.html">bus.service.Util</a></li>
                                <li><a href="../modules/bus.service.Value.html">bus.service.Value</a></li>
                                <li><a href="../modules/bus.service.Value.Persistance.html">bus.service.Value.Persistance</a></li>
                                <li><a href="../modules/bus.transport.html">bus.transport</a></li>
                                <li><a href="../modules/bus.util.html">bus.util</a></li>
                                <li><a href="../modules/client.html">client</a></li>
                                <li><a href="../modules/common.html">common</a></li>
                                <li><a href="../modules/metrics.html">metrics</a></li>
                                <li><a href="../modules/metrics.statistics.html">metrics.statistics</a></li>
                                <li><a href="../modules/metrics.types.html">metrics.types</a></li>
                                <li><a href="../modules/ozpIwc.html">ozpIwc</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: app/js/bus/api/locks/locksApi.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
 * @submodule bus.api.Type
 */

/**
 * The Locks Api. Treats each node as an individual mutex, creating a queue to access/own the resource.
 * Subclasses the {{#crossLink &quot;ozpIwc.CommonApiBase&quot;}}{{/crossLink}}. Utilizes the
 * {{#crossLink &quot;ozpIwc.LocksNode&quot;}}{{/crossLink}} which subclasses the
 * {{#crossLink &quot;ozpIwc.CommonApiValue&quot;}}{{/crossLink}}.
 *
 * @class LocksApi
 * @namespace ozpIwc
 * @extends ozpIwc.CommonApiBase
 * @constructor
 *
 * @type {Function}
 */
ozpIwc.LocksApi =ozpIwc.util.extend(ozpIwc.ApiBase,function(config) {
    if(!config.name) {throw Error(&quot;API must be configured with a name&quot;);}
    this.name = &quot;locks.api&quot;;
    this.events = new ozpIwc.Event();
    this.events.mixinOnOff(this);
    this.router=config.router || ozpIwc.defaultRouter;
    this.endpoints=[];
    this.data={};
    this.watchers={};
    this.collectors=[];
    this.changeList={};

    //Start queueing and queue until either:
    // (1) state comes in a victor message or
    // (2) become leader. whichever is first
    this.enableRequestQueue();
    this.enableSendQueue();

    this.consensusConfiguration(config);
    this.participantConfiguration(config);
    this.on(&quot;addressDisconnects&quot;,this.unlockAll,this);

    this.logPrefix=&quot;[&quot; + this.name + &quot;/&quot; + this.participant.address +&quot;] &quot;;
    //This is poor form, but the apiBase behavior for locks should let everyone write.
    this.leaderState=&quot;loading&quot;;
    this.transitionToLeader();

    var self = this;
    ozpIwc.util.addEventListener(&quot;beforeunload&quot;,function(){
        self.shutdown();
    });
});
ozpIwc.PacketRouter.mixin(ozpIwc.LocksApi);


ozpIwc.LocksApi.prototype.transitionToLeader = function(){
    if(this.leaderState !== &quot;loading&quot;) {
        ozpIwc.log.error(this.logPrefix+&quot;transition to leader called in an invalid state:&quot;,this.leaderState);
        return;
    }
    ozpIwc.log.debug(this.logPrefix+&quot;transitioning to leader&quot;);
    this.leaderState = &quot;leader&quot;;
    this.broadcastLeaderReady();
};

/**
 * The Locks Api uses the Bully Consensus module to determine leadership.
 *
 * @method consensusConfiguration
 * @param {Object} config
 */
ozpIwc.LocksApi.prototype.consensusConfiguration = function(config){
    this.consensusMember = config.consensusMember || new ozpIwc.consensus.Bully({
        &#x27;name&#x27;: this.name,
        &#x27;router&#x27;: this.router,
        &#x27;gatherLogs&#x27;: function(){
            return self.createDeathScream();
        }
    });
    var self = this;
    this.consensusMember.on(&quot;receivedLogs&quot;,this.handleLogs,this);
    this.consensusMember.on(&quot;changedState&quot;,this.handleConsensusState,this);
};

/**
 * For Api call handling, the Locks Api uses a clientParticipant.
 *
 * @method participantConfiguration
 * @param {Object} config
 */
ozpIwc.LocksApi.prototype.participantConfiguration = function(config){
    this.participant =  new ozpIwc.ClientParticipant({internal:true});
    this.participant.on(&quot;receive&quot;,function(packetContext) {
        this.receivePacketContext(packetContext);
    },this);
    this.router.registerMulticast(this.participant,[this.name]);
    if(this.consensusMember.state === &quot;coordinator&quot;){
        this.deliverRequestQueue();
    }
};

/**
 * Unlocks All queued locks for the given address in the Locks Api.
 *
 * @TODO: Right now cycles through Every node, keep a map of addresses to nodes to unlock.
 *
 * @method unlockAll
 * @param {String} address
 */
ozpIwc.LocksApi.prototype.unlockAll = function(address){
    var self = this;
    ozpIwc.object.eachEntry(this.data,function(k,v) {
        self.updateLock(v,v.unlock({
            src: address
        }));
    });
};

/**
 * Iterates over all node&#x27;s and cleans out any rouge locks queue&#x27;d for no-longer/non-existent addresses.
 *
 * @method cleanup
 */
ozpIwc.LocksApi.prototype.cleanup = function(){
    var addrMap = {};
    ozpIwc.object.eachEntry(this.data,function(k,v){
        var queue = v.entity.queue || [];
        queue.forEach(function(entry){
            addrMap[entry.src] = true;
        });
    });

    var self = this;
    this.participant.names().bulkGet(&quot;/address&quot;).then(function(reply){
        reply.entity.forEach(function(node){
            if(node.entity.time &amp;&amp; node.entity.time + ozpIwc.config.heartBeatFrequency &gt; ozpIwc.util.now()){
                addrMap[node.entity.address] = false;
            }
        });
    }).then(function(){
        ozpIwc.object.eachEntry(addrMap,function(k,v){
            if(v) {
                self.unlockAll(k);
            }
        });
    });
};

/**
 * When the Consensus Module changes state, the Locks Api behaves differently. It&#x27;s participant will only send outbound
 * messages if it is the &quot;Coordinator&quot;.
 *
 * @method handleConsensusState
 * @param {String} state
 */
ozpIwc.LocksApi.prototype.handleConsensusState = function(state){
    ozpIwc.log.debug(&quot;[&quot; + this.participant.address + &quot;] State: &quot;, state);
    switch(state){
        case &quot;coordinator&quot;:
            this.deliverRequestQueue();
            this.deliverSendQueue();
            break;
        default:
            this.participant.sendingBlocked = true;
            this.flushSendQueue();
            break;
    }
};

/**
 * If the Locks Api object has not been initialized, it will initialize with the data passed in to the handleLogs
 * function.
 *
 * @method handleLogs
 * @param {Object}data
 */
ozpIwc.LocksApi.prototype.handleLogs = function(data){
    if(this.initialized) {
        return;
    }
    this.initialized = true;
    var logTimestamp = data.timestamp;
    this.initializeData(data);
    this.deliverRequestQueue(logTimestamp);
};

/**
 * Override the default node type to be a Locks Api Value.
 *
 * @override
 * @method createNodeObject
 * @param {type} config
 * @returns {ozpIwc.DataNode}
 */
ozpIwc.LocksApi.prototype.createNodeObject=function(config) {
    return new ozpIwc.LocksNode(config);
};


/**
 * Shuts down the api, issuing a deathscream and releasing the lock, if possible.
 *
 * @method shutdown
 * @return
 */
ozpIwc.LocksApi.prototype.shutdown=function() {
    if(this.leaderState === &quot;leader&quot;) {
        this.broadcastDeathScream(this.createDeathScream());
    }

    this.participant.send({
        dst: &quot;locks.api&quot;,
        resource: &quot;/mutex/&quot;+this.name,
        action: &quot;unlock&quot;
    });
};

//====================================================================
// Default Route
//====================================================================
ozpIwc.LocksApi.useDefaultRoute=function(actions,resource) {
    resource = resource || &quot;{resource:.*}&quot;;
    actions=ozpIwc.util.ensureArray(actions);
    var self = this;
    actions.forEach(function(a) {
        var filterFunc=ozpIwc.standardApiFilters.forAction(a);
        self.declareRoute({
                action: a,
                resource: resource,
                filters: (filterFunc?filterFunc():[])
            },ozpIwc.ApiBase.defaultHandler[a]
        );
    });
};

ozpIwc.LocksApi.useDefaultRoute([&quot;bulkGet&quot;, &quot;list&quot;, &quot;get&quot;,&quot;watch&quot;,&quot;unwatch&quot;]);
//====================================================================
// Bulk Send
//====================================================================
ozpIwc.LocksApi.declareRoute({
    action: [&quot;bulkSend&quot;],
    resource: &quot;{resource:.*}&quot;,
    filters: []
}, function(packet, context, pathParams) {
    var messages = packet.entity || [];
    var self = this;

    messages.forEach(function(message){
        var packetContext=new ozpIwc.TransportPacketContext({
            &#x27;packet&#x27;:message.packet,
            &#x27;router&#x27;: self.router,
            &#x27;srcParticipant&#x27;: message.packet.src,
            &#x27;dstParticipant&#x27;: self.address
        });
        self.receiveRequestPacket(packetContext);
    });
    return { response: &quot;ok&quot;};
});

//====================================================================
// Lock
//====================================================================
ozpIwc.LocksApi.declareRoute({
    action: &quot;lock&quot;,
    resource: &quot;/mutex/{name}&quot;,
    filters: ozpIwc.standardApiFilters.setFilters(ozpIwc.LocksNode)
}, function(packet,context,pathParams) {
    if(context.node) {
        this.updateLock(context.node, context.node.lock({
            src: packet.src,
            msgId: packet.msgId
        }));
    }
});

//====================================================================
// Unlock
//====================================================================
ozpIwc.LocksApi.declareRoute({
    action: &quot;unlock&quot;,
    resource: &quot;/mutex/{name}&quot;,
    filters: ozpIwc.standardApiFilters.setFilters(ozpIwc.LocksNode)
}, function(packet,context,pathParams) {
    packet.entity = packet.entity || {};
    ozpIwc.log.debug(&quot;[locks.api&quot;+ context.node.resource +&quot;][UNLOCK]: &quot;, packet.src);
    if(context.node) {
        this.updateLock(context.node, context.node.unlock({
            src: packet.entity.src || packet.src,
            msgId: packet.entity.msgId || packet.msgId
        }));
    }
});


//====================================================================
// Lock/Unlock Utility
//====================================================================
/**
 * Notifies the owner of the node&#x27;s lock/unlock.
 *
 * @method updateLock
 * @param {ozpIwc.LocksApiValue} node
 * @param {Object} newOwner
 */
ozpIwc.LocksApi.prototype.updateLock=function(node,newOwner) {
    if(newOwner){
        ozpIwc.log.debug(&quot;[locks.api&quot;+ node.resource +&quot;][NEW LEADER]&quot;,newOwner);
        var pkt = {
            &#x27;dst&#x27;: newOwner.src,
            &#x27;src&#x27;: this.participant.name,
            &#x27;replyTo&#x27;: newOwner.msgId,
            &#x27;response&#x27;: &#x27;ok&#x27;,
            &#x27;resource&#x27;: node.resource
        };

        if(this.isSendQueueing) {
            this.sendQueue.push(pkt);
        } else {
            this.participant.send(pkt);
        }
    }
};

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
