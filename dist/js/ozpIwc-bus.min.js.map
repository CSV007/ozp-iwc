{"version":3,"file":"ozpIwc-bus.min.js","sources":["bower_components/es6-promise/promise.js","app/js/common/event.js","app/js/common/ie-console-shim.js","app/js/common/util.js","app/js/metrics/statistics/sample.js","app/js/metrics/statistics/binary_heap.js","app/js/metrics/statistics/exponentiallyDecayingSample.js","app/js/metrics/statistics/exponentiallyWeightedMovingAverage.js","app/js/metrics/baseMetric.js","app/js/metrics/types/counter.js","app/js/metrics/types/gauge.js","app/js/metrics/types/histogram.js","app/js/metrics/types/meter.js","app/js/metrics/types/timer.js","app/js/metrics/metricsRegistry.js","app/js/bus/util/ajax.js","app/js/bus/util/asyncAction.js","app/js/bus/util/log.js","app/js/bus/util/setImmediate.js","app/js/bus/util/util.js","app/js/bus/security/basicAuthentication.js","app/js/bus/security/basicAuthorization.js","app/js/bus/security/pbac/combining/policyCombining.js","app/js/bus/security/pbac/combining/ruleCombining.js","app/js/bus/security/pbac/elements/baseElement.js","app/js/bus/security/pbac/elements/policy.js","app/js/bus/security/pbac/elements/rule.js","app/js/bus/security/pbac/elements/securityAttribute.js","app/js/bus/security/pbac/points/pdp.js","app/js/bus/security/pbac/points/pip.js","app/js/bus/security/pbac/points/prp.js","app/js/bus/security/pbac/policies/abacPolicies.js","app/js/bus/security/pbac/policies/defaultPolicies.js","app/js/bus/network/keyBroadcastLocalStorageLink.js","app/js/bus/network/localStorageLink.js","app/js/bus/network/peer.js","app/js/bus/transport/participant.js","app/js/bus/transport/internalParticipant.js","app/js/bus/transport/router.js","app/js/bus/transport/leaderGroupParticipant.js","app/js/bus/transport/multicastParticipant.js","app/js/bus/transport/postMessageParticipant.js","app/js/bus/transport/routerWatchdogParticipant.js","app/js/bus/api/commonApiValue.js","app/js/bus/api/commonApiCollectionValue.js","app/js/bus/api/apiError.js","app/js/bus/api/commonApiBase.js","app/js/bus/api/endpoints.js","app/js/bus/api/data/dataApi.js","app/js/bus/api/data/dataApiValue.js","app/js/bus/api/intents/intentsApi.js","app/js/bus/api/intents/intentsApiDefinitionValue.js","app/js/bus/api/intents/intentsApiHandlerValue.js","app/js/bus/api/intents/intentsApiInFlightIntent.js","app/js/bus/api/intents/intentsApiTypeValue.js","app/js/bus/api/names/namesApi.js","app/js/bus/api/names/namesApiValue.js","app/js/bus/api/system/systemApi.js","app/js/bus/api/system/systemApiApplicationValue.js","app/js/defaultWiring.js"],"names":["define","requireModule","require","requirejs","registry","seen","name","deps","callback","resolve","child","charAt","parts","split","parentBase","slice","i","l","length","part","pop","push","join","_eak_seen","Error","exports","mod","reified","value","apply","this","__dependency1__","__exports__","all","promises","Promise","isArray","TypeError","reject","resolver","index","resolveAll","results","remaining","promise","isFunction","then","useNextTick","process","nextTick","flush","useMutationObserver","iterations","observer","BrowserMutationObserver","node","document","createTextNode","observe","characterData","data","useSetTimeout","local","setTimeout","queue","tuple","arg","asap","scheduleFlush","browserGlobal","window","MutationObserver","WebKitMutationObserver","global","undefined","toString","call","configure","arguments","config","instrument","__dependency2__","polyfill","self","es6PromiseSupport","r","RSVPPromise","__dependency3__","__dependency4__","__dependency5__","__dependency6__","__dependency7__","_subscribers","invokeResolver","resolvePromise","rejectPromise","reason","e","invokeCallback","settled","detail","error","succeeded","failed","hasCallback","handleThenable","FULFILLED","REJECTED","subscribe","parent","onFulfillment","onRejection","subscribers","publish","_detail","resolved","objectOrFunction","val","fulfill","_state","PENDING","SEALED","async","publishFulfillment","publishRejection","now","race","staticResolve","staticReject","prototype","constructor","thenPromise","callbacks","catch","x","Object","Date","getTime","ozpIwc","Event","events","on","event","wrapped","ozpIwcDelegateFor","off","filter","h","trigger","eventName","CancelableEvent","handlers","forEach","mixinOnOff","target","k","canceled","cancelReason","cancel","console","log","debug","info","warn","util","extend","baseClass","newConstructor","create","safePostMessage","msg","origin","structuredCloneSupport","JSON","stringify","postMessage","message","structuredCloneSupportCache","cloneSupport","cache","clone","Array","parse","protoClone","obj","hasOwnProperty","parseQueryParams","query","location","search","match","params","regex","exec","decodeURIComponent","determineOrigin","url","a","createElement","href","protocol","hostname","port","escapeRegex","str","replace","parseOzpUrl","m","packet","dst","resource","action","isIWCPacket","src","ver","msgId","isDirectDescendant","parentNode","elementParser","reqAttrs","optAttrs","reqNodes","optNodes","element","findings","attrs","nodes","attr","attribute","getAttribute","tag","getElementsByTagName","camelCased","string","toLowerCase","substring","resolveWith","rejectWith","metricsStats","DEFAULT_POOL_SIZE","Sample","clear","update","values","count","size","getValues","UniformSample","limit","rand","parseInt","Math","random","BinaryHeap","scoreFunction","content","heap","bubbleUp","peek","result","end","sinkDown","remove","len","n","parentN","floor","elemScore","child2N","child1N","swap","child1Score","child1","child2","child2Score","DEFAULT_RESCALE_THRESHOLD","DEFAULT_DECAY_ALPHA","ExponentiallyDecayingSample","alpha","rescaleThreshold","elt","newHeap","priority","tick","startTime","nextScaleTime","timestamp","weight","first","rescale","time","exp","oldContent","newContent","oldStartTime","M1_ALPHA","M5_ALPHA","M15_ALPHA","ExponentiallyWeightedMovingAverage","interval","currentRate","uncounted","lastTick","age","requiredTicks","instantRate","rate","metricTypes","BaseMetric","unitName","get","unit","Counter","inc","delta","dec","Gauge","metricsCallback","set","Histogram","sample","min","max","varianceMean","varianceM2","sum","mark","map","v","parseFloat","sort","b","percentile","p","pos","lower","upper","percentile10","percentile25","median","percentile75","percentile90","percentile95","percentile99","percentile999","variance","mean","stdDev","sqrt","Meter","m1Rate","m5Rate","m15Rate","rate1m","rate5m","rate15m","rateMean","Timer","meter","histogram","start","endTime","meterMetrics","MetricsRegistry","metrics","gauge","keys","findOrCreateMetric","Type","makeName","args","counter","timer","register","metric","toJson","rv","path","current","shift","allMetrics","ajax","request","XMLHttpRequest","withCredentials","open","method","headers","header","setRequestHeader","onload","response","responseText","ajaxResponseHeaderToJSON","getAllResponseHeaders","status","responseXML","onerror","send","property","kv","trim","AsyncAction","when","state","resolution","success","failure","asyncActions","returnAction","isAnAction","err","isPrototypeOf","getStackTrace","captureStackTrace","stack","addFromSetImmediateArguments","tasksByHandle","nextHandle","partiallyApplied","handler","Function","runIfPresent","handle","currentlyRunningATask","task","clearImmediate","installNextTickImplementation","setImmediate","canUsePostMessage","importScripts","postMessageIsAsynchronous","oldOnMessage","onmessage","installPostMessageImplementation","messagePrefix","onGlobalMessage","source","indexOf","addEventListener","attachEvent","installMessageChannelImplementation","channel","MessageChannel","port1","port2","installReadyStateChangeImplementation","html","doc","documentElement","script","onreadystatechange","removeChild","appendChild","installSetTimeoutImplementation","attachTo","getPrototypeOf","generateId","f","arrayContainsAll","haystack","needles","equal","every","needle","some","hay","objectContainsAll","openWindow","windowName","features","encodeURIComponent","BUS_ROOT","host","pathname","alert","errorObject","alerts","silence","BasicAuthentication","roles","getRoleCount","login","credentials","preAuthenticatedSubject","BasicAuthorization","policies","abacPolicies","permitWhenObjectHasNoAttributes","subjectHasAllObjectAttributes","implies","subjectVal","objectVal","isPermitted","policy","policyAuth","PolicyCombining","atLeastOneErrorD","atLeastOneErrorP","atLeastOneErrorDP","atLeastOnePermit","decision","RuleCombining","rules","evaluate","BaseElement","construct","parsed","requiredAttributes","optionalAttributes","requiredNodes","optionalNodes","constructNodes","camelCasedProperty","j","itt","itter","Policy","policyId","version","description","ruleCombiningAlgId","rule","Rule","evaluateDefault","ruleId","category","setEffect","effect","getNegativeEffect","reqCategory","attributes","matchFound","reqAttributes","SecurityAttribute","comparator","pushIfNotExist","id","comp","concat","clearAll","getAll","PDP","prp","PRP","pip","PIP","policySets","connectSet","apiSet","readSet","receiveAsSet","sendAsSet","asyncAction","formattedPolicies","onError","formatRequest","formattedRequest","getPolicies","formatAttributes","asyncs","formatAttribute","retObj","getAttributes","tmp","formatAction","formatted","objectHandler","object","arrayHandler","array","ozp:iwc:action","subject","subjectAsync","resourceAsync","actions","gatheredAttributes","sub","res","act","combiningAlgorithm","defaultCombiningAlgorithm","formatCategory","formatCategories","categoryObj","categoryAsyncs","categoryIndexing","categories","grantAttributes","subjectId","grantParent","parentId","persistentPolicies","policyCache","defaultPolicies","policyURIs","policiesToGather","fetchPolicy","permitAll","policyURI","formatPolicy","getDenyall","urn","denyAll","defaultPolicy","policyActions","whiteListedOrigins","KeyBroadcastLocalStorageLink","prefix","peer","defaultPeer","selfId","metricsPrefix","myKeysTimeout","otherKeysTimeout","maxRetries","queueSize","sendQueue","fragments","fragmentSize","fragmentTimeout","String","chunk","receiveStorageEvent","newValue","fragment","handleFragment","forwardToPeer","removeEventListener","receive","linkId","haveSeen","key","storeFragment","defragmentedPacket","defragmentPacket","clearTimeout","fragmentTimer","packetIndex","packetsSeen","srcPeer","sequence","total","chunks","timeoutFunc","defragmented","queueSend","fragmentGen","template","sequenceCounter","attemptSend","retryCount","sendStatus","sendImpl","timeOut","pow","localStorage","setItem","removeItem","code","LocalStorageLink","splitKey","getItem","cleanKeys","setInterval","stats","used","bufferLen","peerUsage","peerPackets","oldKeyTime","createdAt","oldKeysCount","oldKeysSize","makeKey","myKeyExpiration","otherKeyExpiration","keyName","Peer","metricPrefix","knownPeers","unloadListener","shutdown","maxSeqIdPerSource","unshift","networkPacket","preSendEvent","Participant","permissions","sentPacketsMeter","receivedPacketsMeter","forbiddenPacketsMeter","latencyInTimer","latencyOutTimer","participantType","heartBeatContentType","heartBeatStatus","type","replyCallbacks","originalPacket","fixPacket","leaveEventChannel","receiveFromRouter","packetContext","ozp:iwc:receiveAs","authorization","receiveFromRouterImpl","connectToRouter","router","address","metricRoot","reverse","namesResource","joinEventChannel","generateMsgId","ozp:iwc:sendAs","heartbeat","entity","contentType","registerMulticast","InternalParticipant","getCallbackCount","replyTo","done","cancelCallback","TransportPacketContext","dstParticipant","Router","participants","receiveFromPeer","checkFormat","disableBus","MulticastParticipant","watchdog","RouterWatchdog","heartbeatFrequency","registerParticipant","getParticipantCount","participant","registerEvent","registration","registeredEvent","deliverLocal","sendingParticipant","localParticipant","srcParticipant","preDeliverEvent","multicastGroups","groupName","g","addMember","group","peerReceiveEvent","rawPacket","LeaderGroupParticipant","states","electionAddress","defaultLeaderPriority","priorityLessThan","electionTimeout","leaderState","electionQueue","leader","member","election","queueing","activeStates","changeState","leaderPriority","toggleDrop","victoryTS","Number","MAX_VALUE","forwardToTarget","getElectionQueue","startElection","routePacket","inElection","electionTimer","isLeader","sendElectionMessage","previousLeader","opponent","ex","sendVictoryMessage","leaderQuery","leaderQueryTimer","cancelElection","stateStore","handleLeaderQueryMessage","handleElectionMessage","handleVictoryMessage","electionMessage","victoryMessage","heartbeatStatus","_validateState","newState","validState","members","PostMessageParticipant","sourceWindow","sendToRecipient","handleTransportPacket","reply","forwardFromPostMessage","PostMessageParticipantListener","defaultRouter","receiveFromPostMessage","findParticipant","isPacket","ozp:iwc:origin","setupWatches","clearInterval","CommonApiValue","watchers","allowedContentTypes","persist","deleted","isValidContentType","watch","unwatch","w","eachWatcher","deleteData","toPacket","base","eTag","ApiError","snapshot","changesSince","oldValue","isUpdateNeeded","updateContent","deserialize","serverData","serialize","CommonApiCollectionValue","pattern","toJSON","RegExp","changedNodes","changedNode","errorAction","CommonApiBase","unloadState","becameLeader","newLeader","routeEventChannel","dynamicNodes","expectedBranches","retrievedBranches","findNodeForServerResource","objectPath","endpoint","linkRelPrefix","findOrMakeValue","children","loadFromServer","loadFromEndpoint","endpointName","requestHeaders","resolveLoad","rejectLoad","payload","responseHeader","loadLinkedObjectsFromServer","updateResourceFromServer","_links","updateDynamicNode","parseEntity","halLess","_embedded","formatServerData","notifyWatchers","noEmbedded","noLinks","branchesFound","itemLength","item","objectResource","makeValue","changes","watcher","hasKey","createKey","errorWrap","findHandler","validateResource","validatePreconditions","handleEventChannelConnect","handleEventChannelDisconnect","splice","handleEventChannelDisconnectImpl","handleEventChannelConnectImpl","toUpperCase","ifTag","validateContentType","ofInterest","addDynamicNode","defaultHandler","originalRequest","handleGet","handleSet","handleDelete","handleWatch","handleUnwatch","serializedData","setState","dynIndex","rootHandleList","setToLeader","leaderSync","receiveStateTimer","recvFunc","er","persistNodes","Endpoint","endpointRegistry","loadPromise","baseUrl","put","saveNodes","nodejson","EndpointRegistry","apiRoot","endPoints","linkEp","link","embEp","embLink","initEndpoints","DataApi","endpointUrl","DataApiValue","createChild","childNode","handleList","listChildren","handleAddchild","persistNode","addChild","handleRemovechild","deleteNode","endpointref","dirty","originalLen","c","links","removedChildren","addedChildren","IntentsApi","createType","IntentsApiTypeValue","intentType","createDefinition","IntentsApiDefinitionValue","intentAction","createHandler","definition","IntentsApiHandlerValue","makeIntentInvocation","inflightPacket","IntentsApiInFlightIntent","invokePacket","handlerChoices","getHandlers","handleRegister","invokeIntent","handleBroadcast","handlerNodes","updateInFlightEntity","handlerChosen","invokeIntentHandler","handleInvoke","chooseIntentHandler","badActionResponse","requestedState","handleInFlightChoose","handleInFlightRunning","handleInFlightFail","handleInFlightComplete","acceptedStates","handlerNode","inFlightIntent","blacklist","ozpIwc.peer","ozpIwc.intentSelection","dynNode","acceptedReasons","updateNodeEntity","invoked","test","intent","NamesApi","heartbeatDropCount","removeDeadNodes","NamesApiValue","SystemApi","updateIntents","getIntentsRegistrations","intents","icon","icons","small","label","launchDefinition","app","SystemApiApplicationValue","systemApi","launchResource","handleLaunch","launchApplication","intentResource","launchParams","launchUrls","ELECTION_TIMEOUT","apiRootUrl","policyRootUrl","basicAuthUsername","basicAuthPassword","setsEndpoint","enableDefault","defaultLocalStorageLink","heartBeatFrequency","runApis","defaultLeadershipStates","namesApi","dataApi","intentsApi","acceptPostMessageParticipants","defaultPostMessageParticipantListener"],"mappings":"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","sourcesContent":["(function() {\nvar define, requireModule, require, requirejs;\n\n(function() {\n  var registry = {}, seen = {};\n\n  define = function(name, deps, callback) {\n    registry[name] = { deps: deps, callback: callback };\n  };\n\n  requirejs = require = requireModule = function(name) {\n  requirejs._eak_seen = registry;\n\n    if (seen[name]) { return seen[name]; }\n    seen[name] = {};\n\n    if (!registry[name]) {\n      throw new Error(\"Could not find module \" + name);\n    }\n\n    var mod = registry[name],\n        deps = mod.deps,\n        callback = mod.callback,\n        reified = [],\n        exports;\n\n    for (var i=0, l=deps.length; i<l; i++) {\n      if (deps[i] === 'exports') {\n        reified.push(exports = {});\n      } else {\n        reified.push(requireModule(resolve(deps[i])));\n      }\n    }\n\n    var value = callback.apply(this, reified);\n    return seen[name] = exports || value;\n\n    function resolve(child) {\n      if (child.charAt(0) !== '.') { return child; }\n      var parts = child.split(\"/\");\n      var parentBase = name.split(\"/\").slice(0, -1);\n\n      for (var i=0, l=parts.length; i<l; i++) {\n        var part = parts[i];\n\n        if (part === '..') { parentBase.pop(); }\n        else if (part === '.') { continue; }\n        else { parentBase.push(part); }\n      }\n\n      return parentBase.join(\"/\");\n    }\n  };\n})();\n\ndefine(\"promise/all\", \n  [\"./utils\",\"exports\"],\n  function(__dependency1__, __exports__) {\n    \"use strict\";\n    /* global toString */\n\n    var isArray = __dependency1__.isArray;\n    var isFunction = __dependency1__.isFunction;\n\n    /**\n      Returns a promise that is fulfilled when all the given promises have been\n      fulfilled, or rejected if any of them become rejected. The return promise\n      is fulfilled with an array that gives all the values in the order they were\n      passed in the `promises` array argument.\n\n      Example:\n\n      ```javascript\n      var promise1 = RSVP.resolve(1);\n      var promise2 = RSVP.resolve(2);\n      var promise3 = RSVP.resolve(3);\n      var promises = [ promise1, promise2, promise3 ];\n\n      RSVP.all(promises).then(function(array){\n        // The array here would be [ 1, 2, 3 ];\n      });\n      ```\n\n      If any of the `promises` given to `RSVP.all` are rejected, the first promise\n      that is rejected will be given as an argument to the returned promises's\n      rejection handler. For example:\n\n      Example:\n\n      ```javascript\n      var promise1 = RSVP.resolve(1);\n      var promise2 = RSVP.reject(new Error(\"2\"));\n      var promise3 = RSVP.reject(new Error(\"3\"));\n      var promises = [ promise1, promise2, promise3 ];\n\n      RSVP.all(promises).then(function(array){\n        // Code here never runs because there are rejected promises!\n      }, function(error) {\n        // error.message === \"2\"\n      });\n      ```\n\n      @method all\n      @for RSVP\n      @param {Array} promises\n      @param {String} label\n      @return {Promise} promise that is fulfilled when all `promises` have been\n      fulfilled, or rejected if any of them become rejected.\n    */\n    function all(promises) {\n      /*jshint validthis:true */\n      var Promise = this;\n\n      if (!isArray(promises)) {\n        throw new TypeError('You must pass an array to all.');\n      }\n\n      return new Promise(function(resolve, reject) {\n        var results = [], remaining = promises.length,\n        promise;\n\n        if (remaining === 0) {\n          resolve([]);\n        }\n\n        function resolver(index) {\n          return function(value) {\n            resolveAll(index, value);\n          };\n        }\n\n        function resolveAll(index, value) {\n          results[index] = value;\n          if (--remaining === 0) {\n            resolve(results);\n          }\n        }\n\n        for (var i = 0; i < promises.length; i++) {\n          promise = promises[i];\n\n          if (promise && isFunction(promise.then)) {\n            promise.then(resolver(i), reject);\n          } else {\n            resolveAll(i, promise);\n          }\n        }\n      });\n    }\n\n    __exports__.all = all;\n  });\ndefine(\"promise/asap\", \n  [\"exports\"],\n  function(__exports__) {\n    \"use strict\";\n    var browserGlobal = (typeof window !== 'undefined') ? window : {};\n    var BrowserMutationObserver = browserGlobal.MutationObserver || browserGlobal.WebKitMutationObserver;\n    var local = (typeof global !== 'undefined') ? global : (this === undefined? window:this);\n\n    // node\n    function useNextTick() {\n      return function() {\n        process.nextTick(flush);\n      };\n    }\n\n    function useMutationObserver() {\n      var iterations = 0;\n      var observer = new BrowserMutationObserver(flush);\n      var node = document.createTextNode('');\n      observer.observe(node, { characterData: true });\n\n      return function() {\n        node.data = (iterations = ++iterations % 2);\n      };\n    }\n\n    function useSetTimeout() {\n      return function() {\n        local.setTimeout(flush, 1);\n      };\n    }\n\n    var queue = [];\n    function flush() {\n      for (var i = 0; i < queue.length; i++) {\n        var tuple = queue[i];\n        var callback = tuple[0], arg = tuple[1];\n        callback(arg);\n      }\n      queue = [];\n    }\n\n    var scheduleFlush;\n\n    // Decide what async method to use to triggering processing of queued callbacks:\n    if (typeof process !== 'undefined' && {}.toString.call(process) === '[object process]') {\n      scheduleFlush = useNextTick();\n    } else if (BrowserMutationObserver) {\n      scheduleFlush = useMutationObserver();\n    } else {\n      scheduleFlush = useSetTimeout();\n    }\n\n    function asap(callback, arg) {\n      var length = queue.push([callback, arg]);\n      if (length === 1) {\n        // If length is 1, that means that we need to schedule an async flush.\n        // If additional callbacks are queued before the queue is flushed, they\n        // will be processed by this flush that we are scheduling.\n        scheduleFlush();\n      }\n    }\n\n    __exports__.asap = asap;\n  });\ndefine(\"promise/config\", \n  [\"exports\"],\n  function(__exports__) {\n    \"use strict\";\n    var config = {\n      instrument: false\n    };\n\n    function configure(name, value) {\n      if (arguments.length === 2) {\n        config[name] = value;\n      } else {\n        return config[name];\n      }\n    }\n\n    __exports__.config = config;\n    __exports__.configure = configure;\n  });\ndefine(\"promise/polyfill\", \n  [\"./promise\",\"./utils\",\"exports\"],\n  function(__dependency1__, __dependency2__, __exports__) {\n    \"use strict\";\n    /*global self*/\n    var RSVPPromise = __dependency1__.Promise;\n    var isFunction = __dependency2__.isFunction;\n\n    function polyfill() {\n      var local;\n\n      if (typeof global !== 'undefined') {\n        local = global;\n      } else if (typeof window !== 'undefined' && window.document) {\n        local = window;\n      } else {\n        local = self;\n      }\n\n      var es6PromiseSupport = \n        \"Promise\" in local &&\n        // Some of these methods are missing from\n        // Firefox/Chrome experimental implementations\n        \"resolve\" in local.Promise &&\n        \"reject\" in local.Promise &&\n        \"all\" in local.Promise &&\n        \"race\" in local.Promise &&\n        // Older version of the spec had a resolver object\n        // as the arg rather than a function\n        (function() {\n          var resolve;\n          new local.Promise(function(r) { resolve = r; });\n          return isFunction(resolve);\n        }());\n\n      if (!es6PromiseSupport) {\n        local.Promise = RSVPPromise;\n      }\n    }\n\n    __exports__.polyfill = polyfill;\n  });\ndefine(\"promise/promise\", \n  [\"./config\",\"./utils\",\"./all\",\"./race\",\"./resolve\",\"./reject\",\"./asap\",\"exports\"],\n  function(__dependency1__, __dependency2__, __dependency3__, __dependency4__, __dependency5__, __dependency6__, __dependency7__, __exports__) {\n    \"use strict\";\n    var config = __dependency1__.config;\n    var configure = __dependency1__.configure;\n    var objectOrFunction = __dependency2__.objectOrFunction;\n    var isFunction = __dependency2__.isFunction;\n    var now = __dependency2__.now;\n    var all = __dependency3__.all;\n    var race = __dependency4__.race;\n    var staticResolve = __dependency5__.resolve;\n    var staticReject = __dependency6__.reject;\n    var asap = __dependency7__.asap;\n\n    var counter = 0;\n\n    config.async = asap; // default async is asap;\n\n    function Promise(resolver) {\n      if (!isFunction(resolver)) {\n        throw new TypeError('You must pass a resolver function as the first argument to the promise constructor');\n      }\n\n      if (!(this instanceof Promise)) {\n        throw new TypeError(\"Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.\");\n      }\n\n      this._subscribers = [];\n\n      invokeResolver(resolver, this);\n    }\n\n    function invokeResolver(resolver, promise) {\n      function resolvePromise(value) {\n        resolve(promise, value);\n      }\n\n      function rejectPromise(reason) {\n        reject(promise, reason);\n      }\n\n      try {\n        resolver(resolvePromise, rejectPromise);\n      } catch(e) {\n        rejectPromise(e);\n      }\n    }\n\n    function invokeCallback(settled, promise, callback, detail) {\n      var hasCallback = isFunction(callback),\n          value, error, succeeded, failed;\n\n      if (hasCallback) {\n        try {\n          value = callback(detail);\n          succeeded = true;\n        } catch(e) {\n          failed = true;\n          error = e;\n        }\n      } else {\n        value = detail;\n        succeeded = true;\n      }\n\n      if (handleThenable(promise, value)) {\n        return;\n      } else if (hasCallback && succeeded) {\n        resolve(promise, value);\n      } else if (failed) {\n        reject(promise, error);\n      } else if (settled === FULFILLED) {\n        resolve(promise, value);\n      } else if (settled === REJECTED) {\n        reject(promise, value);\n      }\n    }\n\n    var PENDING   = void 0;\n    var SEALED    = 0;\n    var FULFILLED = 1;\n    var REJECTED  = 2;\n\n    function subscribe(parent, child, onFulfillment, onRejection) {\n      var subscribers = parent._subscribers;\n      var length = subscribers.length;\n\n      subscribers[length] = child;\n      subscribers[length + FULFILLED] = onFulfillment;\n      subscribers[length + REJECTED]  = onRejection;\n    }\n\n    function publish(promise, settled) {\n      var child, callback, subscribers = promise._subscribers, detail = promise._detail;\n\n      for (var i = 0; i < subscribers.length; i += 3) {\n        child = subscribers[i];\n        callback = subscribers[i + settled];\n\n        invokeCallback(settled, child, callback, detail);\n      }\n\n      promise._subscribers = null;\n    }\n\n    Promise.prototype = {\n      constructor: Promise,\n\n      _state: undefined,\n      _detail: undefined,\n      _subscribers: undefined,\n\n      then: function(onFulfillment, onRejection) {\n        var promise = this;\n\n        var thenPromise = new this.constructor(function() {});\n\n        if (this._state) {\n          var callbacks = arguments;\n          config.async(function invokePromiseCallback() {\n            invokeCallback(promise._state, thenPromise, callbacks[promise._state - 1], promise._detail);\n          });\n        } else {\n          subscribe(this, thenPromise, onFulfillment, onRejection);\n        }\n\n        return thenPromise;\n      },\n\n      'catch': function(onRejection) {\n        return this.then(null, onRejection);\n      }\n    };\n\n    Promise.all = all;\n    Promise.race = race;\n    Promise.resolve = staticResolve;\n    Promise.reject = staticReject;\n\n    function handleThenable(promise, value) {\n      var then = null,\n      resolved;\n\n      try {\n        if (promise === value) {\n          throw new TypeError(\"A promises callback cannot return that same promise.\");\n        }\n\n        if (objectOrFunction(value)) {\n          then = value.then;\n\n          if (isFunction(then)) {\n            then.call(value, function(val) {\n              if (resolved) { return true; }\n              resolved = true;\n\n              if (value !== val) {\n                resolve(promise, val);\n              } else {\n                fulfill(promise, val);\n              }\n            }, function(val) {\n              if (resolved) { return true; }\n              resolved = true;\n\n              reject(promise, val);\n            });\n\n            return true;\n          }\n        }\n      } catch (error) {\n        if (resolved) { return true; }\n        reject(promise, error);\n        return true;\n      }\n\n      return false;\n    }\n\n    function resolve(promise, value) {\n      if (promise === value) {\n        fulfill(promise, value);\n      } else if (!handleThenable(promise, value)) {\n        fulfill(promise, value);\n      }\n    }\n\n    function fulfill(promise, value) {\n      if (promise._state !== PENDING) { return; }\n      promise._state = SEALED;\n      promise._detail = value;\n\n      config.async(publishFulfillment, promise);\n    }\n\n    function reject(promise, reason) {\n      if (promise._state !== PENDING) { return; }\n      promise._state = SEALED;\n      promise._detail = reason;\n\n      config.async(publishRejection, promise);\n    }\n\n    function publishFulfillment(promise) {\n      publish(promise, promise._state = FULFILLED);\n    }\n\n    function publishRejection(promise) {\n      publish(promise, promise._state = REJECTED);\n    }\n\n    __exports__.Promise = Promise;\n  });\ndefine(\"promise/race\", \n  [\"./utils\",\"exports\"],\n  function(__dependency1__, __exports__) {\n    \"use strict\";\n    /* global toString */\n    var isArray = __dependency1__.isArray;\n\n    /**\n      `RSVP.race` allows you to watch a series of promises and act as soon as the\n      first promise given to the `promises` argument fulfills or rejects.\n\n      Example:\n\n      ```javascript\n      var promise1 = new RSVP.Promise(function(resolve, reject){\n        setTimeout(function(){\n          resolve(\"promise 1\");\n        }, 200);\n      });\n\n      var promise2 = new RSVP.Promise(function(resolve, reject){\n        setTimeout(function(){\n          resolve(\"promise 2\");\n        }, 100);\n      });\n\n      RSVP.race([promise1, promise2]).then(function(result){\n        // result === \"promise 2\" because it was resolved before promise1\n        // was resolved.\n      });\n      ```\n\n      `RSVP.race` is deterministic in that only the state of the first completed\n      promise matters. For example, even if other promises given to the `promises`\n      array argument are resolved, but the first completed promise has become\n      rejected before the other promises became fulfilled, the returned promise\n      will become rejected:\n\n      ```javascript\n      var promise1 = new RSVP.Promise(function(resolve, reject){\n        setTimeout(function(){\n          resolve(\"promise 1\");\n        }, 200);\n      });\n\n      var promise2 = new RSVP.Promise(function(resolve, reject){\n        setTimeout(function(){\n          reject(new Error(\"promise 2\"));\n        }, 100);\n      });\n\n      RSVP.race([promise1, promise2]).then(function(result){\n        // Code here never runs because there are rejected promises!\n      }, function(reason){\n        // reason.message === \"promise2\" because promise 2 became rejected before\n        // promise 1 became fulfilled\n      });\n      ```\n\n      @method race\n      @for RSVP\n      @param {Array} promises array of promises to observe\n      @param {String} label optional string for describing the promise returned.\n      Useful for tooling.\n      @return {Promise} a promise that becomes fulfilled with the value the first\n      completed promises is resolved with if the first completed promise was\n      fulfilled, or rejected with the reason that the first completed promise\n      was rejected with.\n    */\n    function race(promises) {\n      /*jshint validthis:true */\n      var Promise = this;\n\n      if (!isArray(promises)) {\n        throw new TypeError('You must pass an array to race.');\n      }\n      return new Promise(function(resolve, reject) {\n        var results = [], promise;\n\n        for (var i = 0; i < promises.length; i++) {\n          promise = promises[i];\n\n          if (promise && typeof promise.then === 'function') {\n            promise.then(resolve, reject);\n          } else {\n            resolve(promise);\n          }\n        }\n      });\n    }\n\n    __exports__.race = race;\n  });\ndefine(\"promise/reject\", \n  [\"exports\"],\n  function(__exports__) {\n    \"use strict\";\n    /**\n      `RSVP.reject` returns a promise that will become rejected with the passed\n      `reason`. `RSVP.reject` is essentially shorthand for the following:\n\n      ```javascript\n      var promise = new RSVP.Promise(function(resolve, reject){\n        reject(new Error('WHOOPS'));\n      });\n\n      promise.then(function(value){\n        // Code here doesn't run because the promise is rejected!\n      }, function(reason){\n        // reason.message === 'WHOOPS'\n      });\n      ```\n\n      Instead of writing the above, your code now simply becomes the following:\n\n      ```javascript\n      var promise = RSVP.reject(new Error('WHOOPS'));\n\n      promise.then(function(value){\n        // Code here doesn't run because the promise is rejected!\n      }, function(reason){\n        // reason.message === 'WHOOPS'\n      });\n      ```\n\n      @method reject\n      @for RSVP\n      @param {Any} reason value that the returned promise will be rejected with.\n      @param {String} label optional string for identifying the returned promise.\n      Useful for tooling.\n      @return {Promise} a promise that will become rejected with the given\n      `reason`.\n    */\n    function reject(reason) {\n      /*jshint validthis:true */\n      var Promise = this;\n\n      return new Promise(function (resolve, reject) {\n        reject(reason);\n      });\n    }\n\n    __exports__.reject = reject;\n  });\ndefine(\"promise/resolve\", \n  [\"exports\"],\n  function(__exports__) {\n    \"use strict\";\n    function resolve(value) {\n      /*jshint validthis:true */\n      if (value && typeof value === 'object' && value.constructor === this) {\n        return value;\n      }\n\n      var Promise = this;\n\n      return new Promise(function(resolve) {\n        resolve(value);\n      });\n    }\n\n    __exports__.resolve = resolve;\n  });\ndefine(\"promise/utils\", \n  [\"exports\"],\n  function(__exports__) {\n    \"use strict\";\n    function objectOrFunction(x) {\n      return isFunction(x) || (typeof x === \"object\" && x !== null);\n    }\n\n    function isFunction(x) {\n      return typeof x === \"function\";\n    }\n\n    function isArray(x) {\n      return Object.prototype.toString.call(x) === \"[object Array]\";\n    }\n\n    // Date.now is not available in browsers < IE9\n    // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date/now#Compatibility\n    var now = Date.now || function() { return new Date().getTime(); };\n\n\n    __exports__.objectOrFunction = objectOrFunction;\n    __exports__.isFunction = isFunction;\n    __exports__.isArray = isArray;\n    __exports__.now = now;\n  });\nrequireModule('promise/polyfill').polyfill();\n}());","/** @namespace */\nvar ozpIwc=ozpIwc || {};\n\n/**\n * Common classes used between both the Client and the Bus.\n * @module common\n */\n\n/**\n * An Event emmitter/receiver class.\n * @class Event\n * @namespace ozpIwc\n */\nozpIwc.Event=function() {\n    /**\n     * A key value store of events.\n     * @property events\n     * @type Object\n     * @default {}\n     */\n\tthis.events={};\n};\n\n/**\n * Registers a handler for the the event.\n *\n * @method on\n * @param {String} event The name of the event to trigger on.\n * @param {Function} callback Function to be invoked.\n * @param {Object} [self] Used as the this pointer when callback is invoked.\n *\n * @returns {Object} A handle that can be used to unregister the callback via\n * {{#crossLink \"ozpIwc.Event/off:method\"}}{{/crossLink}}\n */\nozpIwc.Event.prototype.on=function(event,callback,self) {\n\tvar wrapped=callback;\n\tif(self) {\n\t\twrapped=function() {\n\t\t\tcallback.apply(self,arguments);\n\t\t};\n\t\twrapped.ozpIwcDelegateFor=callback;\n\t}\n\tthis.events[event]=this.events[event]||[];\n\tthis.events[event].push(wrapped);\n\treturn wrapped;\n};\n\n/**\n * Unregisters an event handler previously registered.\n *\n * @method off\n * @param {String} event\n * @param {Function} callback\n */\nozpIwc.Event.prototype.off=function(event,callback) {\n\tthis.events[event]=(this.events[event]||[]).filter( function(h) {\n\t\treturn h!==callback && h.ozpIwcDelegateFor !== callback;\n\t});\n};\n\n/**\n * Fires an event that will be received by all handlers.\n *\n * @method\n * @param {String} eventName Name of the event.\n * @param {Object} event Event object to pass to the handers.\n *\n * @returns {Object} The event after all handlers have processed it.\n */\nozpIwc.Event.prototype.trigger=function(eventName,event) {\n\tevent = event || new ozpIwc.CancelableEvent();\n\tvar handlers=this.events[eventName] || [];\n\n\thandlers.forEach(function(h) {\n\t\th(event);\n\t});\n\treturn event;\n};\n\n\n/**\n * Adds an {{#crossLink \"ozpIwc.Event/off:method\"}}on(){{/crossLink}} and\n * {{#crossLink \"ozpIwc.Event/off:method\"}}off(){{/crossLink}} function to the target that delegate to this object.\n *\n * @method mixinOnOff\n * @param {Object} target Target to receive the on/off functions\n */\nozpIwc.Event.prototype.mixinOnOff=function(target) {\n\tvar self=this;\n\ttarget.on=function() { return self.on.apply(self,arguments);};\n\ttarget.off=function() { return self.off.apply(self,arguments);};\n};\n\n/**\n * Convenient base for events that can be canceled.  Provides and manages\n * the properties canceled and cancelReason, as well as the member function\n * cancel().\n *\n * @class CancelableEvent\n * @namespace ozpIwc\n * @param {Object} data Data that will be copied into the event\n */\nozpIwc.CancelableEvent=function(data) {\n\tdata = data || {};\n\tfor(var k in data) {\n\t\tthis[k]=data[k];\n\t}\n\tthis.canceled=false;\n\tthis.cancelReason=null;\n};\n\n/**\n * Marks the event as canceled.\n * @method cancel\n * @param {String} reason A text description of why the event was canceled.\n *\n * @returns {ozpIwc.CancelableEvent} Reference to self\n */\nozpIwc.CancelableEvent.prototype.cancel=function(reason) {\n\treason= reason || \"Unknown\";\n\tthis.canceled=true;\n\tthis.cancelReason=reason;\n\treturn this;\n};\n","if(!(window.console && console.log)) {\n    console = {\n        log: function(){},\n        debug: function(){},\n        info: function(){},\n        warn: function(){},\n        error: function(){}\n    };\n}","/** @namespace */\nvar ozpIwc=ozpIwc || {};\n/**\n * @submodule common\n */\n\n/**\n * @class util\n * @namespace ozpIwc\n * @static\n */\nozpIwc.util=ozpIwc.util || {};\n\n/**\n * Used to get the current epoch time.  Tests overrides this\n * to allow a fast-forward on time-based actions.\n *\n * @method now\n * @returns {Number}\n */\nozpIwc.util.now=function() {\n    return new Date().getTime();\n};\n\n/**\n * Create a class with the given parent in it's prototype chain.\n *\n * @method extend\n * @param {Function} baseClass The class being derived from.\n * @param {Function} newConstructor The new base class.\n *\n * @returns {Function} New Constructor with an augmented prototype.\n */\nozpIwc.util.extend=function(baseClass,newConstructor) {\n    if(!baseClass || !baseClass.prototype) {\n        ozpIwc.log.error(\"Cannot create a new class for \",newConstructor,\" due to invalid baseclass:\",baseClass);\n        throw new Error(\"Cannot create a new class due to invalid baseClass.  Dependency not loaded first?\");\n    }\n    newConstructor.prototype = Object.create(baseClass.prototype);\n    newConstructor.prototype.constructor = newConstructor;\n    return newConstructor;\n};\n\n/**\n * Invoke postMessage on a given window in a safe manner. Test whether the browser\n * supports structured clones, and stringifies the message if not. Catches\n * errors (especially attempts to send non-cloneable objects), and tries to\n * send a stringified copy of the message asa fallback.\n *\n * @param window a window on which to invoke postMessage\n * @param msg the message to be sent\n * @param origin the target origin. The message will be sent only if it matches the origin of window.\n */\nozpIwc.util.safePostMessage = function(window,msg,origin) {\n    try {\n        var data = msg;\n        if (!ozpIwc.util.structuredCloneSupport() && typeof data !== 'string') {\n           data=JSON.stringify(msg);\n        }\n        window.postMessage(data, origin);\n    } catch (e) {\n        try {\n            window.postMessage(JSON.stringify(msg), origin);\n        } catch (e) {\n            ozpIwc.util.log(\"Invalid call to window.postMessage: \" + e.message);\n        }\n    }\n};\n\n/**\n * Detect browser support for structured clones. Returns quickly since it\n * caches the result. This method only determines browser support for structured\n * clones. Clients are responsible, when accessing capabilities that rely on structured\n * cloning, to ensure that objects to be cloned meet the criteria of the structured clone\n * algorithm. (See ozpIwc.util.safePostMessage for a method which handles attempts to\n * clone an invalid object.). NB: a bug in FF will cause file objects to be treated as\n * non-cloneable, even in FF versions that support structured clones.\n * (see https://bugzilla.mozilla.org/show_bug.cgi?id=722126).\n *\n * @private\n *\n * @method structuredCloneSupport\n *\n * @returns {Boolean} True if structured clones are supported, false otherwise.\n */\nozpIwc.util.structuredCloneSupport=function() {\n    ozpIwc.util = ozpIwc.util || {};\n    if (ozpIwc.util.structuredCloneSupportCache !== undefined) {\n        return ozpIwc.util.structuredCloneSupportCache;\n    }\n    var cloneSupport = 'postMessage' in window;\n    //If the browser doesn't support structured clones, it will call toString() on the object passed to postMessage.\n    try {\n        window.postMessage({\n            toString: function () {\n                cloneSupport = false;\n            }\n        }, \"*\");\n    } catch (e) {\n        //exception expected: objects with methods can't be cloned\n        //e.DATA_CLONE_ERR will exist only for browsers with structured clone support, which can be used as an additional check if needed\n    }\n    ozpIwc.util.structuredCloneSupportCache=cloneSupport;\n    return ozpIwc.util.structuredCloneSupportCache;\n};\n\nozpIwc.util.structuredCloneSupport.cache=undefined;\n\n/**\n * Does a deep clone of a serializable object.  Note that this will not\n * clone unserializable objects like DOM elements, Date, RegExp, etc.\n *\n * @method clone\n * @param {Array|Object} value The value to be cloned.\n * @returns {Array|Object}  a deep copy of the object\n */\nozpIwc.util.clone=function(value) {\n\tif(Array.isArray(value) || typeof(value) === 'object') {\n        try {\n            return JSON.parse(JSON.stringify(value));\n        } catch (e) {\n            ozpIwc.log.log(e);\n        }\n\t} else {\n\t\treturn value;\n\t}\n};\n\n/**\n * Non serializable cloning. Used to include prototype functions in the cloned object by creating a new instance\n * and copying over any attributes.\n * @method protoClone\n * @param {Object|Array} obj\n * @returns {*|Array.<T>|string|Blob}\n */\nozpIwc.util.protoClone = function(obj) {\n\n    if (obj instanceof Array) {\n        return obj.slice();\n    }\n\n    // Handle Object\n    if (obj instanceof Object) {\n        var clone = new obj.constructor();\n        for(var i in obj){\n\n            if(obj.hasOwnProperty(i)){\n                //recurse if needed\n                clone[i] = ozpIwc.util.protoClone(obj[i]);\n            } else{\n                clone[i] = obj[i];\n            }\n        }\n        return clone;\n    }\n    return obj;\n};\n\n/**\n * A regex method to parse query parameters.\n *\n * @method parseQueryParams\n * @param {String} query\n *\n */\nozpIwc.util.parseQueryParams=function(query) {\n    query = query || window.location.search;\n    var params={};\n\tvar regex=/\\??([^&=]+)=?([^&]*)/g;\n\tvar match;\n\twhile((match=regex.exec(query)) !== null) {\n\t\tparams[match[1]]=decodeURIComponent(match[2]);\n\t}\n    return params;\n};\n\n/**\n * Determines the origin of a given url\n * @method determineOrigin\n * @param url\n * @returns {String}\n */\nozpIwc.util.determineOrigin=function(url) {\n    var a=document.createElement(\"a\");\n    a.href = url;\n    var origin=a.protocol + \"//\" + a.hostname;\n    if(a.port) {\n        origin+= \":\" + a.port;\n    }\n    return origin;\n};\n\n/**\n * Escapes regular expression characters in a string.\n * @method escapeRegex\n * @param {String} str\n * @returns {String}\n */\nozpIwc.util.escapeRegex=function(str) {\n    return str.replace(/[-\\/\\\\^$*+?.()|[\\]{}]/g, '\\\\$&');\n};\n\n/**\n * \n * @method parseOzpUrl\n * @param {type} url\n * @returns {ozpIwc.TransportPacket}\n */\nozpIwc.util.parseOzpUrl=function(url) {\n    var m = /^(?:(?:web\\+ozp|ozp):\\/\\/)?([0-9a-zA-Z](?:[-.\\w])*)(\\/[^?#]*)(\\?[^#]*)?(#.*)?$/.exec(decodeURIComponent(url));\n    if (m) {\n        // an action of \"get\" is implied\n        var packet = {\n            'dst': m[1],\n            'resource': m[2],\n            'action': \"get\"\n        };\n        // TODO: parse the query params into fields\n\n        return packet;\n    }\n    return null;\n};\n\n/**\n * Returns true if the specified packet meets the criteria of an IWC Packet.\n * @method isIwcPacket\n * @static\n * @param {ozpIwc.TransportPacket} packet\n * @returns {Boolean}\n */\nozpIwc.util.isIWCPacket=function(packet) {\n    if(typeof packet.src !== \"string\" ||typeof packet.dst !== \"string\" ||\n        typeof packet.ver !== \"number\" || typeof packet.msgId !== \"string\") {\n        return false;\n    } else {\n        return true;\n    }\n};\n\n/**\n * Returns true if the the given document node is a direct descendant of the parent node.\n * @method isDirectDescendant\n * @param parent\n * @param child\n * @returns {boolean}\n */\nozpIwc.util.isDirectDescendant = function(child,parent){\n    if (child.parentNode === parent) {\n        return true;\n    }\n    return false;\n};\n\n/**\n *\n * @param {Object} config\n * @param {Array<String>} config.reqAttrs\n * @param {Array<String>} config.optAttrs\n * @param {Array<String>} config.reqNodes\n * @param {Array<String>} config.optNodes\n */\nozpIwc.util.elementParser = function(config){\n    config = config || {};\n\n    config.reqAttrs = config.reqAttrs || [];\n    config.optAttrs = config.optAttrs || [];\n    config.reqNodes = config.reqNodes || [];\n    config.optNodes = config.optNodes || [];\n\n    var element = config.element || {};\n\n    var findings = {\n        attrs: {},\n        nodes: {}\n    };\n    config.reqAttrs.forEach(function(attr){\n        var attribute = element.getAttribute(attr);\n        if(attribute){\n//            console.log('Found attribute of policy,(',attr,',',attribute,')');\n            findings.attrs[attr] = attribute;\n        } else {\n            console.error('Required attribute not found,(',attr,')');\n        }\n\n    });\n\n    config.optAttrs.forEach(function(attr){\n        var attribute = element.getAttribute(attr);\n        if(attribute){\n//            console.log('Found attribute of policy,(',attr,',',attribute,')');\n            findings.attrs[attr] = attribute;\n        }\n\n    });\n\n    config.reqNodes.forEach(function(tag){\n        var nodes = element.getElementsByTagName(tag);\n        findings.nodes[tag] = findings.nodes[tag] || [];\n        for(var i in nodes){\n            if(ozpIwc.util.isDirectDescendant(nodes[i],element)){\n//                console.log('Found node of policy: ', nodes[i]);\n                findings.nodes[tag].push(nodes[i]);\n            }\n        }\n        if(findings.nodes[tag].length <= 0) {\n            console.error('Required node not found,(',tag,')');\n        }\n    });\n    config.optNodes.forEach(function(tag){\n        var nodes = element.getElementsByTagName(tag);\n        for(var i in nodes){\n            if(ozpIwc.util.isDirectDescendant(nodes[i],element)){\n//                console.log('Found node of policy: ', nodes[i]);\n                findings.nodes[tag] = findings.nodes[tag] || [];\n                findings.nodes[tag].push(nodes[i]);\n            }\n        }\n    });\n    return findings;\n};\n\nozpIwc.util.camelCased = function(string){\n    return string.charAt(0).toLowerCase() + string.substring(1);\n};\n\n/**\n * Shortened call for returning a resolving promise (cleans up promise chaining)\n * @param {*} obj any valid javascript to resolve with.\n * @returns {Promise}\n */\nozpIwc.util.resolveWith = function(obj){\n    return new Promise(function(resolve,reject){\n        resolve(obj);\n    });\n};\n/**\n * Shortened call for returning a rejecting promise (cleans up promise chaining)\n * @param {*} obj any valid javascript to reject with.\n * @returns {Promise}\n */\nozpIwc.util.rejectWith = function(obj){\n    return new Promise(function(resolve,reject){\n        reject(obj);\n    });\n};","/*\n * The MIT License (MIT) Copyright (c) 2012 Mike Ihbe\n * Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated \n * documentation files (the \"Software\"), to deal in the Software without restriction, including without limitation \n * the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and\n * to permit persons to whom the Software is furnished to do so, subject to the following conditions:\n * \n * The above copyright notice and this permission notice shall be included in all copies or substantial \n * portions of the Software.\n * \n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO \n * THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE \n * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, \n * TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n */\n\n/*\n * Original code owned by Mike Ihbe.  Modifications licensed under same terms.\n */\nvar ozpIwc=ozpIwc || {};\n/**\n * @submodule metrics.statistics\n */\n\n/**\n *\n * @class metricStats\n * @namespace ozpIwc\n */\nozpIwc.metricsStats=ozpIwc.metricsStats || {};\n\n/**\n * @property DEFAULT_POOL_SIZE\n * @type {Number}\n * @default 1028\n */\nozpIwc.metricsStats.DEFAULT_POOL_SIZE=1028;\n\n/**\n * @Class Sample\n * @namespace ozpIwc.metricsStats\n * @constructor\n */\nozpIwc.metricsStats.Sample = function(){\n    /**\n     * @property values\n     * @type Array\n     */\n\tthis.clear();\n};\n\n/**\n * Appends the value.\n * @method update\n * @param {Number} val\n */\nozpIwc.metricsStats.Sample.prototype.update = function(val){ \n\tthis.values.push(val); \n};\n\n/**\n * Clears the values.\n * @method clear\n */\nozpIwc.metricsStats.Sample.prototype.clear = function(){ \n\tthis.values = []; \n\tthis.count = 0; \n};\n\n/**\n * Returns the number of the values.\n * @method size\n * @returns {Number}\n */\nozpIwc.metricsStats.Sample.prototype.size = function(){ \n\treturn this.values.length;\n};\n\n/**\n * Returns the array of values.\n * @method getValues\n * @returns {Array}\n */\nozpIwc.metricsStats.Sample.prototype.getValues = function(){ \n\treturn this.values; \n};\n\n\n/**\n *  Take a uniform sample of size size for all values\n *  @class UniformSample\n *  @param {Number} [size=ozpIwc.metricsStats.DEFAULT_POOL_SIZE] - The size of the sample pool.\n */\nozpIwc.metricsStats.UniformSample=ozpIwc.util.extend(ozpIwc.metricsStats.Sample,function(size) {\n\tozpIwc.metricsStats.Sample.apply(this);\n  this.limit = size || ozpIwc.metricsStats.DEFAULT_POOL_SIZE;\n});\n\nozpIwc.metricsStats.UniformSample.prototype.update = function(val) {\n  this.count++;\n  if (this.size() < this.limit) {\n    this.values.push(val);\n  } else {\n    var rand = parseInt(Math.random() * this.count);\n    if (rand < this.limit) {\n      this.values[rand] = val;\n    }\n  }\n};\n","// From http://eloquentjavascript.net/appendix2.html, \n// licensed under CCv3.0: http://creativecommons.org/licenses/by/3.0/\n\nvar ozpIwc=ozpIwc || {};\n\n/**\n * Statistics classes for the ozpIwc Metrics\n * @module metrics\n * @submodule metrics.statistics\n */\n/**\n * metricStats namespace\n * @class metricStats\n * @namespace ozpIwc\n * @static\n */\nozpIwc.metricsStats=ozpIwc.metricsStats || {};\n/**\n * This acts as a ordered binary heap for any serializeable JS object or collection of such objects \n * <p>Borrowed from https://github.com/mikejihbe/metrics. Originally from from http://eloquentjavascript.net/appendix2.html\n * <p>Licenced under CCv3.0\n *\n * @class BinaryHeap\n * @namespace ozpIwc.metricStats\n * @param {Function} scoreFunction\n * @returns {ozpiwc.metricStats.BinaryHeap}\n */\nozpIwc.metricsStats.BinaryHeap = function BinaryHeap(scoreFunction){\n  this.content = [];\n  this.scoreFunction = scoreFunction;\n};\n\nozpIwc.metricsStats.BinaryHeap.prototype = {\n\n  clone: function() {\n    var heap = new ozpIwc.metricsStats.BinaryHeap(this.scoreFunction);\n    // A little hacky, but effective.\n    heap.content = JSON.parse(JSON.stringify(this.content));\n    return heap;\n  },\n\n  push: function(element) {\n    // Add the new element to the end of the array.\n    this.content.push(element);\n    // Allow it to bubble up.\n    this.bubbleUp(this.content.length - 1);\n  },\n\n  peek: function() {\n    return this.content[0];\n  },\n\n  pop: function() {\n    // Store the first element so we can return it later.\n    var result = this.content[0];\n    // Get the element at the end of the array.\n    var end = this.content.pop();\n    // If there are any elements left, put the end element at the\n    // start, and let it sink down.\n    if (this.content.length > 0) {\n      this.content[0] = end;\n      this.sinkDown(0);\n    }\n    return result;\n  },\n\n  remove: function(node) {\n    var len = this.content.length;\n    // To remove a value, we must search through the array to find\n    // it.\n    for (var i = 0; i < len; i++) {\n      if (this.content[i] === node) {\n        // When it is found, the process seen in 'pop' is repeated\n        // to fill up the hole.\n        var end = this.content.pop();\n        if (i !== len - 1) {\n          this.content[i] = end;\n          if (this.scoreFunction(end) < this.scoreFunction(node)) {\n              this.bubbleUp(i);\n          }\n          else {\n              this.sinkDown(i);\n          }\n        }\n        return true;\n      }\n    }\n    throw new Error(\"Node not found.\");\n  },\n\n  size: function() {\n    return this.content.length;\n  },\n\n  bubbleUp: function(n) {\n    // Fetch the element that has to be moved.\n    var element = this.content[n];\n    // When at 0, an element can not go up any further.\n    while (n > 0) {\n      // Compute the parent element's index, and fetch it.\n      var parentN = Math.floor((n + 1) / 2) - 1,\n          parent = this.content[parentN];\n      // Swap the elements if the parent is greater.\n      if (this.scoreFunction(element) < this.scoreFunction(parent)) {\n        this.content[parentN] = element;\n        this.content[n] = parent;\n        // Update 'n' to continue at the new position.\n        n = parentN;\n      }\n      // Found a parent that is less, no need to move it further.\n      else {\n        break;\n      }\n    }\n  },\n\n  sinkDown: function(n) {\n    // Look up the target element and its score.\n    var length = this.content.length,\n        element = this.content[n],\n        elemScore = this.scoreFunction(element);\n\n    while(true) {\n      // Compute the indices of the child elements.\n      var child2N = (n + 1) * 2, child1N = child2N - 1;\n      // This is used to store the new position of the element,\n      // if any.\n      var swap = null;\n      var child1Score = null;\n      // If the first child exists (is inside the array)...\n      if (child1N < length) {\n        // Look it up and compute its score.\n        var child1 = this.content[child1N];\n        child1Score = this.scoreFunction(child1);\n        // If the score is less than our element's, we need to swap.\n        if (child1Score < elemScore) {\n            swap = child1N;\n        }\n      }\n      // Do the same checks for the other child.\n      if (child2N < length) {\n        var child2 = this.content[child2N],\n            child2Score = this.scoreFunction(child2);\n        if (child2Score < (swap === null ? elemScore : child1Score)) {\n            swap = child2N;\n        }\n      }\n\n      // If the element needs to be moved, swap it, and continue.\n      if (swap !== null) {\n        this.content[n] = this.content[swap];\n        this.content[swap] = element;\n        n = swap;\n      }\n      // Otherwise, we are done.\n      else {\n        break;\n      }\n    }\n  }\n};\n\n","/*\n * The MIT License (MIT) Copyright (c) 2012 Mike Ihbe\n * Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated \n * documentation files (the \"Software\"), to deal in the Software without restriction, including without limitation \n * the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and\n * to permit persons to whom the Software is furnished to do so, subject to the following conditions:\n * \n * The above copyright notice and this permission notice shall be included in all copies or substantial \n * portions of the Software.\n * \n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO \n * THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE \n * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, \n * TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n */\n\n/*\n * Original code owned by Mike Ihbe.  Modifications licensed under same terms.\n */\nvar ozpIwc=ozpIwc || {};\nozpIwc.metricsStats=ozpIwc.metricsStats || {};\n\n/**\n * @submodule metrics.statistics\n */\n\n//  Take an exponentially decaying sample of size size of all values\n/**\n *\n * @class metricStats\n * @namespace ozpIwc\n */\n\n/**\n * @property DEFAULT_RESCALE_THRESHOLD\n * @type {Number}\n * @default 3600000\n */\nozpIwc.metricsStats.DEFAULT_RESCALE_THRESHOLD = 60 * 60 * 1000; // 1 hour in milliseconds\n\n/**\n * @property DEFAULT_DECAY_ALPHA\n * @type {Number}\n * @default 0.015\n */\nozpIwc.metricsStats.DEFAULT_DECAY_ALPHA=0.015;\n\n/**\n * This acts as a ordered binary heap for any serializeable JS object or collection of such objects \n * <p>Borrowed from https://github.com/mikejihbe/metrics. \n * @class ExponentiallyDecayingSample\n * @namespace ozpIwc.metricStats\n */\nozpIwc.metricsStats.ExponentiallyDecayingSample=ozpIwc.util.extend(ozpIwc.metricsStats.Sample,function(size, alpha) {\n\tozpIwc.metricsStats.Sample.apply(this);\n  this.limit = size || ozpIwc.metricsStats.DEFAULT_POOL_SIZE;\n  this.alpha = alpha || ozpIwc.metricsStats.DEFAULT_DECAY_ALPHA;\n\tthis.rescaleThreshold = ozpIwc.metricsStats.DEFAULT_RESCALE_THRESHOLD;\n});\n\n// This is a relatively expensive operation\n/**\n * @method getValues\n * @returns {Array}\n */\nozpIwc.metricsStats.ExponentiallyDecayingSample.prototype.getValues = function() {\n  var values = [];\n  var heap = this.values.clone();\n\tvar elt;\n  while((elt = heap.pop()) !== undefined) {\n    values.push(elt.val);\n  }\n  return values;\n};\n\n/**\n * @method size\n * @returns {Number}\n */\nozpIwc.metricsStats.ExponentiallyDecayingSample.prototype.size = function() {\n  return this.values.size();\n};\n\n/**\n * @method newHeap\n * @returns {ozpIwc.metricsStats.BinaryHeap}\n */\nozpIwc.metricsStats.ExponentiallyDecayingSample.prototype.newHeap = function() {\n  return new ozpIwc.metricsStats.BinaryHeap(function(obj){return obj.priority;});\n};\n\n/**\n * @method now\n * @returns {Number}\n */\nozpIwc.metricsStats.ExponentiallyDecayingSample.prototype.now = function() {\n  return ozpIwc.util.now();\n};\n\n/**\n * @method tick\n * @returns {Number}\n */\nozpIwc.metricsStats.ExponentiallyDecayingSample.prototype.tick = function() {\n  return this.now() / 1000;\n};\n\n/**\n * @method clear\n */\nozpIwc.metricsStats.ExponentiallyDecayingSample.prototype.clear = function() {\n  this.values = this.newHeap();\n  this.count = 0;\n  this.startTime = this.tick();\n  this.nextScaleTime = this.now() + this.rescaleThreshold;\n};\n\n/**\n * timestamp in milliseconds\n * @method update\n * @param {Number} val\n * @param {Number} timestamp\n */\nozpIwc.metricsStats.ExponentiallyDecayingSample.prototype.update = function(val, timestamp) {\n  // Convert timestamp to seconds\n  if (timestamp === undefined) {\n    timestamp = this.tick();\n  } else {\n    timestamp = timestamp / 1000;\n  }\n  var priority = this.weight(timestamp - this.startTime) / Math.random();\n  var value = {val: val, priority: priority};\n  if (this.count < this.limit) {\n    this.count += 1;\n    this.values.push(value);\n  } else {\n    var first = this.values.peek();\n    if (first.priority < priority) {\n      this.values.push(value);\n      this.values.pop();\n    }\n  }\n\n  if (this.now() > this.nextScaleTime) {\n    this.rescale();\n  }\n};\n\n/**\n * @method weight\n * @param {Number}time\n * @returns {Number}\n */\nozpIwc.metricsStats.ExponentiallyDecayingSample.prototype.weight = function(time) {\n  return Math.exp(this.alpha * time);\n};\n\n/**\n * @method rescale\n */\nozpIwc.metricsStats.ExponentiallyDecayingSample.prototype.rescale = function() {\n  this.nextScaleTime = this.now() + this.rescaleThreshold;\n  var oldContent = this.values.content;\n  var newContent = [];\n  var oldStartTime = this.startTime;\n  this.startTime = this.tick();\n  // Downscale every priority by the same factor. Order is unaffected, which is why we're avoiding the cost of popping.\n  for(var i = 0; i < oldContent.length; i++) {\n    newContent.push({val: oldContent[i].val, priority: oldContent[i].priority * Math.exp(-this.alpha * (this.startTime - oldStartTime))});\n  }\n  this.values.content = newContent;\n};\n","/*\n * The MIT License (MIT) Copyright (c) 2012 Mike Ihbe\n * Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated \n * documentation files (the \"Software\"), to deal in the Software without restriction, including without limitation \n * the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and\n * to permit persons to whom the Software is furnished to do so, subject to the following conditions:\n * \n * The above copyright notice and this permission notice shall be included in all copies or substantial \n * portions of the Software.\n * \n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO \n * THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE \n * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, \n * TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n */\n\n/*\n * Original code owned by Mike Ihbe.  Modifications licensed under same terms.\n */\nvar ozpIwc=ozpIwc || {};\nozpIwc.metricsStats=ozpIwc.metricsStats || {};\n/**\n * @submodule metrics.statistics\n */\n\n/**\n *\n * @class metricStats\n * @namespace ozpIwc\n */\n\n/**\n * @property M1_ALPHA\n * @type {Number}\n * @default 1 - e^(-5/60)\n */\nozpIwc.metricsStats.M1_ALPHA = 1 - Math.exp(-5/60);\n\n/**\n * @property M5_ALPHA\n * @type {Number}\n * @default 1 - e^(-5/60/5)\n */\nozpIwc.metricsStats.M5_ALPHA = 1 - Math.exp(-5/60/5);\n\n/**\n * @property M15_ALPHA\n * @type {Number}\n * @default 1 - e^(-5/60/15)\n */\nozpIwc.metricsStats.M15_ALPHA = 1 - Math.exp(-5/60/15);\n\n/**\n *  Exponentially weighted moving average.\n *  @method ExponentiallyWeightedMovingAverage\n *  @param {Number} alpha\n *  @param {Number} interval Time in milliseconds\n */\nozpIwc.metricsStats.ExponentiallyWeightedMovingAverage=function(alpha, interval) {\n  this.alpha = alpha;\n  this.interval = interval || 5000;\n  this.currentRate = null;\n  this.uncounted = 0;\n\tthis.lastTick=ozpIwc.util.now();\n};\n\n/**\n * @method update\n * @param n\n */\nozpIwc.metricsStats.ExponentiallyWeightedMovingAverage.prototype.update = function(n) {\n  this.uncounted += (n || 1);\n\tthis.tick();\n};\n\n/**\n * Update the rate measurements every interval\n *\n * @method tick\n */\nozpIwc.metricsStats.ExponentiallyWeightedMovingAverage.prototype.tick = function() {\n \tvar now=ozpIwc.util.now();\n\tvar age=now-this.lastTick;\n\tif(age > this.interval) {\n\t\tthis.lastTick=now - (age % this.interval);\n\t\tvar requiredTicks=Math.floor(age / this.interval);\n\t\tfor(var i=0; i < requiredTicks; ++i) {\n\t\t\tvar instantRate = this.uncounted / this.interval;\n\t\t\tthis.uncounted = 0;\n\t\t\tif(this.currentRate!==null) {\n\t\t\t\tthis.currentRate += this.alpha * (instantRate - this.currentRate);\n\t\t\t} else {\n\t\t\t\tthis.currentRate = instantRate;\n\t\t\t}\n\t\t}\n\t}\n};\n\n/**\n * Return the rate per second\n *\n * @returns {Number}\n */\nozpIwc.metricsStats.ExponentiallyWeightedMovingAverage.prototype.rate = function() {\n  return this.currentRate * 1000;\n};\n","var ozpIwc=ozpIwc || {};\n/**\n * Metrics capabilities for the IWC.\n * @module metrics\n */\nozpIwc.metricTypes=ozpIwc.metricTypes || {};\n\n/**\n * @Class BaseMetric\n * @namespace ozpIwc.metricTypes\n */\nozpIwc.metricTypes.BaseMetric=function() {\n    /**\n     * The value of the metric\n     * @property value\n     * @type Number\n     * @default 0\n     */\n\tthis.value=0;\n\n    /**\n     * The name of the metric\n     * @property name\n     * @type String\n     * @default \"\"\n     */\n    this.name=\"\";\n\n    /**\n     * The unit name of the metric\n     * @property unitName\n     * @type String\n     * @default \"\"\n     */\n    this.unitName=\"\";\n};\n\n/**\n * Returns the metric value\n * @method get\n * @returns {Number}\n */\nozpIwc.metricTypes.BaseMetric.prototype.get=function() { \n\treturn this.value; \n};\n\n/**\n * Sets the unit name if parameter provided. Returns the unit name if no parameter provided.\n * @method unit\n * @param {String} val\n * @returns {ozpIwc.metricTypes.BaseMetric|String}\n */\nozpIwc.metricTypes.BaseMetric.prototype.unit=function(val) { \n\tif(val) {\n\t\tthis.unitName=val;\n\t\treturn this;\n\t}\n\treturn this.unitName; \n};\n\n\n\n","/**\r\n * Types of metrics available.\r\n * @module metrics\r\n * @submodule metrics.types\r\n */\r\n\r\n\r\n/**\r\n * A counter running total that can be adjusted up or down.\r\n * Where a meter is set to a known value at each update, a\r\n * counter is incremented up or down by a known change.\r\n *\r\n * @class Counter\r\n * @namespace ozpIwc.metricTypes\r\n * @extends ozpIwc.metricTypes.BaseMetric\r\n */\r\nozpIwc.metricTypes.Counter=ozpIwc.util.extend(ozpIwc.metricTypes.BaseMetric,function() {\r\n\tozpIwc.metricTypes.BaseMetric.apply(this,arguments);\r\n\tthis.value=0;\r\n});\r\n\r\n/**\r\n * @method inc\r\n * @param {Number} [delta=1]  Increment by this value\r\n * @returns {Number} Value of the counter after increment\r\n */\r\nozpIwc.metricTypes.Counter.prototype.inc=function(delta) { \r\n\treturn this.value+=(delta?delta:1);\r\n};\r\n\r\n/**\r\n * @method dec\r\n * @param {Number} [delta=1]  Decrement by this value\r\n * @returns {Number} Value of the counter after decrement\r\n */\r\nozpIwc.metricTypes.Counter.prototype.dec=function(delta) { \r\n\treturn this.value-=(delta?delta:1);\r\n};\r\n","ozpIwc.metricTypes=ozpIwc.metricTypes || {};\r\n/**\r\n * @submodule metrics.types\r\n */\r\n\r\n/**\r\n * @callback ozpIwc.metricTypes.Gauge~gaugeCallback\r\n * @returns {ozpIwc.metricTypes.MetricsTree} \r\n */\r\n\r\n/**\r\n * A gauge is an externally defined set of metrics returned by a callback function\r\n *\r\n * @class Gauge\r\n * @namespace ozpIwc.metricTypes\r\n * @extends ozpIwc.metricTypes.BaseMetric\r\n * @param {ozpIwc.metricTypes.Gauge~gaugeCallback} metricsCallback\r\n */\r\nozpIwc.metricTypes.Gauge=ozpIwc.util.extend(ozpIwc.metricTypes.BaseMetric,function(metricsCallback) {\r\n\tozpIwc.metricTypes.BaseMetric.apply(this,arguments);\r\n\tthis.callback=metricsCallback;\r\n});\r\n/**\r\n * Set the metrics callback for this gauge.\r\n *\r\n * @method set\r\n * @param {ozpIwc.metricTypes.Gauge~gaugeCallback} metricsCallback\r\n *\r\n * @returns {ozpIwc.metricTypes.Gauge} this\r\n */\r\nozpIwc.metricTypes.Gauge.prototype.set=function(metricsCallback) { \r\n\tthis.callback=metricsCallback;\r\n\treturn this;\r\n};\r\n/**\r\n * Executes the callback and returns a metrics tree.\r\n *\r\n * @method get\r\n *\r\n * @returns {ozpIwc.metricTypes.MetricsTree}\r\n */\r\nozpIwc.metricTypes.Gauge.prototype.get=function() {\r\n    if (this.callback) {\r\n        return this.callback();\r\n    }\r\n    return undefined;\r\n};\r\n","/**\r\n * @submodule metrics.types\r\n */\r\n\r\n/**\r\n * @class Histogram\r\n * @namespace ozpIwc.metricTypes\r\n * @extends ozpIwc.metricTypes.BaseMetric\r\n */\r\nozpIwc.metricTypes.Histogram=ozpIwc.util.extend(ozpIwc.metricTypes.BaseMetric,function() {\r\n\tozpIwc.metricTypes.BaseMetric.apply(this,arguments);\r\n\r\n    /**\r\n     * @property sample\r\n     * @type {ozpIwc.metricsStats.ExponentiallyDecayingSample}\r\n     */\r\n\tthis.sample = new ozpIwc.metricsStats.ExponentiallyDecayingSample();\r\n\tthis.clear();\r\n});\r\n\r\n\r\n/**\r\n * @method clear\r\n */\r\nozpIwc.metricTypes.Histogram.prototype.clear=function() {\r\n\tthis.sample.clear();\r\n\tthis.min=this.max=null;\r\n\tthis.varianceMean=0;\r\n\tthis.varianceM2=0;\r\n\tthis.sum=0;\r\n\tthis.count=0;\t\r\n};\r\n\r\n/**\r\n * @method mark\r\n * @param {Number} val\r\n * @param {Number} timestamp Current time in milliseconds.\r\n * @returns {Number} Value of the counter after increment\r\n */\r\nozpIwc.metricTypes.Histogram.prototype.mark=function(val,timestamp) { \r\n\ttimestamp = timestamp || ozpIwc.util.now();\r\n\t\r\n\tthis.sample.update(val,timestamp);\r\n\t\r\n\tthis.max=(this.max===null?val:Math.max(this.max,val));\r\n\tthis.min=(this.min===null?val:Math.min(this.min,val));\r\n\tthis.sum+=val;\r\n\tthis.count++;\r\n\t\r\n\tvar delta=val - this.varianceMean;\r\n\tthis.varianceMean += delta/this.count;\r\n\tthis.varianceM2 += delta * (val - this.varianceMean);\r\n\r\n\treturn this.count;\r\n};\r\n\r\n/**\r\n * @method get\r\n * @returns {{percentile10, percentile25, median, percentile75, percentile90, percentile95, percentile99,\r\n * percentile999, variance: null, mean: null, stdDev: null, count: *, sum: *, max: *, min: *}}\r\n */\r\nozpIwc.metricTypes.Histogram.prototype.get=function() { \r\n\tvar values=this.sample.getValues().map(function(v){\r\n\t\treturn parseFloat(v);\r\n\t}).sort(function(a,b) { \r\n\t\treturn a-b;\r\n\t});\r\n\tvar percentile=function(p) {\r\n\t\tvar pos=p *(values.length);\r\n\t\tif(pos >= values.length) {\r\n\t\t\treturn values[values.length-1];\r\n\t\t}\r\n\t\tpos=Math.max(0,pos);\r\n\t\tpos=Math.min(pos,values.length+1);\r\n\t\tvar lower = values[Math.floor(pos)-1];\r\n\t\tvar upper = values[Math.floor(pos)];\r\n\t\treturn lower+(pos-Math.floor(pos))*(upper-lower);\r\n\t};\r\n\r\n\treturn {\r\n\t\t'percentile10': percentile(0.10),\r\n\t\t'percentile25': percentile(0.25),\r\n\t\t'median': percentile(0.50),\t\t\t\t\r\n\t\t'percentile75': percentile(0.75),\r\n\t\t'percentile90': percentile(0.90),\r\n\t\t'percentile95': percentile(0.95),\r\n\t\t'percentile99': percentile(0.99),\r\n\t\t'percentile999': percentile(0.999),\r\n\t\t'variance' : this.count < 1 ? null : this.varianceM2 / (this.count -1),\r\n\t\t'mean' : this.count === 0 ? null : this.varianceMean,\r\n\t\t'stdDev' : this.count < 1 ? null : Math.sqrt(this.varianceM2 / (this.count -1)),\r\n\t\t'count' : this.count,\r\n\t\t'sum' : this.sum,\r\n\t\t'max' : this.max,\r\n\t\t'min' : this.min\r\n\t};\r\n};\r\n\r\n","/**\r\n * @submodule metrics.types\r\n */\r\n\r\n/**\r\n * @class Meter\r\n * @namespace ozpIwc.metricTypes\r\n * @extends ozpIwc.metricTypes.BaseMetric\r\n */\r\nozpIwc.metricTypes.Meter=ozpIwc.util.extend(ozpIwc.metricTypes.BaseMetric,function() {\r\n\tozpIwc.metricTypes.BaseMetric.apply(this,arguments);\r\n    /**\r\n     * @property m1Rate\r\n     * @type {ozpIwc.metricsStats.ExponentiallyWeightedMovingAverage}\r\n     */\r\n\tthis.m1Rate= new ozpIwc.metricsStats.ExponentiallyWeightedMovingAverage(ozpIwc.metricsStats.M1_ALPHA);\r\n    /**\r\n     * @property m5Rate\r\n     * @type {ozpIwc.metricsStats.ExponentiallyWeightedMovingAverage}\r\n     */\r\n\tthis.m5Rate= new ozpIwc.metricsStats.ExponentiallyWeightedMovingAverage(ozpIwc.metricsStats.M5_ALPHA);\r\n    /**\r\n     * @property m15Rate\r\n     * @type {ozpIwc.metricsStats.ExponentiallyWeightedMovingAverage}\r\n     */\r\n\tthis.m15Rate= new ozpIwc.metricsStats.ExponentiallyWeightedMovingAverage(ozpIwc.metricsStats.M15_ALPHA);\r\n    /**\r\n     * @property startTime\r\n     * @type {Number}\r\n     */\r\n\tthis.startTime=ozpIwc.util.now();\r\n    /**\r\n     * @property value\r\n     * @type {Number}\r\n     * @default 0\r\n     */\r\n\tthis.value=0;\r\n});\r\n\r\n/**\r\n * @method mark\r\n * @param {Number} [delta=1] - Increment by this value\r\n * @returns {Number} - Value of the counter after increment\r\n */\r\nozpIwc.metricTypes.Meter.prototype.mark=function(delta) { \r\n\tdelta=delta || 1;\r\n\tthis.value+=delta;\r\n\tthis.m1Rate.update(delta);\r\n\tthis.m5Rate.update(delta);\r\n\tthis.m15Rate.update(delta);\r\n\t\r\n\treturn this.value;\r\n};\r\n\r\n/**\r\n * @method get\r\n * @returns {{rate1m: (Number), rate5m: (Number), rate15m: (Number), rateMean: number, count: (Number)}}\r\n */\r\nozpIwc.metricTypes.Meter.prototype.get=function() {\r\n\treturn {\r\n\t\t'rate1m' : this.m1Rate.rate(),\r\n\t\t'rate5m' : this.m5Rate.rate(),\r\n\t\t'rate15m' : this.m15Rate.rate(),\r\n\t\t'rateMean' : this.value / (ozpIwc.util.now() - this.startTime) * 1000,\r\n\t\t'count' : this.value\r\n\t};\r\n};\r\n\r\n/**\r\n * @method tick\r\n */\r\nozpIwc.metricTypes.Meter.prototype.tick=function() { \r\n\tthis.m1Rate.tick();\r\n\tthis.m5Rate.tick();\r\n\tthis.m15Rate.tick();\r\n};\r\n","/**\n * @submodule metrics.types\n */\n\n/**\n * @class Timer\n * @namespace ozpIwc\n * @extends ozpIwc.metricTypes.BaseMetric\n * @type {Function}\n */\nozpIwc.metricTypes.Timer=ozpIwc.util.extend(ozpIwc.metricTypes.BaseMetric,function() {\n\tozpIwc.metricTypes.BaseMetric.apply(this,arguments);\n    /**\n     * @property meter\n     * @type {ozpIwc.metricTypes.Meter}\n     */\n\tthis.meter=new ozpIwc.metricTypes.Meter();\n\n    /**\n     * @property histogram\n     * @type {ozpIwc.metricTypes.Histogram}\n     */\n\tthis.histogram=new ozpIwc.metricTypes.Histogram();\n});\n\n/**\n * @method mark\n * @param {Number} val\n * @param {Number} timestamp Current time in milliseconds.\n */\nozpIwc.metricTypes.Timer.prototype.mark=function(val,time) {\n\tthis.meter.mark();\n\tthis.histogram.mark(val,time);\n};\n\n/**\n * Starts the timer\n *\n * @method start\n * @returns {Function}\n */\nozpIwc.metricTypes.Timer.prototype.start=function() {\n\tvar self=this;\n\tvar startTime=ozpIwc.util.now();\n\treturn function() {\n\t\tvar endTime=ozpIwc.util.now();\n\t\tself.mark(endTime-startTime,endTime);\n\t};\n};\n\n/**\n * Times the length of a function call.\n *\n * @method time\n * @param {Function}callback\n */\nozpIwc.metricTypes.Timer.prototype.time=function(callback) {\n\tvar startTime=ozpIwc.util.now();\n\ttry {\n\t\tcallback();\n\t} finally {\n\t\tvar endTime=ozpIwc.util.now();\n\t\tthis.mark(endTime-startTime,endTime);\n\t}\n};\n\n/**\n * Returns a histogram of the timer metrics.\n *\n * @method get\n * @returns {Object}\n */\nozpIwc.metricTypes.Timer.prototype.get=function() {\n\tvar val=this.histogram.get();\n\tvar meterMetrics=this.meter.get();\n\tfor(var k in meterMetrics) {\n\t\tval[k]=meterMetrics[k];\n\t}\n\treturn val;\n};","var ozpIwc=ozpIwc || {};\r\n/**\r\n * Metrics capabilities for the IWC.\r\n * @module metrics\r\n */\r\n\r\n/**\r\n * A repository of metrics\r\n * @class MetricsRegistry\r\n * @namespace ozpIwc\r\n */\r\nozpIwc.MetricsRegistry=function() {\r\n    /**\r\n     * Key value store of metrics\r\n     * @property metrics\r\n     * @type Object\r\n     */\r\n\tthis.metrics={};\r\n    var self=this;\r\n    this.gauge('registry.metrics.types').set(function() {\r\n        return Object.keys(self.metrics).length;\r\n    });\r\n\r\n};\r\n\r\n/**\r\n * Finds or creates the metric in the registry.\r\n * @method findOrCreateMetric\r\n * @private\r\n * @param {String} name Name of the metric.\r\n * @param {Function} type The constructor of the requested type for this metric.\r\n * @returns {ozpIwc.MetricType} Null if the metric already exists of a different type. Otherwise a reference to\r\n * the metric.\r\n */\r\nozpIwc.MetricsRegistry.prototype.findOrCreateMetric=function(name,Type) {\r\n\tvar m= this.metrics[name];\r\n    if(!m) {\r\n        m = this.metrics[name] = new Type();\r\n        m.name=name;\r\n        return m;\r\n    }\r\n\tif(m instanceof Type){\r\n\t\t\treturn m;\r\n\t} else {\r\n\t\t\treturn null;\r\n\t}\t\t\t\r\n};\r\n\r\n/**\r\n * Joins the arguments together into a name.\r\n * @method makeName\r\n * @private\r\n * @param {String[]} args Array or the argument-like \"arguments\" value.\r\n * @returns {String} the name.\r\n */\r\nozpIwc.MetricsRegistry.prototype.makeName=function(args) {\r\n\t// slice is necessary because \"arguments\" isn't a real array, and it's what\r\n\t// is usually passed in, here.\r\n\treturn Array.prototype.slice.call(args).join(\".\");\r\n};\r\n\r\n/**\r\n * Returns the counter instance(s) for the given name(s). If it does not exist it will be created.\r\n *\r\n * @method counter\r\n * @param {String} name Components of the name.\r\n *\r\n * @returns {ozpIwc.metricTypes.Counter}\r\n */\r\nozpIwc.MetricsRegistry.prototype.counter=function(name) {\r\n\treturn this.findOrCreateMetric(this.makeName(arguments),ozpIwc.metricTypes.Counter);\r\n};\r\n\r\n/**\r\n * Returns the meter instance(s) for the given name(s). If it does not exist it will be created.\r\n *\r\n * @method meter\r\n * @param {String} name Components of the name.\r\n *\r\n * @returns {ozpIwc.metricTypes.Meter}\r\n */\r\nozpIwc.MetricsRegistry.prototype.meter=function(name) {\r\n\treturn this.findOrCreateMetric(this.makeName(arguments),ozpIwc.metricTypes.Meter);\r\n};\r\n\r\n/**\r\n * Returns the gauge instance(s) for the given name(s). If it does not exist it will be created.\r\n *\r\n * @method gauge\r\n * @param {String} name Components of the name.\r\n * @returns {ozpIwc.metricTypes.Gauge}\r\n */\r\nozpIwc.MetricsRegistry.prototype.gauge=function(name) {\r\n\treturn this.findOrCreateMetric(this.makeName(arguments),ozpIwc.metricTypes.Gauge);\r\n};\r\n\r\n/**\r\n * Returns the histogram instance(s) for the given name(s). If it does not exist it will be created.\r\n *\r\n * @method histogram\r\n * @param {String} name Components of the name.\r\n *\r\n * @returns {ozpIwc.metricTypes.Histogram}\r\n */\r\nozpIwc.MetricsRegistry.prototype.histogram=function(name) {\r\n\treturn this.findOrCreateMetric(this.makeName(arguments),ozpIwc.metricTypes.Histogram);\r\n};\r\n\r\n/**\r\n * Returns the timer instance(s) for the given name(s). If it does not exist it will be created.\r\n *\r\n * @method timer\r\n * @param {String} name Components of the name.\r\n *\r\n * @returns {ozpIwc.metricTypes.Timer}\r\n */\r\nozpIwc.MetricsRegistry.prototype.timer=function(name) {\r\n\treturn this.findOrCreateMetric(this.makeName(arguments),ozpIwc.metricTypes.Timer);\r\n};\r\n\r\n/**\r\n * Registers a metric to the metric registry\r\n *\r\n * @method register\r\n * @param {String} name Components of the name.\r\n * @param {ozpIwc.MetricType} metric\r\n *\r\n * @returns {ozpIwc.MetricType} The metric passed in.\r\n */\r\nozpIwc.MetricsRegistry.prototype.register=function(name,metric) {\r\n\tthis.metrics[this.makeName(name)]=metric;\r\n\t\r\n\treturn metric;\r\n};\r\n\r\n/**\r\n * Converts the metric registry to JSON.\r\n *\r\n * @method toJson\r\n * @returns {Object} JSON converted registry.\r\n */\r\nozpIwc.MetricsRegistry.prototype.toJson=function() {\r\n\tvar rv={};\r\n\tfor(var k in this.metrics) {\r\n\t\tvar path=k.split(\".\");\r\n\t\tvar pos=rv;\r\n\t\twhile(path.length > 1) {\r\n\t\t\tvar current=path.shift();\r\n\t\t\tpos = pos[current]=pos[current] || {};\r\n\t\t}\r\n\t\tpos[path[0]]=this.metrics[k].get();\r\n\t}\r\n\treturn rv;\r\n};\r\n\r\n/**\r\n * Returns an array of all metrics in the registry\r\n * @method allMetrics\r\n * @returns {ozpIwc.MetricType[]}\r\n */\r\nozpIwc.MetricsRegistry.prototype.allMetrics=function() {\r\n    var rv=[];\r\n    for(var k in this.metrics) {\r\n        rv.push(this.metrics[k]);\r\n    }\r\n    return rv;\r\n};\r\n\r\nozpIwc.metrics=new ozpIwc.MetricsRegistry();\r\n","/** @namespace */\nvar ozpIwc=ozpIwc || {};\n\n/**\n * Utility methods used on the IWC bus.\n * @module bus\n * @submodule bus.util\n */\n\n/**\n * @class util\n * @namespace ozpIwc\n * @static\n */\nozpIwc.util=ozpIwc.util || {};\n\n/**\n * Sends an AJAX request. A promise is returned to handle the response.\n *\n * @method ajax\n * @static\n * @param {Object} config\n * @param {String} config.method\n * @param {String} config.href\n * @param [Object] config.headers\n * @param {String} config.headers.name\n * @param {String} config.headers.value\n * @param {boolean} config.withCredentials\n *\n * @returns {Promise}\n */\nozpIwc.util.ajax = function (config) {\n    return new Promise(function(resolve,reject) {\n        var request = new XMLHttpRequest();\n        request.withCredentials = true;\n        request.open(config.method, config.href, true);\n        if (Array.isArray(config.headers)) {\n            config.headers.forEach(function(header) {\n                request.setRequestHeader(header.name, header.value);\n            });\n        }\n        /*\n         * Setting username and password as params to open() (and setting request.withCredentials = true)\n         * per the API does not work in FF. setting them explicitly in the Authorization header works\n         * (but only for BASIC authentication as coded here). If the credentials are set in the open command,\n         * FF will fail to make the request, even though the credentials are manually set in the Authorization header\n         * */\n\n        request.onload = function () {\n            try {\n                resolve({\n                    \"response\": JSON.parse(this.responseText),\n                    \"header\":  ozpIwc.util.ajaxResponseHeaderToJSON(this.getAllResponseHeaders())\n                });\n            }\n            catch (e) {\n                if(this.status === 200 && this.responseXML){\n                    resolve({\n                        \"response\": this.responseXML,\n                        \"header\":  ozpIwc.util.ajaxResponseHeaderToJSON(this.getAllResponseHeaders())\n                    });\n                } else if(this.status === 204 && !this.responseText) {\n                    resolve({\n                        \"response\": {},\n                        \"header\": ozpIwc.util.ajaxResponseHeaderToJSON(this.getAllResponseHeaders())\n                    });\n                }  else {\n                    reject(this);\n                }\n            }\n        };\n\n        request.onerror = function (e) {\n            reject(this);\n        };\n\n        try {\n            if ((config.method === \"POST\") || (config.method === \"PUT\")) {\n                request.send(config.data);\n            }\n            else {\n                request.send();\n            }\n        } catch (e) {\n            reject(e);\n        }\n    });\n};\n\n\n/**\n * Takes the Javascript ajax response header (string) and converts it to JSON\n * @method ajaxResponseHeaderToJSON\n * @param {String} header\n *\n * @returns {Object}\n */\nozpIwc.util.ajaxResponseHeaderToJSON = function(header) {\n    var obj = {};\n    header.split(\"\\n\").forEach(function (property) {\n        var kv = property.split(\":\");\n        if (kv.length === 2) {\n            obj[kv[0].trim()] = kv[1].trim();\n        }\n    });\n\n    return obj;\n};\n","/** @namespace */\nvar ozpIwc=ozpIwc || {};\n/**\n * @submodule bus.util\n */\n\n/**\n * A deferred action, but not in the sense of the Javascript standard.\n * @class AsyncAction\n * @constructor\n * @namespace ozpIwc\n */\nozpIwc.AsyncAction=function() {\n    /**\n     * The result of the logic defered to.\n     * @property resolution\n     * @type string\n     */\n    /**\n     * Key value store of the callbacks to the deferred action.\n     * @property callbacks\n     * @type Object\n     */\n\tthis.callbacks={};\n};\n\n/**\n * Registers the callback to be called when the resolution matches the state. If resolution matches the state before\n * registration, the callback is fired rather than registered.\n *\n * @method when\n * @param state\n * @param callback\n * @param self\n * @returns {ozpIwc.AsyncAction}\n */\nozpIwc.AsyncAction.prototype.when=function(state,callback,self) {\n    self=self || this;\n\t\n\tif(this.resolution === state) {\n\t\tcallback.apply(self,this.value);\n\t} else {\n\t\tthis.callbacks[state]=function() { return callback.apply(self,arguments); };\n\t}\n\treturn this;\n};\n\n/**\n * Sets the deferred action's resolution and calls any callbacks associated to that state.\n *\n * @method resolve\n * @param status\n * @returns {ozpIwc.AsyncAction}\n */\nozpIwc.AsyncAction.prototype.resolve=function(status) {\n\tif(this.resolution) {\n\t\tthrow \"Cannot resolve an already resolved AsyncAction\";\n\t}\n\tvar callback=this.callbacks[status];\n\tthis.resolution=status;\n\n    /**\n     * @property value\n     * @type Array\n     */\n\tthis.value=Array.prototype.slice.call(arguments,1);\n\t\n\tif(callback) {\n\t\tcallback.apply(this,this.value);\n\t}\n\treturn this;\n};\n\n/**\n * Gives implementation of an AsyncAction a chained success registration.\n * @method success\n * @param callback\n * @param self\n * @example\n * var a = new ozpIwc.AsyncAction().success(function(){...}, this).failure(function(){...}, this);\n * @returns {ozpIwc.AsyncAction}\n */\nozpIwc.AsyncAction.prototype.success=function(callback,self) {\n\treturn this.when(\"success\",callback,self);\n};\n\n/**\n * Gives implementation of an AsyncAction a chained failure registration.\n * @method success\n * @param callback\n * @param self\n * @example\n * var a = new ozpIwc.AsyncAction().success(function(){...}, this).failure(function(){...}, this);\n * @returns {ozpIwc.AsyncAction}\n */\nozpIwc.AsyncAction.prototype.failure=function(callback,self) {\n\treturn this.when(\"failure\",callback,self);\n};\n\n/**\n * Returns an async action that resolves when all async Actions are resolved with their resolved values (if applies).\n * @method all\n * @param asyncActions\n */\nozpIwc.AsyncAction.all = function(asyncActions) {\n    var returnAction = new ozpIwc.AsyncAction();\n    var count = asyncActions.length;\n    var self = this;\n    var results = [];\n\n\n    //Register a callback for each action's \"success\"\n    asyncActions.forEach(function(action,index){\n        // If its not an asyncAction, pass it through as a result.\n        if(!self.isAnAction(action)){\n            results[index] = action;\n            if(--count === 0) {\n                returnAction.resolve('success',results);\n            }\n        }else {\n            action\n                .success(function (result) {\n                    results[index] = result;\n                    //once all actions resolved, intermediateAction resolve\n                    if (--count === 0) {\n                        returnAction.resolve('success', results);\n                    }\n                }, self)\n                .failure(function (err) {\n                    //fail the returnAction if any fail.\n                    returnAction.resolve('failure', err);\n                }, self);\n        }\n    });\n\n    return returnAction;\n};\n\n/**\n * Returns true if the object is an AsyncAction, otherwise false.\n * @method isAnAction\n * @param {*} action\n * @returns {Boolean}\n */\nozpIwc.AsyncAction.isAnAction = function(action){\n    return ozpIwc.AsyncAction.prototype.isPrototypeOf(action);\n};","/** @namespace */\nvar ozpIwc=ozpIwc || {};\n\n/**\n * @submodule bus.util\n */\nvar getStackTrace = function() {\n    var obj = {};\n    Error.captureStackTrace(obj, getStackTrace);\n    return obj.stack;\n};\n/**\n * A logging wrapper for the ozpIwc namespace\n * @class log\n * @static\n * @namespace ozpIwc\n */\nozpIwc.log=ozpIwc.log || {\n    /**\n     * A wrapper for log messages. Forwards to console.log if available.\n     * @property log\n     * @type Function\n     */\n\tlog: function() {\n\t\tif(window.console && typeof(window.console.log)===\"function\") {\n\t\t\twindow.console.log.apply(window.console,arguments);\n\t\t}\n\t},\n    /**\n     * A wrapper for error messages. Forwards to console.error if available.\n     * @property error\n     * @type Function\n     */\n\terror: function() {\n\t\tif(window.console && typeof(window.console.error)===\"function\") {\n\t\t\twindow.console.error.apply(window.console,arguments);\n\t\t}\n\t}\n};\n","(function (global, undefined) {\n    \"use strict\";\n\n    if (global.setImmediate) {\n        return;\n    }\n\n    var nextHandle = 1; // Spec says greater than zero\n    var tasksByHandle = {};\n    var currentlyRunningATask = false;\n    var doc = global.document;\n    var setImmediate;\n\n    function addFromSetImmediateArguments(args) {\n        tasksByHandle[nextHandle] = partiallyApplied.apply(undefined, args);\n        return nextHandle++;\n    }\n\n    // This function accepts the same arguments as setImmediate, but\n    // returns a function that requires no arguments.\n    function partiallyApplied(handler) {\n        var args = [].slice.call(arguments, 1);\n        return function() {\n            if (typeof handler === \"function\") {\n                handler.apply(undefined, args);\n            } else {\n                (new Function(\"\" + handler))();\n            }\n        };\n    }\n\n    function runIfPresent(handle) {\n        // From the spec: \"Wait until any invocations of this algorithm started before this one have completed.\"\n        // So if we're currently running a task, we'll need to delay this invocation.\n        if (currentlyRunningATask) {\n            // Delay by doing a setTimeout. setImmediate was tried instead, but in Firefox 7 it generated a\n            // \"too much recursion\" error.\n            setTimeout(partiallyApplied(runIfPresent, handle), 0);\n        } else {\n            var task = tasksByHandle[handle];\n            if (task) {\n                currentlyRunningATask = true;\n                try {\n                    task();\n                } finally {\n                    clearImmediate(handle);\n                    currentlyRunningATask = false;\n                }\n            }\n        }\n    }\n\n    function clearImmediate(handle) {\n        delete tasksByHandle[handle];\n    }\n\n    function installNextTickImplementation() {\n        setImmediate = function() {\n            var handle = addFromSetImmediateArguments(arguments);\n            process.nextTick(partiallyApplied(runIfPresent, handle));\n            return handle;\n        };\n    }\n\n    function canUsePostMessage() {\n        // The test against `importScripts` prevents this implementation from being installed inside a web worker,\n        // where `global.postMessage` means something completely different and can't be used for this purpose.\n        if (global.postMessage && !global.importScripts) {\n            var postMessageIsAsynchronous = true;\n            var oldOnMessage = global.onmessage;\n            global.onmessage = function() {\n                postMessageIsAsynchronous = false;\n            };\n            global.postMessage(\"\", \"*\");\n            global.onmessage = oldOnMessage;\n            return postMessageIsAsynchronous;\n        }\n    }\n\n    function installPostMessageImplementation() {\n        // Installs an event handler on `global` for the `message` event: see\n        // * https://developer.mozilla.org/en/DOM/window.postMessage\n        // * http://www.whatwg.org/specs/web-apps/current-work/multipage/comms.html#crossDocumentMessages\n\n        var messagePrefix = \"setImmediate$\" + Math.random() + \"$\";\n        var onGlobalMessage = function(event) {\n            if (event.source === global &&\n                typeof event.data === \"string\" &&\n                event.data.indexOf(messagePrefix) === 0) {\n                runIfPresent(+event.data.slice(messagePrefix.length));\n            }\n        };\n\n        if (global.addEventListener) {\n            global.addEventListener(\"message\", onGlobalMessage, false);\n        } else {\n            global.attachEvent(\"onmessage\", onGlobalMessage);\n        }\n\n        setImmediate = function() {\n            var handle = addFromSetImmediateArguments(arguments);\n            global.postMessage(messagePrefix + handle, \"*\");\n            return handle;\n        };\n    }\n\n    function installMessageChannelImplementation() {\n        var channel = new MessageChannel();\n        channel.port1.onmessage = function(event) {\n            var handle = event.data;\n            runIfPresent(handle);\n        };\n\n        setImmediate = function() {\n            var handle = addFromSetImmediateArguments(arguments);\n            channel.port2.postMessage(handle);\n            return handle;\n        };\n    }\n\n    function installReadyStateChangeImplementation() {\n        var html = doc.documentElement;\n        setImmediate = function() {\n            var handle = addFromSetImmediateArguments(arguments);\n            // Create a <script> element; its readystatechange event will be fired asynchronously once it is inserted\n            // into the document. Do so, thus queuing up the task. Remember to clean up once it's been called.\n            var script = doc.createElement(\"script\");\n            script.onreadystatechange = function () {\n                runIfPresent(handle);\n                script.onreadystatechange = null;\n                html.removeChild(script);\n                script = null;\n            };\n            html.appendChild(script);\n            return handle;\n        };\n    }\n\n    function installSetTimeoutImplementation() {\n        setImmediate = function() {\n            var handle = addFromSetImmediateArguments(arguments);\n            setTimeout(partiallyApplied(runIfPresent, handle), 0);\n            return handle;\n        };\n    }\n\n    // If supported, we should attach to the prototype of global, since that is where setTimeout et al. live.\n    var attachTo = Object.getPrototypeOf && Object.getPrototypeOf(global);\n    attachTo = attachTo && attachTo.setTimeout ? attachTo : global;\n\n    // Don't get fooled by e.g. browserify environments.\n    if ({}.toString.call(global.process) === \"[object process]\") {\n        // For Node.js before 0.9\n        installNextTickImplementation();\n\n    } else if (canUsePostMessage()) {\n        // For non-IE10 modern browsers\n        installPostMessageImplementation();\n\n    } else if (global.MessageChannel) {\n        // For web workers, where supported\n        installMessageChannelImplementation();\n\n    } else if (doc && \"onreadystatechange\" in doc.createElement(\"script\")) {\n        // For IE 6–8\n        installReadyStateChangeImplementation();\n\n    } else {\n        // For older browsers\n        installSetTimeoutImplementation();\n    }\n\n    attachTo.setImmediate = setImmediate;\n    attachTo.clearImmediate = clearImmediate;\n}(new Function(\"return this\")()));\n","/** @namespace */\nvar ozpIwc=ozpIwc || {};\n/**\n* @submodule bus.util\n*/\n\n/**\n * @class util\n * @namespace ozpIwc\n * @static\n */\nozpIwc.util=ozpIwc.util || {};\n\n/**\n * Generates a large hexidecimal string to serve as a unique ID.  Not a guid.\n *\n * @method generateId\n * @static\n *\n * @returns {String}\n */\nozpIwc.util.generateId=function() {\n    return Math.floor(Math.random() * 0xffffffff).toString(16);\n};\n\n/**\n * Invokes the callback handler on another event loop as soon as possible.\n *\n * @method setImmediate\n * @static\n*/\nozpIwc.util.setImmediate=function(f) {\n//    window.setTimeout(f,0);\n    window.setImmediate(f);\n};\n\n/**\n * Returns true if every needle is found in the haystack.\n *\n * @method arrayContainsAll\n * @static\n * @param {Array} haystack The array to search.\n * @param {Array} needles All of the values to search.\n * @param {Function} [equal] What constitutes equality.  Defaults to a===b.\n *\n * @returns {Boolean}\n */\nozpIwc.util.arrayContainsAll=function(haystack,needles,equal) {\n    equal=equal || function(a,b) { return a===b;};\n    return needles.every(function(needle) { \n        return haystack.some(function(hay) { \n            return equal(hay,needle);\n        });\n    });\n};\n\n\n/**\n * Returns true if the value every attribute in needs is equal to \n * value of the same attribute in haystack.\n *\n * @method objectContainsAll\n * @static\n * @param {Array} haystack The object that must contain all attributes and values.\n * @param {Array} needles The reference object for the attributes and values.\n * @param {Function} [equal] What constitutes equality.  Defaults to a===b.\n *\n * @returns {Boolean}\n */\nozpIwc.util.objectContainsAll=function(haystack,needles,equal) {\n    equal=equal || function(a,b) { return a===b;};\n    \n    for(var attribute in needles) {\n        if(!equal(haystack[attribute],needles[attribute])) {\n            return false;\n        }\n    }\n    return true;\n};\n\n/**\n * Wraps window.open.  If the bus is running in a worker, then\n * it doesn't have access to the window object and needs help from\n * a participant. \n * @see window.open documentation for what the parameters actually do\n * \n * @method openWindow\n * @static\n * @param {String} url The URL to open in a new window\n * @param {String} windowName The window name to open with.\n * @param {String} [features] The window features.\n *\n * @returns {undefined}\n */\nozpIwc.util.openWindow=function(url,windowName,features) {\n    if(typeof windowName === \"object\") {\n        var str=\"\";\n        for(var k in windowName) {\n            str+=k+\"=\"+encodeURIComponent(windowName[k])+\"&\";\n        }\n        windowName=str;\n    }\n    \n    window.open(url,windowName,features);\n};\n\n\n(function() {\n    ozpIwc.BUS_ROOT=window.location.protocol + \"//\" +\n            window.location.host +\n            window.location.pathname.replace(/[^\\/]+$/,\"\");\n})();\n\n\n/**\n * IWC alert handler.\n *\n * @method alert\n * @static\n * @param {String} message The string to display in the popup.\n * @param {Object} errorObject The object related to the alert to give as additional information\n * @todo fill with some form of modal popup regarding the alert.\n * @todo store a list of alerts to not notify if the user selects \"don't show me this again\" in the data.api\n *\n */\nozpIwc.util.alert = function (message, errorObject) {\n    this.alerts = this.alerts || {};\n    if(this.alerts[message]){\n        this.alerts[message].error = errorObject;\n    } else {\n        this.alerts[message] = {\n            error: errorObject,\n            silence: false\n        };\n    }\n    if(!this.alerts[message].silence){\n        //TODO : trigger an angular/bootstrap modal alert to notify the user of the error.\n        // on return of the alert:\n            // set this.alerts[message].silence if the user silenced the alerts\n\n        // Temporary placement: all alerts are silenced after first instance, but since this is not in data.api its on\n        // a widget basis.\n        this.alerts[message].silence = true;\n        ozpIwc.log.log(message,errorObject);\n    }\n};\n","var ozpIwc=ozpIwc || {};\n/**\n * @submodule bus.security\n */\n\n/** @typedef {string} ozpIwc.security.Role */\n\n/** @typedef {string} ozpIwc.security.Permission */\n\n/** @typedef { ozpIwc.security.Role[] } ozpIwc.security.Subject */\n\n/** \n * @typedef {object} ozpIwc.security.Actor \n * @property {ozpIwc.security.Subject} securityAttributes\n */\n\n\n/**\n * @TODO (DOC)\n * @class BasicAuthentication\n * @constructor\n * @namespace ozpIwc\n */\nozpIwc.BasicAuthentication=function() {\n\n    /**\n     * @property roles\n     * @type Object\n     * @default {}\n     */\n\tthis.roles={};\n    var self = this;\n    ozpIwc.metrics.gauge('security.authentication.roles').set(function() {\n        return self.getRoleCount();\n    });\n};\n\n/**\n * Returns the number of roles currently defined.\n *\n * @method getRoleCount\n *\n * @returns {number} the number of roles defined\n */\nozpIwc.BasicAuthentication.prototype.getRoleCount=function() {\n    if (!this.roles || !Object.keys(this.roles)) {\n        return 0;\n    }\n    return Object.keys(this.roles).length;\n};\n\n/**\n * Returns the authenticated subject for the given credentials.\n * \n * <p>The preAuthenticatedSubject allows an existing subject to augment their\n * roles using credentials.  For example, PostMessageParticipants are\n * assigned a role equal to their origin, since the browser authoritatively\n * determines that.  The security module can then add additional roles based\n * upon configuration.\n *\n * @method login\n * @param {ozpIwc.security.Credentials} credentials\n * @param {ozpIwc.security.Subject} [preAuthenticatedSubject] The pre-authenticated\n *   subject that is presenting these credentials.\n *\n * @returns {ozpIwc.AsyncAction} If the credentials are authenticated, the success handler receives\n *     the subject.\n */\nozpIwc.BasicAuthentication.prototype.login=function(credentials,preAuthenticatedSubject) {\n\tif(!credentials) {\n\t\tthrow \"Must supply credentials for login\";\n\t}\n\tvar action=new ozpIwc.AsyncAction();\n\t\n\tpreAuthenticatedSubject=preAuthenticatedSubject || [];\n\treturn action.resolve(\"success\",preAuthenticatedSubject);\n};\n\n","var ozpIwc=ozpIwc || {};\n/**\n * @submodule bus.security\n */\n\n/** @typedef {String} ozpIwc.security.Role */\n/** @typedef {String} ozpIwc.security.Permission */\n/** @typedef { ozpIwc.security.Role[] } ozpIwc.security.Subject */\n/** \n * @typedef {object} ozpIwc.security.Actor \n * @property {ozpIwc.security.Subject} securityAttributes\n */\n\n\n/** \n * A simple Attribute-Based Access Control implementation\n * @todo Permissions are local to each peer.  Does this need to be synced?\n * \n * @class BasicAuthorization\n * @constructor\n *\n * @namespace ozpIwc\n */\nozpIwc.BasicAuthorization=function(config) {\n    config=config || {};\n\n    /**\n     * @property roles\n     * @type Object\n     */\n\tthis.roles={};\n\n    /**\n     * @property policies\n     * @type {auth.policies|*|*[]|ozpIwc.BasicAuthorization.policies|BasicAuthorization.policies}\n     */\n    this.policies= config.policies || [\n//        ozpIwc.abacPolicies.permitAll\n        ozpIwc.abacPolicies.permitWhenObjectHasNoAttributes,\n        ozpIwc.abacPolicies.subjectHasAllObjectAttributes\n    ];\n\n    var self = this;\n    ozpIwc.metrics.gauge('security.authorization.roles').set(function() {\n        return self.getRoleCount();\n    });\n};\n/**\n * Returns the number of roles currently defined.\n *\n * @method getRoleCount\n *\n * @returns {Number} the number of roles defined\n */\nozpIwc.BasicAuthorization.prototype.getRoleCount=function() {\n    if (!this.roles || !Object.keys(this.roles)) {\n        return 0;\n    }\n    return Object.keys(this.roles).length;\n};\n\n/**\n *\n * @method implies\n * @param {Array} subjectVal\n * @param {Array} objectVal\n *\n * @returns {Boolean}\n */\nozpIwc.BasicAuthorization.prototype.implies=function(subjectVal,objectVal) {\n    // no object value is trivially true\n    if(objectVal===undefined || objectVal === null) {\n        return true;\n    }\n    // no subject value when there is an object value is trivially false\n    if(subjectVal===undefined || subjectVal === null) {\n        return false;\n    }\n    \n    // convert both to arrays, if necessary\n    subjectVal=Array.isArray(subjectVal)?subjectVal:[subjectVal];\n    objectVal=Array.isArray(objectVal)?objectVal:[objectVal];\n\n    // confirm that every element in objectVal is also in subjectVal\n    return ozpIwc.util.arrayContainsAll(subjectVal,objectVal);\n};\n\n\n/**\n * Confirms that the subject has all of the permissions requested.\n *\n * @method isPermitted\n * @param {object} request\n *\n * @returns {ozpIwc.AsyncAction}\n */\nozpIwc.BasicAuthorization.prototype.isPermitted=function(request) {\n\tvar action=new ozpIwc.AsyncAction();\n\t\n    var result=this.policies.some(function(policy) {\n        return policy.call(this,request)===\"permit\";\n    },this);\n    \n    \n    if(result) {\n        return action.resolve(\"success\");\n    } else {\n\t\treturn action.resolve('failure');\n    }\n};\n\n\n/**\n * The instantiated authorization object.\n * @type {ozpIwc.BasicAuthorization}\n * @todo Should this be with defaultWiring?\n */\n//ozpIwc.authorization=new ozpIwc.BasicAuthorization();","ozpIwc = ozpIwc || {};\nozpIwc.policyAuth = ozpIwc.policyAuth || {};\nozpIwc.policyAuth.PolicyCombining = ozpIwc.policyAuth.PolicyCombining || {};\n\n\n/**\n *\n *\n * @method urn:oasis:names:tc:xacml:3.0:policy-combining-algorithm:deny-overrides\n */\nozpIwc.policyAuth.PolicyCombining['deny-overrides'] =\n        function(policies,request){\n    var atLeastOneErrorD,\n        atLeastOneErrorP,\n        atLeastOneErrorDP,\n        atLeastOnePermit = false;\n\n    for(var i in policies){\n        var decision = policies[i](request);\n        switch(decision){\n            case \"Deny\":\n                return \"Deny\";\n            case \"Permit\":\n                atLeastOnePermit = true;\n                break;\n            case \"NotApplicable\":\n                continue;\n            case \"Indeterminate{D}\":\n                atLeastOneErrorD = true;\n                break;\n            case \"Indeterminate{P}\":\n                atLeastOneErrorP = true;\n                break;\n            case \"Indeterminate{DP}\":\n                atLeastOneErrorDP = true;\n                break;\n            default:\n                continue;\n        }\n    }\n\n    if(atLeastOneErrorDP){\n        return \"Indeterminate{DP}\";\n    } else if(atLeastOneErrorD && (atLeastOneErrorP || atLeastOnePermit)){\n        return \"Indeterminate{DP}\";\n    } else if(atLeastOneErrorD){\n        return \"Indeterminate{D}\";\n    } else if(atLeastOnePermit) {\n        return \"Permit\";\n    } else if(atLeastOneErrorP){\n        return \"Indeterminate{P}\";\n    }\n\n    return \"NotApplicable\";\n\n};\n\n\n/**\n * @method urn:oasis:names:tc:xacml:3.0:policy-combining-algorithm:permit-overrides\n */\nozpIwc.policyAuth.PolicyCombining['permit-overrides'] =\n        function(){\n\n};\n\n/**\n * @method urn:oasis:names:tc:xacml:1.0:policy-combining-algorithm:first-applicable\n */\nozpIwc.policyAuth.PolicyCombining['first-applicable'] =\n        function(){\n\n};\n\n/**\n * @method urn:oasis:names:tc:xacml:1.0:policy-combining-algorithm:only-one-applicable\n */\nozpIwc.policyAuth.PolicyCombining['only-one-applicable'] =\n        function(){\n\n};\n\n/**\n * @method urn:oasis:names:tc:xacml:3.0:rule-combining-algorithm:ordered-deny-overrides\n */\nozpIwc.policyAuth.PolicyCombining['ordered-deny-overrides'] =\n        function(){\n\n};\n\n/**\n * @method urn:oasis:names:tc:xacml:3.0:policy-combining-algorithm:ordered-permit-overrides\n */\nozpIwc.policyAuth.PolicyCombining['ordered-permit-overrides'] =\n        function(){\n\n};\n\n/**\n * @method urn:oasis:names:tc:xacml:3.0:policy-combining-algorithm:deny-unless-permit\n */\nozpIwc.policyAuth.PolicyCombining['deny-unless-permit'] =\n        function(){\n\n};\n\n/**\n * @method urn:oasis:names:tc:xacml:3.0:policy-combining-algorithm:permit-unless-deny\n */\nozpIwc.policyAuth.PolicyCombining['permit-unless-deny'] =\n        function(){\n\n};","ozpIwc = ozpIwc || {};\nozpIwc.policyAuth = ozpIwc.policyAuth || {};\nozpIwc.policyAuth.RuleCombining = ozpIwc.policyAuth.RuleCombining || {};\n\n\n/**\n * @method urn:oasis:names:tc:xacml:3.0:rule-combining-algorithm:deny-overrides\n */\nozpIwc.policyAuth.RuleCombining['urn:oasis:names:tc:xacml:3.0:rule-combining-algorithm:deny-overrides'] =\n        function(rules,request){\n    var atLeastOneErrorD,\n        atLeastOneErrorP,\n        atLeastOneErrorDP,\n        atLeastOnePermit = false;\n\n    for(var i in rules){\n        var decision = rules[i].evaluate(request);\n        switch(decision){\n            case \"Deny\":\n                return \"Deny\";\n            case \"Permit\":\n                atLeastOnePermit = true;\n                break;\n            case \"NotApplicable\":\n                continue;\n            case \"Indeterminate{D}\":\n                atLeastOneErrorD = true;\n                break;\n            case \"Indeterminate{P}\":\n                atLeastOneErrorP = true;\n                break;\n            case \"Indeterminate{DP}\":\n                atLeastOneErrorDP = true;\n                break;\n            default:\n                continue;\n        }\n    }\n\n    if(atLeastOneErrorDP){\n        return \"Indeterminate{DP}\";\n    } else if(atLeastOneErrorD && (atLeastOneErrorP || atLeastOnePermit)){\n        return \"Indeterminate{DP}\";\n    } else if(atLeastOneErrorD){\n        return \"Indeterminate{D}\";\n    } else if(atLeastOnePermit) {\n        return \"Permit\";\n    } else if(atLeastOneErrorP){\n        return \"Indeterminate{P}\";\n    }\n\n    return \"NotApplicable\";\n};\n\n/**\n * @method urn:oasis:names:tc:xacml:3.0:rule-combining-algorithm:permit-overrides\n */\nozpIwc.policyAuth.RuleCombining['urn:oasis:names:tc:xacml:3.0:rule-combining-algorithm:permit-overrides'] =\n        function(){\n\n};\n\n/**\n * @method urn:oasis:names:tc:xacml:1.0:rule-combining-algorithm:first-applicable\n */\nozpIwc.policyAuth.RuleCombining['urn:oasis:names:tc:xacml:1.0:rule-combining-algorithm:first-applicable'] =\n        function(){\n\n};\n\n/**\n * @method urn:oasis:names:tc:xacml:3.0:rule-combining-algorithm:ordered-deny-overrides\n */\nozpIwc.policyAuth.RuleCombining['urn:oasis:names:tc:xacml:3.0:rule-combining-algorithm:ordered-deny-overrides'] =\n        function(){\n\n};\n\n/**\n * @method urn:oasis:names:tc:xacml:3.0:rule-combining-algorithm:ordered-permit-overrides\n */\nozpIwc.policyAuth.RuleCombining['urn:oasis:names:tc:xacml:3.0:rule-combining-algorithm:ordered-permit-overrides'] =\n        function(){\n\n};\n\n/**\n * @method urn:oasis:names:tc:xacml:3.0:rule-combining-algorithm:deny-unless-permit\n */\nozpIwc.policyAuth.RuleCombining['urn:oasis:names:tc:xacml:3.0:rule-combining-algorithm:deny-unless-permit'] =\n        function(){\n\n};\n\n/**\n * @method urn:oasis:names:tc:xacml:3.0:rule-combining-algorithm:permit-unless-deny\n */\nozpIwc.policyAuth.RuleCombining['urn:oasis:names:tc:xacml:3.0:rule-combining-algorithm:permit-unless-deny'] =\n        function(){\n\n};","ozpIwc = ozpIwc || {};\n\nozpIwc.policyAuth = ozpIwc.policyAuth || {};\n\nozpIwc.policyAuth.BaseElement = function(config){\n    config = config || {};\n};\n\n\nozpIwc.policyAuth.BaseElement.prototype.construct = function(element){\n    var parsed = ozpIwc.util.elementParser({\n        element: element,\n        reqAttrs: this.requiredAttributes,\n        optAttrs: this.optionalAttributes,\n        reqNodes: this.requiredNodes,\n        optNodes: this.optionalNodes\n    });\n    this.constructNodes(parsed);\n};\n\n/**\n *\n *\n * @method constructNodes\n * @param {Object}config\n * @param {Object} config.attrs\n * @param {Object} config.nodes\n */\nozpIwc.policyAuth.BaseElement.prototype.constructNodes = function(config){\n    config = config || {};\n    config.attrs = config.attrs || {};\n    config.nodes = config.nodes || {};\n\n    var camelCasedProperty;\n    // Attributes are just strings, simple assignment\n    for(var i in config.attrs){\n        // The property of the policy is the camelCase version of the tagName\n        // (ex. this.policyId = parsed.attrs.PolicyId)\n        camelCasedProperty = ozpIwc.util.camelCased(i);\n        this[camelCasedProperty] = config.attrs[i];\n    }\n\n    // Each node is likely to be mapped to a XACML element, construct said element and set it as this elements property.\n    for(var j in config.nodes){\n        // The property of the policy is the camelCase version of the tagName\n        camelCasedProperty = ozpIwc.util.camelCased(j);\n\n        // If a property of the Policy accepts multiple elements, it's defaulted as an array.\n        if(Array.isArray(this[camelCasedProperty])){\n\n            // Check if the parsed node type is an array, then we will append all its elements to this element.\n            if(Array.isArray(config.nodes[j])){\n                for(var itt in config.nodes[j]){\n                    // The property of the element is the camelCase version of the tagName, the node to construct from the\n                    // parsed object uses the same notation as the tagName for the class call\n                    // (ex.ozpIwc.policyAuth[i] = ozpIwc.policyAuth.Target)\n                    this[camelCasedProperty].push(new ozpIwc.policyAuth[j]({element: config.nodes[j][itt]}));\n                }\n            }else{\n                for(var k in config.nodes[j]) {\n                    this[camelCasedProperty].push(new ozpIwc.policyAuth[j]({element: config.nodes[j][k]}));\n                }\n            }\n        } else {\n            for(var itter in config.nodes[j]) {\n                this[camelCasedProperty] = new ozpIwc.policyAuth[j]({element: config.nodes[j][itter]});\n            }\n        }\n    }\n};\n\n\nozpIwc.policyAuth.BaseElement.prototype.requiredAttributes = [];\nozpIwc.policyAuth.BaseElement.prototype.optionalAttributes = [];\nozpIwc.policyAuth.BaseElement.prototype.requiredNodes = [];\nozpIwc.policyAuth.BaseElement.prototype.optionalNodes = [];","ozpIwc = ozpIwc || {};\n\nozpIwc.policyAuth = ozpIwc.policyAuth || {};\n\n/**\n * 3.3.2 Policy\n * Rules are not exchanged amongst system entities. Therefore, a PAP combines rules in a policy.\n *\n * The <Policy> element is of PolicyType complex type.\n *\n * @class Policy\n * @namespace ozpIwc.policyAuth\n *\n *\n * @param {Object} config\n * @param {Object} config.target\n * @param {Function} config.ruleCombining\n * @param {Array<ozpIwc.policyAuth.Rules>} config.rules\n * @param {Array<Function>} config.obligations\n * @param {Array<Function>} config.advices\n * @constructor\n */\nozpIwc.policyAuth.Policy = ozpIwc.util.extend(ozpIwc.policyAuth.BaseElement,function(config) {\n    config=config || {};\n\n    /**\n     * @property policyId\n     * @type String\n     * @default null\n     */\n    this.policyId = config.policyId;\n\n    /**\n     * @property version\n     * @type Number\n     * @default null\n     */\n    this.version = config.version;\n\n    /**\n     * @property description\n     * @type String\n     * @default null\n     */\n    this.description = config.description;\n\n    /**\n     * @property ruleCombiningAlgId\n     * @type String\n     * @default null\n     */\n    this.ruleCombiningAlgId = config.ruleCombiningAlgId || this.ruleCombiningAlgId;\n\n    /**\n     * An array of {{#crossLink \"ozpIwc.policyAuth.Rule\"}}{{/crossLink}}\n     * @property rules\n     * @type Array<ozpIwc.policyAuth.Rule>\n     * @default []\n     */\n    this.rule = [];\n\n    for(var i in config.rule){\n        // If the rule has an evaluate function, its already constructed\n        if(config.rule[i].evaluate){\n            this.rule.push(config.rule[i]);\n        } else {\n            this.rule.push(new ozpIwc.policyAuth.Rule(config.rule[i]));\n        }\n    }\n    this.evaluate = config.evaluate || this.evaluateDefault;\n\n});\n\n/**\n * Default value\n * @property ruleCombiningAlgId\n * @type {string}\n * @default 'urn:oasis:names:tc:xacml:3.0:rule-combining-algorithm:deny-overrides'\n */\nozpIwc.policyAuth.Policy.prototype.ruleCombiningAlgId = 'urn:oasis:names:tc:xacml:3.0:rule-combining-algorithm:deny-overrides';\n\n/**\n *\n * @TODO request is formatted by urn. see a request.category.\n *\n * @method evaluate(request)\n * @param {Object | String} [request.category.subject]  The subject attributes or id performing the action.\n * @param {Object | String} [request.category.resource] The resource attributes or id that is being acted upon.\n * @param {Object | String} [request.category.action]  The action attributes.  A string should be interpreted as the\n *                                            value of the “action-id” attribute.\n * @param {Array<String>} [request.policies]  A list of URIs applicable to this decision.\n * @param {String} [request. combiningAlgorithm]  Only supports “deny-overrides”\n * @returns {Promise}\n */\nozpIwc.policyAuth.Policy.prototype.evaluateDefault = function(request){\n    return ozpIwc.policyAuth.RuleCombining[this.ruleCombiningAlgId](this.rule,request);\n\n};","ozpIwc = ozpIwc || {};\n\nozpIwc.policyAuth = ozpIwc.policyAuth || {};\n\n\n/**\n * 3.3.1 Rule\n * A rule is the most elementary unit of policy.  It may exist in isolation only within one of the major actors of\n * the XACML domain.  In order to exchange rules between major actors, they must be encapsulated in a policy.\n * A rule can be evaluated on the basis of its contents.  The main components of a rule are:\n *\n * The <Rule> element is of RuleType complex type.\n *\n * @class Rule\n * @namespace ozpIwc.policyAuth\n *\n * @param {Object} config\n * @param {Object} config.target\n * @param {String} config.effect\n * @param {Array<Function>} config.obligations\n * @param {Array<Function>} config.advices\n *\n * @constructor\n */\nozpIwc.policyAuth.Rule = function(config){\n    config=config || {};\n\n    /**\n     * A string identifying this rule.\n     * @property ruleId\n     * @type String\n     * @default null\n     */\n    this.ruleId = config.ruleId;\n\n    /**\n     * A category-keyed collection of attributes.\n     * @property ruleId\n     * @type String\n     * @default null\n     */\n    this.category = config.category;\n\n    /**\n     * The rule-writer's intended consequence of a \"True\" evaluation for the rule.\n     * Two values are allowed: \"Permit\" and \"Deny\".\n     * @property effect\n     * @type String\n     * @default \"Permit\"\n     */\n    this.setEffect(config.effect);\n};\n\n/**\n * 3.3.1.2 Effect\n * The effect of the rule indicates the rule-writer's intended consequence of a \"True\" evaluation for the rule.\n * Two values are allowed: \"Permit\" and \"Deny\".\n *\n * @method setEffect\n * @param {String} effect\n */\nozpIwc.policyAuth.Rule.prototype.setEffect = function(effect){\n    switch(effect){\n        case \"Permit\":\n            this.effect = effect;\n            break;\n        case \"Deny\":\n            this.effect = effect;\n            break;\n        default:\n            this.effect = \"Permit\";\n    }\n};\n\nozpIwc.policyAuth.Rule.prototype.getNegativeEffect = function(){\n    switch(this.effect){\n        case \"Deny\":\n            return \"Permit\";\n        default:\n            return \"Deny\";\n    }\n};\n\nozpIwc.policyAuth.Rule.prototype.evaluate = function(request){\n    var reqCategory = request.category;\n\n    // Iterate over each category\n    for(var i in this.category){\n        // If the request doesn't have the category, fail it\n        if(!reqCategory[i]){\n            //@TODO\n            return this.getNegativeEffect();\n        } else {\n            // iterate over each attribute in the request\n            for(var j in reqCategory[i]){\n                //If the attribute in the request does not exist in the policy, keep moving.\n                if(!this.category[i][j]){\n                    continue;\n                }\n                var attributes = this.category[i][j];\n\n                var matchFound = false;\n                var reqAttributes = reqCategory[i][j];\n\n\n                //Make sure the attributes are arrays\n                reqAttributes = Array.isArray(reqAttributes) ?\n                    reqAttributes : [reqAttributes];\n\n                // If no attribute values in the policy\n                if(attributes.length === 0){\n                    // and none in the request, it passes\n                    if (attributes.length === 0) {\n                        matchFound = true;\n                    } else {\n                        // it fails\n                        matchFound = false;\n                    }\n                } else {\n                    matchFound = true;\n                    // Else iterate over each req attribute value, if one doesn't show in the policy, it fails.\n                    for (var k in reqAttributes) {\n                        if(attributes.indexOf(reqAttributes[k]) < 0){\n                            matchFound = false;\n                        }\n                    }\n                }\n\n                if(!matchFound){\n                    return this.getNegativeEffect();\n                }\n            }\n        }\n    }\n    return this.effect;\n};\n\n","ozpIwc = ozpIwc || {};\nozpIwc.policyAuth = ozpIwc.policyAuth || {};\n\n/**\n * A security attribute constructor for policyAuth use. Structured to be common to both bus-internal and api needs.\n * @class SecurityAttribute\n * @namespace ozpIwc.policyAuth\n * @param config\n * @constructor\n */\nozpIwc.policyAuth.SecurityAttribute = function(config){\n    config = config || {};\n    this.attributes =  config.attributes ||  {};\n    this.comparator = config.comparator || this.comparator;\n};\n\n/**\n * Adds a value to the security attribute if it does not already exist. Constructs the attribute object if it does not\n * exist\n *\n * @method pushIfNotExist\n * @param id\n * @param val\n */\nozpIwc.policyAuth.SecurityAttribute.prototype.pushIfNotExist = function(id, val, comp) {\n    comp = comp || this.comparator;\n    if(!val){\n        return;\n    }\n    var value = Array.isArray(val) ? val : [val];\n    if (!this.attributes[id]) {\n        this.attributes[id] = [];\n        this.attributes[id] = this.attributes[id].concat(value);\n    } else {\n        for (var i in this.attributes[id]) {\n            for (var j in value) {\n                if (!comp(this.attributes[id][i], value[j])) {\n                    this.attributes[id].push(val);\n                }\n            }\n        }\n    }\n};\n\n/**\n * Clears the attributes given to an id.\n * @param id\n */\nozpIwc.policyAuth.SecurityAttribute.prototype.clear = function(id){\n    delete this.attributes[id];\n};\n\n/**\n * Clears all attributes.\n * @method clear\n */\nozpIwc.policyAuth.SecurityAttribute.prototype.clearAll = function(){\n    this.attributes = {};\n};\n\n/**\n * Returns an object containing all of the attributes.\n * @returns {Object}\n */\nozpIwc.policyAuth.SecurityAttribute.prototype.getAll = function(){\n    return this.attributes;\n};\n\n/**\n *\n * Determines the equality of an object against a securityAttribute value.\n * @method comparator\n * @param a\n * @param b\n * @returns {boolean}\n */\nozpIwc.policyAuth.SecurityAttribute.prototype.comparator = function(a, b) {\n    return a === b;\n};","ozpIwc = ozpIwc || {};\n\nozpIwc.policyAuth = ozpIwc.policyAuth || {};\n\n/**\n * System entity that evaluates applicable policy and renders an authorization decision.\n * @class PDP\n * @namespace ozpIwc.policyAuth\n *\n * @param {Object} config\n * @param {ozpIwc.policyAuth.PRP} config.prp Policy Repository Point for the PDP to gather policies from.\n * @param {ozpIwc.policyAuth.PIP} config.pip Policy Information Point for the PDP to gather attributes from.\n * @constructor\n */\nozpIwc.policyAuth.PDP = function(config){\n    config=config || {};\n\n    /**\n     * Policy Repository Point\n     * @property prp\n     * @type {ozpIwc.policyAuth.PRP}\n     * @default new ozpIwc.policyAuth.PRP()\n     */\n    this.prp = config.prp ||  new ozpIwc.policyAuth.PRP();\n\n\n    /**\n     * Policy Information Point\n     * @property pip\n     * @type {ozpIwc.policyAuth.PIP}\n     * @default new ozpIwc.policyAuth.PIP()\n     */\n    this.pip = config.pip || new ozpIwc.policyAuth.PIP();\n\n    this.policySets = config.policySets ||\n    {\n        'connectSet': [\"/policy/connect\"],\n        'apiSet': [\"/policy/apiNode\"],\n        'readSet': [\"/policy/read\"],\n        'receiveAsSet': [\"/policy/receiveAs\"],\n        'sendAsSet': [\"/policy/sendAs\"]\n    };\n};\n\n\n/**\n * @method isPermitted(request)\n * @param {Object | String} [request.subject]       The subject attributes or id performing the action.\n * @param {Object | String} [request.resource]      The resource attributes or id that is being acted upon.\n * @param {Object | String} [request.action]        The action attributes.  A string should be interpreted as the\n *                                                  value of the “action-id” attribute.\n * @param {Array<String>} [request.policies]        A list of URIs applicable to this decision.\n * @param {String} [request. combiningAlgorithm]    Only supports “deny-overrides”\n * @param {Object} [contextHolder]                  An object that holds 'securityAttribute' attributes to populate the\n *                                                  PIP cache with for request/policy use.\n * @returns {ozpIwc.AsyncAction} will resolve with 'success' if the policy gives a \"Permit\".\n *                                    rejects else wise. the async success will receive:\n * ```{\n *      'result': <String>,\n *      'request': <Object> // a copy of the request passed in,\n *      'formattedRequest': <Object> // a copy of the formatted request (for PDP user caching)\n *      'formattedPolicies': <Object> // a copy of the formatted policies (for PDP user caching)\n *    }```\n */\nozpIwc.policyAuth.PDP.prototype.isPermitted = function(request){\n    var asyncAction = new ozpIwc.AsyncAction();\n\n    var self = this;\n    //If there is no request information, its a trivial \"Permit\"\n    if(!request){\n        return asyncAction.resolve('success',{\n                'result':\"Permit\"\n            });\n    }\n\n    var formattedPolicies = [];\n\n    var onError = function(err){\n        asyncAction.resolve('failure',err);\n    };\n    //Format the request\n    this.formatRequest(request)\n        .success(function(formattedRequest){\n\n            // Get the policies from the PRP\n            self.prp.getPolicies(formattedRequest.policies)\n                .success(function(policies){\n\n                    var result = ozpIwc.policyAuth.PolicyCombining['deny-overrides'](policies,formattedRequest.category);\n                    var response = {\n                        'result':result,\n                        'request': request,\n                        'formattedRequest': formattedRequest,\n                        'formattedPolicies': formattedPolicies\n                    };\n                    if(result === \"Permit\"){\n                       asyncAction.resolve('success',response);\n                    } else {\n                        onError(response);\n                    }\n                }).failure(onError);\n        }).failure(onError);\n    return asyncAction;\n};\n\n\nozpIwc.policyAuth.PDP.prototype.formatAttributes = function(attributes,pip){\n    attributes = Array.isArray(attributes) ? attributes : [attributes];\n    var asyncAction = new ozpIwc.AsyncAction();\n    pip = pip || this.pip;\n    var asyncs = [];\n    for(var i in attributes){\n        asyncs.push(this.formatAttribute(attributes[i],pip));\n    }\n    ozpIwc.AsyncAction.all(asyncs).success(function(attrs){\n        var retObj = {};\n        for(var i in attrs){\n            if(Object.keys(attrs[i]).length > 0) {\n                for (var j in attrs[i]) {\n                    retObj[j] = attrs[i][j];\n                }\n            }\n        }\n        asyncAction.resolve(\"success\",retObj);\n    });\n    return asyncAction;\n};\n\n\n\n\n    /**\n * Takes a URN, array of urns, object, array of objects, or array of any combination and fetches/formats to the\n * necessary structure to be used by a request of policy's category object.\n *\n * @method formatAttribute\n * @param {String|Object|Array<String|Object>}attribute The attribute to format\n * @param {ozpIwc.policyAuth.PIP} [pip] Policy information point, uses ozpIwc.authorization.pip by default.\n * @returns {ozpIwc.AsyncAction} returns an async action that will resolve with an object of the formatted attributes.\n *                               each attribute is ID indexed in the object, such that the formatting of id\n *                               `ozp:iwc:node` which has attributes `a` and `b`would resolve as follows:\n *                  ```\n *                  {\n *                      'ozp:iwc:node': {\n *                          'attributeValues': ['a','b']\n *                       }\n *                  }\n *                  ```\n *\n */\nozpIwc.policyAuth.PDP.prototype.formatAttribute = function(attribute,pip){\n    var asyncAction = new ozpIwc.AsyncAction();\n    pip = pip || this.pip;\n    var asyncs = [];\n    if(!attribute){\n        return asyncAction.resolve('success');\n    }\n\n\n    if(!attribute){\n        //do nothing and return an empty object.\n        asyncAction.resolve('success', {});\n\n    }else if(typeof attribute === \"string\") {\n        // If its a string, use it as a key and fetch its attrs from PIP\n        pip.getAttributes(attribute)\n            .success(function(attr){\n                //TODO check if is an array or string (APPLY RECURSION!)\n                asyncAction.resolve(\"success\",attr);\n            })\n\n    } else if(Array.isArray(attribute)){\n        // If its an array, its multiple actions. Wrap as needed\n        return this.formatAttributes(attribute,pip);\n\n    } else if(typeof attribute === \"object\"){\n        // If its an object, make sure each key's value is an array.\n        var keys = Object.keys(attribute);\n        for (var i in keys) {\n            var tmp = attribute[keys[i]];\n            if (['string', 'number', 'boolean'].indexOf(typeof attribute[keys[i]]) >= 0) {\n                attribute[keys[i]] =  [tmp];\n            }\n            attribute[keys[i]] = attribute[keys[i]] || [];\n        }\n        asyncAction.resolve(\"success\",attribute);\n    }\n    return asyncAction;\n};\n\n\n\n/**\n * Formats an action to be used by a request or policy. Actions are not gathered from the Policy Information Point.\n * Rather they are string values explaining the operation to be permitted. To comply with XACML, these strings are\n * wrapped in objects for easier comparison\n *\n * @method formatAction\n * @param {String|Object|Array<String|Object>} action\n * @returns {Object} An object of formatted actions indexed by the ozp action id `ozp:action:id`.\n *                   An example output for actions ['read','write'] is as follows:\n *      ```\n *      {\n *          'ozp:iwc:action': {\n *              'attributeValue': ['read', 'write']\n *          }\n *      }\n *      ```\n *\n */\nozpIwc.policyAuth.PDP.prototype.formatAction = function(action){\n\n    var formatted =  [];\n\n    var objectHandler = function(object,formatted){\n        var values;\n        // We only care about attributeValues\n        if(object['ozp:iwc:action']){\n            values = object['ozp:iwc:action'];\n        }\n        if(Array.isArray(values)) {\n                return arrayHandler(values,formatted);\n        } else if(['string', 'number', 'boolean'].indexOf(typeof values) >= 0){\n            if(formatted.indexOf(values) < 0){\n                formatted.push(values);\n            }\n        }\n    };\n    var arrayHandler = function(array,formatted){\n        for(var i in array){\n            if(typeof array[i] === 'string') {\n                if (formatted.indexOf(array[i]) < 0) {\n                    formatted.push(array[i]);\n                }\n            } else if(Array.isArray(array[i])){\n                arrayHandler(array[i],formatted);\n            } else if(typeof array[i] === 'object') {\n                objectHandler(array[i],formatted);\n            }\n        }\n    };\n\n    if(!action){\n        //do nothing and return an empty array\n    }else if(typeof action === \"string\"){\n        // If its a string, its a single action.\n        formatted.push(action);\n    } else if(Array.isArray(action)){\n        arrayHandler(action,formatted);\n    } else if(typeof action === 'object'){\n        objectHandler(action,formatted);\n    }\n\n    return {'ozp:iwc:action': formatted};\n};\n\n/**\n * Takes a request object and applies any context needed from the PIP.\n *\n * @method formatRequest\n * @param {Object}          request\n * @param {String|Array<String>|Object}    request.subject URN(s) of attribute to gather, or formatted subject object\n * @param {String|Array<String>Object}     request.resource URN(s) of attribute to gather, or formatted resource object\n * @param {String|Array<String>Object}     request.action URN(s) of attribute to gather, or formatted action object\n * @param {String}                         request.combiningAlgorithm URN of combining algorithm\n * @param {Array<String|ozpIwc.policyAuth.Policy>}   request.policies either a URN or a formatted policy\n * @param {ozpIwc.policyAuth.PIP} [pip] custom policy information point for attribute gathering.\n * @returns {ozpIwc.AsyncAction}  will resolve when all attribute formatting completes.\n *                    The resolution will pass a formatted\n *                      structured as so:\n *                    ```{\n *                      'category':{\n *                          \"urn:oasis:names:tc:xacml:1.0:subject-category:access-subject\": {\n *                              <AttributeId>: {\n *                                  \"attributeValues\": Array<Primitive>\n *                              }\n *                          },\n *                          \"urn:oasis:names:tc:xacml:3.0:attribute-category:resource\": {\n *                              <AttributeId>: {\n *                                  \"attributeValues\": Array<Primitive>\n *                              }\n *                          },\n *                          \"urn:oasis:names:tc:xacml:3.0:attribute-category:action\": {\n *                              \"ozp:iwc:action\": {\n *                                  \"attributeValues\": Array<String>\n *                              }\n *                          }\n *                       },\n *                      'combiningAlgorithm': request.combiningAlgorithm,\n *                      'policies': request.policies\n *                     }```\n */\nozpIwc.policyAuth.PDP.prototype.formatRequest = function(request,pip){\n    var asyncAction = new ozpIwc.AsyncAction();\n    pip = pip || this.pip;\n    request = request || {};\n    request.subject = request.subject || {};\n    request.resource = request.resource || {};\n    request.action = request.action || {};\n    var asyncs = [];\n\n    var subjectAsync = this.formatAttribute(request.subject,pip);\n    var resourceAsync = this.formatAttribute(request.resource,pip);\n    var actions = this.formatAction(request.action);\n\n    asyncs.push(subjectAsync,resourceAsync,actions);\n\n    ozpIwc.AsyncAction.all(asyncs)\n        .success(function(gatheredAttributes){\n            var sub = gatheredAttributes[0];\n            var res = gatheredAttributes[1];\n            var act = gatheredAttributes[2];\n            asyncAction.resolve('success',{\n                'category':{\n                    \"subject\": sub,\n                    \"resource\": res,\n                    \"action\": act\n                },\n                'combiningAlgorithm': request.combiningAlgorithm,\n                'policies': request.policies\n            });\n        }).failure(function(err){\n            asyncAction.resolve('failure',err);\n        });\n    return asyncAction;\n};\n\n/**\n * The URN of the default combining algorithm to use when basing a decision on multiple policies.\n * @property defaultCombiningAlgorithm\n * @type {String}\n * @default \"urn:oasis:names:tc:xacml:3.0:policy-combining-algorithm:deny-overrides\"\n */\nozpIwc.policyAuth.PDP.prototype.defaultCombiningAlgorithm =\n    \"urn:oasis:names:tc:xacml:3.0:policy-combining-algorithm:deny-overrides\";\n\n/**\n * A factory function to create a function for evaluating formatted policies against a given combining algorithm\n * in the ozpIwc.policyAuth.PolicyCombining namespace.\n *\n * @method generateEvaluation\n * @param {String|Array<String>}        policies none, one, or many policies to evaluate with the given combining algorithm\n * @param {String} combiningAlgorithm   the name of the combining algorithm to obtain from the\n *                                      ozpIwc.policyAuth.PolicyCombining namespace.\n * @returns {Function}                  returns a function call expecting a formatted request to be passed to for\n *                                      evaluation. Ex:\n *                                      ```\n *                                      var pdp = new ozpIwc.policyAuth.PDP(...);\n *                                      var evalFunc = pdp.generateEvaluation(somePolicies, someCombiningAlgorithm);\n *                                      var result = evalFunc(someRequest);\n *                                      ```\n */\n//ozpIwc.policyAuth.PDP.prototype.generateEvaluation = function(policies,combiningAlgorithm){\n//    policies = policies || [];\n//    policies = Array.isArray(policies)? policies : [policies];\n//\n//    var combiningFunction = ozpIwc.policyAuth.PolicyCombining[combiningAlgorithm] ||\n//        ozpIwc.policyAuth.PolicyCombining[this.defaultCombiningAlgorithm];\n//\n//    // If there are no policies to check against, assume trivial and permit\n//    if(policies.length === 0){\n//        return ozpIwc.abacPolicies.permitAll;\n//    }\n//\n//    return function(request){\n//            return combiningFunction(policies,request);\n//    };\n//};\n\n\n/**\n * Formats a category object. If needed the attribute data is gathered from the PIP.\n *\n * @method formatCategory\n * @param {String|Array<String>|Object} category the category (subject,resource,action) to format\n * @param {String} categoryId the category name used to map to its corresponding attributeId (see PDP.mappedID)\n * @param {ozpIwc.policyAuth.PIP} [pip] custom policy information point for attribute gathering.\n * @returns {ozpIwc.AsyncAction}  will resolve with a category object formatted as so:\n *      ```\n *      {\n *          <AttributeId>: {\n *              'attributeValue': {Array<Primative>}\n *          }\n *      }\n *      ```\n *\n */\nozpIwc.policyAuth.PDP.prototype.formatCategory = function(category,pip){\n    var asyncAction = new ozpIwc.AsyncAction();\n    if(!category){\n        return asyncAction.resolve('success');\n    }\n\n    pip = pip || this.pip;\n\n    this.formatAttribute(category,pip)\n        .success(function(attributes){\n            for(var i in attributes['ozp:iwc:permissions']){\n                attributes[i] = attributes['ozp:iwc:permissions'][i];\n            }\n            delete attributes['ozp:iwc:permissions'];\n            asyncAction.resolve('success',attributes);\n        }).failure(function(err){\n            asyncAction.resolve('failure',err);\n        });\n    return asyncAction;\n};\n\n/**\n *\n * Category context handling for policy objects.\n * Takes object key-indexed categories for a policy\n * and returns an object key-indexed listing of formatted. Each category is keyed by its XACML URN. currently only\n * subject,resource, and action categories are supported.\n *\n * @method formatCategories\n * @param {Object} categoryObj\n * @param {Object|String|Array<String|Object>}\n *          [categoryObj[\"urn:oasis:names:tc:xacml:1.0:subject-category:access-subject\"]]\n *                                          Formats xacml subject category attributes\n * @param {Object|String|Array<String|Object>}\n *          [categoryObj[\"urn:oasis:names:tc:xacml:3.0:attribute-category:resource\"]]\n *                                          Formats xacml resource category attributes\n * @param {Object|String|Array<String|Object>}\n *          [categoryObj[\"urn:oasis:names:tc:xacml:1.0:subject-category:access-subject\"]]\n *                                          Formats xacml action category attributes\n * @param {ozpIwc.policyAuth.PIP} [pip] custom policy information point for attribute gathering.\n * @returns {ozpIwc.AsyncAction} will resolve an object of categories be structured as so:\n * ```\n * {\n *   'urn:oasis:names:tc:xacml:1.0:subject-category:access-subject' : {\n *      <AttributeId>:{\n *          'attributeValue' : Array<Primitive>\n *      },\n *      <AttributeId>:{\n *          'attributeValue' : Array<Primitive>\n *      }\n *   },\n *   'urn:oasis:names:tc:xacml:3.0:attribute-category:resource': {...},\n *   'urn:oasis:names:tc:xacml:1.0:subject-category:access-subject': {...},\n * }\n * ```\n */\nozpIwc.policyAuth.PDP.prototype.formatCategories = function(categoryObj,pip){\n    var asyncAction = new ozpIwc.AsyncAction();\n    pip = pip || this.pip;\n    var categoryAsyncs = [];\n    var categoryIndexing = {};\n    for(var i in categoryObj){\n        categoryAsyncs.push(this.formatCategory(categoryObj[i],pip));\n        categoryIndexing[i] = categoryAsyncs.length - 1;\n    }\n    ozpIwc.AsyncAction.all(categoryAsyncs)\n        .success(function(categories){\n            var map = {};\n            var keys = Object.keys(categoryIndexing);\n            for(var i in keys){\n                map[keys[i]] = categories[categoryIndexing[keys[i]]] || {};\n            }\n            asyncAction.resolve('success',map);\n        }).failure(function(err){\n            asyncAction.resolve('failure',err);\n        });\n    return asyncAction;\n};\n\n\n/**\n * Context handler for a policy rule object.\n *\n * Formats the rules categories,\n * @method formatRule\n * @param {Object} rule\n * @param {ozpIwc.policyAuth.PIP} [pip] custom policy information point for attribute gathering.\n * @returns {ozpIwc.AsyncAction} will resolve with a formatted rule.\n */\n//ozpIwc.policyAuth.PDP.prototype.formatRule = function(rule,pip) {\n//    var asyncAction = new ozpIwc.AsyncAction();\n//    pip = pip || this.pip;\n//    this.formatCategories(rule.category,pip)\n//        .success(function (categories) {\n//            rule.category = categories;\n//            asyncAction.resolve('success',rule);\n//        }).failure(function(err){\n//            asyncAction.resolve('failure',err);\n//        });\n//    return asyncAction;\n//};\n\n/**\n * Context handler for policy rule objects.\n *\n * @method formatRules\n * @param {Array<Object>} rules\n * @param {ozpIwc.policyAuth.PIP} [pip] custom policy information point for attribute gathering.\n * @returns {ozpIwc.AsyncAction} will resolve with a matching-order of formatted rules array.\n */\n//ozpIwc.policyAuth.PDP.prototype.formatRules = function(rules,pip){\n//    pip = pip || this.pip;\n//    var ruleAsyncs = [];\n//    for(var i in rules){\n//        var tmp = this.formatRule(rules[i],pip);\n//        ruleAsyncs.push(tmp);\n//    }\n//    return ozpIwc.AsyncAction.all(ruleAsyncs);\n//};\n\n\n/**\n * Context handler for a policy object.\n *\n * @method formatPolicy\n * @param {Object} policy\n * @param {ozpIwc.policyAuth.PIP} [pip] custom policy information point for attribute gathering.\n * @returns {ozpIwc.AsyncAction} calls and returns a formatRules AsyncAction\n */\n//ozpIwc.policyAuth.PDP.prototype.formatPolicy = function(policy,pip){\n//    var asyncAction = new ozpIwc.AsyncAction();\n//    pip = pip || this.pip;\n//    policy = policy || {};\n//\n//    this.formatRules(policy.rule,pip)\n//        .success(function(rules){\n//            policy.rule = rules;\n//            asyncAction.resolve('success',policy);\n//        }).failure(function(err){\n//            asyncAction.resolve('failure',err);\n//        });\n//    return asyncAction;\n//};\n\n\n/**\n * Context handler for multiple policy objects.\n *\n * @method formatPolicies\n * @param {Array<Object>} policies\n * @param {ozpIwc.policyAuth.PIP} [pip] custom policy information point for attribute gathering.\n * @returns {ozpIwc.AsyncAction} will resolve with an array of formatted policies\n */\n//ozpIwc.policyAuth.PDP.prototype.formatPolicies = function(policies,pip){\n//    var asyncAction = new ozpIwc.AsyncAction();\n//    pip = pip || this.pip;\n//    var policyAsyncs = [];\n//    for(var i in policies){\n//        policyAsyncs.push(this.formatPolicy(policies[i],pip));\n//    }\n//    ozpIwc.AsyncAction.all(policyAsyncs)\n//        .success(function(policies){\n//            var formattedPolicies = [];\n//            for(var i in policies){\n//                formattedPolicies[i] = new ozpIwc.policyAuth.Policy(policies[i]);\n//            }\n//            asyncAction.resolve('success',formattedPolicies);\n//        }).failure(function(err){\n//            asyncAction.resolve('failure',err);\n//        });\n//    return asyncAction;\n//};\n\n/**\n * Simple mapping function for assigning attributeId's to category types.\n *\n * @method mappedId\n * @param {String} string\n * @returns {String|undefined} returns undefined if a matching Id is not found (likely because not supported).\n */\n//ozpIwc.policyAuth.PDP.prototype.mappedId = function(string){\n//    switch(string){\n//        case \"urn:oasis:names:tc:xacml:1.0:subject-category:access-subject\":\n//            return \"urn:oasis:names:tc:xacml:1.0:subject:subject-id\";\n//        case \"urn:oasis:names:tc:xacml:3.0:attribute-category:resource\":\n//            return \"urn:oasis:names:tc:xacml:1.0:resource:resource-id\";\n//        case \"urn:oasis:names:tc:xacml:3.0:attribute-category:action\":\n//            return \"urn:oasis:names:tc:xacml:1.0:action:action-id\";\n//        default:\n//            return undefined;\n//    }\n//};\n//\n//ozpIwc.policyAuth.PDP.prototype.gatherContext = function(contextHolder){\n//\n//    var permissions = {};\n//    for(var i in contextHolder.permissions.attributes) {\n//        permissions[i] = contextHolder.permissions.attributes[i];\n//        var wrapped = {};\n//        wrapped[i] = permissions[i];\n//        this.pip.grantAttributes(i, wrapped);\n//    }\n//    this.pip.grantAttributes(\"ozp:iwc:permissions\", permissions);\n//\n//    //Take a snapshot of the pip to use for the permission check (due to async nature)\n//    return ozpIwc.util.protoClone(this.pip);\n//};\n","ozpIwc = ozpIwc || {};\n\n\nozpIwc.policyAuth = ozpIwc.policyAuth || {};\n\n/**\n * Policy Information Point\n *\n * @param config\n * @param {Object} config.attributes\n * @constructor\n */\nozpIwc.policyAuth.PIP = ozpIwc.util.extend(ozpIwc.policyAuth.SecurityAttribute,function(config) {\n    ozpIwc.policyAuth.SecurityAttribute.apply(this,arguments);\n});\n\n\n/**\n * Returns an asyncAction that will resolve with the attributes stored at the given URN.\n *\n * @method getAttributes(id)\n * @param {String} [subjectId] – The authenticated identity to get attributes for.\n * @returns {ozpIwc.AsyncAction} – Resolves an object of the attributes of the subject.\n * @example URN \"ozp:storage:myAttrs\" may contain \"ozp:iwc:loginTime\" and \"ozp:iwc:name\".\n * getAttributes(\"ozp:storage:myAttrs\") would resolve with the following:\n * ```\n * {\n *      'ozp:iwc:loginTime' : {\n *         'attributeValue': Array<Primative>\n *     },\n *      'ozp:iwc:name' : {\n *         'attributeValue': Array<Primative>\n *     }\n * }\n * ```\n */\nozpIwc.policyAuth.PIP.prototype.getAttributes = function(id){\n    var asyncAction = new ozpIwc.AsyncAction();\n    var self = this;\n\n    if(this.attributes[id]) {\n        return asyncAction.resolve('success', self.attributes[id]);\n    } else {\n        ozpIwc.util.ajax({\n            href: id,\n            method: \"GET\"\n        }).then(function(data){\n            if(typeof data !== \"object\") {\n                return asyncAction.resolve('failure',\"Invalid data loaded from the remote PIP\");\n            }\n            self.attributes[id] = {};\n            for(var i in data){\n                self.attributes[id][i] = Array.isArray(data[i] ) ? data[i]  : [data[i] ];\n            }\n            asyncAction.resolve('success', self.attributes[id]);\n        })['catch'](function(err){\n            asyncAction.resolve('failure',err);\n        });\n        return asyncAction;\n    }\n\n};\n/**\n * Sets the desired attributes in the cache at the specified URN.\n *\n * @method grantAttributes(subjectId,attributes)\n * @param {String} [subjectId] – The recipient of attributes.\n * @param {object} [attributes] – The attributes to grant (replacing previous values, if applicable)\n */\nozpIwc.policyAuth.PIP.prototype.grantAttributes = function(subjectId,attributes){\n    var attrs = {};\n    for(var i in attributes){\n        attrs[i] = Array.isArray(attributes[i]) ? attributes[i] : [attributes[i]];\n    }\n    this.attributes[subjectId] = attrs;\n};\n\n/**\n * Merges the attributes stored at the parentId urn into the given subject. All merge conflicts take the parent\n * attribute. Will resolve with the subject when completed.\n *\n * @method grantParent(subjectId,parentSubjectId)\n * @param {String} [subjectId] – The recipient of attributes.\n * @param {String} [parentSubjectId] – The subject to inherit attributes from.\n * @returns {ozpIwc.AsyncAction} resolves with the subject and its granted attributes merged in.\n */\nozpIwc.policyAuth.PIP.prototype.grantParent = function (subjectId,parentId){\n    var asyncAction = new ozpIwc.AsyncAction();\n    this.attributes[subjectId] = this.attributes[subjectId] || {};\n    var self = this;\n\n    if(self.attributes[parentId]){\n        for(var i in self.attributes[parentId]){\n            self.attributes[subjectId][i] = self.attributes[subjectId][i] || [];\n            for(var j in self.attributes[parentId][i]) {\n                if (self.attributes[subjectId][i].indexOf(self.attributes[parentId][i][j]) < 0) {\n                    self.attributes[subjectId][i].push(self.attributes[parentId][i][j]);\n                }\n            }\n        }\n        return asyncAction.resolve('success',self.attributes[subjectId]);\n\n    } else {\n        self.getAttributes(parentId)\n            .success(function(attributes){\n                for(var i in attributes){\n                    if(self.attributes[subjectId].indexOf(attributes[i]) < 0) {\n                        self.attributes[subjectId].push(attributes[i]);\n                    }\n                }\n                asyncAction.resolve('success',self.attributes[subjectId]);\n            }).failure(function(err){\n                asyncAction.resolve('failure',err);\n            });\n        return asyncAction;\n    }\n};","ozpIwc = ozpIwc || {};\n\n\nozpIwc.policyAuth = ozpIwc.policyAuth || {};\n\n/**\n * Policy Repository Point\n *\n * @param config\n * @param {Object} config.policyCache\n * @constructor\n */\nozpIwc.policyAuth.PRP = function(config){\n    config = config || {};\n\n    this.persistentPolicies = config.persistentPolicies || [];\n    this.policyCache = config.policyCache || ozpIwc.policyAuth.defaultPolicies;\n\n\n};\n\n\n/**\n * Gathers policies by their URN. These policies may need formatting by the formatPolicies function to gather any\n * attribute data needed for the policy evaluation.\n * If a policy cannot be found, it is labeled as a \"denyAll\" policy and placed in the cache. Thus, making any permission\n * check using said policy always deny.\n *\n * @method getPolicy(policyURIs)\n * @param {String | Array<String> } [policyURIs] The subject attributes or id performing the action.\n * @param {String} [combiningAlgorithm] Defaults to “deny-overrides”.\n * @return {ozpIwc.AsyncAction} will resolve with an array of policy data.\n */\nozpIwc.policyAuth.PRP.prototype.getPolicies = function(policyURIs){\n    var asyncAction = new ozpIwc.AsyncAction();\n    policyURIs = policyURIs || [];\n    policyURIs = Array.isArray(policyURIs)? policyURIs : [policyURIs];\n    var policies = [];\n\n    var policiesToGather = this.persistentPolicies.concat(policyURIs);\n    for(var i in policiesToGather){\n        if(this.policyCache[policiesToGather[i]]){\n            policies.push(ozpIwc.util.clone(this.policyCache[policiesToGather[i]]));\n        } else {\n            var async = this.fetchPolicy(policiesToGather[i]);\n\n            //Push the policy fetch to the array, when it resolves its value (policy) will be part of the array\n            policies.push(async);\n        }\n    }\n\n    // If there are no policies to check against, assume trivial and permit\n    if(policies.length === 0){\n        return asyncAction.resolve('success',[ozpIwc.abacPolicies.permitAll]);\n    }\n\n    return ozpIwc.AsyncAction.all(policies);\n};\n\n\n\n/**\n * The URN of the default combining algorithm to use when basing a decision on multiple rules in a policy.\n * @TODO not used.\n * @property defaultCombiningAlgorithm\n * @type {String}\n * @default 'urn:oasis:names:tc:xacml:3.0:rule-combining-algorithm:deny-overrides'\n */\nozpIwc.policyAuth.PRP.prototype.defaultCombiningAlgorithm =\n    'urn:oasis:names:tc:xacml:3.0:rule-combining-algorithm:deny-overrides';\n\n/**\n * Fetches the requested policy and stores a copy of it in the cache. Returns a denyAll if policy is unobtainable.\n * @method fetchPolicy\n * @param {String} policyURI the uri to gather the policy from\n * @returns {AsyncAction} will resolve with the gathered policy constructed as an ozpIwc.policyAuth.Policy.\n */\nozpIwc.policyAuth.PRP.prototype.fetchPolicy = function(policyURI){\n    var asyncAction = new ozpIwc.AsyncAction();\n    var self = this;\n    ozpIwc.util.ajax({\n        'method': \"GET\",\n        'href': policyURI\n    }).then(function(data){\n        self.policyCache[policyURI] = self.formatPolicy(data.response);\n        asyncAction.resolve('success',ozpIwc.util.clone(self.policyCache[policyURI]));\n    })['catch'](function(e){\n        //Note: failure resolves success because we force a denyAll policy.\n        asyncAction.resolve('success',self.getDenyall(policyURI));\n    });\n    return asyncAction;\n};\n\n/**\n * Turns JSON data in to ozpIwc.policyAuth.Policy\n * @method formatPolicy\n * @param data\n * @returns {ozpIwc.policyAuth.Policy}\n */\nozpIwc.policyAuth.PRP.prototype.formatPolicy = function(data){\n    return new ozpIwc.policyAuth.Policy(data);\n};\n\n/**\n * Returns a policy that will always deny any request. Said policy is stored in the cache under the given URN\n * @param urn\n * @returns {ozpIwc.policyAuth.Policy} a denyAll policy\n */\nozpIwc.policyAuth.PRP.prototype.getDenyall = function(urn){\n    if(this.policyCache[urn]){\n        return this.policyCache[urn];\n    } else {\n        var policy = new ozpIwc.policyAuth.Policy({\n            policyId: urn\n        });\n        policy.evaluate = ozpIwc.abacPolicies.denyAll;\n        this.policyCache[urn] = policy;\n        return policy;\n    }\n};\n","\n/**\n * Classes related to security aspects of the IWC.\n * @module bus\n * @submodule bus.security\n */\n\n/**\n * Attribute Based Access Control policies.\n * @class abacPolicies\n * @static\n */\nozpIwc.abacPolicies={};\n\n/**\n * Returns `permit` when the request's object exists and is empty.\n *\n * @static\n * @method permitWhenObjectHasNoAttributes\n * @param request\n *\n * @returns {String}\n */\nozpIwc.abacPolicies.permitWhenObjectHasNoAttributes=function(request) {\n    if(request.object && Object.keys(request.object).length===0) {\n        return \"Permit\";\n    }\n    return \"Undetermined\";\n};\n/**\n * Returns `permit` when the request's subject contains all of the request's object.\n *\n * @static\n * @method subjectHasAllObjectAttributes\n * @param request\n *\n * @returns {String}\n */\nozpIwc.abacPolicies.subjectHasAllObjectAttributes=function(request) {\n    // if no object permissions, then it's trivially true\n    if(!request.object) {\n        return \"Permit\";\n    }\n    var subject = request.subject || {};\n    if(ozpIwc.util.objectContainsAll(subject,request.object,this.implies)) {\n        return \"Permit\";\n    }\n    return \"Deny\";\n};\n\n/**\n * Returns `permit` for any scenario.\n *\n * @static\n * @method permitAll\n * @returns {String}\n */\nozpIwc.abacPolicies.permitAll=function() {\n    return \"Permit\";\n};\n\n\n/**\n * Returns `Deny` for any scenario.\n *\n * @static\n * @method denyAll\n * @returns {String}\n */\nozpIwc.abacPolicies.denyAll=function() {\n    return \"Deny\";\n};\n\n\n\n/**\n *\n * @method implies\n * @param {Array} subjectVal\n * @param {Array} objectVal\n *\n * @returns {Boolean}\n */\nozpIwc.abacPolicies.implies=function(subjectVal,objectVal) {\n    // no object value is trivially true\n    if(objectVal===undefined || objectVal === null) {\n        return true;\n    }\n    // no subject value when there is an object value is trivially false\n    if(subjectVal===undefined || subjectVal === null) {\n        return false;\n    }\n\n    // convert both to arrays, if necessary\n    subjectVal=Array.isArray(subjectVal)?subjectVal:[subjectVal];\n    objectVal=Array.isArray(objectVal)?objectVal:[objectVal];\n\n    // confirm that every element in objectVal is also in subjectVal\n    return ozpIwc.util.arrayContainsAll(subjectVal,objectVal);\n};\n\n\nozpIwc.abacPolicies.defaultPolicy = function(request,action){\n    action = Array.isArray(action) ? action : [action];\n    if(!ozpIwc.util.arrayContainsAll(action,request.action['ozp:iwc:action'])) {\n        return \"NotApplicable\";\n    } else if(!ozpIwc.util.objectContainsAll(request.subject,request.resource,ozpIwc.abacPolicies.implies)) {\n        return \"Deny\";\n    } else {\n        return \"Permit\";\n    }\n};\n\n","ozpIwc = ozpIwc || {};\nozpIwc.policyAuth = ozpIwc.policyAuth || {};\nozpIwc.policyAuth.defaultPolicies = {};\n\nozpIwc.policyAuth.defaultPolicies['/policy/connect'] = function(request){\n    var policyActions = ['connect'];\n    var whiteListedOrigins = [\n        \"http://localhost:13000\",\n        \"http://localhost:14000\",\n        \"http://localhost:14001\",\n        \"http://localhost:14002\",\n        \"http://localhost:15000\",\n        \"http://localhost:15001\",\n        \"http://localhost:15002\",\n        \"http://localhost:15003\",\n        \"http://localhost:15004\",\n        \"http://localhost:15005\",\n        \"http://localhost:15006\",\n        \"http://localhost:15007\",\n        \"http://ozone-development.github.io\"\n    ];\n\n    if(!ozpIwc.util.arrayContainsAll(policyActions,request.action['ozp:iwc:action'])){\n        return \"NotApplicable\";\n    } else if(!ozpIwc.util.arrayContainsAll(whiteListedOrigins,request.subject['ozp:iwc:origin'])){\n        return \"Deny\";\n    } else {\n        return \"Permit\";\n    }\n};\n\n/**\n *\n * @param request\n * @param {Object} request.subject\n * @param {Object} request.resource\n * @returns {string}\n */\nozpIwc.policyAuth.defaultPolicies['/policy/sendAs'] = function(request){\n    return ozpIwc.abacPolicies.defaultPolicy(request,'sendAs');\n};\n\nozpIwc.policyAuth.defaultPolicies['/policy/receiveAs'] = function(request){\n    return ozpIwc.abacPolicies.defaultPolicy(request,'receiveAs');\n};\n\nozpIwc.policyAuth.defaultPolicies['/policy/read'] = function(request){\n    return ozpIwc.abacPolicies.defaultPolicy(request,'read');\n};\nozpIwc.policyAuth.defaultPolicies['/policy/apiNode'] = function(request){\n    return ozpIwc.abacPolicies.defaultPolicy(request,'access');\n};\n","/** @namespace **/\r\nvar ozpIwc = ozpIwc || {};\r\n\r\n\r\n/**\r\n * Classes related to security aspects of the IWC.\r\n * @module bus\r\n * @submodule bus.network\r\n */\r\n\r\n/**\r\n * <p>This link connects peers using the HTML5 localstorage API.  It is a second generation version of\r\n * the localStorageLink that bypasses most of the garbage collection issues.\r\n *\r\n * <p> When a packet is sent, this link turns it to a string, creates a key with that value, and\r\n * immediately deletes it.  This still sends the storage event containing the packet as the key.\r\n * This completely eliminates the need to garbage collect the localstorage space, with the associated\r\n * mutex contention and full-buffer issues.\r\n *\r\n * @todo Compress the key\r\n *\r\n * @class KeyBroadcastLocalStorageLink\r\n * @namespace ozpIwc\r\n * @constructor\r\n *\r\n * @param {Object} [config] Configuration for this link\r\n * @param {ozpIwc.Peer} [config.peer=ozpIwc.defaultPeer] The peer to connect to.\r\n * @param {String} [config.prefix='ozpIwc'] Namespace for communicating, must be the same for all peers on the same network.\r\n * @param {String} [config.selfId] Unique name within the peer network.  Defaults to the peer id.\r\n * @param {Number} [config.maxRetries] Number of times packet transmission will retry if failed. Defaults to 6.\r\n * @param {Number} [config.queueSize] Number of packets allowed to be queued at one time. Defaults to 1024.\r\n * @param {Number} [config.fragmentSize] Size in bytes of which any TransportPacket exceeds will be sent in FragmentPackets.\r\n * @param {Number} [config.fragmentTime] Time in milliseconds after a fragment is received and additional expected\r\n * fragments are not received that the message is dropped.\r\n */\r\nozpIwc.KeyBroadcastLocalStorageLink = function (config) {\r\n    config = config || {};\r\n\r\n    /**\r\n     * Namespace for communicating, must be the same for all peers on the same network.\r\n     * @property prefix\r\n     * @type String\r\n     * @default \"ozpIwc\"\r\n     */\r\n    this.prefix = config.prefix || 'ozpIwc';\r\n\r\n    /**\r\n     * The peer this link will connect to.\r\n     * @property peer\r\n     * @type ozpIwc.Peer\r\n     * @default ozpIwc.defaultPeer\r\n     */\r\n    this.peer = config.peer || ozpIwc.defaultPeer;\r\n\r\n    /**\r\n     * Unique name within the peer network.  Defaults to the peer id.\r\n     * @property selfId\r\n     * @type String\r\n     * @default ozpIwc.defaultPeer.selfId\r\n     */\r\n    this.selfId = config.selfId || this.peer.selfId;\r\n\r\n    this.metricsPrefix=\"keyBroadcastLocalStorageLink.\"+this.selfId;\r\n    \r\n    /**\r\n     * Milliseconds to wait before deleting this link's keys\r\n     * @todo UNUSUED\r\n     * @property myKeysTimeout\r\n     * @type Number\r\n     * @default 5000\r\n     */\r\n    this.myKeysTimeout = config.myKeysTimeout || 5000; // 5 seconds\r\n\r\n    /**\r\n     * Milliseconds to wait before deleting other link's keys\r\n     * @todo UNUSUED\r\n     * @property otherKeysTimeout\r\n     * @type Number\r\n     * @default 120000\r\n     */\r\n    this.otherKeysTimeout = config.otherKeysTimeout || 2 * 60000; // 2 minutes\r\n\r\n\r\n    /**\r\n     * The maximum number of retries the link will take to send a package. A timeout of\r\n     * max(1, 2^( <retry count> -1) - 1) milliseconds occurs between send attempts.\r\n     * @property maxRetries\r\n     * @type Number\r\n     * @default 6\r\n     */\r\n    this.maxRetries = config.maxRetries || 6;\r\n\r\n    /**\r\n     * Maximum number of packets that can be in the send queue at any given time.\r\n     * @property queueSize\r\n     * @type Number\r\n     * @default 1024\r\n     */\r\n    this.queueSize = config.queueSize || 1024;\r\n\r\n    /**\r\n     * A queue for outgoing packets. If this queue is full further packets will not be added.\r\n     * @property sendQueue\r\n     * @type Array[]\r\n     * @default []\r\n     */\r\n    this.sendQueue = this.sendQueue || [];\r\n\r\n    /**\r\n     * An array of temporarily held received packet fragments indexed by their message key.\r\n     * @type Array[]\r\n     * @default []\r\n     */\r\n    this.fragments = this.fragments || [];\r\n\r\n    /**\r\n     * Minimum size in bytes that a packet will broken into fragments.\r\n     * @property fragmentSize\r\n     * @type Number\r\n     * @default 1310720\r\n     */\r\n    this.fragmentSize = config.fragmentSize || (5 * 1024 * 1024) / 2 / 2; //50% of 5mb, divide by 2 for utf-16 characters\r\n\r\n    /**\r\n     * The amount of time allotted to the Link to wait between expected fragment packets. If an expected fragment\r\n     * is not received within this timeout the packet is dropped.\r\n     * @property fragmentTimeout\r\n     * @type Number\r\n     * @default 1000\r\n     */\r\n    this.fragmentTimeout = config.fragmentTimeout || 1000; // 1 second\r\n\r\n    //Add fragmenting capabilities\r\n    String.prototype.chunk = function (size) {\r\n        var res = [];\r\n        for (var i = 0; i < this.length; i += size) {\r\n            res.push(this.slice(i, i + size));\r\n        }\r\n        return res;\r\n    };\r\n\r\n    // Hook into the system\r\n    var self = this;\r\n    var packet;\r\n    var receiveStorageEvent = function (event) {\r\n        if(event.newValue) {\r\n            try {\r\n                packet = JSON.parse(event.newValue);\r\n            } catch (e) {\r\n                ozpIwc.log.log(\"Parse error on \" + event.newValue);\r\n                ozpIwc.metrics.counter(self.metricsPrefix,'packets_parseError').inc();\r\n                return;\r\n            }\r\n            if (packet.data.fragment) {\r\n                self.handleFragment(packet);\r\n            } else {\r\n                self.forwardToPeer(packet);\r\n            }\r\n        }\r\n    };\r\n    window.addEventListener('storage', receiveStorageEvent, false);\r\n\r\n    this.peer.on(\"send\", function (event) {\r\n        self.send(event.packet);\r\n    });\r\n\r\n    this.peer.on(\"beforeShutdown\", function () {\r\n        window.removeEventListener('storage', receiveStorageEvent);\r\n    }, this);\r\n\r\n};\r\n\r\nozpIwc.KeyBroadcastLocalStorageLink.prototype.forwardToPeer=function(packet) {\r\n    this.peer.receive(this.linkId, packet);\r\n    ozpIwc.metrics.counter(this.metricsPrefix,'packets_received').inc();\r\n    if(packet.data.time) {\r\n        ozpIwc.metrics.timer(this.metricsPrefix,'latencyIn').mark(ozpIwc.util.now() - packet.data.time);\r\n    }\r\n};\r\n\r\n/**\r\n * Handles fragmented packets received from the router. When all fragments of a message have been received,\r\n * the resulting packet will be passed on to the\r\n * {{#crossLink \"ozpIwc.KeyBroadcastLocalStorageLink/peer:property\"}}registered peer{{/crossLink}}.\r\n *\r\n * @method handleFragment\r\n * @param {ozpIwc.NetworkPacket} packet NetworkPacket containing an ozpIwc.FragmentPacket as its data property\r\n */\r\nozpIwc.KeyBroadcastLocalStorageLink.prototype.handleFragment = function (packet) {\r\n    // Check to make sure the packet is a fragment and we haven't seen it\r\n    if (this.peer.haveSeen(packet)) {\r\n        return;\r\n    }\r\n\r\n    var key = packet.data.msgId;\r\n\r\n    this.storeFragment(packet);\r\n\r\n    var defragmentedPacket = this.defragmentPacket(this.fragments[key]);\r\n\r\n    if (defragmentedPacket) {\r\n\r\n        // clear the fragment timeout\r\n        window.clearTimeout(this.fragments[key].fragmentTimer);\r\n\r\n        // Remove the last sequence from the known packets to reuse it for the defragmented packet\r\n        var packetIndex = this.peer.packetsSeen[defragmentedPacket.srcPeer].indexOf(defragmentedPacket.sequence);\r\n        delete this.peer.packetsSeen[defragmentedPacket.srcPeer][packetIndex];\r\n\r\n        this.forwardToPeer(defragmentedPacket);\r\n\r\n        delete this.fragments[key];\r\n    }\r\n};\r\n\r\n/**\r\n *  Stores a received fragment. When the first fragment of a message is received, a timer is set to destroy the storage\r\n *  of the message fragments should not all messages be received.\r\n *\r\n * @method storeFragment\r\n * @param {ozpIwc.NetworkPacket} packet NetworkPacket containing an {{#crossLink \"ozpIwc.FragmentPacket\"}}{{/crossLink}} as its data property\r\n *\r\n * @returns {Boolean} result true if successful.\r\n */\r\nozpIwc.KeyBroadcastLocalStorageLink.prototype.storeFragment = function (packet) {\r\n    if (!packet.data.fragment) {\r\n        return null;\r\n    }\r\n\r\n    // NetworkPacket properties\r\n    var sequence = packet.sequence;\r\n    var srcPeer = packet.srcPeer;\r\n    // FragmentPacket Properties\r\n    var key = packet.data.msgId;\r\n    var id = packet.data.id;\r\n    var chunk = packet.data.chunk;\r\n    var total = packet.data.total;\r\n\r\n    if (key === undefined || id === undefined) {\r\n        return null;\r\n    }\r\n\r\n    // If this is the first fragment of a message, add the storage object\r\n    if (!this.fragments[key]) {\r\n        this.fragments[key] = {};\r\n        this.fragments[key].chunks = [];\r\n\r\n        var self = this;\r\n        self.key = key;\r\n        self.total = total ;\r\n\r\n        // Add a timeout to destroy the fragment should the whole message not be received.\r\n        this.fragments[key].timeoutFunc = function () {\r\n            ozpIwc.metrics.meter(self.metricsPrefix,'fragments_dropped').mark(self.total);\r\n            delete self.fragments[self.key];\r\n        };\r\n    }\r\n\r\n    // Restart the fragment drop countdown\r\n    window.clearTimeout(this.fragments[key].fragmentTimer);\r\n    this.fragments[key].fragmentTimer = window.setTimeout(this.fragments[key].timeoutFunc, this.fragmentTimeout);\r\n\r\n    // keep a copy of properties needed for defragmenting, the last sequence & srcPeer received will be\r\n    // reused in the defragmented packet\r\n    this.fragments[key].total = total || this.fragments[key].total ;\r\n    this.fragments[key].sequence = (sequence !== undefined) ? sequence : this.fragments[key].sequence;\r\n    this.fragments[key].srcPeer = srcPeer || this.fragments[key].srcPeer;\r\n    this.fragments[key].chunks[id] = chunk;\r\n\r\n    // If the necessary properties for defragmenting aren't set the storage fails\r\n    if (this.fragments[key].total === undefined || this.fragments[key].sequence === undefined ||\r\n        this.fragments[key].srcPeer === undefined) {\r\n        return null;\r\n    } else {\r\n        ozpIwc.metrics.meter(this.metricsPrefix,'fragments_received').mark();\r\n        return true;\r\n    }\r\n};\r\n\r\n/**\r\n * Rebuilds the original packet sent across the keyBroadcastLocalStorageLink from the fragments it was broken up into.\r\n *\r\n * @method defragmentPacket\r\n * @param {ozpIwc.FragmentStore} fragments the grouping of fragments to reconstruct\r\n *\r\n * @returns {ozpIwc.NetworkPacket} result the reconstructed NetworkPacket with TransportPacket as its data property.\r\n */\r\nozpIwc.KeyBroadcastLocalStorageLink.prototype.defragmentPacket = function (fragments) {\r\n    if (fragments.total !== fragments.chunks.length) {\r\n        return null;\r\n    }\r\n    try {\r\n        var result = JSON.parse(fragments.chunks.join(''));\r\n        return {\r\n            defragmented: true,\r\n            sequence: fragments.sequence,\r\n            srcPeer: fragments.srcPeer,\r\n            data: result\r\n        };\r\n    } catch (e) {\r\n        return null;\r\n    }\r\n};\r\n\r\n/**\r\n * Publishes a packet to other peers. If the sendQueue is full the send will not occur. If the TransportPacket is larger\r\n * than the {{#crossLink \"ozpIwc.KeyBroadcastLocalStorageLink/fragmentSize:property\"}}{{/crossLink}}, an\r\n * {{#crossLink \"ozpIwc.FragmentPacket\"}}{{/crossLink}} will be sent instead.\r\n *\r\n * @method send\r\n * @param {ozpIwc.NetworkPacket} packet\r\n */\r\nozpIwc.KeyBroadcastLocalStorageLink.prototype.send = function (packet) {\r\n    var str;\r\n    try {\r\n       str = JSON.stringify(packet.data);\r\n    } catch (e){\r\n        ozpIwc.metrics.meter(this.metricsPrefix,'packets_failed').mark();\r\n        var msgId = packet.msgId || \"unknown\";\r\n        ozpIwc.log.error(\"Failed to write packet(msgId=\" + msgId+ \"):\" + e.message);\r\n        return;\r\n    }\r\n\r\n    if (str.length < this.fragmentSize) {\r\n        this.queueSend(packet);\r\n    } else {\r\n        var fragments = str.chunk(this.fragmentSize);\r\n\r\n        // Use the original packet as a template, delete the data and\r\n        // generate new packets.\r\n        var self = this;\r\n        self.data= packet.data;\r\n        delete packet.data;\r\n\r\n        var fragmentGen = function (chunk, template) {\r\n\r\n            template.sequence = self.peer.sequenceCounter++;\r\n            template.data = {\r\n                fragment: true,\r\n                msgId: self.data.msgId,\r\n                id: i,\r\n                total: fragments.length,\r\n                chunk: chunk\r\n            };\r\n            return template;\r\n        };\r\n\r\n        // Generate & queue the fragments\r\n        for (var i = 0; i < fragments.length; i++) {\r\n            this.queueSend(fragmentGen(fragments[i], packet));\r\n        }\r\n    }\r\n};\r\n\r\n/**\r\n * Places a packet in the {{#crossLink \"ozpIwc.KeyBroadcastLocalStorageLink/sendQueue:property\"}}{{/crossLink}}\r\n * if it does not already hold {{#crossLink \"ozpIwc.KeyBroadcastLocalStorageLink/queueSize:property\"}}{{/crossLink}}\r\n * amount of packets.\r\n *\r\n * @method queueSend\r\n * @param packet\r\n */\r\nozpIwc.KeyBroadcastLocalStorageLink.prototype.queueSend = function (packet) {\r\n    if (this.sendQueue.length < this.queueSize) {\r\n        this.sendQueue = this.sendQueue.concat(packet);\r\n        while (this.sendQueue.length > 0) {\r\n            this.attemptSend(this.sendQueue.shift());\r\n        }\r\n    } else {\r\n        ozpIwc.metrics.meter(this.metricsPrefix,'packets_failed').mark();\r\n        ozpIwc.log.error(\"Failed to write packet(len=\" + packet.length + \"):\" + \" Send queue full.\");\r\n    }\r\n};\r\n\r\n/**\r\n * Recursively tries sending the packet\r\n * {{#crossLink \"ozpIwc.KeyBroadcastLocalStorageLink/maxRetries:property\"}}{{/crossLink}} times.\r\n * The packet is dropped and the send fails after reaching max attempts.\r\n *\r\n * @method attemptSend\r\n * @param {ozpIwc.NetworkPacket} packet\r\n * @param {Number} [attemptCount] number of times attempted to send packet.\r\n */\r\nozpIwc.KeyBroadcastLocalStorageLink.prototype.attemptSend = function (packet, retryCount) {\r\n\r\n    var sendStatus = this.sendImpl(packet);\r\n    if (sendStatus) {\r\n        var self = this;\r\n        retryCount = retryCount || 0;\r\n        var timeOut = Math.max(1, Math.pow(2, (retryCount - 1))) - 1;\r\n\r\n        if (retryCount < self.maxRetries) {\r\n            retryCount++;\r\n            // Call again but back off for an exponential amount of time.\r\n            window.setTimeout(function () {\r\n                self.attemptSend(packet, retryCount);\r\n            }, timeOut);\r\n        } else {\r\n            ozpIwc.metrics.meter(this.metricsPrefix,'packets_failed').mark();\r\n            ozpIwc.log.error(\"Failed to write packet(len=\" + packet.length + \"):\" + sendStatus);\r\n            return sendStatus;\r\n        }\r\n    }\r\n};\r\n\r\n/**\r\n * Implementation of publishing packets to peers through localStorage. If the localStorage is full or a write collision\r\n * occurs, the send will not occur. Returns status of localStorage write, null if success.\r\n *\r\n * @todo move counter.inc() out of the impl and handle in attemptSend?\r\n * @method sendImpl\r\n * @param {ozpIwc.NetworkPacket} packet\r\n */\r\nozpIwc.KeyBroadcastLocalStorageLink.prototype.sendImpl = function (packet) {\r\n    var sendStatus;\r\n    try {\r\n        var p = JSON.stringify(packet);\r\n        localStorage.setItem(\"x\", p);\r\n        ozpIwc.metrics.meter(this.metricsPrefix,'packets_sent').mark();\r\n        if(packet.data.time) {\r\n            ozpIwc.metrics.timer(this.metricsPrefix,'latencyOut').mark(ozpIwc.util.now() - packet.data.time);\r\n        }\r\n        localStorage.removeItem(\"x\");\r\n        sendStatus = null;\r\n    }\r\n    catch (e) {\r\n        if(e.message === \"localStorage is null\"){\r\n            // Firefox about:config dom.storage.enabled = false : no mitigation with current links\r\n            ozpIwc.util.alert(\"Cannot locate localStorage. Contact your system administrator.\", e);\r\n        } else if(e.code === 18){\r\n            // cookies disabled : no mitigation with current links\r\n            ozpIwc.util.alert(\"Ozone requires your browser to accept cookies. Contact your system administrator.\", e);\r\n        } else {\r\n            // If the error can't be mitigated, bubble it up\r\n            sendStatus = e;\r\n        }\r\n    }\r\n    finally {\r\n        return sendStatus;\r\n    }\r\n};\r\n","/** @namespace **/\r\nvar ozpIwc = ozpIwc || {};\r\n/**\r\n * @submodule bus.network\r\n */\r\n\r\n/**\r\n * <p>This link connects peers using the HTML5 localstorage API.  It handles cleaning up\r\n * the buffer, depduplication of sends, and other trivia.\r\n * \r\n * <p>Individual local storage operations are atomic, but there are no consistency\r\n * gaurantees between multiple calls.  This means a read, modify, write operation may\r\n * create race conditions.  The LocalStorageLink addresses the concurrency problem without\r\n * locks by only allowing creation, read, and delete operations.\r\n * \r\n * <p>Each packet is written to it's own key/value pair in local storage.  The key is the\r\n * of the form \"${prefix}|${selfId}|${timestamp}\".  Each LocalStorageLink owns the lifecycle\r\n * of packets it creates.\r\n * \r\n * For senders:\r\n * <ol>\r\n *   <li> Write a new packet.\r\n *   <li> Wait config.myKeysTimeout milliseconds.\r\n *   <li> Delete own packets where the timestamp is expired.\r\n * </ol>\r\n * \r\n * For receivers:\r\n * <ol>\r\n *   <li> Receive a \"storage\" event containing the new key.\r\n *   <li> Reads the packets from local storage.\r\n * </ol>\r\n * \r\n * <p>The potential race condition is if the packet is deleted before the receiver\r\n * can read it.  In this case, the packet is simply considered lost, but no inconsistent\r\n * data will be read.\r\n * \r\n * <p>Links are responsible for their own packets, but each will clean up other link's packets\r\n * on a much larger expiration window (config.otherKeysTimeout).  Race conditions between\r\n * multiple links interleaving the lockless \"list keys\" and \"delete item\" sequence generates\r\n * a consistent postcondition-- the key will not exist.\r\n * \r\n * @class LocalStorageLink\r\n * @namespace ozpIwc\r\n * @param {Object} [config] - Configuration for this link\r\n * @param {ozpIwc.Peer} [config.peer=ozpIwc.defaultPeer] - The peer to connect to.\r\n * @param {Number} [config.myKeysTimeout=5000] - Milliseconds to wait before deleting this link's keys.\r\n * @param {Number} [config.otherKeysTimeout=120000] - Milliseconds to wait before cleaning up other link's keys\r\n * @param {String} [config.prefix='ozpIwc'] - Namespace for communicating, must be the same for all peers on the same network.\r\n * @param {String} [config.selfId] - Unique name within the peer network.  Defaults to the peer id.\r\n */\r\nozpIwc.LocalStorageLink = function(config) {\r\n\tconfig=config || {};\r\n\r\n\r\n    /**\r\n     * Namespace for communicating, must be the same for all peers on the same network.\r\n     * @property prefix\r\n     * @type String\r\n     * @default \"ozpIwc\"\r\n     */\r\n\tthis.prefix=config.prefix || 'ozpIwc';\r\n\r\n    /**\r\n     * The peer this link will connect to.\r\n     * @property peer\r\n     * @type ozpIwc.Peer\r\n     * @default ozpIwc.defaultPeer\r\n     */\r\n\tthis.peer=config.peer || ozpIwc.defaultPeer;\r\n\r\n    /**\r\n     * Unique name within the peer network.  Defaults to the peer id.\r\n     * @property selfId\r\n     * @type String\r\n     * @default ozpIwc.defaultPeer.selfId\r\n     */\r\n\tthis.selfId=config.selfId || this.peer.selfId;\r\n\r\n\r\n    /**\r\n     * Milliseconds to wait before deleting this link's keys\r\n     * @property myKeysTimeout\r\n     * @type Number\r\n     * @default 5000\r\n     */\r\n\tthis.myKeysTimeout = config.myKeysTimeout || 5000; // 5 seconds\r\n\r\n    /**\r\n     * Milliseconds to wait before deleting other link's keys\r\n     * @todo UNUSUED\r\n     * @property otherKeysTimeout\r\n     * @type Number\r\n     * @default 120000\r\n     */\r\n\tthis.otherKeysTimeout = config.otherKeysTimeout || 2*60000; // 2 minutes\r\n\r\n  // Hook into the system\r\n\tvar self=this;\r\n\t\r\n\tvar receiveStorageEvent=function(event) {\r\n\t\tvar key=self.splitKey(event.key);\r\n\t\tif(key) {\r\n\t\t\tvar packet=JSON.parse(localStorage.getItem(event.key));\r\n\r\n\t\t\tif(!packet) {\r\n\t\t\t\tozpIwc.metrics.counter('links.localStorage.packets.vanished').inc();\r\n\t\t\t} else if(typeof(packet) !== \"object\") {\r\n\t\t\t\tozpIwc.metrics.counter('links.localStorage.packets.notAnObject').inc();\r\n\t\t\t} else {\r\n\t\t\t\tozpIwc.metrics.counter('links.localStorage.packets.receive').inc();\r\n\t\t\t\tself.peer.receive(self.linkId,packet);\r\n\t\t\t} \r\n\t\t}\r\n\t};\r\n\twindow.addEventListener('storage',receiveStorageEvent , false); \r\n\t\r\n\tthis.peer.on(\"send\",function(event) { \r\n\t\tself.send(event.packet); \r\n\t});\r\n\t\r\n\tthis.peer.on(\"beforeShutdown\",function() {\r\n\t\tself.cleanKeys();\r\n\t\twindow.removeEventListener('storage',receiveStorageEvent);\r\n\t},this);\r\n\t\r\n\twindow.setInterval(function() {\r\n\t\tself.cleanKeys();\r\n\t},250); \r\n\r\n\r\n\t// METRICS\r\n\tozpIwc.metrics.gauge('links.localStorage.buffer').set(function() {\r\n\t\tvar\tstats= {\r\n\t\t\t\t\tused: 0,\r\n\t\t\t\t\tmax: 5 *1024 * 1024,\r\n\t\t\t\t\tbufferLen: 0,\r\n\t\t\t\t\tpeerUsage: {},\r\n\t\t\t\t\tpeerPackets: {}\r\n\t\t\t\t\t\r\n\t\t};\r\n\t\tfor(var i=0; i < localStorage.length;++i) {\r\n\t\t\tvar k=localStorage.key(i);\r\n\t\t\tvar v=localStorage.getItem(k);\r\n\t\t\t\r\n\t\t\tvar size=v.length*2;\r\n\t\t\tvar oldKeyTime = ozpIwc.util.now() - this.myKeysTimeout;\r\n\r\n\t\t\tstats.used+=size;\r\n\t\t\t\r\n\t\t\tvar key=self.splitKey(k);\r\n\t\t\tif(key) {\r\n\t\t\t\tstats.peerUsage[key.id] = stats.peerUsage[key.id]?(stats.peerUsage[key.id]+size):size;\r\n\t\t\t\tstats.peerPackets[key.id] = stats.peerPackets[key.id]?(stats.peerPackets[key.id]+1):1;\r\n\t\t\t\tstats.bufferLen++;\r\n\t\t\t\tif(key.createdAt < oldKeyTime) {\r\n\t\t\t\t\tstats.oldKeysCount++;\r\n\t\t\t\t\tstats.oldKeysSize+=size;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\t\t\r\n\t\treturn stats;\r\n\t});\r\n};\r\n\r\n/**\r\n * Creates a key for the message in localStorage\r\n * @todo Is timestamp granular enough that no two packets can come in at the same time?\r\n *\r\n * @method makeKey\r\n *\r\n * @returns {string} a new key\r\n */\r\nozpIwc.LocalStorageLink.prototype.makeKey=function(sequence) { \r\n\treturn [this.prefix,this.selfId,ozpIwc.util.now(),sequence].join('|');\r\n};\r\n\r\n/**\r\n * If it's a key for a buffered message, split it into the id of the \r\n * link that put it here and the time it was created at.\r\n *\r\n * @method splitKey\r\n * @param {String} k The key to split\r\n *\r\n * @returns {Object} The id and createdAt for the key if it's valid, otherwise null.\r\n */\r\nozpIwc.LocalStorageLink.prototype.splitKey=function(k) { \r\n\tvar parts=k.split(\"|\");\r\n\tif(parts.length===4 && parts[0]===this.prefix) {\r\n\t\treturn { id: parts[1], createdAt: parseInt(parts[2]) };\r\n\t}\t\r\n\treturn null;\r\n};\r\n\r\n/**\r\n * Goes through localStorage and looks for expired packets.  Packets owned\r\n * by this link are removed if they are older than myKeysTimeout.  Other\r\n * keys are cleaned if they are older than otherKeysTimeout.\r\n * @todo Coordinate expiration windows.\r\n *\r\n * @method cleanKeys\r\n */\r\nozpIwc.LocalStorageLink.prototype.cleanKeys=function() {\r\n\tvar now=ozpIwc.util.now();\r\n\tvar myKeyExpiration = now - this.myKeysTimeout;\r\n\tvar otherKeyExpiration = now - this.otherKeysTimeout;\r\n\r\n\tfor(var i=0; i < localStorage.length;++i) {\r\n\t\tvar keyName=localStorage.key(i);\r\n\t\tvar k=this.splitKey(keyName);\r\n\t\tif(k) {\r\n\t\t\tif((k.id===this.selfId && k.createdAt <= myKeyExpiration) ||\r\n\t\t\t\t\t(k.createdAt <= otherKeyExpiration)) {\r\n\t\t\t\tlocalStorage.removeItem(keyName);\r\n\t\t\t}\t\t\t\t\r\n\t\t}\r\n\t}\r\n\r\n\r\n};\r\n/**\r\n * Publishes a packet to other peers.\r\n * @todo Handle local storage being full.\r\n *\r\n * @method send\r\n * @param {ozpIwc.NetworkPacket} packet\r\n */\r\nozpIwc.LocalStorageLink.prototype.send=function(packet) { \r\n\tlocalStorage.setItem(this.makeKey(packet.sequence),JSON.stringify(packet));\r\n\tozpIwc.metrics.counter('links.localStorage.packets.sent').inc();\r\n};\r\n\r\n","\r\n/**\r\n * The peer handles low-level broadcast communications between multiple browser contexts.\r\n * Links do the actual work of moving the packet to other browser contexts.  The links\r\n * call {{#crossLink \"ozpIwc.Peer/receive:method\"}}{{/crossLink}} when they need to deliver a packet to this peer and\r\n * hook the {{#crossLink \"ozpIwc.Peer/send:method\"}}{{/crossLink}} event in order to send packets.\r\n * @class Peer\r\n * @namespace ozpIwc\r\n * @constructor\r\n * @mixin ozpIwc.Events\r\n */\r\nozpIwc.Peer=function() {\r\n\r\n\r\n    /**\r\n     * A generated random 4 byte id\r\n     * @property selfId\r\n     * @type String\r\n     * @default {{#crossLink \"ozpIwc.util/generateId:method\"}}{{/crossLink}}\r\n     */\r\n    this.selfId=ozpIwc.util.generateId();\r\n\r\n    this.metricPrefix=\"peer.\"+this.selfId;\r\n\r\n    /**\r\n     * @TODO (DOC)\r\n     * @property sequenceCounter\r\n     * @type Number\r\n     * @default 0\r\n     */\r\n    this.sequenceCounter=0;\r\n\r\n    /**\r\n     * A history of packets seen from each peer. Each key is a peer name, each value is an array of the last 50 packet\r\n     * ids seen.\r\n     * @property packetsSeen\r\n     * @type Object\r\n     * @default {}\r\n     */\r\n    this.packetsSeen={};\r\n\r\n    /**\r\n     * @property knownPeers\r\n     * @type Object\r\n     * @default {}\r\n     */\r\n    this.knownPeers={};\r\n\r\n    /**\r\n     * Eventing module for the Peer.\r\n     * @property events\r\n     * @type ozpIwc.Event\r\n     * @default ozpIwc.Event\r\n     */\r\n    this.events=new ozpIwc.Event();\r\n    this.events.mixinOnOff(this);\r\n\r\n    var self=this;\r\n\r\n    // Shutdown handling\r\n    this.unloadListener=function() {\r\n        self.shutdown();\r\n    };\r\n    window.addEventListener('beforeunload',this.unloadListener);\r\n\r\n};\r\n\r\n/**\r\n * The peer has received a packet from other peers.\r\n * @event #receive\r\n *\r\n * @param {ozpIwc.NetworkPacket} packet\r\n * @param {String} linkId\r\n */\r\n\r\n\r\n/**\r\n * A cancelable event that allows listeners to override the forwarding of\r\n * a given packet to other peers.\r\n * @event #preSend\r\n * @extends ozpIwc.CancelableEvent\r\n *\r\n * @param {ozpIwc.NetworkPacket} packet\r\n */\r\n\r\n/**\r\n * Notifies that a packet is being sent to other peers.  Links should use this\r\n * event to forward packets to other peers.\r\n * @event #send\r\n *\r\n * @param {ozpIwc.NetworkPacket} packet\r\n */\r\n\r\n/**\r\n * Fires when the peer is being explicitly or implicitly shut down.\r\n * @event #beforeShutdown\r\n */\r\n\r\n/**\r\n * Number of sequence Id's held in an entry of {{#crossLink \"ozpIwc.Peer/packetsSeen:property\"}}{{/crossLink}}\r\n * @property maxSeqIdPerSource\r\n * @static\r\n * @type Number\r\n * @default 500\r\n */\r\nozpIwc.Peer.maxSeqIdPerSource=500;\r\n\r\n/**\r\n * Determine if the peer has already seen the packet in question.\r\n *\r\n * @method haveSeen\r\n * @param {ozpIwc.NetworkPacket} packet\r\n *\r\n * @returns {Boolean}\r\n */\r\nozpIwc.Peer.prototype.haveSeen=function(packet) {\r\n    // don't forward our own packets\r\n    if (packet.srcPeer === this.selfId) {\r\n        ozpIwc.metrics.counter(this.metricPrefix,'droppedOwnPacket').inc();\r\n        return true;\r\n    }\r\n    var seen = this.packetsSeen[packet.srcPeer];\r\n    if (!seen) {\r\n        seen = this.packetsSeen[packet.srcPeer] = [];\r\n    }\r\n\r\n    // abort if we've seen the packet before\r\n    if (seen.indexOf(packet.sequence) >= 0) {\r\n        return true;\r\n    }\r\n\r\n    //remove oldest array members when truncate needed\r\n    seen.unshift(packet.sequence);\r\n    if (seen.length >= ozpIwc.Peer.maxSeqIdPerSource) {\r\n        seen.length = ozpIwc.Peer.maxSeqIdPerSource;\r\n    }\r\n    return false;\r\n};\r\n\r\n/**\r\n * Used by routers to broadcast a packet to network.\r\n *\r\n * Fires:\r\n *   - {{#crossLink \"ozpIwc.Peer/#preSend:event\"}}{{/crossLink}}\r\n *   - {{#crossLink \"ozpIwc.Peer/#send:event\"}}{{/crossLink}}\r\n *\r\n * @method send\r\n * @param {ozpIwc.NetworkPacket} packet\r\n */\r\nozpIwc.Peer.prototype.send= function(packet) {\r\n    var networkPacket={\r\n        srcPeer: this.selfId,\r\n        sequence: this.sequenceCounter++,\r\n        data: packet\r\n    };\r\n\r\n    var preSendEvent=new ozpIwc.CancelableEvent({'packet': networkPacket});\r\n\r\n    this.events.trigger(\"preSend\",preSendEvent);\r\n    if(!preSendEvent.canceled) {\r\n        ozpIwc.metrics.counter(this.metricPrefix,'sent').inc();\r\n        if(packet.time) {\r\n            ozpIwc.metrics.timer(this.metricPrefix,'latencyOut').mark(ozpIwc.util.now() - packet.time);\r\n        }\r\n        this.events.trigger(\"send\",{'packet':networkPacket});\r\n    } else {\r\n        ozpIwc.metrics.counter(this.metricPrefix,'sendRejected').inc();\r\n    }\r\n};\r\n\r\n/**\r\n * Called by the links when a new packet is received.\r\n *\r\n * Fires:\r\n *   - {{#crossLink \"ozpIwc.Peer/#receive:event\"}}{{/crossLink}}\r\n *\r\n * @method receive\r\n * @param {String} linkId\r\n * @param {ozpIwc.NetworkPacket} packet\r\n */\r\nozpIwc.Peer.prototype.receive=function(linkId,packet) {\r\n    // drop it if we've seen it before\r\n    if(this.haveSeen(packet)) {\r\n        ozpIwc.metrics.counter(this.metricPrefix,'dropped').inc();\r\n        return;\r\n    }\r\n    ozpIwc.metrics.counter(this.metricPrefix,'received').inc();\r\n    if(packet.data.time) {\r\n        ozpIwc.metrics.timer(this.metricPrefix,'latencyIn').mark(ozpIwc.util.now() - packet.data.time);\r\n    }\r\n\r\n    this.events.trigger(\"receive\",{'packet':packet,'linkId': linkId});\r\n};\r\n\r\n/**\r\n * Explicitly shuts down the peer.\r\n *\r\n * Fires:\r\n *   - {{#crossLink \"ozpIwc.Peer/#receive:event\"}}{{/crossLink}}\r\n *\r\n * @method shutdown\r\n */\r\nozpIwc.Peer.prototype.shutdown=function() {\r\n    this.events.trigger(\"beforeShutdown\");\r\n    window.removeEventListener('beforeunload',this.unloadListener);\r\n};\r\n\r\n\r\n/**\r\n * Various packet definitions for the network aspects of the IWC. These are not instantiable, rather guidelines for\r\n * conforming to classes that use them.\r\n * @module bus.network\r\n * @submodule bus.network.packets\r\n */\r\n\r\n/**\r\n * Network Packets\r\n * @class NetworkPacket\r\n * @namespace ozpIwc\r\n */\r\n\r\n/**\r\n * The id of the peer who broadcast this packet.\r\n * @property srcPeer\r\n * @type String\r\n */\r\n\r\n/**\r\n * A monotonically increasing, unique identifier for this packet.\r\n * @property sequence\r\n * @type String\r\n */\r\n\r\n/**\r\n * The payload of this packet.\r\n * @property data\r\n * @type Object\r\n */\r\n\r\n\r\n/**\r\n * Packet format for the data property of ozpIwc.NetworkPacket when working with fragmented packets.\r\n * @class FragmentPacket\r\n * @namespace ozpIwc\r\n */\r\n\r\n/**\r\n * Flag for knowing this is a fragment packet. Should be true.\r\n * @property fragment\r\n * @type boolean\r\n */\r\n\r\n/**\r\n * The msgId from the TransportPacket broken up into fragments.\r\n * @property msgId\r\n * @type Number\r\n */\r\n\r\n/**\r\n * The position amongst other fragments of the TransportPacket.\r\n * @property id\r\n * @type Number\r\n */\r\n\r\n/**\r\n * Total number of fragments of the TransportPacket expected.\r\n * @property total\r\n * @type Number\r\n */\r\n\r\n/**\r\n * A segment of the TransportPacket in string form.\r\n * @property chunk\r\n * @type String\r\n */\r\n\r\n/**\r\n * Storage for Fragment Packets\r\n * @class ozpIwc.FragmentStore\r\n */\r\n\r\n/**\r\n *  The sequence of the latest fragment received.\r\n * @property sequence\r\n * @type Number\r\n */\r\n\r\n/**\r\n * The total number of fragments expected.\r\n * @property total\r\n * @type Number\r\n */\r\n\r\n/**\r\n * The srcPeer of the fragments expected.\r\n * @property srcPeer\r\n * @type String\r\n */\r\n\r\n/**\r\n * String segments of the TransportPacket.\r\n * @property chunks\r\n * @type Array[String]\r\n */\r\n","var ozpIwc=ozpIwc || {};\n\n/**\n * @submodule bus.transport\n */\n\n/**\n * @class Participant\n * @namespace ozpIwc\n * @constructor\n * @mixes ozpIwc.security.Actor\n * @property {String} address The assigned address to this address.\n * @property {ozpIwc.policyAuth.SecurityAttribute} permissions The security attributes for this participant.\n */\nozpIwc.Participant=function() {\n\n\n    /**\n     * An events module for the participant.\n     * @property events\n     * @type Event\n     */\n    this.events=new ozpIwc.Event();\n\tthis.events.mixinOnOff(this);\n\n    /**\n     * A key value store of the security attributes assigned to the participant.\n     * @property permissions\n     * @type Object\n     * @default {}\n     */\n\tthis.permissions= new ozpIwc.policyAuth.SecurityAttribute();\n\n    /**\n     * The message id assigned to the next packet if a packet msgId is not specified.\n     * @property msgId\n     * @type {Number}\n     */\n    this.msgId=0;\n\n    /**\n     * A Metrics meter for packets sent from the participant.\n     * @property sentPacketsmeter\n     * @type ozpIwc.metricTypes.Meter\n     */\n    this.sentPacketsMeter=new ozpIwc.metricTypes.Meter();\n\n    /**\n     * A Metrics meter for packets received by the participant.\n     * @property receivedPacketMeter\n     * @type ozpIwc.metricTypes.Meter\n     */\n    this.receivedPacketsMeter=new ozpIwc.metricTypes.Meter();\n\n    /**\n     * A Metrics meter for packets sent to the participant that did not pass authorization.\n     * @property forbiddenPacketMeter\n     * @type ozpIwc.metricTypes.Meter\n     */\n    this.forbiddenPacketsMeter=new ozpIwc.metricTypes.Meter();\n    this.latencyInTimer=new ozpIwc.metricTypes.Meter();\n    this.latencyOutTimer=new ozpIwc.metricTypes.Meter();\n\n    /**\n     * The type of the participant.\n     * @property participantType\n     * @type String\n     */\n    this.participantType=this.constructor.name;\n\n    /**\n     * Content type for the Participant's heartbeat status packets.\n     * @property heartBeatContentType\n     * @type String\n     * @default \"application/vnd.ozp-iwc-address-v1+json\"\n     */\n    this.heartBeatContentType=\"application/vnd.ozp-iwc-address-v1+json\";\n\n    /**\n     * The heartbeat status packet of the participant.\n     * @property heartBeatStatus\n     * @type Object\n     */\n    this.heartBeatStatus={\n        name: this.name,\n        type: this.participantType || this.constructor.name\n    };\n\n    this.replyCallbacks = {};\n\n    // Handle leaving Event Channel\n    var self=this;\n    window.addEventListener(\"beforeunload\",function() {\n        // Unload events can't use setTimeout's. Therefore make all sending happen with normal execution\n        self.send = function(originalPacket,callback) {\n            var packet=this.fixPacket(originalPacket);\n            if(callback) {\n                self.replyCallbacks[packet.msgId]=callback;\n            }\n            ozpIwc.Participant.prototype.send.call(self,packet);\n\n            return packet;\n        };\n        self.leaveEventChannel();\n    });\n};\n\n/**\n * Processes packets sent from the router to the participant. If a packet does not pass authorization it is marked\n * forbidden.\n *\n * @method receiveFromRouter\n * @param {ozpIwc.PacketContext} packetContext\n * @returns {Boolean} true if this packet could have additional recipients\n */\nozpIwc.Participant.prototype.receiveFromRouter=function(packetContext) {\n    var self = this;\n\n    var request = {\n        'subject': this.permissions.getAll(),\n        'resource': {'ozp:iwc:receiveAs': packetContext.packet.dst},\n        'action': {'ozp:iwc:action': 'receiveAs'},\n        'policies': ozpIwc.authorization.policySets.receiveAsSet\n    };\n\n    var onError = function(err){\n        self.forbiddenPacketsMeter.mark();\n        /** @todo do we send a \"denied\" message to the destination?  drop?  who knows? */\n        ozpIwc.metrics.counter(\"transport.packets.forbidden\").inc();\n        console.error(\"failure\");\n    };\n\n    ozpIwc.authorization.isPermitted(request,this)\n        .success(function() {\n            ozpIwc.authorization.formatCategory(packetContext.packet.permissions)\n                .success(function(permissions) {\n                    var request = {\n                        'subject': self.permissions.getAll(),\n                        'resource':permissions || {},\n                        'action': {'ozp:iwc:action': 'read'},\n                        'policies': ozpIwc.authorization.policySets.readSet\n                    };\n\n                    ozpIwc.authorization.isPermitted(request, self)\n                        .success(function (resolution) {\n                            self.receivedPacketsMeter.mark();\n                            if(packetContext.packet.time) {\n                                self.latencyInTimer.mark(ozpIwc.util.now() - packetContext.packet.time);\n                            }\n\n                            self.receiveFromRouterImpl(packetContext);\n                        }).failure(onError);\n                }).failure(onError);\n        }).failure(onError);\n};\n\n/**\n * Overridden by inherited Participants.\n *\n * @override\n * @method receiveFromRouterImple\n * @param packetContext\n * @returns {Boolean}\n */\nozpIwc.Participant.prototype.receiveFromRouterImpl = function (packetContext) {\n    // doesn't really do anything other than return a bool and prevent \"unused param\" warnings\n    return !packetContext;\n};\n\n/**\n * Connects the participant to a given router.\n *\n * Fires:\n *     - {{#crossLink \"ozpIwc.Participant/#connectedToRouter:event\"}}{{/crossLink}}\n *\n * @method connectToRouter\n * @param {ozpIwc.Router} router The router to connect to\n * @param {String} address The address to assign to the participant.\n */\nozpIwc.Participant.prototype.connectToRouter=function(router,address) {\n    this.address=address;\n    this.router=router;\n    this.msgId=0;\n    if(this.name) {\n        this.metricRoot=\"participants.\"+ this.name +\".\" + this.address.split(\".\").reverse().join(\".\");\n    } else {\n        this.metricRoot=\"participants.\"+ this.address.split(\".\").reverse().join(\".\");\n    }\n    this.sentPacketsMeter=ozpIwc.metrics.meter(this.metricRoot,\"sentPackets\").unit(\"packets\");\n    this.receivedPacketsMeter=ozpIwc.metrics.meter(this.metricRoot,\"receivedPackets\").unit(\"packets\");\n    this.forbiddenPacketsMeter=ozpIwc.metrics.meter(this.metricRoot,\"forbiddenPackets\").unit(\"packets\");\n    this.latencyInTimer=ozpIwc.metrics.timer(this.metricRoot,\"latencyIn\").unit(\"packets\");\n    this.latencyOutTimer=ozpIwc.metrics.timer(this.metricRoot,\"latencyOut\").unit(\"packets\");\n    \n    this.namesResource=\"/address/\"+this.address;\n    this.heartBeatStatus.address=this.address;\n    this.heartBeatStatus.name=this.name;\n    this.heartBeatStatus.type=this.participantType || this.constructor.name;\n\n    this.events.trigger(\"connectedToRouter\");\n    this.joinEventChannel();\n};\n\n/**\n * Populates fields relevant to this packet if they aren't already set:\n * src, ver, msgId, and time.\n *\n * @method fixPacket\n * @param {ozpIwc.TransportPacket} packet\n *\n * @returns {ozpIwc.TransportPacket}\n */\nozpIwc.Participant.prototype.fixPacket=function(packet) {\n    // clean up the packet a bit on behalf of the sender\n    packet.src=packet.src || this.address;\n    packet.ver = packet.ver || 1;\n\n    // if the packet doesn't have a msgId, generate one\n    packet.msgId = packet.msgId || this.generateMsgId();\n\n    // might as well be helpful and set the time, too\n    packet.time = packet.time || ozpIwc.util.now();\n    return packet;\n};\n\n/**\n * Sends a packet to this participants router.  Calls fixPacket\n * before doing so.\n *\n * @method send\n * @param {ozpIwc.TransportPacket} packet\n *\n * @returns {ozpIwc.TransportPacket}\n */\nozpIwc.Participant.prototype.send=function(packet) {\n    var self = this;\n    var request = {\n        'subject': this.permissions.getAll(),\n        'resource': {'ozp:iwc:sendAs': packet.src},\n        'action': {'ozp:iwc:action': 'sendAs'},\n        'policies': ozpIwc.authorization.policySets.sendAsSet\n    };\n    packet = self.fixPacket(packet);\n    ozpIwc.authorization.isPermitted(request,self)\n        .success(function(resolution) {\n            self.sentPacketsMeter.mark();\n            if(packet.time) {\n                self.latencyOutTimer.mark(ozpIwc.util.now() - packet.time);\n            }\n            self.router.send(packet, self);\n        }).failure(function(e){\n            console.error(\"Participant Failed to send a packet:\",e);\n        });\n    return packet;\n};\n\n/**\n * Creates a message id for a packet by iterating {{#crossLink \"ozpIwc.Participant.msgId\"}}{{/crossLink}}\n *\n * @method generateMsgId\n * @returns {string}\n */\nozpIwc.Participant.prototype.generateMsgId=function() {\n    return \"i:\" + this.msgId++;\n};\n\n/**\n * Sends a heartbeat packet to Participant's router.\n *\n * @method heartbeat\n */\nozpIwc.Participant.prototype.heartbeat=function() {\n    if(this.router) {\n        this.send({\n            'dst': \"names.api\",\n            'resource': this.namesResource,\n            'action' : \"set\",\n            'entity' : this.heartBeatStatus,\n            'contentType' : this.heartBeatContentType\n        });\n    }\n};\n\n/**\n * Adds this participant to the $bus.multicast multicast group.\n *\n * @method joinEventChannel\n * @returns {boolean}\n */\nozpIwc.Participant.prototype.joinEventChannel = function() {\n    if(this.router) {\n        this.router.registerMulticast(this, [\"$bus.multicast\"]);\n        this.send({\n            dst: \"$bus.multicast\",\n            action: \"connect\",\n            entity: {\n                address: this.address,\n                participantType: this.participantType\n            }\n        });\n        return true;\n    } else {\n        return false;\n    }\n};\n\n/**\n * Remove this participant from the $bus.multicast multicast group.\n *\n * @method leaveEventChannel\n */\nozpIwc.Participant.prototype.leaveEventChannel = function() {\n    if(this.router) {\n        this.send({\n            dst: \"$bus.multicast\",\n            action: \"disconnect\",\n            entity: {\n                address: this.address,\n                participantType: this.participantType,\n                namesResource: this.namesResource\n            }\n        });\n        //TODO not implemented\n//        this.router.unregisterMulticast(this, [\"$bus.multicast\"]);\n        return true;\n    } else {\n        return false;\n    }\n\n};","/**\n * Classes related to transport aspects of the IWC.\n * @module bus\n * @submodule bus.transport\n */\n\n/**\n * @class InternalParticipant\n * @namespace ozpIwc\n * @constructor\n * @extends ozpIwc.Participant\n * @param {Object} config\n * @param {String} config.name The name of the participant.\n */\nozpIwc.InternalParticipant=ozpIwc.util.extend(ozpIwc.Participant,function(config) {\n    config=config || {};\n\tozpIwc.Participant.apply(this,arguments);\n    /**\n     * @property replyCallbacks\n     * @type {Object}\n     */\n\tthis.replyCallbacks={};\n\n    /**\n     * The type of the participant.\n     * @property participantType\n     * @type {String}\n     * @default \"internal\"\n     */\n\tthis.participantType=\"internal\";\n\n    /**\n     * The name of the participant.\n     * @property name\n     * @type {String}\n     * @default \"\"\n     */\n\tthis.name=config.name;\n\n    var self = this;\n    this.on(\"connectedToRouter\",function() {\n        self.permissions.pushIfNotExist('ozp:iwc:address', self.address);\n        self.permissions.pushIfNotExist('ozp:iwc:sendAs',self.address);\n        self.permissions.pushIfNotExist('ozp:iwc:receiveAs', self.address);\n\n        ozpIwc.metrics.gauge(self.metricRoot,\"registeredCallbacks\").set(function() {\n            return self.getCallbackCount();\n        });\n    });\n});\n\n/**\n * Gets the count of the registered reply callbacks.\n *\n * @method getCallbackCount\n * @returns {Number} The number of registered callbacks.\n */\nozpIwc.InternalParticipant.prototype.getCallbackCount=function() {\n    if (!this.replyCallbacks || !Object.keys(this.replyCallbacks)) {\n        return 0;\n    }\n    return Object.keys(this.replyCallbacks).length;\n};\n\n/**\n * Handles packets received from the {{#crossLink \"ozpIwc.Router\"}}{{/crossLink}} the participant is registered to.\n *\n * Fires:\n *   - {{#crossLink \"ozpIwc.Participant/#receive:event\"}}{{/crossLink}}\n *\n * @method receiveFromRouterImpl\n * @param {ozpIwc.TransportPacketContext} packetContext\n *\n * @returns {boolean} true if this packet could have additional recipients\n */\nozpIwc.InternalParticipant.prototype.receiveFromRouterImpl=function(packetContext) {\n    this.receivedPacketsMeter.mark();\n\tvar packet=packetContext.packet;\n\tif(packet.replyTo && this.replyCallbacks[packet.replyTo]) {\n        var cancel = false;\n        var done=function() {\n            cancel = true;\n        };\n        this.replyCallbacks[packet.replyTo](packet,done);\n\t\tif (cancel) {\n            this.cancelCallback(packet.replyTo);\n        }\n\t} else if (packet.dst === \"$bus.multicast\"){\n        this.events.trigger(\"receiveEventChannelPacket\",packetContext);\n    } else {\n\t\tthis.events.trigger(\"receive\",packetContext);\n\t}\n};\n\n/**\n * Sends a packet to this participants router. Uses setImmediate to force messages out in queue order.\n *\n * @method send\n * @param originalPacket\n * @param callback\n *\n * @returns {ozpIwc.TransportPacket|*}\n */\nozpIwc.InternalParticipant.prototype.send=function(originalPacket,callback) {\n    var packet=this.fixPacket(originalPacket);\n\tif(callback) {\n\t\tthis.replyCallbacks[packet.msgId]=callback;\n\t}\n    var self=this;\n    var send = ozpIwc.Participant.prototype.send;\n\tozpIwc.util.setImmediate(function() {\n        send.call(self,packet);\n    });\n\n\treturn packet;\n};\n\n/**\n * Cancels the callback corresponding to the given msgId.\n *\n * @method cancelCallback\n * @param {Number} msgId\n *\n * @returns {Boolean} returns true if successful.\n */\nozpIwc.InternalParticipant.prototype.cancelCallback=function(msgId) {\n    var success=false;\n    if (msgId) {\n        delete this.replyCallbacks[msgId];\n        success=true;\n    }\n    return success;\n};\n","var ozpIwc=ozpIwc || {};\r\n\r\n/**\r\n * @submodule bus.transport\r\n */\r\n\r\n/**\r\n * @class ozpIwc.TransportPacket\r\n */\r\n\r\n/**\r\n * The participant address that sent this packet.\r\n * @property src\r\n * @type String\r\n */\r\n\r\n/**\r\n * The intended recipient of this packet.\r\n * @property dst\r\n * @type String\r\n */\r\n\r\n/**\r\n * Protocol Version.  Should be 1.\r\n * @property ver\r\n * @type Number\r\n */\r\n\r\n/**\r\n * A unique id for this packet.\r\n * @property msgId\r\n * @type Number\r\n */\r\n\r\n/**\r\n * The payload of this packet.\r\n * @property entity\r\n * @type Object\r\n */\r\n\r\n/**\r\n * Permissions required to see the payload of this packet.\r\n * @property [permissions]\r\n * @type Object\r\n */\r\n\r\n/**\r\n * The time in milliseconds since epoch that this packet was created.\r\n * @property [time]\r\n * @type Number\r\n */\r\n\r\n/**\r\n * Reference to the msgId that this is in reply to.\r\n * @property [replyTo]\r\n * @type Number\r\n */\r\n\r\n/**\r\n * Action to be performed.\r\n * @property [action]\r\n * @type String\r\n */\r\n\r\n/**\r\n * Resource to perform the action upon.\r\n * @property [resource]\r\n * @type String\r\n */\r\n\r\n/**\r\n * Marker for test packets.\r\n * @property [test]\r\n * @type Boolean\r\n*/\r\n\r\n/**\r\n * @class TransportPacketContext\r\n * @namespace ozpIwc\r\n * @param {Object} config\r\n * @param {ozpIwc.TransportPacket} config.packet\r\n * @param {ozpIwc.Router} config.router\r\n * @param {ozpIwc.Participant} [config.srcParticpant]\r\n * @param {ozpIwc.Participant} [config.dstParticpant]\r\n */\r\nozpIwc.TransportPacketContext=function(config) {\r\n    /**\r\n     * @property packet\r\n     * @type ozpIwc.TransportPacket\r\n     */\r\n\r\n    /**\r\n     * @property router\r\n     * @type ozpIwc.Router\r\n     */\r\n\r\n    /**\r\n     * @property [srcParticipant]\r\n     * @type ozpIwc.Participant\r\n     */\r\n\r\n    /**\r\n     * @property [dstParticipant]\r\n     * @type ozpIwc.Participant\r\n     */\r\n    for(var i in config) {\r\n        this[i]=config[i];\r\n    }\r\n};\r\n\r\n/**\r\n * @method replyTo\r\n * @param {ozpIwc.TransportPacket} response\r\n *\r\n * @returns {ozpIwc.TransportPacket} the packet that was sent\r\n */\r\nozpIwc.TransportPacketContext.prototype.replyTo=function(response) {\r\n    var now=new Date().getTime();\r\n    response.ver = response.ver || 1;\r\n    response.time = response.time || now;\r\n    response.replyTo=response.replyTo || this.packet.msgId;\r\n    response.src=response.src || this.packet.dst;\r\n    response.dst=response.dst || this.packet.src;\r\n    if(this.dstParticipant) {\r\n        this.dstParticipant.send(response);\r\n    } else{\r\n        response.msgId = response.msgId || now;\r\n        this.router.send(response);\r\n    }\r\n    return response;\r\n};\r\n\r\n\r\n/**\r\n * @class Router\r\n * @namespace ozpIwc\r\n * @constructor\r\n * @param {Object} [config]\r\n * @param {ozpIwc.Peer} [config.peer=ozpIwc.defaultPeer]\r\n */\r\n/**\r\n * @event ozpIwc.Router#preRegisterParticipant\r\n * @mixes ozpIwc.CancelableEvent\r\n * @param {ozpIwc.TransportPacket} [packet] - The packet to be delivered\r\n * @param {object} registration - Information provided by the participant about it's registration\r\n * @param {ozpIwc.Participant} participant - The participant that will receive the packet\r\n */\r\n\r\n/**\r\n * @event ozpIwc.Router#preSend\r\n * @mixes ozpIwc.CancelableEvent\r\n * @param {ozpIwc.TransportPacket} packet - The packet to be sent\r\n * @param {ozpIwc.Participant} participant - The participant that sent the packet\r\n */\r\n\r\n/**\r\n * @event ozpIwc.Router#preDeliver\r\n * @mixes ozpIwc.CancelableEvent\r\n * @param {ozpIwc.TransportPacket} packet - The packet to be delivered\r\n * @param {ozpIwc.Participant} participant - The participant that will receive the packet\r\n */\r\n\r\n/**\r\n * @event ozpIwc.Router#send\r\n * @param {ozpIwc.TransportPacket} packet - The packet to be delivered\r\n */\r\n\r\n/**\r\n * @event ozpIwc.Router#prePeerReceive\r\n * @mixes ozpIwc.CancelableEvent\r\n * @param {ozpIwc.TransportPacket} packet\r\n * @param {ozpIwc.NetworkPacket} rawPacket\r\n */\r\n\r\nozpIwc.Router=function(config) {\r\n    config=config || {};\r\n\r\n    /**\r\n     * @property peer\r\n     * @type ozpIwc.Peer\r\n     */\r\n    this.peer=config.peer || ozpIwc.defaultPeer;\r\n\r\n//\tthis.nobodyAddress=\"$nobody\";\r\n//\tthis.routerControlAddress='$transport';\r\n\tvar self=this;\r\n\r\n    /**\r\n     * @property selfId\r\n     * @type String\r\n     */\r\n\tthis.selfId=ozpIwc.util.generateId();\r\n\t\r\n    /**\r\n     * A key value store of all participants local to the router.\r\n     * @property participants\r\n     * @type Object\r\n     * @default {}\r\n     */\r\n\tthis.participants={};\r\n\t\r\n\tozpIwc.metrics.gauge(\"transport.participants\").set(function() {\r\n\t\treturn Object.keys(self.participants).length;\r\n\t});\r\n\r\n\r\n    /**\r\n     * Eventing module for the router.\r\n     * @property events\r\n     * @type ozpIwc.Event\r\n     * @default ozpIwc.Event\r\n     */\r\n\tthis.events=new ozpIwc.Event();\r\n\tthis.events.mixinOnOff(this);\r\n\t\r\n\t// Wire up to the peer\r\n\tthis.peer.on(\"receive\",function(event) {\r\n\t\tself.receiveFromPeer(event.packet);\r\n\t});\r\n\t\r\n\tvar checkFormat=function(event) {\r\n\t\tvar message=event.packet;\r\n\t\tif(message.ver !== 1) {\r\n\t\t\tevent.cancel(\"badVersion\");\r\n\t\t}\r\n\t\tif(!message.src) {\r\n\t\t\tevent.cancel(\"nullSource\");\r\n\t\t}\r\n\t\tif(!message.dst) {\r\n\t\t\tevent.cancel(\"nullDestination\");\r\n\t\t}\r\n\t\tif(event.canceled) {\r\n\t\t\tozpIwc.metrics.counter(\"transport.packets.invalidFormat\").inc();\r\n\t\t}\r\n\t};\r\n\tthis.events.on(\"preSend\",checkFormat);\r\n\r\n    if(!config.disableBus){\r\n        this.participants[\"$bus.multicast\"]=new ozpIwc.MulticastParticipant(\"$bus.multicast\");\r\n    }\r\n    /**\r\n     * @property watchdog\r\n     * @type ozpIwc.RouterWatchdog\r\n     */\r\n\tthis.watchdog=new ozpIwc.RouterWatchdog({\r\n        router: this,\r\n        heartbeatFrequency: config.heartbeatFrequency\r\n    });\r\n\tthis.registerParticipant(this.watchdog);\r\n\r\n    ozpIwc.metrics.gauge('transport.router.participants').set(function() {\r\n        return self.getParticipantCount();\r\n    });\r\n};\r\n\r\n/**\r\n * Gets the count of participants who have registered with the router.\r\n * @method getParticipantCount\r\n *\r\n * @returns {Number} the number of registered participants\r\n */\r\nozpIwc.Router.prototype.getParticipantCount=function() {\r\n    if (!this.participants || !Object.keys(this.participants)) {\r\n        return 0;\r\n    }\r\n    return Object.keys(this.participants).length;\r\n\r\n};\r\n\r\n/**\r\n * @method shutdown\r\n */\r\nozpIwc.Router.prototype.shutdown=function() {\r\n    this.watchdog.shutdown();\r\n};\r\n\r\n/**\r\n * Allows a listener to add a new participant.\r\n *\r\n * Fires:\r\n *     - {{#crossLink \"ozpIwc.Router/#registerParticipant:event\"}}{{/crossLink}}\r\n *\r\n * @method registerParticipant\r\n * @param {Object} participant the participant object that contains a send() function.\r\n * @param {Object} packet The handshake requesting registration.\r\n *\r\n * @returns {String} returns participant id\r\n */\r\nozpIwc.Router.prototype.registerParticipant=function(participant,packet) {\r\n    packet = packet || {};\r\n    var address;\r\n    do {\r\n        address=ozpIwc.util.generateId()+\".\"+this.selfId;\r\n    } while(this.participants.hasOwnProperty(address));\r\n\r\n    var registerEvent=new ozpIwc.CancelableEvent({\r\n        'packet': packet,\r\n        'registration': packet.entity,\r\n        'participant': participant\r\n    });\r\n    this.events.trigger(\"preRegisterParticipant\",registerEvent);\r\n\r\n    if(registerEvent.canceled){\r\n        // someone vetoed this participant\r\n        ozpIwc.log.log(\"registeredParticipant[DENIED] origin:\"+participant.origin+\r\n            \" because \" + registerEvent.cancelReason);\r\n        return null;\r\n    }\r\n\r\n    this.participants[address] = participant;\r\n     participant.connectToRouter(this,address);\r\n    var registeredEvent=new ozpIwc.CancelableEvent({\r\n        'packet': packet,\r\n        'participant': participant\r\n    });\r\n    this.events.trigger(\"registeredParticipant\",registeredEvent);\r\n\r\n//\tozpIwc.log.log(\"registeredParticipant[\"+participant_id+\"] origin:\"+participant.origin);\r\n    return address;\r\n};\r\n\r\n/**\r\n * Fires:\r\n *     - {{#crossLink \"ozpIwc.Router/#preDeliver:event\"}}{{/crossLink}}\r\n *\r\n * @method deliverLocal\r\n * @param {ozpIwc.TransportPacket} packet\r\n * @param {ozpIwc.Participant} sendingParticipant\r\n */\r\nozpIwc.Router.prototype.deliverLocal=function(packet,sendingParticipant) {\r\n    if(!packet) {\r\n        throw \"Cannot deliver a null packet!\";\r\n    }\r\n    var localParticipant=this.participants[packet.dst];\r\n    if(!localParticipant) {\r\n        return;\r\n    }\r\n    var packetContext=new ozpIwc.TransportPacketContext({\r\n        'packet':packet,\r\n        'router': this,\r\n        'srcParticipant': sendingParticipant,\r\n        'dstParticipant': localParticipant\r\n    });\r\n\r\n    var preDeliverEvent=new ozpIwc.CancelableEvent({\r\n        'packet': packet,\r\n        'dstParticipant': localParticipant,\r\n        'srcParticipant': sendingParticipant\r\n    });\r\n\r\n    if(this.events.trigger(\"preDeliver\",preDeliverEvent).canceled) {\r\n        ozpIwc.metrics.counter(\"transport.packets.rejected\").inc();\r\n        return;\r\n    }\r\n    ozpIwc.metrics.counter(\"transport.packets.delivered\").inc();\r\n    localParticipant.receiveFromRouter(packetContext);\r\n};\r\n\r\n\r\n/**\r\n * Registers a participant for a multicast group\r\n *\r\n * Fires:\r\n *     - {{#crossLink \"ozpIwc.Router/#registerMulticast:event\"}}{{/crossLink}}\r\n *\r\n * @method registerMulticast\r\n * @param {ozpIwc.Participant} participant\r\n * @param {String[]} multicastGroups\r\n */\r\nozpIwc.Router.prototype.registerMulticast=function(participant,multicastGroups) {\r\n    var self=this;\r\n    multicastGroups.forEach(function(groupName) {\r\n        var g=self.participants[groupName];\r\n        if(!g) {\r\n            g=self.participants[groupName]=new ozpIwc.MulticastParticipant(groupName);\r\n        }\r\n        g.addMember(participant);\r\n        if (participant.address) {\r\n            var registeredEvent = new ozpIwc.CancelableEvent({\r\n                'entity': {'group': groupName, 'address': participant.address}\r\n            });\r\n            participant.permissions.pushIfNotExist('ozp:iwc:sendAs', groupName);\r\n            participant.permissions.pushIfNotExist('ozp:iwc:receiveAs', groupName);\r\n\r\n            self.events.trigger(\"registeredMulticast\", registeredEvent);\r\n        } else {\r\n            ozpIwc.log.log(\"no address for \" +  participant.participantType + \" \" + participant.name + \"with address \" + participant.address + \" for group \" + groupName);\r\n        }\r\n        //ozpIwc.log.log(\"registered \" + participant.participantType + \" \" + participant.name + \"with address \" + participant.address + \" for group \" + groupName);\r\n    });\r\n    return multicastGroups;\r\n};\r\n\r\n/**\r\n * Used by participant listeners to route a message to other participants.\r\n *\r\n * Fires:\r\n *     -{{#crossLink \"ozpIwc.Router/#preSend:event\"}}{{/crossLink}}\r\n *     -{{#crossLink \"ozpIwc.Router/#send:event\"}}{{/crossLink}}\r\n *\r\n * @method send\r\n * @param {ozpIwc.TransportPacket} packet The packet to route.\r\n * @param {ozpIwc.Participant} sendingParticipant Information about the participant that is attempting to send\r\n * the packet.\r\n */\r\nozpIwc.Router.prototype.send=function(packet,sendingParticipant) {\r\n\r\n    var preSendEvent=new ozpIwc.CancelableEvent({\r\n        'packet': packet,\r\n        'participant': sendingParticipant\r\n    });\r\n    this.events.trigger(\"preSend\",preSendEvent);\r\n\r\n    if(preSendEvent.canceled) {\r\n        ozpIwc.metrics.counter(\"transport.packets.sendCanceled\");\r\n        return;\r\n    }\r\n    ozpIwc.metrics.counter(\"transport.packets.sent\").inc();\r\n    this.deliverLocal(packet,sendingParticipant);\r\n    this.events.trigger(\"send\",{'packet': packet});\r\n    this.peer.send(packet);\r\n};\r\n\r\n/**\r\n * Receive a packet from the peer.\r\n *\r\n * Fires:\r\n *     -{{#crossLink \"ozpIwc.Router/#prePeerReceive:event\"}}{{/crossLink}}\r\n *\r\n * @param packet {ozpIwc.TransportPacket} the packet to receive\r\n */\r\nozpIwc.Router.prototype.receiveFromPeer=function(packet) {\r\n    ozpIwc.metrics.counter(\"transport.packets.receivedFromPeer\").inc();\r\n    var now = Date.now();\r\n    ozpIwc.metrics.histogram(\"transport.packets.latency\").mark(now-packet.data.time,now);\r\n    var peerReceiveEvent=new ozpIwc.CancelableEvent({\r\n        'packet' : packet.data,\r\n        'rawPacket' : packet\r\n    });\r\n    this.events.trigger(\"prePeerReceive\",peerReceiveEvent);\r\n\r\n    if(!peerReceiveEvent.canceled){\r\n        this.deliverLocal(packet.data);\r\n    }\r\n};\r\n\r\n","var ozpIwc=ozpIwc || {};\n\n/**\n * @submodule bus.transport\n */\n\n/**\n * Baseclass for APIs that need leader election.  Uses the Bully algorithm for leader election.\n *\n * Implementer is responsible for handling two events:\n *    <li> <b>\"becameLeaderEvent\"</b> - participant has finished its election process and is to become the leader. Handle\n *    any logic necessary above the LeaderGroupParticipant and then trigger the participant's event <b>\"becameLeader\"</b>\n *    <i>(ex. participant.events.trigger(\"becameLeader\")</i></li>\n *    <li> <b>\"newLeaderEvent\"</b> - participant has finished its election process and is to become a member. Handle any logic necessary above\n *    the LeaderGroupParticipant then trigger the participant's event <b>\"newLeader\"</b>\n *    <i>(ex. participant.events.trigger(\"newLeader\")</i></li>\n *\n * @class LeaderGroupParticipant\n * @namespace ozpIwc\n * @extends ozpIwc.InternalParticipant\n * @constructor\n *\n * @param {Object} config\n * @param {String} config.name\n *        The name of this API.\n * @param {String} [config.electionAddress=config.name+\".election\"]\n *        The multicast channel for running elections.  \n *        The leader will register to receive multicast on this channel.\n * @param {Number} [config.priority=Math.Random]\n *        How strongly this node feels it should be leader.\n * @param {Function} [config.priorityLessThan]\n *        Function that provides a strict total ordering on the priority.  Default is \"<\".\n * @param {Number} [config.electionTimeout=250]\n *        Number of milliseconds to wait before declaring victory on an election. \n * @param {number} [config.electionTimeout=250]\n *        Number of milliseconds to wait before declaring victory on an election.\n * @param {Object} config.states  State machine states the participant will register and react to given their assigned category.\n *        Default states listed are always applied and need not be passed in configuration.\n * @param {Object} [config.states.leader=['leader']]\n *        Any state that the participant should deem itself the leader of its group.\n * @param {Object} [config.states.member=['member']]\n *        Any state that the participant should deem itself a member (not leader) of its group.\n * @param {Object} [config.states.election=['election']]\n *        Any state that the participant should deem itself in an election with its group.\n * @param {Object} [config.states.queueing=['connecting','election']]\n *        Any state that the participant should block non-election messages until not in a queueing state\n */\nozpIwc.LeaderGroupParticipant=ozpIwc.util.extend(ozpIwc.InternalParticipant,function(config) {\n\tozpIwc.InternalParticipant.apply(this,arguments);\n    config.states = config.states || {};\n\n\n\tif(!config.name) {\n\t\tthrow \"Config must contain a name value\";\n\t}\n\n\n\t// Networking info\n    /**\n     * The name of the participant.\n     * @property name\n     * @type String\n     * @default \"\"\n     */\n\tthis.name=config.name;\n\n    /**\n     * The election address for common LeaderGroupParticipant's on the IWC bus.\n     * @property electionAddress\n     * @type String\n     * @default \".election\"\n     */\n\tthis.electionAddress=config.electionAddress || (this.name + \".election\");\n\n\n\t// Election times and how to score them\n    /**\n     * A numeric value to determine who the leader of the group should be.\n     * @property priority\n     * @type Number\n     * @default {{#crossLink \"ozpIwc.util/now:method\"}}-ozpIwc.util.now(){{/crossLink}}\n     */\n\tthis.priority = config.priority || ozpIwc.defaultLeaderPriority || -ozpIwc.util.now();\n\n    /**\n     * Function to determine the lower value amongst two priorities.\n     * @property priorityLessThan\n     * @type Function\n     * @default function( l, r) { return l < r };\n     */\n\tthis.priorityLessThan = config.priorityLessThan || function(l,r) { return l < r; };\n\n\n    /**\n     * How long a participant partakes in an election.\n     * @property electionTimeout\n     * @type Number\n     * @default 250\n     */\n\tthis.electionTimeout=config.electionTimeout || 1000; // quarter second\n\n    /**\n     * The current state of the participant.\n     *\n     * The leaderGroupParticipant has the following states:\n     *   - connecting\n     *   - queueing\n     *   - election\n     *   - leader\n     *   - member\n     *\n     * @property leaderState\n     * @type String\n     * @default \"connecting\"\n     */\n\tthis.leaderState=\"connecting\";\n\n    /**\n     * Packets received from the router that are not pertinent to the election. They will be processed post election\n     * if this participant becomes the leader.\n     * @property electionQueue\n     * @type ozpIwc.NetworkPacket[]\n     * @default []\n     */\n\tthis.electionQueue=[];\n\n    /**\n     * A registry of sub-states of the Election State Machine. While leaderGroupParticipant operates on states \"leader\",\n     * \"member\", \"queueing\", and \"election\", it can fire events for those states should a substate change.\n     * @property states\n     * @type {states|*|Object|{}}\n     */\n    this.states = config.states;\n\n    /**\n     * Leader sub-states of the State Machine.\n     * @property states.leader\n     * @type {String[]}\n     * @default [\"leader\"]\n     */\n    this.states.leader = this.states.leader || [];\n    this.states.leader = this.states.leader.concat([\"leader\"]);\n\n    /**\n     * Member sub-states of the State Machine.\n     * @property states.member\n     * @type {String[]}\n     * @default [\"member\"]\n     */\n    this.states.member = this.states.member || [];\n    this.states.member = this.states.member.concat([\"member\"]);\n\n    /**\n     * Election sub-states of the State Machine.\n     * @property states.election\n     * @type {String[]}\n     * @default [\"election\"]\n     */\n    this.states.election = this.states.election || [];\n    this.states.election = this.states.election.concat([\"election\"]);\n\n    /**\n     * Queueing sub-states of the State Machine.\n     * @property states.queueing\n     * @type {String[]}\n     * @default [\"connecting\", \"election\"]\n     */\n    this.states.queueing = this.states.queueing || [];\n    this.states.queueing = this.states.queueing.concat([\"connecting\", \"election\"]);\n\n    /**\n     * A snapshot of the current active states of the participant.\n     * @propery activeStates\n     * @type {Object}\n     */\n    this.activeStates = config.activeStates || {\n        'leader': false,\n        'member': false,\n        'election': false,\n        'queueing': true\n    };\n\n    this.changeState(\"connecting\");\n\n\n\t// tracking the current leader\n    /**\n     * The address of the current leader.\n     * @property leader\n     * @type String\n     * @default null\n     */\n\tthis.leader=null;\n\n    /**\n     * The priority of the current leader.\n     * @property leaderPriority\n     * @type Number\n     * @default null\n     */\n\tthis.leaderPriority=null;\n\n    /**\n     * The type of the participant.\n     * @property participantType\n     * @type String\n     * @default \"leaderGroup\"\n     */\n\tthis.participantType=\"leaderGroup\";\n\n    /**\n     * The name of the participant.\n     * @property name\n     * @type String\n     * @default \"\"\n     */\n\tthis.name=config.name;\n\n\n    /**\n     * An internal flag used to debounce invalid leadership attempts due to high network traffic.\n     * @property toggleDrop\n     * @type Boolean\n     * @default false\n     */\n    this.toggleDrop = false;\n\n    this.victoryTS = -Number.MAX_VALUE;\n    /**\n     * Fires when the participant enters an election.\n     * @event #startElection\n     */\n\tthis.on(\"startElection\",function() {\n        this.toggleDrop = false;\n\t},this);\n\n    /**\n     * Fires when this participant becomes the leader.\n     * @event #becameLeader\n     *\n     */\n\tthis.on(\"becameLeader\",function() {\n        this.leader = this.address;\n        this.leaderPriority = this.priority;\n\t\tthis.electionQueue.forEach(function(p) {\n\t\t\tthis.forwardToTarget(p);\n\t\t},this);\n\t\tthis.electionQueue=[];\n\t},this);\n\n    /**\n     * Fires when a leader has been assigned and this participant is not it.\n     * @event #newLeader\n     */\n\tthis.on(\"newLeader\",function() {\n\t\tthis.electionQueue=[];\n\t},this);\n\n\n\n    // Handle passing of state on unload\n    var self=this;\n\twindow.addEventListener(\"beforeunload\",function() {\n        //Priority has to be the minimum possible\n        self.priority=-Number.MAX_VALUE;\n\n        if(self.activeStates.leader) {\n            for (var part in self.router.participants) {\n                var participant = self.router.participants[part];\n\n                // Each leaderParticipant should report out what participants are on\n                // the router so that higher level elements can clean up soon to be dead references before passing on state.\n                if (participant.address) {\n                    self.events.trigger(\"receiveEventChannelPacket\", {\n                        packet: self.fixPacket({\n                            dst: \"$bus.multicast\",\n                            action: \"disconnect\",\n                            entity: {\n                                address: participant.address,\n                                participantType: participant.participantType,\n                                namesResource: participant.namesResource\n                            }\n                        })\n                    });\n                }\n            }\n        }\n\n        self.events.trigger(\"unloadState\");\n\t});\n\n\n    // Connect Metrics\n    ozpIwc.metrics.gauge('transport.leaderGroup.election').set(function() {\n        var queue = self.getElectionQueue();\n        return {'queue': queue ? queue.length : 0};\n    });\n\n    /**\n     * Fires when the participant has connected to its router.\n     * @event #connectedToRouter\n     */\n\tthis.on(\"connectedToRouter\",function() {\n        this.router.registerMulticast(this,[this.electionAddress,this.name]);\n        var self = this;\n        ozpIwc.util.setImmediate(function(){\n            self.startElection();\n        });\n\n    },this);\n\n    this.on(\"receive\",this.routePacket,this);\n});\n\n/**\n * Retrieve the election queue. Called by closures which need access to the queue as it grows\n *\n * @method getElectionQueue\n *\n * @returns {Array} the election queue\n */\nozpIwc.LeaderGroupParticipant.prototype.getElectionQueue=function() {\n    return this.electionQueue;\n};\n\n\n/**\n * Checks to see if the leadership group is in an election\n *\n * @method inElection\n *\n * @returns {Boolean} True if in an election state, otherwise false\n */\nozpIwc.LeaderGroupParticipant.prototype.inElection=function() {\n    return !!this.electionTimer || this.activeStates.election;\n};\n\n\n/**\n * Checks to see if this instance is the leader of it's group.\n *\n * @method isLeader\n *\n * @returns {Boolean} True if leader.\n */\nozpIwc.LeaderGroupParticipant.prototype.isLeader=function() {\n    return this.leader === this.address;\n};\n\n\n/**\n * Sends an election message to the leadership group.\n *\n * @method sendElectionMessage\n * @private\n * @param {String} type The type of message -- \"election\" or \"victory\"\n */\nozpIwc.LeaderGroupParticipant.prototype.sendElectionMessage=function(type, config, callback) {\n    config = config || {};\n    var state = config.state || {};\n    var previousLeader = config.previousLeader || this.leader;\n    var opponent = config.opponent || \"\";\n    // TODO: no state should have circular references, this will eventually go away.\n    try {\n        JSON.stringify(state);\n    } catch (ex) {\n        ozpIwc.log.error(this.name,this.address,\"failed to send state.\", ex);\n        state = {};\n    }\n\n    this.send({\n\t\t'src': this.address,\n\t\t'dst': this.electionAddress,\n\t\t'action': type,\n\t\t'entity': {\n\t\t\t'priority': this.priority,\n            'state': state,\n            'previousLeader': previousLeader,\n            'opponent': opponent\n\t\t}\n\t},callback);\n};\n\n\n/**\n * Sends a message to the leadership group stating victory in the current election. LeaderGroupParticipant.priority\n * included to allow rebuttal. Will only send if participant's current state is in one of the following state categories:\n *      <li>leader</li>\n *      <li>election</li>\n * @returns {ozpIwc.TransportPacket} Packet returned if valid request, else false.\n */\nozpIwc.LeaderGroupParticipant.prototype.sendVictoryMessage = function(){\n    if(this.activeStates.leader || this.activeStates.election) {\n        return this.send({\n            'src': this.address,\n            'dst': this.electionAddress,\n            'action': 'victory',\n            'entity': {\n                'priority': this.priority\n            }\n        });\n    } else {\n        return false;\n    }\n};\n\nozpIwc.LeaderGroupParticipant.prototype.leaderQuery=function(config){\n    if(this.inElection()){\n        return;\n    }\n    this.leaderQueryTimer = window.setTimeout(function(){\n        self.cancelElection();\n        self.startElection();\n    },this.electionTimeout);\n\n    var self = this;\n    this.sendElectionMessage(\"leaderQuery\",{},function(response){\n        window.clearTimeout(self.leaderQueryTimer);\n\n        if(response.entity.priority > self.priority) {\n            this.leader = response.src;\n            this.leaderPriority = response.entity.priority;\n            this.victoryTS = response.time;\n            self.events.trigger(\"newLeaderEvent\");\n            this.stateStore = {};\n        }\n    });\n};\n\n/**\n * Attempt to start a new election.\n *\n * Fires:\n *     - {{#crossLink \"ozpiwc.LeaderGroupParticipant/#startElection:event\"}{{/crossLink}}\n *     - {{#crossLink \"ozpiwc.LeaderGroupParticipant/#becameLeader:event\"}{{/crossLink}}\n *\n * @method startElection\n * @param {Object} config\n * @param {Object} config.state\n * @protected\n *\n */\nozpIwc.LeaderGroupParticipant.prototype.startElection=function(config) {\n    config = config || {};\n    var state = config.state || {};\n    var opponent = config.opponent || \"\";\n\t// don't start a new election if we are in one\n\tif(this.inElection()) {\n\t\treturn;\n\t}\n    this.events.trigger(\"startElection\");\n\n\tvar self=this;\n\t// if no one overrules us, declare victory\n\tthis.electionTimer=window.setTimeout(function() {\n\t\tself.cancelElection();\n        self.events.trigger(\"becameLeaderEvent\");\n\t},this.electionTimeout);\n\n\tthis.sendElectionMessage(\"election\", {state: state, previousLeader: this.leader, opponent: opponent});\n};\n\n\n/**\n * Cancels participation in an in-progress election.\n *\n * Fires:\n *     - {{#crossLink \"ozpiwc.LeaderGroupParticipant/#endElection:event\"}{{/crossLink}}\n *\n * @method cancelElection\n *\n * @protected\n */\nozpIwc.LeaderGroupParticipant.prototype.cancelElection=function() {\n\tif(this.electionTimer) {\n        window.clearTimeout(this.electionTimer);\n        this.electionTimer=null;\n        this.events.trigger(\"endElection\");\n\t}\n};\n\n\n/**\n * Receives a packet on the election control group or forwards it to the target implementation of this leadership group.\n *\n * @method routePacket\n * @param {ozpIwc.TransportPacket} packetContext\n */\nozpIwc.LeaderGroupParticipant.prototype.routePacket=function(packetContext) {\n\tvar packet=packetContext.packet;\n\tpacketContext.leaderState=this.leaderState;\n    if(packet.src === this.address) {\n        // drop our own packets that found their way here\n        return;\n    }\n    if(packet.dst === this.electionAddress) {\n        if(packet.src === this.address) {\n\t\t\t// even if we see our own messages, we shouldn't act upon them\n\t\t\treturn;\n\t\t} else if(packet.action === \"leaderQuery\"){\n            this.handleLeaderQueryMessage(packetContext);\n        } else if(packet.action === \"election\") {\n\t\t\tthis.handleElectionMessage(packet);\n\t\t} else if(packet.action === \"victory\") {\n\t\t\tthis.handleVictoryMessage(packet);\n        }\n    } else {\n        this.forwardToTarget(packetContext);\n\t}\t\t\n};\n\n/**\n * Forwards received packets to the target implementation of the participant. If currently in an election, messages\n * are queued.\n *\n * Fires:\n *     - {{#crossLink \"ozpiwc.LeaderGroupParticipant/#receiveApiPacket:event\"}{{/crossLink}}\n *\n * @method forwardToTarget\n *\n * @param {ozpIwc.TransportPacket} packetContext\n */\nozpIwc.LeaderGroupParticipant.prototype.forwardToTarget=function(packetContext) {\n    if(this.activeStates.queueing) {\n\t\tthis.electionQueue.push(packetContext);\n\t\treturn;\n\t}\n\tpacketContext.leaderState=this.leaderState;\n\tthis.events.trigger(\"receiveApiPacket\",packetContext);\n};\n\n\nozpIwc.LeaderGroupParticipant.prototype.handleLeaderQueryMessage=function(electionMessage){\n    if(!this.activeStates.leader){\n        return;\n    }\n    electionMessage.replyTo({\n        action: \"leaderResponse\",\n        entity: {\n            priority: this.priority\n        }\n    });\n};\n\t\n/**\n * Respond to someone else starting an election.\n *\n * @method handleElectionMessage\n *\n * @private\n * @param {ozpIwc.TransportPacket} electionMessage\n */\nozpIwc.LeaderGroupParticipant.prototype.handleElectionMessage=function(electionMessage) {\n    //If a state was received, store it case participant becomes the leader\n    if(Object.keys(electionMessage.entity.state).length > 0){\n        this.stateStore = electionMessage.entity.state;\n        this.events.trigger(\"receivedState\");\n    }\n\n    // If knowledge of a previousLeader was received, store it case participant becomes the leader and requests state\n    // from said participant.\n    if(electionMessage.entity.previousLeader){\n        if (electionMessage.entity.previousLeader !== this.address) {\n            this.previousLeader = electionMessage.entity.previousLeader;\n        }\n    }\n\n\n\t// is the new election lower priority than us?\n\tif(this.priorityLessThan(electionMessage.entity.priority,this.priority) && this.victoryTS < electionMessage.time) {\n        if(electionMessage.entity.priority === -Number.MAX_VALUE){\n            this.cancelElection();\n            this.activeStates.election = false;\n        } else {\n            if(!this.inElection()) {\n                this.electionQueue = [];\n            }\n        }\n        // Quell the rebellion!\n        this.startElection({opponent: electionMessage.src});\n\n    } else if(this.activeStates.leader) {\n        // If this participant is currently the leader but will loose the election, it sends out notification that their\n        // is currently a leader (for state retrieval purposes)\n        this.sendElectionMessage(\"election\", {previousLeader: this.address});\n\n    } else {\n\n        // Abandon dreams of leadership\n        this.cancelElection();\n\n        // If set, after canceling, the participant will force itself to a membership state. Used to debounce invalid\n        // leadership attempts due to high network traffic.\n        if(this.toggleDrop){\n            this.toggleDrop = false;\n            this.events.trigger(\"newLeaderEvent\");\n        }\n\t}\n\n};\n\n\n/**\n * Handle someone else declaring victory.\n *\n * Fires:\n *     - {{#crossLink \"ozpiwc.LeaderGroupParticipant/#newLeader:event\"}{{/crossLink}}\n *\n * @param {ozpIwc.TransportPacket} victoryMessage\n */\nozpIwc.LeaderGroupParticipant.prototype.handleVictoryMessage=function(victoryMessage) {\n\tif(this.priorityLessThan(victoryMessage.entity.priority,this.priority)) {\n\t\t// someone usurped our leadership! start an election!\n            this.startElection({opponent: victoryMessage.src +\"USURPER\"});\n\t} else {\n\t\t// submit to the bully\n\t\tthis.leader=victoryMessage.src;\n\t\tthis.leaderPriority=victoryMessage.entity.priority;\n        this.victoryTS = victoryMessage.time;\n\t\tthis.cancelElection();\n\t\tthis.events.trigger(\"newLeaderEvent\");\n        this.stateStore = {};\n\t}\n};\n\n/**\n * Returns the status of the participant.\n *\n * @method heartbeatStatus\n * @returns {Object}\n */\nozpIwc.LeaderGroupParticipant.prototype.heartbeatStatus=function() {\n\tvar status= ozpIwc.Participant.prototype.heartbeatStatus.apply(this,arguments);\n\tstatus.leaderState=this.leaderState;\n\tstatus.leaderPriority=this.priority;\n\treturn status;\n};\n\n\n/**\n * Changes the current state of the participant.\n * @param state {string} The state to change to.\n * @param config {object} properties to change in the participant should the state transition be valid\n * @returns {boolean}\n *      Will return true if a state transition occurred.\n *      Will not change state and return false if:\n *      <li>the new state was the current state</li>\n *      <li>the new state is not a registered state @see ozpIwc.LeaderGroupParticipant</li>\n */\nozpIwc.LeaderGroupParticipant.prototype.changeState=function(state,config) {\n    if(state !== this.leaderState){\n//        ozpIwc.log.log(this.address, this.leaderState, state);\n        if(this._validateState(state)){\n            for(var key in config){\n                this[key] = config[key];\n            }\n            return true;\n        }\n    }\n    return false;\n};\n\n\n/**\n *  Validates if the desired state transition is possible.\n *\n * @param state {string} The desired state to transition to.\n * @returns {boolean}\n *      Will return true if a state transition occured. </br>\n *      Will not change state and return false if:\n *      <li>the new state was the current state</li>\n *      <li>the new state is not a registered state</li>\n * @private\n */\nozpIwc.LeaderGroupParticipant.prototype._validateState = function(state){\n    var newState = {};\n    var validState = false;\n    for(var x in this.states) {\n        if(ozpIwc.util.arrayContainsAll(this.states[x], [state])){\n            newState[x] = true;\n            validState = true;\n        } else {\n            newState[x] = false;\n        }\n    }\n    if(validState){\n        this.activeStates = newState;\n        this.leaderState = state;\n        return true;\n    } else {\n        ozpIwc.log.error(this.address, this.name, \"does not have state:\", state);\n        return false;\n    }\n};","var ozpIwc=ozpIwc || {};\n\n/**\n * @submodule bus.transport\n */\n\n/**\n * A participant to handle multicast communication on the IWC.\n *\n * @class MulticastParticipant\n * @namespace ozpIwc\n * @extends ozpIwc.Participant\n * @constructor\n *\n * @param {String} name The name of the participant.\n */\nozpIwc.MulticastParticipant=ozpIwc.util.extend(ozpIwc.Participant,function(name) {\n\n    /**\n     * The address of the participant.\n     * @property address\n     * @type String\n     */\n\tthis.address = name;\n\n    /**\n     * The name of the participant.\n     * @property name\n     * @type String\n     */\n    this.name=name;\n\n    /**\n     * The type of the participant\n     * @property participantType\n     * @type String\n     * @default \"multicast\"\n     */\n\tthis.participantType=\"multicast\";\n\n    ozpIwc.Participant.apply(this,arguments);\n\n    /**\n     * Array of Participants that are part of the multicast group.\n     * @property members\n     * @type ozpIwc.Participant[]\n     * @default []\n     */\n\tthis.members=[];\n\n    /**\n     * The participants resource path for the Names API.\n     * @property namesResource\n     * @type String\n     * @default \"/multicast/\"\n     */\n    this.namesResource=\"/multicast/\"+this.name;\n\n    /**\n     * Content type for the Participant's heartbeat status packets.\n     * @property heartBeatContentType\n     * @type String\n     * @default \"application/vnd.ozp-iwc-multicast-address-v1+json\"\n     */\n    this.heartBeatContentType=\"application/vnd.ozp-iwc-multicast-address-v1+json\";\n\n    /**\n     *\n     * @property heartBeatStatus.members\n     * @type Array\n     * @default []\n     */\n    this.heartBeatStatus.members=[];\n\n    /**\n     * Fires when the participant has connected to its router.\n     * @event #connectedToRouter\n     */\n    this.on(\"connectedToRouter\",function() {\n        this.namesResource=\"/multicast/\" + this.name;\n    },this);\n\n    //At creation the multicast participant knows what it can sendAs/receiveAs\n    this.permissions.pushIfNotExist('ozp:iwc:address', name);\n    this.permissions.pushIfNotExist('ozp:iwc:sendAs', name);\n    this.permissions.pushIfNotExist('ozp:iwc:receiveAs', name);\n});\n\n/**\n * Receives a packet on behalf of the multicast group.\n *\n * @method receiveFromRouterImpl\n *\n * @param {ozpIwc.TransportPacket} packet\n * @returns {Boolean} always false.\n */\nozpIwc.MulticastParticipant.prototype.receiveFromRouterImpl=function(packet) {\n\n    this.receivedPacketsMeter.mark();\n\tthis.members.forEach(function(m) {\n        // as we send to each member, update the context to make it believe that it's the only recipient\n        packet.dstParticipant=m;\n        m.receiveFromRouter(packet);\n    });\n\treturn false;\n};\n\n/**\n * Adds a member to the multicast group.\n *\n * @method addMember\n *\n * @param {ozpIwc.Participant} participant\n */\nozpIwc.MulticastParticipant.prototype.addMember=function(participant) {\n\tthis.members.push(participant);\n    this.heartBeatStatus.members.push(participant.address);\n};","/** @namespace */\r\nvar ozpIwc=ozpIwc || {};\r\n\r\n/**\r\n * @submodule bus.transport\r\n */\r\n\r\n/**\r\n * @class PostMessageParticipant\r\n * @namespace ozpIwc\r\n * @extends ozpIwc.Participant\r\n *\r\n * @param {Object} config\r\n * @param {String} config.origin\r\n * @param {Object} config.sourceWindow\r\n * @param {Object} config.credentials\r\n */\r\nozpIwc.PostMessageParticipant=ozpIwc.util.extend(ozpIwc.Participant,function(config) {\r\n\tozpIwc.Participant.apply(this,arguments);\r\n\r\n    /**\r\n     * The origin of the Participant.\r\n     * @property origin\r\n     */\r\n    /**\r\n     * The name of the Participant.\r\n     * @property name\r\n     */\r\n\tthis.origin=this.name=config.origin;\r\n\r\n    /**\r\n     * The window of the Participant.\r\n     * @property sourceWindow\r\n     * @type Window\r\n     */\r\n\tthis.sourceWindow=config.sourceWindow;\r\n\r\n    /**\r\n     * @property credentials\r\n     * @type\r\n     */\r\n    this.credentials=config.credentials;\r\n\r\n    /**\r\n     * The type of the participant.\r\n     * @property participantType\r\n     * @type  String\r\n     * @default \"postMessageProxy\"\r\n     */\r\n\tthis.participantType=\"postMessageProxy\";\r\n\r\n    /**\r\n     * @property permissions.attributes['ozp:iwc:origin']\r\n     * @type String\r\n     */\r\n    this.permissions.pushIfNotExist(\"ozp:iwc:origin\",this.origin);\r\n\r\n    this.on(\"connectedToRouter\",function() {\r\n        this.permissions.pushIfNotExist('ozp:iwc:address', this.address);\r\n        this.permissions.pushIfNotExist('ozp:iwc:sendAs', this.address);\r\n        this.permissions.pushIfNotExist('ozp:iwc:receiveAs', this.address);\r\n    },this);\r\n    /**\r\n     * @property heartBeatStatus.origin\r\n     * @type String\r\n     */\r\n    this.heartBeatStatus.origin=this.origin;\r\n});\r\n\r\n/**\r\n * Receives a packet on behalf of this participant and forwards it via PostMessage.\r\n *\r\n * @method receiveFromRouterImpl\r\n * @param {ozpIwc.TransportPacketContext} packetContext\r\n */\r\nozpIwc.PostMessageParticipant.prototype.receiveFromRouterImpl=function(packetContext) {\r\n    this.receivedPacketsMeter.mark();\r\n    this.sendToRecipient(packetContext.packet);\r\n};\r\n\r\n/**\r\n * Sends a message to the other end of our connection.  Wraps any string mangling\r\n * necessary by the postMessage implementation of the browser.\r\n *\r\n * @method sendToParticipant\r\n * @param {ozpIwc.TransportPacket} packet\r\n * @todo Only IE requires the packet to be stringified before sending, should use feature detection?\r\n */\r\nozpIwc.PostMessageParticipant.prototype.sendToRecipient=function(packet) {\r\n\tozpIwc.util.safePostMessage(this.sourceWindow,packet,this.origin);\r\n};\r\n\r\n/**\r\n * The participant hijacks anything addressed to \"$transport\" and serves it\r\n * directly.  This isolates basic connection checking from the router, itself.\r\n *\r\n * @method handleTransportpacket\r\n * @param {Object} packet\r\n */\r\nozpIwc.PostMessageParticipant.prototype.handleTransportPacket=function(packet) {\r\n\tvar reply={\r\n\t\t'ver': 1,\r\n\t\t'dst': this.address,\r\n\t\t'src': '$transport',\r\n\t\t'replyTo': packet.msgId,\r\n\t\t'msgId': this.generateMsgId(),\r\n\t\t'entity': {\r\n\t\t\t\"address\": this.address\r\n\t\t}\r\n\t};\r\n\tthis.sendToRecipient(reply);\r\n};\r\n\r\n\r\n/**\r\n * Sends a packet received via PostMessage to the Participant's router.\r\n *\r\n * @method forwardFromPostMessage\r\n * @todo track the last used timestamp and make sure we don't send a duplicate messageId\r\n * @param {ozpIwc.TransportPacket} packet\r\n * @param {type} event\r\n */\r\nozpIwc.PostMessageParticipant.prototype.forwardFromPostMessage=function(packet,event) {\r\n\tif(typeof(packet) !== \"object\") {\r\n\t\tozpIwc.log.error(\"Unknown packet received: \" + JSON.stringify(packet));\r\n\t\treturn;\r\n\t}\r\n\tif(event.origin !== this.origin) {\r\n\t\t/** @todo participant changing origins should set off more alarms, probably */\r\n\t\tozpIwc.metrics.counter(\"transport.\"+this.address+\".invalidSenderOrigin\").inc();\r\n\t\treturn;\r\n\t}\r\n\r\n\tpacket=this.fixPacket(packet);\r\n\r\n\t// if it's addressed to $transport, hijack it\r\n\tif(packet.dst === \"$transport\") {\r\n\t\tthis.handleTransportPacket(packet);\r\n\t} else {\r\n\t\tthis.router.send(packet,this);\r\n\t}\r\n};\r\n\r\n/**\r\n * @TODO (DOC)\r\n * Listens for PostMessage messages and forwards them to the respected Participant.\r\n *\r\n * @class PostMessageParticipantListener\r\n * @param {Object} config\r\n * @param {ozpIwc.Router} config.router\r\n */\r\nozpIwc.PostMessageParticipantListener=function(config) {\r\n\tconfig = config || {};\r\n\r\n    /**\r\n     * @property Participants\r\n     * @type ozpiwc.PostMessageParticipant[]\r\n     */\r\n\tthis.participants=[];\r\n\r\n    /**\r\n     * @property router\r\n     * @type ozpIwc.Router\r\n     */\r\n\tthis.router=config.router || ozpIwc.defaultRouter;\r\n\r\n\tvar self=this;\r\n\r\n\twindow.addEventListener(\"message\", function(event) {\r\n\t\tself.receiveFromPostMessage(event);\r\n\t}, false);\r\n\r\n    ozpIwc.metrics.gauge('transport.postMessageListener.participants').set(function() {\r\n        return self.getParticipantCount();\r\n    });\r\n};\r\n\r\n/**\r\n * Gets the count of known participants\r\n *\r\n * @method getParticipantCount\r\n *\r\n * @returns {Number} the number of known participants\r\n */\r\nozpIwc.PostMessageParticipantListener.prototype.getParticipantCount=function() {\r\n    if (!this.participants) {\r\n        return 0;\r\n    }\r\n    return this.participants.length;\r\n};\r\n\r\n/**\r\n * Finds the participant associated with the given window.  Unfortunately, this is an\r\n * o(n) algorithm, since there doesn't seem to be any way to hash, order, or any other way to\r\n * compare windows other than equality.\r\n *\r\n * @method findParticipant\r\n * @param {Object} sourceWindow - the participant window handle from message's event.source\r\n */\r\nozpIwc.PostMessageParticipantListener.prototype.findParticipant=function(sourceWindow) {\r\n\tfor(var i=0; i< this.participants.length; ++i) {\r\n\t\tif(this.participants[i].sourceWindow === sourceWindow) {\r\n\t\t\treturn this.participants[i];\r\n\t\t}\r\n\t}\r\n};\r\n\r\n/**\r\n * Process a post message that is received from a peer\r\n *\r\n * @method receiveFromPostMessage\r\n * @param {Object} event - The event received from the \"message\" event handler\r\n * @param {String} event.origin\r\n * @param {Object} event.source\r\n * @param {ozpIwc.TransportPacket} event.data\r\n */\r\nozpIwc.PostMessageParticipantListener.prototype.receiveFromPostMessage=function(event) {\r\n\tvar participant=this.findParticipant(event.source);\r\n    var packet=event.data;\r\n    if(event.source === window) {\r\n        // the IE profiler seems to make the window receive it's own postMessages\r\n        // ... don't ask.  I don't know why\r\n        return;\r\n    }\r\n\tif(typeof(event.data)===\"string\") {\r\n\t\ttry {\r\n            packet=JSON.parse(event.data);\r\n        } catch(e) {\r\n            // assume that it's some other library using the bus and let it go\r\n            return;\r\n        }\r\n\t}\r\n\r\n    var isPacket = function(packet){\r\n        if (ozpIwc.util.isIWCPacket(packet)) {\r\n            participant.forwardFromPostMessage(packet, event);\r\n        } else {\r\n            ozpIwc.log.log(\"Packet does not meet IWC Packet criteria, dropping.\", packet);\r\n        }\r\n    };\r\n\r\n\t// if this is a window who hasn't talked to us before, sign them up\r\n\tif(!participant) {\r\n\r\n        var self = this;\r\n        var request = {\r\n            'subject': {'ozp:iwc:origin': event.origin},\r\n            'action': {'ozp:iwc:action': 'connect'},\r\n            'policies': ozpIwc.authorization.policySets.connectSet\r\n        };\r\n        ozpIwc.authorization.isPermitted(request)\r\n            .success(function () {\r\n                participant = new ozpIwc.PostMessageParticipant({\r\n                    'origin': event.origin,\r\n                    'sourceWindow': event.source,\r\n                    'credentials': packet.entity\r\n                });\r\n                self.router.registerParticipant(participant, packet);\r\n                self.participants.push(participant);\r\n                isPacket(packet);\r\n\r\n            }).failure(function (err) {\r\n                console.error(\"Failed to connect. Could not authorize:\", err);\r\n            });\r\n\t} else{\r\n        isPacket(packet);\r\n    }\r\n\r\n};\r\n","/**\n * @submodule bus.transport\n */\n\n/**\n * @class RouterWatchdog\n * @extends ozpIwc.InternalParticipant\n * @namespace ozpIwc\n */\nozpIwc.RouterWatchdog = ozpIwc.util.extend(ozpIwc.InternalParticipant, function(config) {\n    ozpIwc.InternalParticipant.apply(this, arguments);\n\n    /**\n     * The type of the participant.\n     * @property participantType\n     * @type String\n     */\n    this.participantType = \"routerWatchdog\";\n\n    /**\n     * Fired when connected.\n     * @event #connected\n     */\n    this.on(\"connected\", function() {\n        this.name = this.router.selfId;\n    }, this);\n\n    /**\n     * Frequency of heartbeats\n     * @property heartbeatFrequency\n     * @type Number\n     * @defualt 10000\n     */\n    this.heartbeatFrequency = config.heartbeatFrequency || 10000;\n\n    /**\n     * Fired when connected to the router.\n     * @event #connectedToRouter\n     */\n    this.on(\"connectedToRouter\", this.setupWatches, this);\n\n\n});\n\n/**\n * Removes this participant from the $bus.multicast multicast group.\n *\n * @method leaveEventChannel\n */\nozpIwc.RouterWatchdog.prototype.leaveEventChannel = function() {\n    // handle anything before leaving.\n    if(this.router) {\n\n        this.send({\n            dst: \"$bus.multicast\",\n            action: \"disconnect\",\n            entity: {\n                address: this.address,\n                participantType: this.participantType,\n                namesResource: this.namesResource\n            }\n        });\n\n        this.send({\n            dst: \"$bus.multicast\",\n            action: \"disconnect\",\n            entity: {\n                address: this.router.selfId,\n                namesResource: \"/router/\"+this.router.selfId\n            }\n        });\n        //TODO not implemented\n//        this.router.unregisterMulticast(this, [\"$bus.multicast\"]);\n        return true;\n    } else {\n        return false;\n    }\n\n};\n/**\n * Sets up the watchdog for all participants connected to the router. Reports heartbeats based on\n * {{#crossLink \"ozpIwc.RouterWatchdogParticipant/heartbeatFrequency:property\"}}{{/crossLink}}\n * @method setupWatches\n */\nozpIwc.RouterWatchdog.prototype.setupWatches = function() {\n    this.name = this.router.selfId;\n    var self=this;\n    var heartbeat=function() {\n        self.send({\n            dst: \"names.api\",\n            action: \"set\",\n            resource: \"/router/\" + self.router.selfId,\n            contentType: \"application/vnd.ozp-iwc-router-v1+json\",\n            entity: {\n                'address': self.router.selfId,\n                'participants': self.router.getParticipantCount(),\n                'time': ozpIwc.util.now()\n            }\n        });\n\n        for (var k in self.router.participants) {\n            var participant=self.router.participants[k];\n            participant.heartBeatStatus.time = ozpIwc.util.now();\n            if(participant instanceof ozpIwc.MulticastParticipant) {\n                /*jshint loopfunc:true*/\n                participant.members.forEach(function(member){\n                    self.send({\n                        'dst': \"names.api\",\n                        'resource': participant.namesResource + \"/\"+ member.address,\n                        'action' : \"set\",\n                        'entity' : member.heartBeatStatus,\n                        'contentType' : participant.heartBeatContentType\n                    });\n                });\n            } else {\n                participant.heartbeat();\n            }            \n        }\n\n    };\n//    heartbeat();\n\n    /**\n     * The timer for the heartBeat\n     * @property timer\n     * @type window.setInterval\n     */\n    this.timer = window.setInterval(heartbeat, this.heartbeatFrequency);\n};\n\n/**\n * Removes the watchdog.\n * @method shutdown\n */\nozpIwc.RouterWatchdog.prototype.shutdown = function() {\n    window.clearInterval(this.timer);\n};\n\n","/**\n * @submodule bus.api.Value\n */\n\n/**\n * The base class for values in the various APIs.  Designed to be extended with API-specific\n * concerns and validation.\n *\n * @class CommonApiValue\n * @namespace ozpIwc\n * @param {object} config\n * @param {string} config.name the name of this resource\n */\nozpIwc.CommonApiValue = function(config) {\n\tconfig = config || {};\n\n    /**\n     * @property watchers\n     * @type Array[String]\n     * @default []\n     */\n\tthis.watchers= config.watchers || [];\n\n    /**\n     * @property resource\n     * @type String\n     */\n\tthis.resource=config.resource;\n\n    /**\n     * @property allowedContentTypes\n     * @type Array\n     */\n    this.allowedContentTypes=config.allowedContentTypes;\n\n    /**\n     * @property entity\n     * @type Object\n     */\n    this.entity=config.entity;\n\n    /**\n     * @property contentType\n     * @type String\n     */\n\tthis.contentType=config.contentType;\n\n    /**\n     * @property permissions\n     * @type Object\n     * @default {}\n     */\n\tthis.permissions=new ozpIwc.policyAuth.SecurityAttribute();\n    for(var i in config.permissions){\n        this.permissions.pushIfNotExist(i, config.permissions[i]);\n    }\n\n    /**\n     * @property version\n     * @type Number\n     * @default 0\n     */\n\tthis.version=config.version || 0;\n\n    /**\n     * @property persist\n     * @type Boolean\n     * @default false\n     */\n    this.persist=false;\n\n    /**\n     * @property deleted\n     * @type Boolean\n     * @default true\n     */\n    this.deleted=true;\n};\n\n/**\n * Sets a data based upon the content of the packet.  Automatically updates the content type,\n * permissions, entity, and updates the version.\n *\n * @method set\n * @param {ozpIwc.TransportPacket} packet\n * @returns {undefined}\n */\nozpIwc.CommonApiValue.prototype.set=function(packet) {\n\tif(this.isValidContentType(packet.contentType)) {\n\n        if(!Array.isArray(packet.permissions)){\n            for(var i in packet.permissions) {\n                //If a permission was passed, wipe its value and set it to the new value;\n                this.permissions.clear(i);\n                this.permissions.pushIfNotExist(i,packet.permissions[i]);\n            }\n        }\n\t\tthis.contentType=packet.contentType;\n\t\tthis.entity=packet.entity;\n\t\tthis.version++;\n\t}\n};\n/**\n * Adds a new watcher based upon the contents of the packet.\n *\n * @method watch\n * @param {ozpIwc.TransportPacket} packet\n * @returns {undefined}\n */\nozpIwc.CommonApiValue.prototype.watch=function(packet) {\n\tthis.watchers.push({\n\t\tsrc: packet.src,\n\t\tmsgId: packet.msgId\n\t});\n};\n\n/**\n * Removes a previously registered watcher.  An unwatch on\n * someone who isn't actually watching is not an error-- \n * the post condition is satisfied.\n *\n * @method unwatch\n * @param {ozpIwc.TransportPacket} packet\n * @returns {undefined}\n */\nozpIwc.CommonApiValue.prototype.unwatch=function(packet) {\n\tthis.watchers=this.watchers.filter(function(w) {\n\t\treturn packet.replyTo !== w.msgId && packet.src !==w.src;\n\t});\n};\n\n/**\n * Invokes the callback on each watcher.\n *\n * @method eachWatcher\n * @param {function} callback\n * @param {object} [self]  Used as 'this' for the callback.  Defaults to the Value object.\n * @returns {undefined}\n */\nozpIwc.CommonApiValue.prototype.eachWatcher=function(callback,self) {\n\tself=self || this;\n\treturn this.watchers.map(callback,self);\n};\n\n/**\n * Resets the data to an empy state-- undefined entity and contentType, no permissions,\n * and version of 0.  It does NOT remove watchers.  This allows for watches on values\n * that do not exist yet, or will be created in the future.\n *\n * @method deleteData\n * @returns {undefined}\n */\nozpIwc.CommonApiValue.prototype.deleteData=function() {\n\tthis.entity=undefined;\n\tthis.contentType=undefined;\n    this.permissions.clearAll();\n\tthis.version=0;\n    this.deleted=true;\n};\n\n/**\n * Turns this value into a packet.\n *\n * @method toPacket\n * @param {ozpIwc.TransportPacket} base Fields to be merged into the packet.\n * @returns {ozpIwc.TransportPacket}\n */\nozpIwc.CommonApiValue.prototype.toPacket=function(base) {\n\tbase = base || {};\n\tbase.entity=ozpIwc.util.clone(this.entity);\n\tbase.contentType=this.contentType;\n\tbase.permissions=ozpIwc.util.clone(this.permissions.getAll());\n\tbase.eTag=this.version;\n\tbase.resource=this.resource;\n\treturn base;\n};\n\n/**\n * Determines if the contentType is acceptable to this value.  Intended to be\n * overriden by subclasses.\n *\n * @method isValidContentType\n * @param {string} contentType\n * @returns {Boolean}\n */\nozpIwc.CommonApiValue.prototype.isValidContentType=function(contentType) {\n    if(this.allowedContentTypes && this.allowedContentTypes.indexOf(contentType) < 0) {\n        throw new ozpIwc.ApiError(\"badContent\",\n                \"Bad contentType \" + contentType +\", expected \" + this.allowedContentTypes.join(\",\"));\n     } else {\n        return true;\n    }\n};\n\n/**\n * Generates a point-in-time snapshot of this value that can later be sent to\n * {@link ozpIwc.CommonApiValue#changesSince} to determine the changes made to the value.\n * This value should be considered opaque to consumers.\n * \n * <p> For API subclasses, the default behavior is to simply call toPacket().  Subclasses\n * can override this, but should likely override {@link ozpIwc.CommonApiValue#changesSince}\n * as well.\n *\n * @method snapshot\n * @returns {object}\n */\nozpIwc.CommonApiValue.prototype.snapshot=function() {\n\treturn this.toPacket();\n};\n\n/**\n * From a given snapshot, create a change notifications.  This is not a delta, rather it's\n * change structure.\n * <p> API subclasses can override if there are additional change notifications (e.g. children in DataApi).\n *\n * @method changesSince\n * @param {object} snapshot The state of the value at some time in the past.\n * @returns {Object} A record of the current value and the value of the snapshot.\n */\nozpIwc.CommonApiValue.prototype.changesSince=function(snapshot) {\n\tif(snapshot.eTag === this.version) {\n        return null;\n    }\n\treturn {\n\t\t\t'newValue': ozpIwc.util.clone(this.entity),\n\t\t\t'oldValue': snapshot.entity\n\t};\n};\n\n/**\n * Returns true if the value of this is impacted by the value of node.\n * For nodes that base their value off of other nodes, override this function.\n *\n * @method isUpdateNeeded\n * @param {type} node \n * @returns boolean\n */\nozpIwc.CommonApiValue.prototype.isUpdateNeeded=function(node) {\n    return false;\n};\n\n/**\n * Update this node based upon the changes made to changedNodes.\n *\n * @method updateContent\n * @param {ozpIwc.CommonApiValue[]} changedNodes Array of all nodes for which isUpdatedNeeded returned true.\n * @returns {ozpIwc.CommonApiValue.changes}\n */\nozpIwc.CommonApiValue.prototype.updateContent=function(changedNodes) {\n    return null;\n};\n\n/**\n * Handles deserializing an {{#crossLink \"ozpIwc.TransportPacket\"}}{{/crossLink}} and setting this value with\n * the contents.\n *\n * @method deserialize\n * @param {ozpIwc.TransportPacket} serverData\n */\nozpIwc.CommonApiValue.prototype.deserialize=function(serverData) {\n    var clone = ozpIwc.util.clone(serverData);\n// we need the persistent data to conform with the structure of non persistent data.\n    this.entity= clone.entity || {};\n    this.contentType=clone.contentType || this.contentType;\n    for(var i in clone.permissions){\n        this.permissions.pushIfNotExist(i, clone.permissions[i]);\n    }\n    this.version=clone.version || this.version;\n    this.watchers = serverData.watchers || this.watchers;\n};\n\n/**\n * Serializes a Common Api value to a packet.\n *\n * @method serialize\n * @return {ozpIwc.TransportPacket}\n */\nozpIwc.CommonApiValue.prototype.serialize=function() {\n    var serverData = {};\n    serverData.entity=this.entity;\n    serverData.contentType=this.contentType;\n    serverData.permissions=this.permissions.getAll();\n    serverData.version=this.version;\n    serverData.watchers=this.watchers;\n    return serverData;\n};\n","/**\n * @submodule bus.api.Value\n */\n\n/**\n * @class CommonApiCollectionValue\n * @namespace ozpIwc\n * @extends ozpIwc.CommonApiValue\n *\n * @type {Function}\n * @param {Object} config\n * @oaram {String} config.pattern\n */\nozpIwc.CommonApiCollectionValue = ozpIwc.util.extend(ozpIwc.CommonApiValue,function(config) {\n\tozpIwc.CommonApiValue.apply(this,arguments);\n\n    /**\n     * @property persist\n     * @type Boolean\n     * @default false\n     */\n    this.persist=false;\n\n    /**\n     * @property pattern\n     * @type RegExp\n     * @default ''\n     */\n    this.pattern=config.pattern || '';\n    this.pattern.toJSON = RegExp.prototype.toString;\n    this.entity=[];\n});\n\n/**\n * Returns if an update is needed.\n *\n * @method isUpdateNeeded\n * @param node\n * @returns {Boolean}\n */\nozpIwc.CommonApiCollectionValue.prototype.isUpdateNeeded=function(node) {\n    return node.resource.match(this.pattern);\n};\n\n/**\n * Update the content of this value with an array of changed nodes.\n *\n * @method updateContent\n * @param {ozpIwc.commonApiValue[]} changedNodes\n */\nozpIwc.CommonApiCollectionValue.prototype.updateContent=function(changedNodes) {\n    this.version++;\n    this.entity=changedNodes.map(function(changedNode) { return changedNode.resource; });\n};\n\n/**\n * Handles set actions on the value.\n *\n * @method set\n */\nozpIwc.CommonApiCollectionValue.prototype.set=function() {\n    throw new ozpIwc.ApiError(\"noPermission\",\"This resource cannot be modified.\");\n};\n\n/**\n * Deserializes a Common Api Collection value from a packet.\n *\n * @method deserialize\n * @param {ozpIwc.TransportPacket} serverData\n */\nozpIwc.CommonApiCollectionValue.prototype.deserialize=function(serverData) {\n    ozpIwc.CommonApiValue.prototype.deserialize.apply(this,arguments);\n    var clone = ozpIwc.util.clone(serverData);\n\n    this.pattern = (typeof clone.pattern === \"string\") ? new RegExp(clone.pattern.replace(/^\\/|\\/$/g, '')) : this.pattern;\n    this.pattern.toJSON = RegExp.prototype.toString;\n};\n\n/**\n * Serializes a Common Api Collection value to a packet.\n *\n * @method serialize\n * @return {ozpIwc.TransportPacket}\n*/\nozpIwc.CommonApiCollectionValue.prototype.serialize=function() {\n    var serverData = {};\n    serverData.entity=this.entity;\n    serverData.pattern=this.pattern;\n    serverData.contentType=this.contentType;\n    serverData.permissions=this.permissions;\n    serverData.version=this.version;\n    serverData.watchers=this.watchers;\n    return serverData;\n};\n","/**\n * ```\n    .---------------------------.\n   /,--..---..---..---..---..--. `.\n  //___||___||___||___||___||___\\_|\n  [j__ ######################## [_|\n     \\============================|\n  .==|  |\"\"\"||\"\"\"||\"\"\"||\"\"\"| |\"\"\"||\n /======\"---\"\"---\"\"---\"\"---\"=|  =||\n |____    []*  IWC     ____  | ==||\n //  \\\\        BUS    //  \\\\ |===||  hjw -(& kjk)\n \"\\__/\"---------------\"\\__/\"-+---+'\n * ```\n * @module bus\n */\n\n/**\n * Classes related to api aspects of the IWC.\n * @module bus\n * @submodule bus.api\n */\n/**\n * The API classes that can be used on the IWC bus. All of which subclass {{#crossLink \"ozpIwc.CommonApiBase\"}}{{/crossLink}}\n * @module bus.api\n * @submodule bus.api.Type\n */\n/**\n * The API Value types that can be used in IWC apis. All of which subclass\n * {{#crossLink \"CommonApiValue\"}}{{/crossLink}}\n * @module bus.api\n * @submodule bus.api.Value\n */\n\n/**\n * @TODO (Describe ApiError)\n *\n * @class ApiError\n * @namespace ozpIwc\n * @constructor\n *\n * @type {Function}\n * @param {String} action The action of the error.\n * @param {String} message The message corresponding to the error.\n */\nozpIwc.ApiError=ozpIwc.util.extend(Error,function(action,message) {\n    Error.call(this,message);\n    this.name=\"ApiError\";\n    this.errorAction=action;\n    this.message=message;\n});","/**\n * @submodule bus.api.Type\n */\n\n/**\n * The Common API Base implements the API Common Conventions.  It is intended to be subclassed by\n * the specific API implementations.\n * @class CommonApiBase\n * @namespace ozpIwc\n * @constructor\n * @param {Object} config\n * @params {Participant} config.participant  the participant used for the Api communication\n */\nozpIwc.CommonApiBase = function(config) {\n    config = config || {};\n\n    /**\n     * The participant used for the Api communication on the bus.\n     * @property participant\n     * @type Participant\n     * @default {}\n     */\n    this.participant=config.participant;\n    this.participant.on(\"unloadState\",this.unloadState,this);\n    this.participant.on(\"receiveApiPacket\",this.routePacket,this);\n    this.participant.on(\"becameLeaderEvent\", this.becameLeader,this);\n    this.participant.on(\"newLeaderEvent\", this.newLeader,this);\n    this.participant.on(\"startElection\", this.startElection,this);\n    this.participant.on(\"receiveEventChannelPacket\",this.routeEventChannel,this);\n   /**\n    * An events module for the API.\n    * @property events\n    * @type Event\n    */\n\tthis.events = new ozpIwc.Event();\n    this.events.mixinOnOff(this);\n\n    /**\n     * Api nodes that are updated based on other api nodes. Used for keeping dynamic lists of related resources.\n     * @property dynamicNodes\n     * @type Array\n     * @default []\n     */\n    this.dynamicNodes=[];\n\n    /**\n     * Key value storage for the API. each element of the object is a node of the API.\n     * @property data\n     * @type Object\n     * @default {}\n     */\n    this.data={};\n\n    /**\n     * A count for the recursive gathering of server data. Keeps track of the number of expected branches to traverse\n     * through the HAL data. Set to 1 at the start of\n     * {{#crossLink \"ozpIwc.CommonApiBase/loadFromEndpoint:method\"}}{{/crossLink}}\n     * @private\n     * @type Number\n     * @default 1\n     */\n    this.expectedBranches = 1;\n\n    /**\n     * A count for the recursive gathering of server data. Keeps track of the number of branches that have been fully\n     * retrieved in the HAL data. Set to 0 at the start of\n     * {{#crossLink \"ozpIwc.CommonApiBase/loadFromEndpoint:method\"}}{{/crossLink}}\n     * @private\n     * @type Number\n     * @default 0\n     */\n    this.retrievedBranches = 0;\n};\n\n/**\n * Finds or creates the corresponding node to store a server loaded resource.\n *\n * @method findNodeForServerResource\n * @param {ozpIwc.TransportPacket} serverObject The object to be stored.\n * @param {String} objectPath The full path resource of the object including it's root path.\n * @param {String} rootPath The root path resource of the object.\n *\n * @returns {ozpIwc.CommonApiValue} The node that is now holding the data provided in the serverObject parameter.\n */\nozpIwc.CommonApiBase.prototype.findNodeForServerResource=function(object,objectPath,endpoint) {\n    var resource = '/';\n    //Temporarily hard-code prefix. Will derive this from the server response eventually\n    switch (endpoint.name) {\n        case ozpIwc.linkRelPrefix + ':intent' :\n            if (object.type) {\n                resource += object.type;\n                if (object.action) {\n                    resource += '/' + object.action;\n                    if (object.handler) {\n                        resource += '/' + object.handler;\n                    }\n                }\n            }\n            break;\n        case ozpIwc.linkRelPrefix + ':application':\n            if (object.id) {\n                resource += 'application/' + object.id;\n            }\n            break;\n        case ozpIwc.linkRelPrefix + ':system':\n            resource += 'system';\n            break;\n        case ozpIwc.linkRelPrefix + ':user':\n            resource += 'user';\n            break;\n        case ozpIwc.linkRelPrefix + ':user-data':\n            if (object.key) {\n                resource += object.key;\n            }\n            break;\n        default:\n            resource+= 'FIXME_UNKNOWN_ENDPOINT_' + endpoint.name;\n    }\n\n    if (resource === '/') {\n        return null;\n    }\n\n    return this.findOrMakeValue({\n        'resource': resource,\n        'entity': {},\n        'contentType': object.contentType,\n        'children': object.children // for data.api only\n    });\n};\n\n/**\n * Loads api data from the server.  Intended to be overrided by subclasses to load data\n * when this instance becomes a leader without receiving data from the previous leader.\n *\n * @method loadFromServer\n */\nozpIwc.CommonApiBase.prototype.loadFromServer=function() {\n    // Do nothing by default, resolve to prevent clashing with overridden promise implementations.\n    return new Promise(function(resolve,reject){\n        resolve();\n    });\n};\n\n/**\n * Loads api data from a specific endpoint.\n *\n * @method loadFromEndpoint\n * @param {String} endpointName The name of the endpoint to load from the server.\n * @param [Object] requestHeaders\n * @param {String} requestHeaders.name\n * @param {String} requestHeaders.value\n *\n */\nozpIwc.CommonApiBase.prototype.loadFromEndpoint=function(endpointName, requestHeaders) {\n    this.expectedBranches = 1;\n    this.retrievedBranches = 0;\n\n    // fetch the base endpoint. it should be a HAL Json object that all of the\n    // resources and keys in it\n    var endpoint=ozpIwc.endpoint(endpointName);\n    var resolveLoad, rejectLoad;\n\n    var p = new Promise(function(resolve,reject){\n        resolveLoad = resolve;\n        rejectLoad = reject;\n    });\n\n    var self=this;\n    endpoint.get(\"/\")\n        .then(function(data) {\n            var payload = data.response;\n            var responseHeader = data.header;\n            self.loadLinkedObjectsFromServer(endpoint,payload,resolveLoad, requestHeaders,responseHeader);\n            self.updateResourceFromServer(payload,payload._links.self.href,endpoint,resolveLoad,responseHeader);\n            // update all the collection values\n            self.dynamicNodes.forEach(function(resource) {\n                self.updateDynamicNode(self.data[resource]);\n            });\n        })['catch'](function(e) {\n            ozpIwc.log.error(\"Could not load from api (\" + endpointName + \"): \" + e.message,e);\n            rejectLoad(\"Could not load from api (\" + endpointName + \"): \" + e.message + e);\n        });\n    return p;\n};\n\n/**\n * Updates an Api node with server loaded HAL data.\n *\n * @method updateResourceFromServer\n * @param {ozpIwc.TransportPacket} object The object retrieved from the server to store.\n * @param {String} path The path of the resource retrieved.\n * @param {ozpIwc.Endpoint} endpoint the endpoint of the HAL data.\n */\nozpIwc.CommonApiBase.prototype.updateResourceFromServer=function(object,path,endpoint,res,header) {\n    //TODO where should we get content-type?\n    header = header || {};\n    object.contentType = object.contentType || header['Content-Type'] || 'application/json';\n\n    var parseEntity;\n    if(typeof object.entity === \"string\"){\n        try{\n            parseEntity = JSON.parse(object.entity);\n            object.entity = parseEntity;\n        }catch(e){\n            // fail silently for now\n        }\n    }\n    var node = this.findNodeForServerResource(object,path,endpoint);\n\n    if (node) {\n        var snapshot = node.snapshot();\n\n        var halLess = ozpIwc.util.clone(object);\n        delete halLess._links;\n        delete halLess._embedded;\n        node.deserialize(this.formatServerData(halLess));\n\n        this.notifyWatchers(node, node.changesSince(snapshot));\n        this.loadLinkedObjectsFromServer(endpoint, object, res);\n    }\n};\n\n/**\n * A middleware function used to format server data to be deserialized into Api nodes\n *\n * @method formatServerData\n * @param {Object} the data to format.\n * @returns {{entity: object}}\n */\nozpIwc.CommonApiBase.prototype.formatServerData = function(object){\n    return {\n        entity: object\n    };\n};\n\n/**\n * Traverses through HAL data from the server and updates api resources based on the data it finds.\n *\n * @method loadLinkedObjectsFromServer\n * @param {ozpIwc.Endpoint} endpoint the endpoint of the HAL data.\n * @param data the HAL data.\n * @parm [Object] headers\n * @param {String} headers.name\n * @param {String} headers.value\n */\nozpIwc.CommonApiBase.prototype.loadLinkedObjectsFromServer=function(endpoint,data,res, requestHeaders) {\n    // fetch the base endpoint. it should be a HAL Json object that all of the \n    // resources and keys in it\n    if(!data) {\n        return;\n    }\n\n    var self=this;\n    var noEmbedded = true;\n    var noLinks = true;\n    var branchesFound = 0;\n    var itemLength = 0;\n\n    if(data._embedded && data._embedded.item) {\n        data._embedded.item = Array.isArray(data._embedded.item) ? data._embedded.item : [data._embedded.item];\n        noEmbedded = false;\n        if (Object.prototype.toString.call(data._embedded.item) === '[object Array]' ) {\n            itemLength=data._embedded.item.length;\n        } else {\n            itemLength=1;\n        }\n        branchesFound+=itemLength;\n    }\n\n    if(data._links && data._links.item) {\n        data._links.item = Array.isArray(data._links.item) ? data._links.item : [data._links.item];\n        noLinks = false;\n        if (Object.prototype.toString.call(data._links.item) === '[object Array]' ) {\n            itemLength=data._links.item.length;\n        } else {\n            itemLength=1;\n        }\n        branchesFound+=itemLength;\n    }\n\n    if(noEmbedded && noLinks) {\n        this.retrievedBranches++;\n        if(this.retrievedBranches >= this.expectedBranches){\n            res(\"RESOLVING\");\n        }\n    } else {\n\n        this.expectedBranches += branchesFound - 1;\n\n        //TODO should we parse objects from _links and _embedded not wrapped in an item object?\n\n        if(data._embedded && data._embedded.item) {\n            var object = {};\n\n            if( Object.prototype.toString.call(data._embedded.item) === '[object Array]' ) {\n                for (var i in data._embedded.item) {\n                    object = data._embedded.item[i];\n                    this.updateResourceFromServer(object, object._links.self.href, endpoint, res);\n                }\n            } else {\n                object = data._embedded.item;\n                this.updateResourceFromServer(object, object._links.self.href, endpoint, res);\n            }\n        }\n\n        if(data._links && data._links.item) {\n\n            if( Object.prototype.toString.call(data._links.item) === '[object Array]' ) {\n                data._links.item.forEach(function (object) {\n                    var href = object.href;\n                    endpoint.get(href, requestHeaders).then(function (objectResource) {\n                        var payload = objectResource.response;\n                        var header = objectResource.header;\n                        self.updateResourceFromServer(payload, href, endpoint, res,header);\n                    })['catch'](function (error) {\n                        ozpIwc.log.error(\"unable to load \" + object.href + \" because: \", error);\n                    });\n                });\n            } else {\n                var href = data._links.item.href;\n                endpoint.get(href, requestHeaders).then(function (objectResource) {\n                    var payload = objectResource.response;\n                    var header = objectResource.header;\n                    self.updateResourceFromServer(payload, href, endpoint, res,header);\n                })['catch'](function (error) {\n                    ozpIwc.log.error(\"unable to load \" + object.href + \" because: \", error);\n                });\n            }\n        }\n    }\n};\n\n\n/**\n * Creates a new value for the given packet's request.  Subclasses must override this\n * function to return the proper value based upon the packet's resource, content type, or\n * other parameters.\n *\n * @method makeValue\n * @abstract\n * @param {ozpIwc.TransportPacket} packet\n *\n * @returns {CommonApiValue} an object implementing the commonApiValue interfaces\n */\nozpIwc.CommonApiBase.prototype.makeValue=function(/*packet*/) {\n    throw new Error(\"Subclasses of CommonApiBase must implement the makeValue(packet) function.\");\n};\n\n/**\n * Determines whether the action implied by the packet is permitted to occur on\n * node in question.\n *\n * @todo the refactoring of security to allow action-level permissions\n * @todo make the packetContext have the srcSubject inside of it\n *\n * @method isPermitted\n * @param {ozpIwc.TransportPacketContext} packetContext The packet of which permission is in question.\n * @param {ozpIwc.CommonApiValue} node The node of the api that permission is being checked against\n *\n * @returns {ozpIwc.AsyncAction} An asynchronous response, the response will call either success or failure depending on\n * the result of the check.\n *\n * @example\n * ```\n * foo.isPermitted(node,packetContext)\n *      .success(function(){\n *          ...\n *      }).failure(function(){\n *          ...\n *      });\n * ```\n */\nozpIwc.CommonApiBase.prototype.isPermitted=function(packetContext,node) {\n    var asyncAction = new ozpIwc.AsyncAction();\n\n    ozpIwc.authorization.formatCategory(packetContext.packet.permissions)\n        .success(function(permissions) {\n            var request = {\n                'subject': node.permissions.getAll(),\n                'resource': permissions || {},\n                'action': {'ozp:iwc:action': 'access'},\n                'policies': ozpIwc.authorization.policySets.apiSet\n            };\n\n            ozpIwc.authorization.isPermitted(request, node)\n                .success(function (resolution) {\n                        asyncAction.resolve(\"success\",resolution);\n                }).failure(function (err) {\n                    console.error(\"Api could not perform action:\", err);\n                    asyncAction.resolve(\"failure\",err);\n                });\n        }).failure(function(err){\n            console.error(\"Api could not format permission check on packet\", err);\n            asyncAction.resolve(\"failure\",err);\n        });\n\n    return asyncAction;\n};\n\n\n/**\n * Turn an event into a list of change packets to be sent to the watchers.\n *\n * @method notifyWatchers\n * @param {ozpIwc.CommonApiValue} node The node being changed.\n * @param {Object} changes The changes to the node.\n */\nozpIwc.CommonApiBase.prototype.notifyWatchers=function(node,changes) {\n    if(!changes) {\n        return;\n    }\n    this.events.trigger(\"changedNode\",node,changes);\n    node.eachWatcher(function(watcher) {\n        // @TODO check that the recipient has permission to both the new and old values\n        var reply={\n            'dst'   : watcher.src,\n            'src'   : this.participant.name,\n            'replyTo' : watcher.msgId,\n            'response': 'changed',\n            'resource': node.resource,\n            'permissions': node.permissions.getAll(),\n            'entity': changes\n        };\n\n        this.participant.send(reply);\n    },this);\n};\n\n/**\n * For a given packet, return the value if it already exists, otherwise create the value\n * using makeValue()\n *\n * @method findOrMakeValue\n * @protected\n * @param {ozpIwc.TransportPacket} packet The data that will be used to either find or create the api node.\n */\nozpIwc.CommonApiBase.prototype.findOrMakeValue=function(packet) {\n    if(packet.resource === null || packet.resource === undefined) {\n        // return a throw-away value\n        return new ozpIwc.CommonApiValue();\n    }\n    var node=this.data[packet.resource];\n\n    if(!node) {\n        node=this.data[packet.resource]=this.makeValue(packet);\n    }\n    return node;\n};\n\n/**\n *\n * Determines if the given resource exists.\n *\n * @method hasKey\n * @param {String} resource The path of the resource in question.\n * @returns {Boolean} Returns true if there is a node with a corresponding resource in the api.\n */\nozpIwc.CommonApiBase.prototype.hasKey=function(resource) {\n    return resource in this.data;\n};\n\n/**\n * Generates a key name that does not already exist and starts with a given prefix.\n *\n * @method createKey\n * @param {String} prefix The prefix resource string.\n * @returns {String} The prefix resource string with an appended generated Id that is not already in use.\n */\nozpIwc.CommonApiBase.prototype.createKey=function(prefix) {\n    prefix=prefix || \"\";\n    var key;\n    do {\n        key=prefix + ozpIwc.util.generateId();\n    } while(this.hasKey(key));\n    return key;\n};\n\n/**\n * Route a packet to the appropriate handler.  The routing path is based upon\n * the action and whether a resource is defined. If the handler does not exist, it is routed\n * to defaultHandler(node,packetContext)\n *\n * Has Resource: handleAction(node,packetContext)\n *\n * No resource: rootHandleAction(node,packetContext)\n *\n * Where \"Action\" is replaced with the packet's action, lowercase with first letter capitalized\n * (e.g. \"doSomething\" invokes \"handleDosomething\")\n * Note that node will usually be null for the rootHandlerAction calls.\n * <ul>\n * <li> Pre-routing checks\t<ul>\n *\t\t<li> Permission check</li>\n *\t\t<li> ACL Checks (todo)</li>\n *\t\t<li> Precondition checks</li>\n * </ul></li>\n * <li> Post-routing actions <ul>\n *\t\t<li> Reply to requester </li>\n *\t\t<li> If node version changed, notify all watchers </li>\n * </ul></li>\n *\n * @method routePacket\n * @param {ozpIwc.TransportPacketContext} packetContext The packet to route.\n *\n */\nozpIwc.CommonApiBase.prototype.routePacket=function(packetContext) {\n    var packet=packetContext.packet;\n    this.events.trigger(\"receive\",packetContext);\n    var self=this;\n    var errorWrap=function(f) {\n        try {\n            f.apply(self);\n        } catch(e) {\n            if(!e.errorAction) {\n                ozpIwc.log.log(\"Unexpected error:\",e);\n            }\n            packetContext.replyTo({\n                'response': e.errorAction || \"unknownError\",\n                'entity': e.message\n            });\n            return;\n        }\n    };\n    if(packetContext.leaderState !== 'leader' && packetContext.leaderState !== 'actingLeader'  )\t{\n        // if not leader, just drop it.\n        return;\n    }\n\n    if(packet.response && !packet.action) {\n        //TODO create a metric for this instead of logging to console\n        //ozpIwc.log.log(this.participant.name + \" dropping response packet \",packet);\n        // if it's a response packet that didn't wire an explicit handler, drop the sucker\n        return;\n    }\n    var node;\n\n    errorWrap(function() {\n        var handler=this.findHandler(packetContext);\n        this.validateResource(node,packetContext);\n        node=this.findOrMakeValue(packetContext.packet);\n\n        this.isPermitted(packetContext,node)\n            .success(function() {\n                errorWrap(function() {\n                    this.validatePreconditions(node,packetContext);\n                    var snapshot=node.snapshot();\n                    handler.call(this,node,packetContext);\n                    this.notifyWatchers(node, node.changesSince(snapshot));\n\n                // update all the collection values\n                    this.dynamicNodes.forEach(function(resource) {\n                        this.updateDynamicNode(this.data[resource]);\n                    },this);\n                });\n            },this)\n            .failure(function(err) {\n                packetContext.replyTo({'response':'noPerm'});\n                console.log(\"failure\");\n            });\n    });\n};\n\n/**\n * Routes event channel messages.\n *\n * @method routeEventChannel\n * @param {ozpIwc.TransportPacketContext} packetContext\n */\nozpIwc.CommonApiBase.prototype.routeEventChannel = function(packetContext) {\n    if (!this.participant.activeStates.leader) {\n        return;\n    }\n    var packet = packetContext.packet;\n    switch (packet.action) {\n        case \"connect\":\n            this.handleEventChannelConnect(packetContext);\n            break;\n        case \"disconnect\":\n            this.handleEventChannelDisconnect(packetContext);\n            break;\n        default:\n            ozpIwc.log.error(this.participant.name, \"No handler found for corresponding event channel action: \", packet.action);\n            break;\n    }\n};\n\n/**\n * Handles disconnect messages received over the $bus.multicast group.\n *\n * @method handleEventChannelDisconnect\n * @param {ozpIwc.TransportPacketContext} packetContext\n */\nozpIwc.CommonApiBase.prototype.handleEventChannelDisconnect = function(packetContext) {\n    for(var node in this.data){\n        for(var j in this.data[node].watchers) {\n            if (this.data[node].watchers[j].src === packetContext.packet.entity.address) {\n                this.data[node].watchers.splice(j,1);\n            }\n        }\n    }\n    this.handleEventChannelDisconnectImpl(packetContext);\n};\n\n/**\n * Handles connect messages received over the $bus.multicast group.\n *\n * @method handleEventChannelConnect\n* @param {ozpIwc.TransportPacketContext} packetContext\n*/\nozpIwc.CommonApiBase.prototype.handleEventChannelConnect = function(packetContext) {\n    this.handleEventChannelConnectImpl(packetContext);\n};\n\n/**\n * Intended to be overridden by subclass.\n *\n * @abstract\n * @method handleEventChannelDisconnectImpl\n * @param {ozpIwc.TransportPacketContext} packetContext\n */\nozpIwc.CommonApiBase.prototype.handleEventChannelDisconnectImpl = function(packetContext) {\n};\n/**\n * Intended to be overridden by subclass.\n *\n * @abstract\n * @method handleEventChannelDisconnectImpl\n * @param {ozpIwc.TransportPacketContext} packetContext\n */\nozpIwc.CommonApiBase.prototype.handleEventChannelConnectImpl = function(packetContext) {\n};\n/**\n * Determines which handler in the api is needed to process the given packet.\n *\n * @method findHandler\n * @param {ozpIwc.TransportPacketContext} packetContext The packet context to find a proper handler for.\n *\n * @returns {Function} The handler for the given packet context.\n */\nozpIwc.CommonApiBase.prototype.findHandler=function(packetContext) {\n    var action=packetContext.packet.action;\n    var resource=packetContext.packet.resource;\n\n    var handler;\n\n    if(resource===null || resource===undefined) {\n        handler=\"rootHandle\";\n    } else {\n        handler=\"handle\";\n    }\n\n    if(action) {\n        handler+=action.charAt(0).toUpperCase() + action.slice(1).toLowerCase();\n    } else {\n        handler=\"defaultHandler\";\n    }\n\n    if(!handler || typeof(this[handler]) !== 'function') {\n        handler=\"defaultHandler\";\n    }\n    return this[handler];\n};\n\n\n/**\n * Checks that the given packet context's resource meets the requirements of the api. Subclasses should override this\n * method as it performs no check by default.\n *\n * @method validateResource\n * @param {CommonApiValue} node @TODO is a node needed to validate?\n * @param {ozpIwc.TransportPacketContext} packetContext The packetContext with the resource to be validated.\n *\n * @returns {Boolean} always returns true.\n */\nozpIwc.CommonApiBase.prototype.validateResource=function(/* node,packetContext */) {\n    return true;\n};\n\n/**\n * Checks the given packet context's `ifTag` against the desired api node's `version`. Throws ApiError if ifTag exists\n * and doesn't match.\n *\n * @method validatePreconditions\n * @param node The api node being checked against.\n * @param packetContext The packet context to validate.\n *\n */\nozpIwc.CommonApiBase.prototype.validatePreconditions=function(node,packetContext) {\n    if(packetContext.packet.ifTag && packetContext.packet.ifTag!==node.version) {\n        throw new ozpIwc.ApiError('noMatch',\"Latest version is \" + node.version);\n    }\n};\n\n/**\n * Checks that the given packet context's contextType meets the requirements of the api. Subclasses should override this\n * method as it performs no check by default.\n *\n * @method validateContextType\n * @param {CommonApiValue} node @TODO is a node needed to validate?\n * @param {ozpIwc.TransportPacketContext} packetContext The packetContext with the contextType to be validated.\n *\n * @returns {Boolean} - always returns true.\n */\nozpIwc.CommonApiBase.prototype.validateContentType=function(node,packetContext) {\n    return true;\n};\n\n/**\n * @TODO (DOC)\n * @method updateDynamicNode\n * @param {ozpIwc.CommonApiValue} node @TODO (DOC)\n */\nozpIwc.CommonApiBase.prototype.updateDynamicNode=function(node) {\n    if(!node) {\n        return;\n    }\n    var ofInterest=[];\n\n    for(var k in this.data) {\n        if(node.isUpdateNeeded(this.data[k])){\n            ofInterest.push(this.data[k]);\n        }\n    }\n\n    if(ofInterest) {\n        var snapshot=node.snapshot();\n        node.updateContent(ofInterest);\n        this.notifyWatchers(node,node.changesSince(snapshot));\n    }\n};\n\n/**\n * @TODO (DOC)\n * @method addDynamicNode\n * @param {ozpIwc.CommonApiValue} node @TODO (DOC)\n */\nozpIwc.CommonApiBase.prototype.addDynamicNode=function(node) {\n    this.data[node.resource]=node;\n    this.dynamicNodes.push(node.resource);\n    this.updateDynamicNode(node);\n};\n\n/**\n * The default handler for the api when receiving packets. This handler is called when no handler was found for the\n * given packet context's action.\n *\n *\n * @method defaultHandler\n * @param {ozpIwc.CommonApiValue} node @TODO is a node needed? or is this intended for subclass purposes\n * @param {ozpIwc.TransportPacketContext} packetContext The packet context being handled.\n */\nozpIwc.CommonApiBase.prototype.defaultHandler=function(node,packetContext) {\n    packetContext.replyTo({\n        'response': 'badAction',\n        'entity': {\n            'action': packetContext.packet.action,\n            'originalRequest' : packetContext.packet\n        }\n    });\n};\n\n/**\n * Common handler for packet contexts with `get` actions.\n *\n * @method handleGet\n * @param {ozpIwc.CommonApiValue} node The api node to retrieve.\n * @param {ozpIwc.TransportPacketContext} packetContext The packet context containing the get action.\n */\nozpIwc.CommonApiBase.prototype.handleGet=function(node,packetContext) {\n    packetContext.replyTo(node.toPacket({'response': 'ok'}));\n};\n\n/**\n * Common handler for packet contexts with `set` actions.\n *\n * @method handleSet\n * @param {ozpIwc.CommonApiValue} node The api node to store the packet contexts' data in.\n * @param {ozpIwc.TransportPacketContext} packetContext The packet context containing the set action.\n */\nozpIwc.CommonApiBase.prototype.handleSet=function(node,packetContext) {\n    node.set(packetContext.packet);\n    packetContext.replyTo({'response':'ok'});\n};\n\n/**\n * Common handler for packet contexts with `delete` actions.\n *\n * @TODO (DOC)\n * @method handleDelete\n * @param {ozpIwc.CommonApiValue} node @TODO (DOC)\n * @param {ozpIwc.TransportPacketContext} packetContext @TODO (DOC)\n */\nozpIwc.CommonApiBase.prototype.handleDelete=function(node,packetContext) {\n    node.deleteData();\n    packetContext.replyTo({'response':'ok'});\n};\n\n/**\n * Common handler for packet contexts with `watch` actions.\n *\n * @method handleWatch\n * @param {ozpIwc.CommonApiValue} node The api node to register a watch on.\n * @param {ozpIwc.TransportPacketContext} packetContext The packet context containing the watch action.\n */\nozpIwc.CommonApiBase.prototype.handleWatch=function(node,packetContext) {\n    node.watch(packetContext.packet);\n\n    // @TODO: Reply with the entity? Immediately send a change notice to the new watcher?\n    packetContext.replyTo({'response': 'ok'});\n};\n\n/**\n * Common handler for packet contexts with `unwatch` actions.\n *\n * @method handleUnwatch\n * @param {ozpIwc.CommonApiValue} node The api node to remove a watch registration from.\n * @param {ozpIwc.TransportPacketContext} packetContext The packet context containing the unwatch action.\n */\nozpIwc.CommonApiBase.prototype.handleUnwatch=function(node,packetContext) {\n    node.unwatch(packetContext.packet);\n\n    packetContext.replyTo({'response':'ok'});\n};\n\n/**\n * Called when the leader participant fires its beforeUnload state. Releases the Api's data property\n * to be consumed by all, then used by the new leader.\n *\n * @method unloadState\n */\nozpIwc.CommonApiBase.prototype.unloadState = function(){\n    if(this.participant.activeStates.leader) {\n\n        var serializedData = {};\n        for(var  i in this.data){\n            serializedData[i] = this.data[i].serialize();\n        }\n        this.participant.sendElectionMessage(\"election\",{state: {\n            data: serializedData,\n            dynamicNodes: this.dynamicNodes\n        }, previousLeader: this.participant.address});\n\n        this.data = {};\n    } else {\n        this.participant.sendElectionMessage(\"election\");\n    }\n};\n\n\n/**\n * Sets the APIs data property. Removes current values, then constructs each API value anew.\n *\n * @method setState\n * @param {Object} state The object containing key value pairs to set as this api's state.\n */\nozpIwc.CommonApiBase.prototype.setState = function(state) {\n    this.data = {};\n    this.dynamicNodes = state.dynamicNodes;\n    for (var key in state.data) {\n        var dynIndex = this.dynamicNodes.indexOf(key);\n        var node;\n        if(dynIndex > -1){\n             node = this.data[key] = new ozpIwc.CommonApiCollectionValue({\n                resource: key\n            });\n            node.deserialize(state.data[key]);\n            this.updateDynamicNode(node);\n        } else {\n            node = this.findOrMakeValue({\n                resource: key,\n                contentType: state.data[key].contentType\n            });\n            node.deserialize(state.data[key]);\n        }\n    }\n    // update all the collection values\n    this.dynamicNodes.forEach(function(resource) {\n        this.updateDynamicNode(this.data[resource]);\n    },this);\n};\n\n/**\n * Common handler for packet contexts with a `list` action but no resource.\n *\n * @method rootHandleList\n * @param {ozpIwc.CommonApiValue}node @TODO is a node needed? or is this intended for subclass purposes\n * @param {ozpIwc.TransportPacketContext} packetContext The packet context of the received request.\n */\nozpIwc.CommonApiBase.prototype.rootHandleList=function(node,packetContext) {\n    packetContext.replyTo({\n        'response':'ok',\n        'entity': Object.keys(this.data)\n    });\n};\n\n/**\n * Puts the API's participant into it's election state.\n *\n * @method startElection\n */\nozpIwc.CommonApiBase.prototype.startElection = function(){\n    if (this.participant.activeStates.leader) {\n        this.participant.changeState(\"actingLeader\");\n    } else if(this.participant.leaderState === \"leaderSync\") {\n        // do nothing.\n    } else {\n        this.participant.changeState(\"election\");\n    }\n};\n\n\n/**\n *  Handles taking over control of the API's participant group as the leader.\n *      <li>If this API instance's participant was the leader prior to election and won, normal functionality resumes.</li>\n *      <li>If this API instance's participant received state from a leaving leader participant, it will consume said participants state</li>\n *\n * @method becameLeader\n */\nozpIwc.CommonApiBase.prototype.becameLeader= function(){\n    this.participant.sendElectionMessage(\"victory\");\n\n    // Was I the leader at the start of the election?\n    if (this.participant.leaderState === \"actingLeader\" || this.participant.leaderState === \"leader\") {\n        // Continue leading\n        this.setToLeader();\n\n    } else if (this.participant.leaderState === \"election\") {\n        //If this is the initial state we need to wait till the endpoint data is ready\n        this.leaderSync();\n    }\n};\n\n\n/**\n * Handles a new leader being assigned to this API's participant group.\n *      <li>@TODO: If this API instance was leader prior to the election, its state will be sent off to the new leader.</li>\n *      <li>If this API instance wasn't the leader prior to the election it will resume normal functionality.</li>\n *\n * Fires:\n *   - {{#crossLink \"ozpIwc.leaderGroupParticipant/#newLeader:event\"}}{{/crossLink}}\n *\n * @method newLeader\n */\nozpIwc.CommonApiBase.prototype.newLeader = function() {\n    // If this API was the leader, send its state to the new leader\n    if (this.participant.leaderState === \"actingLeader\") {\n        this.participant.sendElectionMessage(\"election\", {previousLeader: this.participant.address, state: this.data});\n    }\n    this.participant.changeState(\"member\");\n    this.participant.events.trigger(\"newLeader\");\n};\n\n\n\n/**\n * Handles setting the API's participant to the leader state.\n *\n * Fires:\n *   - {{#crossLink \"ozpIwc.leaderGroupParticipant/#becameLeader:event\"}}{{/crossLink}}\n *\n * @method setToLeader\n */\nozpIwc.CommonApiBase.prototype.setToLeader = function(){\n    var self = this;\n    ozpIwc.util.setImmediate(function() {\n        self.participant.changeState(\"leader\");\n        self.participant.events.trigger(\"becameLeader\");\n    });\n};\n\n\n/**\n * Handles the syncronizing of API data from previous leaders.\n * <li> If this API's participant has a state stored from the election it is set </li>\n * <li> If no state present but expected, a listener is set to retrieve the state if acquired within 250ms </li>\n *\n * @method leaderSync\n */\nozpIwc.CommonApiBase.prototype.leaderSync = function () {\n    this.participant.changeState(\"leaderSync\",{toggleDrop: true});\n\n    var self = this;\n    ozpIwc.util.setImmediate(function() {\n\n        // If the election synchronizing pushed this API out of leadership, don't try to become leader.\n        if(self.participant.leaderState !== \"leaderSync\") {\n            return;\n        }\n\n        // Previous leader sent out their state, it was stored in the participant\n        if (self.participant.stateStore && Object.keys(self.participant.stateStore).length > 0) {\n            self.setState(self.participant.stateStore);\n            self.participant.stateStore = {};\n            self.setToLeader();\n\n        } else if (self.participant.previousLeader) {\n            // There was a previous leader but we haven't seen their state. Wait for it.\n            self.receiveStateTimer = null;\n\n            var recvFunc = function () {\n                self.setState(self.participant.stateStore);\n                self.participant.off(\"receivedState\", recvFunc);\n                self.setToLeader();\n                window.clearInterval(self.receiveStateTimer);\n                self.receiveStateTimer = null;\n            };\n\n            self.participant.on(\"receivedState\", recvFunc);\n\n            self.receiveStateTimer = window.setTimeout(function () {\n                if (self.participant.stateStore && Object.keys(self.participant.stateStore).length > 0) {\n                    recvFunc();\n                } else {\n                    self.loadFromServer();\n                    ozpIwc.log.log(self.participant.name, \"New leader(\",self.participant.address, \") failed to retrieve state from previous leader(\", self.participant.previousLeader, \"), so is loading data from server.\");\n                }\n\n                self.participant.off(\"receivedState\", recvFunc);\n                self.setToLeader();\n            }, 250);\n\n        } else {\n            // This is the first of the bus, winner doesn't obtain any previous state\n            ozpIwc.log.log(self.participant.name, \"New leader(\",self.participant.address, \") is loading data from server.\");\n            self.loadFromServer().then(function (data) {\n                self.setToLeader();\n            },function(err){\n                ozpIwc.log.error(self.participant.name, \"New leader(\",self.participant.address, \") could not load data from server. Error:\", err);\n                self.setToLeader();\n            })['catch'](function(er){\n                ozpIwc.log.log(er);\n            });\n        }\n    });\n};\n\n/**\n * @TODO DOC\n * @method persistNodes\n */\nozpIwc.CommonApiBase.prototype.persistNodes=function() {\n\t// throw not implemented error\n\tthrow new ozpIwc.ApiError(\"noImplementation\",\"Base class persistence call not implemented.  Use DataApi to persist nodes.\");\n};\n","var ozpIwc=ozpIwc || {};\n\n/**\n * @class Endpoint\n * @namespace ozpIwc\n * @param {ozpIwc.EndpointRegistry} endpointRegistry Endpoint name\n * @constructor\n */\nozpIwc.Endpoint=function(endpointRegistry) {\n\n    /**\n     * @property endpointRegistry\n     * @type ozpIwc.EndpointRegistry\n     */\n\tthis.endpointRegistry=endpointRegistry;\n};\n\n/**\n * Performs an AJAX request of GET for specified resource href.\n *\n * @method get\n * @param {String} resource\n * @param [Object] requestHeaders\n * @param {String} requestHeaders.name\n * @param {String} requestHeaders.value\n *\n * @returns {Promise}\n */\nozpIwc.Endpoint.prototype.get=function(resource, requestHeaders) {\n    var self=this;\n    resource = resource || '';\n    return this.endpointRegistry.loadPromise.then(function() {\n        if (resource === '/' || resource === '' ) {\n            resource=self.baseUrl;\n        }\n        return ozpIwc.util.ajax({\n            href:  resource,\n            method: 'GET',\n            headers: requestHeaders\n        });\n    });\n};\n\n/**\n *\n * Performs an AJAX request of PUT for specified resource href.\n *\n * @method put\n * @param {String} resource\n * @param {Object} data\\\n * @param [Object] requestHeaders\n * @param {String} requestHeaders.name\n * @param {String} requestHeaders.value\n *\n * @returns {Promise}\n */\nozpIwc.Endpoint.prototype.put=function(resource, data, requestHeaders) {\n    var self=this;\n\n    return this.endpointRegistry.loadPromise.then(function() {\n        if(resource.indexOf(self.baseUrl)!==0) {\n            resource=self.baseUrl + resource;\n        }\n        return ozpIwc.util.ajax({\n            href:  resource,\n            method: 'PUT',\n\t\t\tdata: data,\n            headers: requestHeaders\n        });\n    });\n};\n\n/**\n *\n * Performs an AJAX request of DELETE for specified resource href.\n *\n * @method put\n * @param {String} resource\n * @param [Object] requestHeaders\n * @param {String} requestHeaders.name\n * @param {String} requestHeaders.value\n *\n * @returns {Promise}\n */\nozpIwc.Endpoint.prototype.delete=function(resource, data, requestHeaders) {\n    var self=this;\n\n    return this.endpointRegistry.loadPromise.then(function() {\n        if(!self.baseUrl) {\n            throw Error(\"The server did not define a relation of type \" + this.name + \" for retrivieving \" + resource);\n        }\n        if(resource.indexOf(self.baseUrl)!==0) {\n            resource=self.baseUrl + resource;\n        }\n        return ozpIwc.util.ajax({\n            href:  resource,\n            method: 'DELETE',\n            headers: requestHeaders\n        });\n    });\n};\n\n/**\n * Sends AJAX requests to PUT the specified nodes into the endpoint.\n * @todo PUTs each node individually. Currently sends to a fixed api point switch to using the node.self endpoint and remove fixed resource\n * @method saveNodes\n * @param {ozpIwc.CommonApiValue[]} nodes\n */\nozpIwc.Endpoint.prototype.saveNodes=function(nodes) {\n    var resource = \"/data\";\n    for (var node in nodes) {\n        var nodejson = JSON.stringify(nodes[node]);\n        this.put((nodes[node].self || resource), nodejson);\n    }\n};\n\n/**\n * @class EndpointRegistry\n * @namespace ozpIwc\n * @constructor\n *\n * @param {Object} config\n * @param {String} config.apiRoot the root of the api path.\n */\nozpIwc.EndpointRegistry=function(config) {\n    config=config || {};\n    var apiRoot=config.apiRoot || '/api';\n\n    /**\n     * The root path of the specified apis\n     * @property apiRoot\n     * @type String\n     * @default '/api'\n     */\n    this.apiRoot = apiRoot;\n\n    /**\n     * The collection of api endpoints\n     * @property endPoints\n     * @type Object\n     * @default {}\n     */\n    this.endPoints={};\n\n    var self=this;\n\n    /**\n     * An AJAX GET request fired at the creation of the Endpoint Registry to gather endpoint data.\n     * @property loadPromise\n     * @type Promise\n     */\n    this.loadPromise=ozpIwc.util.ajax({\n        href: apiRoot,\n        method: 'GET'\n    }).then(function(data) {\n        var payload = data.response || {};\n        payload._links = payload._links || {};\n        payload._embedded = payload._embedded || {};\n\n        for (var linkEp in payload._links) {\n            if (linkEp !== 'self') {\n                var link = payload._links[linkEp].href;\n\t\t\t\t\t\t\t\tif(Array.isArray(payload._links[linkEp])) {\n\t\t\t\t\t\t\t\t\tlink=payload._links[linkEp][0].href;\n\t\t\t\t\t\t\t\t}\n\n                self.endpoint(linkEp).baseUrl = link;\n            }\n        }\n        for (var embEp in payload._embedded) {\n            var embLink = payload._embedded[embEp]._links.self.href;\n            self.endpoint(embEp).baseUrl = embLink;\n        }\n    });\n};\n\n/**\n * Finds or creates an input with the given name.\n *\n * @method endpoint\n * @param {String} name\n * @returns {ozpIwc.Endpoint}\n */\nozpIwc.EndpointRegistry.prototype.endpoint=function(name) {\n    var endpoint=this.endPoints[name];\n    if(!endpoint) {\n        endpoint=this.endPoints[name]=new ozpIwc.Endpoint(this);\n        endpoint.name=name;\n    }\n    return endpoint;\n};\n\n/**\n * Initializes the Endpoint Registry with the api root path.\n *\n * @method initEndpoints\n * @param {String} apiRoot\n */\nozpIwc.initEndpoints=function(apiRoot) {\n    var registry=new ozpIwc.EndpointRegistry({'apiRoot':apiRoot});\n    ozpIwc.endpoint=function(name) {\n        return registry.endpoint(name);\n    };\n};\n\n","/**\n * @submodule bus.api.Type\n */\n\n/**\n * The Data Api. Provides key value storage and app state-sharing through the IWC. Subclasses the\n * {{#crossLink \"CommonApiBase\"}}{{/crossLink}}. Utilizes the {{#crossLink \"DataApiValue\"}}{{/crossLink}} which\n * subclasses the {{#crossLink \"CommonApiValue\"}}{{/crossLink}}.\n *\n * @class DataApi\n * @namespace ozpIwc\n * @extends ozpIwc.CommonApiBase\n *\n * @constructor\n * @uses DataApiValue\n * @type {Function}\n * @params {Object} config\n * @params {ozpIwc.Participant} config.participant - the participant used for the Api communication\n */\nozpIwc.DataApi = ozpIwc.util.extend(ozpIwc.CommonApiBase,function(config) {\n    ozpIwc.CommonApiBase.apply(this,arguments);\n    this.endpointUrl=ozpIwc.linkRelPrefix+\":user-data\";\n});\n\n/**\n * Loads data from the server.\n *\n * @method loadFromServer\n */\nozpIwc.DataApi.prototype.loadFromServer=function() {\n    return this.loadFromEndpoint(this.endpointUrl);\n};\n\n/**\n * Creates a DataApiValue from the given packet.\n *\n * @method makeValue\n * @param {ozpIwc.TransportPacket} packet The packet used to create an api value\n *\n * @returns {ozpIwc.DataApiValue}\n */\nozpIwc.DataApi.prototype.makeValue = function(packet){\n    return new ozpIwc.DataApiValue(packet);\n};\n\n/**\n * A middleware function used to format server data to be deserialized into Api nodes\n *\n * @method formatServerData\n * @param object\n * @returns {{object}}\n */\nozpIwc.DataApi.prototype.formatServerData = function(object){\n    return object.entity;\n};\n/**\n * Creates a child node of a given Data Api node. The child's key will be automatically generated based on its\n * parents key.\n *\n * @method createChild\n * @private\n * @param {ozpIwc.DataApiValue} node  The node of the Api to create a child of.\n * @param {ozpIwc.TransportPacketContext} packetContext The TransportPacketContext\n * containing information to build the child node.\n *\n * @returns {ozpIwc.DataApiValue} The childNode created.\n */\nozpIwc.DataApi.prototype.createChild=function(node,packetContext) {\n    var key=this.createKey(node.resource+\"/\");\n\n    // save the new child\n    var childNode=this.findOrMakeValue({'resource':key});\n    childNode.set(packetContext.packet);\n    return childNode;\n};\n\n/**\n * Sends a list of children of the specified node to the sender of the packet context.\n *\n * The sender of the packet context will receive a responding message with the following parameters:\n * ```\n * {\n *     response: 'ok',\n *     entity: [ <array of child node resources (String)> ]\n * }\n * ```\n * @method handleList\n * @param {ozpIwc.DataApiValue} node The node containing children to list.\n * @param {ozpIwc.TransportPacketContext} packetContext Packet context of the list request.\n */\nozpIwc.DataApi.prototype.handleList=function(node,packetContext) {\n    packetContext.replyTo({\n        'response': 'ok',\n        'entity': node.listChildren()\n    });\n};\n\n/**\n * Creates a child node of the given Data Api node. Creates a reference to the child node in the parent node's children\n * property.\n *\n *\n * A responding message is sent back to the sender of the packet context with the following parameters:\n * ```\n * {\n *     response: 'ok',\n *     entity: {\n *        resource: <resource(String) of the new child node>\n *     }\n * }\n * ```\n *\n * @method handleAddchild\n * @param {ozpIwc.DataApiValue} node - The parent node to add a child node to.\n * @param {ozpIwc.TransportPacketContext} packetContext - The packet context of which the child is constructed from.\n */\nozpIwc.DataApi.prototype.handleAddchild=function(node,packetContext) {\n    var childNode=this.createChild(node,packetContext);\n    if (childNode && childNode.entity && childNode.entity.persist) {\n        this.persistNode(childNode);\n    }\n\n    node.addChild(childNode.resource);\n\n    if (node && packetContext.packet.entity.persist) {\n        this.persistNode(node);\n    }\n\n    packetContext.replyTo({\n        'response':'ok',\n        'entity' : {\n            'resource': childNode.resource\n        }\n    });\n};\n\n/**\n * Removes a child node from a given parent node.\n *\n * A responding message is sent back to the sender of the packet context with the following parameters:\n * ```\n * {\n *     response: 'ok'\n * }\n * ```\n * @method handleRemovechild\n * @param {ozpIwc.DataApiValue} node - The parent node of which to remove the child node.\n * @param {ozpIwc.TransportPacketContext} packetContext - The packet context containing the child node's resource in\n * its entity.\n */\nozpIwc.DataApi.prototype.handleRemovechild=function(node,packetContext) {\n    node.removeChild(packetContext.packet.entity.resource);\n    if (node && packetContext.packet.entity.persist) {\n        this.persistNode(node);\n    }\n    var childNode=this.findOrMakeValue(packetContext.packet.entity);\n    if (childNode && childNode.entity && childNode.entity.persist) {\n        this.deleteNode(childNode);\n    }\n\n    // delegate to the handleGet call\n    packetContext.replyTo({\n        'response':'ok'\n    });\n};\n\n\n/**\n * Overrides the implementation of ozpIwc.CommonApiBase.handleSet\n * to add a node to persistent storage after setting it's value.\n *\n * @method handleSet\n * @param {ozpIwc.DataApiValue} node\n * @param {ozpIwc.PacketContext} packetContext\n */\nozpIwc.DataApi.prototype.handleSet=function(node,packetContext) {\n    ozpIwc.CommonApiBase.prototype.handleSet.apply(this,arguments);\n    if (node && packetContext.packet.entity.persist) {\n        this.persistNode(node);\n    }\n};\n\n/**\n * Overrides the implementation of ozpIwc.CommonApiBase.handleDelete\n * to delete a node from persistent storage before deleting it's value.\n *\n * @method handleDelete\n * @param {ozpIwc.DataApiValue} node\n */\nozpIwc.DataApi.prototype.handleDelete=function(node,packetContext) {\n    if (node.entity && node.entity.persist) {\n        this.deleteNode(node);\n    }\n    ozpIwc.CommonApiBase.prototype.handleDelete.apply(this,arguments);\n};\n\n/**\n * \tSaves an individual node to the persistent data store\n *\n * \t@method persistNode\n * \t@param {ozpIwc.DataApiValue} node\n */\nozpIwc.DataApi.prototype.persistNode=function(node) {\n    var endpointref= ozpIwc.endpoint(this.endpointUrl);\n    var persistNode = node.serialize();\n\n    //Watchers don't need persistence they are run time.\n    delete persistNode.watchers;\n\n    endpointref.put(node.resource, JSON.stringify(persistNode));\n};\n\n/**\n * \tDeletes an individual node from the persistent data store\n *\n * \t@method deleteNode\n * \t@param {ozpIwc.DataApiValue} node\n */\nozpIwc.DataApi.prototype.deleteNode=function(node) {\n    var endpointref= ozpIwc.endpoint(this.endpointUrl);\n    endpointref.delete(node.resource);\n};\n\n/**\n * \tCollect list of nodes to persist, send to server, reset persist flag.\n * \tCurrently sends every dirty node with a separate ajax call.\n *\n * \t@method persistNodes\n */\nozpIwc.DataApi.prototype.persistNodes=function() {\n    // collect list of nodes to persist, send to server, reset persist flag\n    var nodes=[];\n    for (var node in this.data) {\n        if ((this.data[node].dirty === true) &&\n            (this.data[node].persist === true)) {\n            nodes[nodes.length]=this.data[node].serialize();\n            this.data[node].dirty = false;\n        }\n    }\n    // send list of objects to endpoint ajax call\n    if (nodes) {\n        var endpointref= ozpIwc.EndpointRegistry.endpoint(this.endpointUrl);\n        endpointref.saveNodes(nodes);\n    }\n};\n","/**\n * @submodule bus.api.Value\n */\n\n/**\n * @class DataApiValue\n * @namespace ozpIwc\n * @extends ozpIwc.CommonApiValue\n * @constructor\n *\n * @type {Function}\n */\nozpIwc.DataApiValue = ozpIwc.util.extend(ozpIwc.CommonApiValue,function(config) {\n\tozpIwc.CommonApiValue.apply(this,arguments);\n    config = config || {};\n\n    /**\n     * @property children\n     * @type Array[String]\n     */\n\tthis.children=config.children || [];\n\n    /**\n     * @property persist\n     * @type Boolean\n     * @default true\n     */\n\tthis.persist=config.persist || true;\n\n    /**\n     * @property dirty\n     * @type Boolean\n     * @default true\n     */\n\tthis.dirty=config.dirty || true;\n});\n\n/**\n * Adds a child resource to the Data Api value.\n *\n * @method addChild\n * @param {String} child name of the child record of this\n */\nozpIwc.DataApiValue.prototype.addChild=function(child) {\n    if(this.children.indexOf(child) < 0) {\n        this.children.push(child);\n    \tthis.version++;\n    }\n\tthis.dirty= true;\n};\n\n/**\n *\n * Removes a child resource from the Data Api value.\n *\n * @method removeChild\n * @param {String} child name of the child record of this\n */\nozpIwc.DataApiValue.prototype.removeChild=function(child) {\n\tthis.dirty= true;\n\tvar originalLen=this.children.length;\n    this.children=this.children.filter(function(c) {\n        return c !== child;\n    });\n    if(originalLen !== this.children.length) {\n     \tthis.version++;\n    }\n};\n\n/**\n * Lists all children resources of the Data Api value.\n *\n * @method listChildren\n * @param {string} child name of the child record of this\n * @returns {String[]}\n */\nozpIwc.DataApiValue.prototype.listChildren=function() {\n    return ozpIwc.util.clone(this.children);\n};\n\n/**\n * Converts the Data Api value to a {{#crossLink \"ozpIwc.TransportPacket\"}}{{/crossLink}}.\n *\n * @method toPacket\n * @param {String} child name of the child record of this\n * @returns {ozpIwc.TransportPacket}\n */\nozpIwc.DataApiValue.prototype.toPacket=function() {\n\tvar packet=ozpIwc.CommonApiValue.prototype.toPacket.apply(this,arguments);\n\tpacket.links=packet.links || {};\n\tpacket.links.children=this.listChildren();\n\treturn packet;\n};\n\n/**\n * Returns a comparison of the current Data Api value to a previous snapshot.\n *\n * @method changesSince\n * @param {ozpIwc.TransportPacket} snapshot\n * @returns {Object}\n */\nozpIwc.DataApiValue.prototype.changesSince=function(snapshot) {\n    var changes=ozpIwc.CommonApiValue.prototype.changesSince.apply(this,arguments);\n\tif(changes) {\n        changes.removedChildren=snapshot.links.children.filter(function(f) {\n            return this.indexOf(f) < 0;\n        },this.children);\n        changes.addedChildren=this.children.filter(function(f) {\n            return this.indexOf(f) < 0;\n        },snapshot.links.children);\n\t}\n    return changes;\n};\n\n/**\n * Deserializes a Data Api value from a packet and constructs this Data Api value.\n *\n * @method deserialize\n * @param {ozpIwc.TransportPacket} serverData\n */\nozpIwc.DataApiValue.prototype.deserialize=function(serverData) {\n\n    ozpIwc.CommonApiValue.prototype.deserialize.apply(this,arguments);\n    var clone = ozpIwc.util.clone(serverData);\n    /**\n     * @property key\n     * @type String\n     */\n    this.key =  clone.key || this.key;\n    /**\n     * @property children\n     * @type String\n     */\n    this.children = clone.children || this.children;\n\n    /**\n     * @property self\n     * @type Object\n     */\n    this.self= clone.self || this.self;\n\n};\n\n/**\n * Serializes a Data Api value from a  Data Api value to a packet.\n *\n * @method serialize\n * @return {ozpIwc.TransportPacket}\n */\nozpIwc.DataApiValue.prototype.serialize=function() {\n\tvar serverData = {};\n\tserverData.entity=this.entity;\n    serverData.children = this.children;\n\tserverData.contentType=this.contentType;\n\tserverData.permissions=this.permissions;\n\tserverData.version=this.version;\n\tserverData.self=this.self;\n    serverData.watchers =this.watchers;\n\treturn serverData;\n};\n\n","/**\n * @submodule bus.api.Type\n */\n\n/**\n * The Intents Api. Provides Android-like intents through the IWC. Subclasses the\n * {{#crossLink \"CommonApiBase\"}}{{/crossLink}} Utilizes the following value classes which subclass the\n * {{#crossLink \"CommonApiValue\"}}{{/crossLink}}:\n *  - {{#crossLink \"intentsApiDefinitionValue\"}}{{/crossLink}}\n *  - {{#crossLink \"intentsApiHandlerValue\"}}{{/crossLink}}\n *  - {{#crossLink \"intentsApiTypeValue\"}}{{/crossLink}}\n *\n * @class IntentsApi\n * @namespace ozpIwc\n * @extends CommonApiBase\n * @constructor\n *\n * @params config {Object}\n * @params config.href {String} URI of the server side Data storage to load the Intents Api with\n * @params config.loadServerData {Boolean} Flag to load server side data.\n * @params config.loadServerDataEmbedded {Boolean} Flag to load embedded version of server side data.\n *                                                  Takes precedence over config.loadServerData\n */\nozpIwc.IntentsApi = ozpIwc.util.extend(ozpIwc.CommonApiBase, function (config) {\n    ozpIwc.CommonApiBase.apply(this, arguments);\n\n    this.addDynamicNode(new ozpIwc.CommonApiCollectionValue({\n        resource: \"/ozpIntents/invocations\",\n        pattern: /^\\/ozpIntents\\/invocations\\/.*$/,\n        contentType: \"application/vnd.ozp-iwc-intent-invocation-list-v1+json\"\n    }));\n});\n\n/**\n * Loads data from the server.\n *\n * @method loadFromServer\n */\nozpIwc.IntentsApi.prototype.loadFromServer=function() {\n    return this.loadFromEndpoint(ozpIwc.linkRelPrefix + \":intent\");\n};\n/**\n * Takes the resource of the given packet and creates an empty value in the IntentsApi. Chaining of creation is\n * accounted for (A handler requires a definition, which requires a capability).\n *\n * @param {Object} packet\n *\n * @returns {IntentsApiHandlerValue|IntentsAPiDefinitionValue|IntentsApiCapabilityValue}\n */\nozpIwc.IntentsApi.prototype.makeValue = function (packet) {\n    // resource of form /majorType/minorType/action?/handler?\n    var path=packet.resource.split(/\\//);\n    path.shift(); // shift off the empty element before the first slash\n    var self=this;\n    var createType=function(resource) {\n        var node=new ozpIwc.IntentsApiTypeValue({\n            resource: resource,\n            intentType: path[0] + \"/\" + path[1]                \n        });\n        self.addDynamicNode(node);\n        return node;\n    };\n    var createDefinition=function(resource) {\n        var type=\"/\" +path[0]+\"/\" + path[1];\n        if(!self.data[type]) {\n            self.data[type]=createType(type);\n        }\n        var node=new ozpIwc.IntentsApiDefinitionValue({\n            resource: resource,\n            intentType: path[0]+\"/\" + path[1],\n            intentAction: path[2]\n        });\n        self.addDynamicNode(node);\n        return node;\n    };\n    var createHandler=function(resource) {\n        var definition=\"/\" +path[0]+\"/\" + path[1] + \"/\" + path[2];\n        if(!self.data[definition]) {\n            self.data[definition]=createDefinition(definition);\n        }\n        \n        return new ozpIwc.IntentsApiHandlerValue({\n            resource: resource,\n            intentType: path[0] + \"/\" + path[1],\n            intentAction: path[2]\n        });\n    };\n    \n    switch (path.length) {\n        case 2:\n            return createType(packet.resource);\n        case 3:\n\n            return createDefinition(packet.resource);\n        case 4:\n            return createHandler(packet.resource);\n        default:\n            throw new ozpIwc.ApiError(\"badResource\",\"Invalid resource: \" + packet.resource);\n    }\n};\n\nozpIwc.IntentsApi.prototype.makeIntentInvocation = function (node,packetContext){\n    var resource = this.createKey(\"/ozpIntents/invocations/\");\n\n    var inflightPacket = new ozpIwc.IntentsApiInFlightIntent({\n        resource: resource,\n        invokePacket:packetContext.packet,\n        contentType: node.contentType,\n        type: node.entity.type,\n        action: node.entity.action,\n        entity: packetContext.packet.entity,\n        handlerChoices: node.getHandlers(packetContext)\n    });\n\n    this.data[inflightPacket.resource] = inflightPacket;\n\n    return inflightPacket;\n};\n\n/**\n * Creates and registers a handler to the given definition resource path.\n *\n * @method handleRegister\n * @param {Object} node the handler value to register, or the definition value the handler will register to\n * (handler will receive a generated key if definition value is provided).\n * @param {ozpIwc.TransportPacketContext} packetContext the packet received by the router.\n */\nozpIwc.IntentsApi.prototype.handleRegister = function (node, packetContext) {\n    var key=this.createKey(node.resource+\"/\"); //+packetContext.packet.src;\n\n    // save the new child\n    var childNode=this.findOrMakeValue({'resource':key});\n    var clone = ozpIwc.util.clone(childNode);\n    clone.permissions = childNode.permissions.getAll();\n    packetContext.packet.entity.invokeIntent = packetContext.packet.entity.invokeIntent || {};\n    packetContext.packet.entity.invokeIntent.dst = packetContext.packet.src;\n    packetContext.packet.entity.invokeIntent.replyTo = packetContext.packet.msgId;\n\n    for(var i in packetContext.packet.entity){\n        clone.entity[i] = packetContext.packet.entity[i];\n    }\n    childNode.set(clone);\n\n    packetContext.replyTo({\n        'response':'ok',\n        'entity' : {\n            'resource': childNode.resource\n        }\n    });\n};\n\n/**\n * Invokes all handlers for the given intent.\n *\n * @method handleBroadcast\n * @param {Object} node the definition or handler value used to invoke the intent.\n * @param {ozpIwc.TransportPacketContext} packetContext the packet received by the router.\n */\nozpIwc.IntentsApi.prototype.handleBroadcast = function (node, packetContext) {\n    if(typeof(node.getHandlers) !== \"function\") {\n        throw new ozpIwc.ApiError(\"badResource\",\"Resource is not an invokable intent\");\n    }\n\n    var handlerNodes=node.getHandlers(packetContext);\n\n    var self = this;\n    handlerNodes.forEach(function(handler){\n\n        var inflightPacket = self.makeIntentInvocation(node,packetContext);\n\n        var updateInFlightEntity =inflightPacket.toPacket();\n        updateInFlightEntity.entity.handlerChosen = {\n            'resource' : handler.resource,\n            'reason' : \"broadcast\"\n        };\n\n        updateInFlightEntity.entity.state = \"delivering\";\n\n        inflightPacket.set(updateInFlightEntity);\n\n        self.invokeIntentHandler(handler,packetContext,inflightPacket);\n    });\n};\n\n/**\n * Invokes the appropriate handler for the intent from one of the following methods:\n *  <li> user preference specifies which handler to use. </li>\n *  <li> by prompting the user to select which handler to use. </li>\n *  <li> by receiving a handler resource instead of a definition resource </li>\n *  @todo <li> user preference specifies which handler to use. </li>\n *  @todo <li> by prompting the user to select which handler to use. </li>\n *\n * @method handleInvoke\n * @param {Object} node the definition or handler value used to invoke the intent.\n * @param {ozpIwc.TransportPacketContext} packetContext the packet received by the router.\n */\nozpIwc.IntentsApi.prototype.handleInvoke = function (node, packetContext) {\n    if(typeof(node.getHandlers) !== \"function\") {\n        throw new ozpIwc.ApiError(\"badResource\",\"Resource is not an invokable intent\");\n    }\n    \n    var handlerNodes=node.getHandlers(packetContext);\n\n    var inflightPacket = this.makeIntentInvocation(node,packetContext);\n\n    if(handlerNodes.length === 1) {\n        var updateInFlightEntity = inflightPacket.toPacket();\n        updateInFlightEntity.entity.handlerChosen = {\n            'resource' : handlerNodes[0].resource,\n            'reason' : \"onlyOne\"\n        };\n\n        updateInFlightEntity.entity.state = \"delivering\";\n        inflightPacket.set(updateInFlightEntity);\n\n        this.invokeIntentHandler(handlerNodes[0],packetContext,inflightPacket);\n    } else {\n        this.chooseIntentHandler(node,packetContext,inflightPacket);\n    }\n};\n\n/**\n * Invokes the appropriate handler for set actions. If the action pertains to an In-Flight Intent, the state of the\n * entity is used to determine how the action is handled.\n *\n * @method handleSet\n * @param node\n * @param packetContext\n */\nozpIwc.IntentsApi.prototype.handleSet = function (node, packetContext) {\n    if(packetContext.packet.contentType === \"application/vnd.ozp-iwc-intent-invocation-v1+json\"){\n\n        var badActionResponse = {\n            'response': 'badAction',\n            'entity': {\n                'reason': \"cannot drive inFlightIntent state transition\",\n                'state': node.entity.state,\n                'requestedState': packetContext.packet.entity.state\n            }\n        };\n\n        switch (packetContext.packet.entity.state){\n            case \"new\":\n                // shouldn't be set externally\n                packetContext.replyTo(badActionResponse);\n                break;\n            case \"choosing\":\n                this.handleInFlightChoose(node,packetContext);\n                break;\n            case \"delivering\":\n                // shouldn't be set externally\n                packetContext.replyTo({'response':'badAction'});\n                break;\n            case \"running\":\n                this.handleInFlightRunning(node,packetContext);\n                break;\n            case \"fail\":\n                this.handleInFlightFail(node,packetContext);\n                break;\n            case \"complete\":\n                this.handleInFlightComplete(node,packetContext);\n                break;\n            default:\n                if(node.acceptedStates.indexOf(packetContext.packet.entity.state) < 0){\n                    packetContext.replyTo(badActionResponse);\n                }\n        }\n    } else {\n        ozpIwc.CommonApiBase.prototype.handleSet.apply(this, arguments);\n    }\n};\n\n\n/**\n *\n * @TODO (DOC)\n * @method handleDelete\n * @param {ozpIwc.CommonApiValue} node @TODO (DOC)\n * @param {ozpIwc.TransportPacketContext} packetContext @TODO (DOC)\n */\nozpIwc.IntentsApi.prototype.handleDelete=function(node,packetContext) {\n    delete this.data[node.resource];\n    packetContext.replyTo({'response':'ok'});\n};\n\n/**\n * Invokes an Intent Api Intent handler based on the given packetContext.\n *\n * @method invokeIntentHandler\n * @param {ozpIwc.intentsApiHandlerValue} node\n * @param {ozpIwc.TransportPacket} packetContext\n */\nozpIwc.IntentsApi.prototype.invokeIntentHandler = function (handlerNode, packetContext,inFlightIntent) {\n    inFlightIntent = inFlightIntent || {};\n\n    var packet = handlerNode.entity.invokeIntent;\n    packet.entity = packet.entity || {};\n    packet.entity.inFlightIntent = inFlightIntent.resource;\n\n    var self = this;\n    this.participant.send(packet,function(response,done) {\n        var blacklist=['src','dst','msgId','replyTo'];\n        var packet={};\n        for(var k in response) {\n            if(blacklist.indexOf(k) === -1) {\n                packet[k]=response[k];\n            }\n        }\n        self.participant.send({\n            replyTo: packet.msgId,\n            dst: packet.src,\n            response: 'ok',\n            entity: packet\n        });\n        packetContext.replyTo(packet);\n        done();\n    });\n};\n\n/**\n * Produces a modal for the user to select a handler from the given list of intent handlrs.\n * @TODO not implemented.\n *\n * @method chooseIntentHandler\n * @param {ozpIwc.intentsApiHandlerValue[]} nodeList\n * @param {ozpIwc.TransportPacket} packetContext\n */\nozpIwc.IntentsApi.prototype.chooseIntentHandler = function (node, packetContext,inflightPacket) {\n\n\n    inflightPacket.entity.state = \"choosing\";\n    ozpIwc.util.openWindow(\"intentsChooser.html\",{\n       \"ozpIwc.peer\":ozpIwc.BUS_ROOT,\n       \"ozpIwc.intentSelection\": \"intents.api\"+inflightPacket.resource\n    });\n};\n\n/**\n * Handles removing participant registrations from intent handlers when said participant disconnects.\n *\n * @method handleEventChannelDisconnectImpl\n * @param packetContext\n */\nozpIwc.IntentsApi.prototype.handleEventChannelDisconnectImpl = function (packetContext) {\n    for(var node in this.data){\n        if(this.data[node] instanceof ozpIwc.IntentsApiHandlerValue) {\n            if(this.data[node].entity.invokeIntent.dst === packetContext.packet.entity.address) {\n                delete this.data[node];\n            }\n        }\n    }\n\n    for(var dynNode in this.dynamicNodes) {\n        var resource = this.dynamicNodes[dynNode];\n        this.updateDynamicNode(this.data[resource]);\n    }\n};\n\n\n/**\n * Handles in flight intent set actions with a state of \"choosing\"\n * @private\n * @method handleInFlightChoose\n * @param node\n * @param packetContext\n * @returns {null}\n */\nozpIwc.IntentsApi.prototype.handleInFlightChoose = function (node, packetContext) {\n\n    if(node.entity.state !== \"choosing\"){\n        return null;\n    }\n\n    var handlerNode = this.data[packetContext.packet.entity.resource];\n    if(!handlerNode){\n        return null;\n    }\n\n    if(node.acceptedReasons.indexOf(packetContext.packet.entity.reason) < 0){\n        return null;\n    }\n\n    var updateNodeEntity = ozpIwc.util.clone(node);\n\n    updateNodeEntity.entity.handlerChosen = {\n        'resource' : packetContext.packet.entity.resource,\n        'reason' : packetContext.packet.entity.reason\n    };\n    updateNodeEntity.entity.state = \"delivering\";\n    node.set(updateNodeEntity);\n\n    this.invokeIntentHandler(handlerNode,packetContext,node);\n\n    packetContext.replyTo({\n        'response':'ok'\n    });\n};\n\n/**\n * Handles in flight intent set actions with a state of \"running\"\n *\n * @private\n * @method handleInFlightRunning\n * @param node\n * @param packetContext\n */\nozpIwc.IntentsApi.prototype.handleInFlightRunning = function (node, packetContext) {\n    var updateNodeEntity = ozpIwc.util.clone(node);\n    updateNodeEntity.entity.state = \"running\";\n    updateNodeEntity.entity.handler.address = packetContext.packet.entity.address;\n    updateNodeEntity.entity.handler.resource = packetContext.packet.entity.resource;\n    node.set(updateNodeEntity);\n    packetContext.replyTo({\n        'response':'ok'\n    });\n\n\n};\n\n/**\n * Handles in flight intent set actions with a state of \"fail\"\n *\n * @private\n * @method handleInFlightFail\n * @param node\n * @param packetContext\n */\nozpIwc.IntentsApi.prototype.handleInFlightFail = function (node, packetContext) {\n    var invokePacket = node.invokePacket;\n    var updateNodeEntity = ozpIwc.util.clone(node);\n\n    updateNodeEntity.entity.state = packetContext.packet.entity.state;\n    updateNodeEntity.entity.reply.contentType = packetContext.packet.entity.reply.contentType;\n    updateNodeEntity.entity.reply.entity = packetContext.packet.entity.reply.entity;\n\n    node.set(updateNodeEntity);\n\n    var snapshot = node.snapshot();\n\n    this.handleDelete(node,packetContext);\n\n    this.notifyWatchers(node, node.changesSince(snapshot));\n\n    packetContext.replyTo({\n        'response':'ok'\n    });\n\n    this.participant.send({\n        replyTo: invokePacket.msgId,\n        dst: invokePacket.src,\n        response: 'ok',\n        entity: {\n            response: node.entity.reply,\n            invoked: false\n        }\n    });\n};\n\n/**\n * Handles in flight intent set actions with a state of \"complete\"\n *\n * @private\n * @method handleInFlightComplete\n * @param node\n * @param packetContext\n */\nozpIwc.IntentsApi.prototype.handleInFlightComplete = function (node, packetContext) {\n    var invokePacket = node.invokePacket;\n    var updateNodeEntity = ozpIwc.util.clone(node);\n\n    updateNodeEntity.entity.state = packetContext.packet.entity.state;\n    updateNodeEntity.entity.reply.contentType = packetContext.packet.entity.reply.contentType;\n    updateNodeEntity.entity.reply.entity = packetContext.packet.entity.reply.entity;\n\n    node.set(updateNodeEntity);\n\n    var snapshot = node.snapshot();\n\n    this.handleDelete(node,packetContext);\n\n    this.notifyWatchers(node, node.changesSince(snapshot));\n\n    packetContext.replyTo({\n        'response':'ok'\n    });\n\n    this.participant.send({\n        replyTo: invokePacket.msgId,\n        dst: invokePacket.src,\n        response: 'ok',\n        entity: {\n            response: node.entity.reply,\n            invoked: true\n        }\n    });\n};\n/**\n * Sets the APIs data property. Removes current values, then constructs each API value anew.\n *\n * @method setState\n * @param {Object} state The object containing key value pairs to set as this api's state.\n */\nozpIwc.IntentsApi.prototype.setState = function(state) {\n    this.data = {};\n    this.dynamicNodes = state.dynamicNodes;\n    for (var key in state.data) {\n        var node = this.findOrMakeValue({\n            resource: key,\n            contentType: state.data[key].contentType\n        });\n        node.deserialize(state.data[key]);\n    }\n    // update all the collection values\n    this.dynamicNodes.forEach(function(resource) {\n        this.updateDynamicNode(this.data[resource]);\n    },this);\n};","/**\n * @submodule bus.api.Value\n */\n\n/**\n * The capability value for an intent. adheres to the application/vnd.ozp-iwc-intent-definition-v1+json content type.\n * @class IntentsApiDefinitionValue\n * @namespace ozpIwc\n * @extends ozpIwc.CommonApiValue\n * @constructor\n *\n * @param {Object} config\n *@param {Object} config.entity\n * @param {String} config.entity.definitions the list of definitions in this intent capability.\n */\nozpIwc.IntentsApiDefinitionValue = ozpIwc.util.extend(ozpIwc.CommonApiValue, function (config) {\n    config=config || {};\n    config.allowedContentTypes=[\"application/vnd.ozp-iwc-intent-definition-v1+json\"];\n    config.contentType=\"application/vnd.ozp-iwc-intent-definition-v1+json\";\n    ozpIwc.CommonApiValue.call(this, config);\n\n    /**\n     * @property pattern\n     * @type RegExp\n     */\n    this.pattern=new RegExp(ozpIwc.util.escapeRegex(this.resource)+\"/[^/]*\");\n    this.pattern.toJSON = RegExp.prototype.toString;\n    this.handlers=[];\n    this.entity={\n        type: config.intentType,\n        action: config.intentAction,        \n        handlers: []\n    };\n});\n\n/**\n * Returns true if the definition value contains a reference to the node specified.\n *\n * @method isUpdateNeeded\n * @param {ozpIwc.CommonApiValue} node\n * @returns {Boolean}\n */\nozpIwc.IntentsApiDefinitionValue.prototype.isUpdateNeeded=function(node) {\n    return this.pattern.test(node.resource);\n};\n\n/**\n * Updates the Intents Api Definition value with a list of changed handlers.\n *\n * @method updateContent\n * @param {String[]} changedNodes\n */\nozpIwc.IntentsApiDefinitionValue.prototype.updateContent=function(changedNodes) {\n    this.version++;\n    this.handlers=changedNodes;\n    this.entity.handlers=changedNodes.map(function(changedNode) { \n        return changedNode.resource; \n    });\n};\n\n/**\n * Returns the list of handlers registered to the definition value.\n *\n * @method getHandlers\n * @param packetContext\n * @returns {*[]}\n */\nozpIwc.IntentsApiDefinitionValue.prototype.getHandlers=function(packetContext) {\n    return this.handlers;\n};\n\n/**\n * Handles deserializing an {{#crossLink \"ozpIwc.TransportPacket\"}}{{/crossLink}} and setting this value with\n * the contents.\n *\n * @method deserialize\n * @param {ozpIwc.TransportPacket} serverData\n */\nozpIwc.IntentsApiDefinitionValue.prototype.deserialize=function(serverData) {\n    var clone = ozpIwc.util.clone(serverData);\n// we need the persistent data to conform with the structure of non persistent data.\n    this.entity= clone.entity || {};\n\n    this.pattern = (typeof clone.pattern === \"string\") ? new RegExp(clone.pattern.replace(/^\\/|\\/$/g, '')) : this.pattern;\n    this.pattern.toJSON = RegExp.prototype.toString;\n\n    this.contentType=clone.contentType || this.contentType;\n    this.permissions=clone.permissions || this.permissions;\n    this.version=clone.version || this.version;\n    this.watchers = clone.watchers || this.watchers;\n};\n\n/**\n * Serializes a Intent Api Definition value to a packet.\n *\n * @method serialize\n * @return {ozpIwc.TransportPacket}\n */\nozpIwc.IntentsApiDefinitionValue.prototype.serialize=function() {\n    var serverData = {};\n    serverData.entity=this.entity;\n    serverData.pattern=this.pattern;\n    serverData.contentType=this.contentType;\n    serverData.permissions=this.permissions;\n    serverData.version=this.version;\n    serverData.watchers=this.watchers;\n    return serverData;\n};\n","/**\n * @submodule bus.api.Value\n */\n/**\n * The capability value for an intent. adheres to the ozpIwc-intents-type-capabilities-v1+json content type.\n * @class IntentsApiHandlerValue\n * @namespace ozpIwc\n * @extends ozpIwc.CommonApiValue\n * @constructor\n *\n * @param {Object} config\n *@param {Object} config.entity\n * @param {String} config.entity.definitions the list of definitions in this intent capability.\n */\nozpIwc.IntentsApiHandlerValue = ozpIwc.util.extend(ozpIwc.CommonApiValue, function (config) {\n    config=config || {};\n    config.allowedContentTypes=[\"application/vnd.ozp-iwc-intent-handler-v1+json\"];\n    config.contentType=\"application/vnd.ozp-iwc-intent-handler-v1+json\";\n    ozpIwc.CommonApiValue.apply(this, arguments);\n    this.entity={\n        type: config.intentType,\n        action: config.intentAction\n    };\n});\n\n/**\n * Returns this handler wrapped in an Array.\n *\n * @method getHandlers\n * @param {ozpIwc.TransportPacket} packetContext\n * @todo packetContext not needed, left for signature matching of base class?\n * @returns {ozpIwc.intentsApiHandlerValue[]}\n */\nozpIwc.IntentsApiHandlerValue.prototype.getHandlers=function(packetContext) {\n    return [this];\n};\n\n/**\n * Sets the entity value of this handler.\n *\n * @method set\n * @param {ozpIwc.TransportPacket} packet\n */\nozpIwc.IntentsApiHandlerValue.prototype.set=function(packet) {\n    ozpIwc.CommonApiValue.prototype.set.apply(this,arguments);\n    this.entity.invokeIntent = this.entity.invokeIntent  || {};\n    this.entity.invokeIntent.dst = this.entity.invokeIntent.dst || packet.src;\n    this.entity.invokeIntent.resource = this.entity.invokeIntent.resource || \"/intents\" + packet.resource;\n    this.entity.invokeIntent.action = this.entity.invokeIntent.action || \"invoke\";\n};\n","/**\n * @submodule bus.api.Value\n */\n\n/**\n * The capability value for an intent. adheres to the ozp-intents-type-capabilities-v1+json content type.\n * @class IntentsApiTypeValue\n * @namespace ozpIwc\n * @extends ozpIwc.CommonApiValue\n * @constructor\n *\n * @param {Object} config\n *@param {Object} config.entity\n * @param {String} config.entity.definitions the list of definitions in this intent capability.\n */\nozpIwc.IntentsApiInFlightIntent = ozpIwc.util.extend(ozpIwc.CommonApiValue, function (config) {\n    config=config || {};\n    config.contentType=\"application/vnd.ozp-iwc-intent-invocation-v1+json\";\n    config.allowedContentTypes=[config.contentType];\n\n    ozpIwc.CommonApiValue.apply(this, arguments);\n    this.resource = config.resource;\n    this.invokePacket=config.invokePacket;\n    //for (var i in config.invokePacket.permissions) {\n    //    this.permissions.pushIfNotExist(i,config.invokePacket.permissions[i]);\n    //}\n    this.entity={\n        'intent': {\n            'type': config.type,\n            'action': config.action,\n        },\n        'contentType' : config.contentType,\n        'entity': config.entity,\n        'state' : \"new\", // new, choosing, running, error, complete\n        'status' : \"ok\", // noHandlerRegistered, noHandlerChosen\n        'handlerChoices': config.handlerChoices || [],\n        'handlerChosen': {\n            'resource' : null, // e.g. \"intents.api/text/plain/12345\"\n            'reason' : null // how the handler was chosen: \"user\", \"pref\", \"onlyOne\"\n        },\n        'handler': {\n            'resource': null, // e.g. \"names.api/address/45678\"\n            'address': null   // e.g. \"45678\"\n        },\n        'reply': {\n            'contentType': null,\n            'entity': null\n        }\n\n    };\n});\n\nozpIwc.IntentsApiInFlightIntent.prototype.acceptedReasons = [\"user\",\"pref\",\"onlyOne\",\"broadcast\"];\nozpIwc.IntentsApiInFlightIntent.prototype.acceptedStates = [\"new\",\"choosing\",\"delivering\",\"running\",\"error\",\"complete\"];\n","/**\n * @submodule bus.api.Value\n */\n\n/**\n * The capability value for an intent. adheres to the application/vnd.ozp-iwc-intent-type-v1+json content type.\n * @class IntentsApiTypeValue\n * @namespace ozpIwc\n * @extends ozpIwc.CommonApiValue\n * @constructor\n *\n * @param {Object} config\n *@param {Object} config.entity\n * @param {String} config.entity.definitions the list of definitions in this intent capability.\n */\nozpIwc.IntentsApiTypeValue = ozpIwc.util.extend(ozpIwc.CommonApiValue, function (config) {\n    config=config || {};\n    config.allowedContentTypes=[\"application/vnd.ozp-iwc-intent-type-v1+json\"];\n    config.contentType=\"application/vnd.ozp-iwc-intent-type-v1+json\";\n\n    ozpIwc.CommonApiValue.apply(this, arguments);\n\n    /**\n     * @property pattern\n     * @type RegExp\n     */\n    this.pattern=new RegExp(this.resource.replace(\"$\",\"\\\\$\").replace(\".\",\"\\\\.\")+\"\\/[^/]*$\");\n    this.pattern.toJSON = RegExp.prototype.toString;\n    this.entity={\n        'type': config.intentType,\n        'actions': []\n    };\n});\n\n/**\n * Returns true if the type value contains a reference to the node specified\n *\n * @method isUpdateNeeded\n * @param {ozpIwc.CommonApiValue} node\n * @returns {Boolean}\n */\nozpIwc.IntentsApiTypeValue.prototype.isUpdateNeeded=function(node) {\n    return this.pattern.test(node.resource);\n};\n\n/**\n * Updates the Intents Api Type value with a list of changed definitions.\n *\n * @method updateContent\n * @param {String[]} changedNodes\n */\nozpIwc.IntentsApiTypeValue.prototype.updateContent=function(changedNodes) {\n    this.version++;\n    this.entity.actions=changedNodes.map(function(changedNode) { \n        return changedNode.resource; \n    });\n};\n\n/**\n * Handles deserializing an {{#crossLink \"ozpIwc.TransportPacket\"}}{{/crossLink}} and setting this value with\n * the contents.\n *\n * @method deserialize\n * @param {ozpIwc.TransportPacket} serverData\n */\nozpIwc.IntentsApiTypeValue.prototype.deserialize=function(serverData) {\n    ozpIwc.IntentsApiDefinitionValue.prototype.deserialize.apply(this, arguments);\n};\n\n/**\n * Serializes a Intents Api Type value to a packet.\n *\n * @method serialize\n * @return {ozpIwc.TransportPacket}\n */\nozpIwc.IntentsApiTypeValue.prototype.serialize=function() {\n    return  ozpIwc.IntentsApiDefinitionValue.prototype.serialize.apply(this,arguments);\n};\n","/**\n * @submodule bus.api.Type\n */\n\n/**\n * The Names Api. Collects information about current IWC state, Manages names, aliases, and permissions through the IWC.\n * Subclasses the {{#crossLink \"ozpIwc.CommonApiBase\"}}{{/crossLink}}. Utilizes the\n * {{#crossLink \"ozpIwc.NamesApiValue\"}}{{/crossLink}} which subclasses the\n * {{#crossLink \"ozpIwc.CommonApiValue\"}}{{/crossLink}}.\n *\n * @class NamesApi\n * @namespace ozpIwc\n * @extends ozpIwc.CommonApiBase\n * @constructor\n *\n * @type {Function}\n */\nozpIwc.NamesApi = ozpIwc.util.extend(ozpIwc.CommonApiBase, function(config) {\n    ozpIwc.CommonApiBase.apply(this, arguments);\n\n    /**\n     * How often a heartbeat message should occur.\n     * @property heartbeatFrequency\n     * @type {Number}\n     * @default 10000\n     */\n    this.heartbeatFrequency = config.heartbeatFrequency || 10000;\n\n    /**\n     * The amount of heartbeats to drop an unresponsive participant after\n     * @property heartbeatDropCount\n     * @type {number|*}\n     * @default 3\n     */\n    this.heartbeatDropCount = config.heartbeatDropCount || 3;\n    // map the alias \"/me\" to \"/address/{packet.src}\" upon receiving the packet\n    this.on(\"receive\", function (packetContext) {\n        var packet = packetContext.packet;\n        if (packet.resource) {\n            packet.resource = packet.resource.replace(/$\\/me^/, packetContext.packet.src);\n        }\n    });\n\n    this.addDynamicNode(new ozpIwc.CommonApiCollectionValue({\n        resource: \"/address\",\n        pattern: /^\\/address\\/.*$/,\n        contentType: \"application/vnd.ozp-iwc-address-list-v1+json\"\n    }));\n    this.addDynamicNode(new ozpIwc.CommonApiCollectionValue({\n        resource: \"/multicast\",\n        pattern: /^\\/multicast\\/[^\\/\\n]*$/,\n        contentType: \"application/vnd.ozp-iwc-multicast-list-v1+json\"\n    }));\n    this.addDynamicNode(new ozpIwc.CommonApiCollectionValue({\n        resource: \"/router\",\n        pattern: /^\\/router\\/.*$/,\n        contentType: \"application/vnd.ozp-iwc-router-list-v1+json\"\n    }));\n    this.addDynamicNode(new ozpIwc.CommonApiCollectionValue({\n        resource: \"/api\",\n        pattern: /^\\/api\\/.*$/,\n        contentType: \"application/vnd.ozp-iwc-api-list-v1+json\"\n    }));\n    //temporary injector code. Remove when api loader is implemented\n    var packet = {\n        resource: '/api/data.api',\n        entity: {'actions': ['get', 'set', 'delete', 'watch', 'unwatch', 'addChild', 'removeChild', 'list']},\n        contentType: 'application/vnd.ozp-iwc-api-v1+json'\n    };\n    var node=this.findOrMakeValue(packet);\n    node.set(packet);\n    packet = {\n        resource: '/api/intents.api',\n        entity: {'actions': ['get','set','delete','watch','unwatch','register','invoke','broadcast', 'list']},\n        contentType: 'application/vnd.ozp-iwc-api-v1+json'\n    };\n    node=this.findOrMakeValue(packet);\n    node.set(packet);\n    packet = {\n        resource: '/api/names.api',\n        entity: {'actions': ['get','set','delete','watch','unwatch', 'list']},\n        contentType: 'application/vnd.ozp-iwc-api-v1+json'\n    };\n    node=this.findOrMakeValue(packet);\n    node.set(packet);\n    packet = {\n        resource: '/api/system.api',\n        entity: { 'actions': ['get','set','delete','watch','unwatch', 'list', 'launch']},\n        contentType: 'application/vnd.ozp-iwc-api-v1+json'\n    };\n    node=this.findOrMakeValue(packet);\n    node.set(packet);\n    var self = this;\n    this.dynamicNodes.forEach(function(resource) {\n        self.updateDynamicNode(self.data[resource]);\n    });\n    setInterval(function(){\n        self.removeDeadNodes();\n    },this.heartbeatFrequency);\n});\n\nozpIwc.NamesApi.prototype.removeDeadNodes = function(){\n    for(var key in this.data){\n        var node = this.data[key];\n        if(this.dynamicNodes.indexOf(key) < 0 && node.entity && node.entity.time) {\n            if ((ozpIwc.util.now() - node.entity.time) > this.heartbeatFrequency * this.heartbeatDropCount) {\n                var snapshot = node.snapshot();\n                node.deleteData();\n                this.notifyWatchers(node, node.changesSince(snapshot));\n                delete this.data[key];\n                // update all the collection values\n                /*jshint loopfunc:true*/\n                this.dynamicNodes.forEach(function(resource) {\n                    this.updateDynamicNode(this.data[resource]);\n                },this);\n            }\n        }\n    }\n};\n/**\n * Checks that the given packet context's resource meets the requirements of the api. Throws exception if fails\n * validation\n *\n * @method validateResource\n * @param {CommonApiValue} node @TODO is a node needed to validate?\n * @param {ozpIwc.TransportPacketContext} packetContext The packetContext with the resource to be validated.\n */\nozpIwc.NamesApi.prototype.validateResource=function(node,packetContext) {\n    if(packetContext.packet.resource && !packetContext.packet.resource.match(/^\\/(api|address|multicast|router|me)/)){\n        throw new ozpIwc.ApiError('badResource',\"Invalide resource for name.api: \" + packetContext.packet.resource);\n    }\n};\n\n/**\n * Makes a {{#crossLink \"ozpIwc.NamesApiValue\"}}{{/crossLink}} from the given packet.\n *\n * @method makeValue\n * @param {ozpIwc.TransportPacket} packet\n * @returns {ozpIwc.NamesApiValue}\n */\nozpIwc.NamesApi.prototype.makeValue = function(packet) {\n    var path=packet.resource.split(\"/\");\n    var config={\n        resource: packet.resource,\n        contentType: packet.contentType\n    };\n    switch (packet.contentType) {\n        case \"application/vnd.ozp-iwc-api-v1+json\":\n            config.allowedContentTypes=[\"application/vnd.ozp-iwc-api-v1+json\"];\n            break;\n        case \"application/vnd.ozp-iwc-multicast-address-v1+json\":\n            config.allowedContentTypes=[\"application/vnd.ozp-iwc-multicast-address-v1+json\"];\n            if(path.length >= 3){\n                var resource = '/' + path[1] + '/' + path[2];\n                if(this.dynamicNodes.indexOf(resource) < 0){\n                    this.addDynamicNode(new ozpIwc.CommonApiCollectionValue({\n                        resource: resource,\n                        pattern: new RegExp(\"^\\/\" + path[1].replace(\"$\",\"\\\\$\").replace(\".\",\"\\\\.\") + \"\\/\" +\n                            path[2].replace(\"$\",\"\\\\$\").replace(\".\",\"\\\\.\") + \"\\/.*$\"),\n                        contentType: \"application/vnd.ozp-iwc-address-list-v1+json\"\n                    }));\n                }\n            }\n            break;\n        case \"application/vnd.ozp-iwc-address-v1+json\":\n            config.allowedContentTypes=[\"application/vnd.ozp-iwc-address-v1+json\"];\n            break;\n        case \"application/vnd.ozp-iwc-router-v1+json\":\n            config.allowedContentTypes=[\"application/vnd.ozp-iwc-router-v1+json\"];\n            break;\n\n        default:\n            throw new ozpIwc.ApiError(\"badContent\",\"Not a valid contentType of names.api: \" + path[1] + \" in \" + packet.resource);\n    }\n    return new ozpIwc.NamesApiValue(config);\n};\n\n/**\n * Handles removing participant addresses from the names api.\n *\n * @method handleEventChannelDisconnectImpl\n * @param packetContext\n */\nozpIwc.NamesApi.prototype.handleEventChannelDisconnectImpl = function (packetContext) {\n\n    delete this.data[packetContext.packet.entity.namesResource];\n\n    for(var node in this.dynamicNodes) {\n        var resource = this.dynamicNodes[node];\n        this.updateDynamicNode(this.data[resource]);\n    }\n};\n","/**\n * @submodule bus.api.Value\n */\n\n/**\n * @class NamesApiValue\n * @namespace ozpIwc\n * @extends ozpIwc.CommonApiValue\n * @constructor\n *\n * @type {Function}\n * @param {Object} config\n * @param {String[]} config.allowedContentTypes a list of content types this Names Api value will accept.\n */\nozpIwc.NamesApiValue = ozpIwc.util.extend(ozpIwc.CommonApiValue,function(config) {\n    if(!config || !config.allowedContentTypes) {\n        throw new Error(\"NamesAPIValue must be configured with allowedContentTypes.\");\n    }\n\tozpIwc.CommonApiValue.apply(this,arguments);\n});\n","var ozpIwc=ozpIwc || {};\n\n/**\n * @submodule bus.api.Type\n */\n\n/**\n * The System Api. Provides reference data of registered applications, versions, and information about the current user\n * through the IWC. Subclasses the {{#crossLink \"ozpIwc.CommonApiBase\"}}{{/crossLink}}. Utilizes the following value\n * classes which subclass the {{#crossLink \"ozpIwc.CommonApiValue\"}}{{/crossLink}}:\n *  - {{#crossLink \"ozpIwc.SystemApiApplicationValue\"}}{{/crossLink}}\n *  - {{#crossLink \"ozpIwc.SystemApiMailboxValue\"}}{{/crossLink}}\n *\n * @class SystemApi\n * @namespace ozpIwc\n * @extends ozpIwc.CommonApiBase\n * @constructor\n *\n * @type {Function}\n * @param {Object} config\n */\nozpIwc.SystemApi = ozpIwc.util.extend(ozpIwc.CommonApiBase,function(config) {\n    ozpIwc.CommonApiBase.apply(this,arguments);\n\n    this.addDynamicNode(new ozpIwc.CommonApiCollectionValue({\n        resource: \"/application\",\n        pattern: /^\\/application\\/.*$/,\n        contentType: \"application/vnd.ozp-iwc-application-list-v1+json\"\n    }));\n\n    this.on(\"changedNode\",this.updateIntents,this);\n});\n\n/**\n * Loads data from the server.\n *\n * @method loadFromServer\n */\nozpIwc.SystemApi.prototype.loadFromServer=function() {\n\n    var self=this;\n    var headers = [\n        {name: \"Accept\", value: \"application/vnd.ozp-application-v1+json\"}\n    ];\n    return new Promise(function(resolve, reject) {\n        self.loadFromEndpoint(ozpIwc.linkRelPrefix + \":application\", headers)\n            .then(function() {\n                self.loadFromEndpoint(ozpIwc.linkRelPrefix + \":user\")\n                    .then(function() {\n                        self.loadFromEndpoint(ozpIwc.linkRelPrefix + \":system\")\n                            .then(function() {\n                                resolve(\"system.api load complete\");\n                            });\n                    });\n            })\n            ['catch'](function(error) {\n                reject(error);\n            });\n    });\n};\n\n/**\n * Update all intents registered to the given System Api node.\n *\n * @method updateIntents\n * @param {ozpIwc.SystemApiApplicationValue} node\n * @param {?} changes @TODO unused.\n */\nozpIwc.SystemApi.prototype.updateIntents=function(node,changes) {\n    if(!node.getIntentsRegistrations) {\n        return;\n    }\n    var intents=node.getIntentsRegistrations();\n    if(!intents) {\n        return;\n    }\n    intents.forEach(function(i) {\n        var icon = i.icon || (node.entity && node.entity.icons && node.entity.icons.small) ? node.entity.icons.small : '';\n        var label = i.label || node.entity.name;\n        this.participant.send({\n            'dst' : \"intents.api\",\n            'src' : \"system.api\",\n            'action': \"set\",\n            'resource': \"/\"+i.type+\"/\"+i.action+\"/system.api\"+node.resource.replace(/\\//g,'.'),\n            'contentType': \"application/vnd.ozp-iwc-intent-handler-v1+json\",\n            'entity': {\n                'type': i.type,\n                'action': i.action,\n                'icon': icon,\n                'label': label,\n                '_links': node.entity._links,\n                'invokeIntent': {\n                    'action' : 'invoke',\n                    'resource' : node.resource\n                }\n            }\n        });\n    },this);\n\n};\n\n/**\n * Creates a System Api Application or Mailbox value from the given packet.\n *\n * @method makeValue\n * @param {ozpIwc.TransportPacket} packet\n * @returns {ozpIwc.SystemApiMailboxValue|ozpIwc.SystemApiApplicationValue}\n */\nozpIwc.SystemApi.prototype.makeValue = function(packet){\n        switch (packet.contentType) {\n            case \"application/vnd.ozp-application-v1+json\":\n                var launchDefinition = \"/system\" + packet.resource;\n                packet.entity = packet.entity || {};\n                packet.entity.launchDefinition = packet.entity.launchDefinition || launchDefinition;\n\n                var app = new ozpIwc.SystemApiApplicationValue({\n                    resource: packet.resource,\n                    entity: packet.entity,\n                    contentType: packet.contentType,\n                    systemApi: this\n                });\n\n                this.participant.send({\n                    dst: \"intents.api\",\n                    action: \"register\",\n                    contentType: \"application/vnd.ozp-iwc-intent-handler-v1+json\",\n                    resource: launchDefinition,\n                    entity: {\n                        icon: (packet.entity.icons && packet.entity.icons.small) ? packet.entity.icons.small : \"\",\n                        label: packet.entity.name || \"\",\n                        contentType: \"application/json\",\n                        invokeIntent: {\n                            dst: \"system.api\",\n                            action: \"invoke\",\n                            resource: packet.resource\n                        }\n                    }\n                }, function (response, done) {\n                    app.entity.launchResource = response.entity.resource;\n                    done();\n                });\n\n                return app;\n            default:\n                return new ozpIwc.CommonApiValue(packet);\n        }\n};\n\n/**\n * Handles System api requests with an action of \"set\"\n * @method handleSet\n */\nozpIwc.SystemApi.prototype.handleSet = function(node,packetContext) {\n    packetContext.replyTo({\n        'response': 'badAction',\n        'entity': {\n            'action': packetContext.packet.action,\n            'originalRequest' : packetContext.packet\n        }\n    });\n};\n\n/**\n * Handles System api requests with an action of \"delete\"\n *\n * @method handleDelete\n */\nozpIwc.SystemApi.prototype.handleDelete = function(node,packetContext) {\n    packetContext.replyTo({\n        'response': 'badAction',\n        'entity': {\n            'action': packetContext.packet.action,\n            'originalRequest' : packetContext.packet\n        }\n    });\n};\n\n/**\n * Handles System api requests with an action of \"launch\"\n *\n * @method handleLaunch\n */\nozpIwc.SystemApi.prototype.handleLaunch = function(node,packetContext) {\n\n    this.participant.send({\n        dst: \"intents.api\",\n        contentType: \"application/vnd.ozp-iwc-intent-handler-v1+json\",\n        action: \"invoke\",\n        resource: node.entity.launchResource,\n        entity: packetContext.packet.entity\n    });\n    packetContext.replyTo({'response': \"ok\"});\n};\n\n/**\n * Handles System api requests with an action of \"invoke\"\n *\n * @method handleInvoke\n */\nozpIwc.SystemApi.prototype.handleInvoke = function(node,packetContext) {\n    if(packetContext.packet.entity && packetContext.packet.entity.inFlightIntent){\n        this.launchApplication(node,packetContext.packet.entity.inFlightIntent);\n        packetContext.replyTo({'response': \"ok\"});\n    } else{\n        packetContext.replyTo({'response': \"badResource\"});\n    }\n\n};\n\n/**\n * Launches the specified node's application.\n *\n * @method launchApplication\n * @param {ozpIwc.SystemApiApplicationValue} node\n * @param {ozpIwc.SystemApiMailboxValue} mailboxNode\n */\nozpIwc.SystemApi.prototype.launchApplication=function(node,intentResource) {\n    var launchParams=[\n            \"ozpIwc.peer=\"+encodeURIComponent(ozpIwc.BUS_ROOT),\n            \"ozpIwc.inFlightIntent=\"+encodeURIComponent(intentResource)\n    ];\n\n    ozpIwc.util.openWindow(node.entity.launchUrls.default,launchParams.join(\"&\"));\n};\n\n","/**\n * @submodule bus.api.Value\n */\n\n/**\n * @class SystemApiApplicationValue\n * @namespace ozpIwc\n * @extends ozpIwc.CommonApiValue\n * @constructor\n *\n * @type {Function}\n * @param {Object} config\n */\nozpIwc.SystemApiApplicationValue = ozpIwc.util.extend(ozpIwc.CommonApiValue,function(config) {\n    ozpIwc.CommonApiValue.apply(this,arguments);\n\n    /**\n     * A reference to the instantiated system Api\n     * @property systemApi\n     * @type {ozpIwc.SystemApi}\n     */\n    this.systemApi=config.systemApi;\n});\n\n/**\n * Returns the intents registered to this value.\n *\n * @method getIntentsRegistrations\n * @returns {ozpIwc.IntentsApiHandlerValue[]}\n */\nozpIwc.SystemApiApplicationValue.prototype.getIntentsRegistrations=function() {\n    return this.entity.intents;\n};","var ozpIwc=ozpIwc || {};\nozpIwc.ELECTION_TIMEOUT = 1000;\nozpIwc.apiRootUrl = ozpIwc.apiRootUrl || \"/api\";\nozpIwc.policyRootUrl = ozpIwc.policyRootUrl || \"/policy\";\nozpIwc.basicAuthUsername= ozpIwc.basicAuthUsername || '';\nozpIwc.basicAuthPassword= ozpIwc.basicAuthPassword || '';\nozpIwc.linkRelPrefix = ozpIwc.linkRelPrefix || \"ozp\";\nozpIwc.authorization = new ozpIwc.policyAuth.PDP({\n    'pip': new ozpIwc.policyAuth.PIP(),\n    'prp': new ozpIwc.policyAuth.PRP(),\n    'setsEndpoint': ozpIwc.policyRootUrl\n});\n\nif(typeof ozpIwc.enableDefault === \"undefined\" || ozpIwc.enableDefault) {\n    ozpIwc.initEndpoints(ozpIwc.apiRootUrl);\n\n\n    ozpIwc.defaultPeer = new ozpIwc.Peer();\n    ozpIwc.defaultLocalStorageLink = new ozpIwc.KeyBroadcastLocalStorageLink({\n        peer: ozpIwc.defaultPeer\n    });\n\n    ozpIwc.heartBeatFrequency = 10000; // 10 seconds\n    ozpIwc.defaultRouter = new ozpIwc.Router({\n        peer: ozpIwc.defaultPeer,\n        heartbeatFrequency: ozpIwc.heartBeatFrequency\n    });\n\n\n    if (typeof ozpIwc.runApis === \"undefined\" || ozpIwc.runApis) {\n        ozpIwc.defaultLeadershipStates = function () {\n            return {\n                'leader': ['actingLeader'],\n                'election': ['leaderSync', 'actingLeader'],\n                'queueing': ['leaderSync'],\n                'member': []\n            };\n        };\n\n        ozpIwc.initEndpoints(ozpIwc.apiRootUrl || \"api\");\n\n\n        ozpIwc.namesApi = new ozpIwc.NamesApi({\n            'participant': new ozpIwc.LeaderGroupParticipant({\n                'name': \"names.api\",\n                'states': ozpIwc.defaultLeadershipStates(),\n                electionTimeout: ozpIwc.ELECTION_TIMEOUT\n            }),\n            'heartbeatDropCount': 3,\n            'heartbeatFrequency': ozpIwc.heartBeatFrequency\n        });\n        ozpIwc.defaultRouter.registerParticipant(ozpIwc.namesApi.participant);\n\n        ozpIwc.dataApi = new ozpIwc.DataApi({\n            'participant': new ozpIwc.LeaderGroupParticipant({\n                'name': \"data.api\",\n                'states': ozpIwc.defaultLeadershipStates(),\n                electionTimeout: ozpIwc.ELECTION_TIMEOUT\n            })\n        });\n        ozpIwc.defaultRouter.registerParticipant(ozpIwc.dataApi.participant);\n\n        ozpIwc.intentsApi = new ozpIwc.IntentsApi({\n            'participant': new ozpIwc.LeaderGroupParticipant({\n                'name': \"intents.api\",\n                'states': ozpIwc.defaultLeadershipStates(),\n                electionTimeout: ozpIwc.ELECTION_TIMEOUT\n            })\n        });\n        ozpIwc.defaultRouter.registerParticipant(ozpIwc.intentsApi.participant);\n\n        ozpIwc.systemApi = new ozpIwc.SystemApi({\n            'participant': new ozpIwc.LeaderGroupParticipant({\n                'name': \"system.api\",\n                'states': ozpIwc.defaultLeadershipStates(),\n                electionTimeout: ozpIwc.ELECTION_TIMEOUT\n            })\n        });\n        ozpIwc.defaultRouter.registerParticipant(ozpIwc.systemApi.participant);\n    }\n    if (typeof ozpIwc.acceptPostMessageParticipants === \"undefined\" ||\n        ozpIwc.acceptPostMessageParticipants\n        ) {\n        ozpIwc.defaultPostMessageParticipantListener = new ozpIwc.PostMessageParticipantListener({\n            router: ozpIwc.defaultRouter\n        });\n    }\n}"]}