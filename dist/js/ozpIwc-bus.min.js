!function(){var a,b,c,d;!function(){var e={},f={};a=function(a,b,c){e[a]={deps:b,callback:c}},d=c=b=function(a){function c(b){if("."!==b.charAt(0))return b;for(var c=b.split("/"),d=a.split("/").slice(0,-1),e=0,f=c.length;f>e;e++){var g=c[e];if(".."===g)d.pop();else{if("."===g)continue;d.push(g)}}return d.join("/")}if(d._eak_seen=e,f[a])return f[a];if(f[a]={},!e[a])throw new Error("Could not find module "+a);for(var g,h=e[a],i=h.deps,j=h.callback,k=[],l=0,m=i.length;m>l;l++)k.push("exports"===i[l]?g={}:b(c(i[l])));var n=j.apply(this,k);return f[a]=g||n}}(),a("promise/all",["./utils","exports"],function(a,b){"use strict";function c(a){var b=this;if(!d(a))throw new TypeError("You must pass an array to all.");return new b(function(b,c){function d(a){return function(b){f(a,b)}}function f(a,c){h[a]=c,0===--i&&b(h)}var g,h=[],i=a.length;0===i&&b([]);for(var j=0;j<a.length;j++)g=a[j],g&&e(g.then)?g.then(d(j),c):f(j,g)})}var d=a.isArray,e=a.isFunction;b.all=c}),a("promise/asap",["exports"],function(a){"use strict";function b(){return function(){process.nextTick(e)}}function c(){var a=0,b=new i(e),c=document.createTextNode("");return b.observe(c,{characterData:!0}),function(){c.data=a=++a%2}}function d(){return function(){j.setTimeout(e,1)}}function e(){for(var a=0;a<k.length;a++){var b=k[a],c=b[0],d=b[1];c(d)}k=[]}function f(a,b){var c=k.push([a,b]);1===c&&g()}var g,h="undefined"!=typeof window?window:{},i=h.MutationObserver||h.WebKitMutationObserver,j="undefined"!=typeof global?global:void 0===this?window:this,k=[];g="undefined"!=typeof process&&"[object process]"==={}.toString.call(process)?b():i?c():d(),a.asap=f}),a("promise/config",["exports"],function(a){"use strict";function b(a,b){return 2!==arguments.length?c[a]:void(c[a]=b)}var c={instrument:!1};a.config=c,a.configure=b}),a("promise/polyfill",["./promise","./utils","exports"],function(a,b,c){"use strict";function d(){var a;a="undefined"!=typeof global?global:"undefined"!=typeof window&&window.document?window:self;var b="Promise"in a&&"resolve"in a.Promise&&"reject"in a.Promise&&"all"in a.Promise&&"race"in a.Promise&&function(){var b;return new a.Promise(function(a){b=a}),f(b)}();b||(a.Promise=e)}var e=a.Promise,f=b.isFunction;c.polyfill=d}),a("promise/promise",["./config","./utils","./all","./race","./resolve","./reject","./asap","exports"],function(a,b,c,d,e,f,g,h){"use strict";function i(a){if(!v(a))throw new TypeError("You must pass a resolver function as the first argument to the promise constructor");if(!(this instanceof i))throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.");this._subscribers=[],j(a,this)}function j(a,b){function c(a){o(b,a)}function d(a){q(b,a)}try{a(c,d)}catch(e){d(e)}}function k(a,b,c,d){var e,f,g,h,i=v(c);if(i)try{e=c(d),g=!0}catch(j){h=!0,f=j}else e=d,g=!0;n(b,e)||(i&&g?o(b,e):h?q(b,f):a===D?o(b,e):a===E&&q(b,e))}function l(a,b,c,d){var e=a._subscribers,f=e.length;e[f]=b,e[f+D]=c,e[f+E]=d}function m(a,b){for(var c,d,e=a._subscribers,f=a._detail,g=0;g<e.length;g+=3)c=e[g],d=e[g+b],k(b,c,d,f);a._subscribers=null}function n(a,b){var c,d=null;try{if(a===b)throw new TypeError("A promises callback cannot return that same promise.");if(u(b)&&(d=b.then,v(d)))return d.call(b,function(d){return c?!0:(c=!0,void(b!==d?o(a,d):p(a,d)))},function(b){return c?!0:(c=!0,void q(a,b))}),!0}catch(e){return c?!0:(q(a,e),!0)}return!1}function o(a,b){a===b?p(a,b):n(a,b)||p(a,b)}function p(a,b){a._state===B&&(a._state=C,a._detail=b,t.async(r,a))}function q(a,b){a._state===B&&(a._state=C,a._detail=b,t.async(s,a))}function r(a){m(a,a._state=D)}function s(a){m(a,a._state=E)}var t=a.config,u=(a.configure,b.objectOrFunction),v=b.isFunction,w=(b.now,c.all),x=d.race,y=e.resolve,z=f.reject,A=g.asap;t.async=A;var B=void 0,C=0,D=1,E=2;i.prototype={constructor:i,_state:void 0,_detail:void 0,_subscribers:void 0,then:function(a,b){var c=this,d=new this.constructor(function(){});if(this._state){var e=arguments;t.async(function(){k(c._state,d,e[c._state-1],c._detail)})}else l(this,d,a,b);return d},"catch":function(a){return this.then(null,a)}},i.all=w,i.race=x,i.resolve=y,i.reject=z,h.Promise=i}),a("promise/race",["./utils","exports"],function(a,b){"use strict";function c(a){var b=this;if(!d(a))throw new TypeError("You must pass an array to race.");return new b(function(b,c){for(var d,e=0;e<a.length;e++)d=a[e],d&&"function"==typeof d.then?d.then(b,c):b(d)})}var d=a.isArray;b.race=c}),a("promise/reject",["exports"],function(a){"use strict";function b(a){var b=this;return new b(function(b,c){c(a)})}a.reject=b}),a("promise/resolve",["exports"],function(a){"use strict";function b(a){if(a&&"object"==typeof a&&a.constructor===this)return a;var b=this;return new b(function(b){b(a)})}a.resolve=b}),a("promise/utils",["exports"],function(a){"use strict";function b(a){return c(a)||"object"==typeof a&&null!==a}function c(a){return"function"==typeof a}function d(a){return"[object Array]"===Object.prototype.toString.call(a)}var e=Date.now||function(){return(new Date).getTime()};a.objectOrFunction=b,a.isFunction=c,a.isArray=d,a.now=e}),b("promise/polyfill").polyfill()}();var ozpIwc=ozpIwc||{};ozpIwc.Event=function(){this.events={}},ozpIwc.Event.prototype.on=function(a,b,c){var d=b;return c&&(d=function(){b.apply(c,arguments)},d.ozpIwcDelegateFor=b),this.events[a]=this.events[a]||[],this.events[a].push(d),d},ozpIwc.Event.prototype.off=function(a,b){this.events[a]=(this.events[a]||[]).filter(function(a){return a!==b&&a.ozpIwcDelegateFor!==b})},ozpIwc.Event.prototype.trigger=function(a,b){b=b||new ozpIwc.CancelableEvent;var c=this.events[a]||[];return c.forEach(function(a){a(b)}),b},ozpIwc.Event.prototype.mixinOnOff=function(a){var b=this;a.on=function(){return b.on.apply(b,arguments)},a.off=function(){return b.off.apply(b,arguments)}},ozpIwc.CancelableEvent=function(a){a=a||{};for(var b in a)this[b]=a[b];this.canceled=!1,this.cancelReason=null},ozpIwc.CancelableEvent.prototype.cancel=function(a){return a=a||"Unknown",this.canceled=!0,this.cancelReason=a,this},window.console&&console.log||(console={log:function(){},debug:function(){},info:function(){},warn:function(){},error:function(){}});var ozpIwc=ozpIwc||{};ozpIwc.util=ozpIwc.util||{},ozpIwc.util.now=function(){return(new Date).getTime()},ozpIwc.util.extend=function(a,b){if(!a||!a.prototype)throw ozpIwc.log.error("Cannot create a new class for ",b," due to invalid baseclass:",a),new Error("Cannot create a new class due to invalid baseClass.  Dependency not loaded first?");return b.prototype=Object.create(a.prototype),b.prototype.constructor=b,b},ozpIwc.util.safePostMessage=function(a,b,c){try{var d=b;ozpIwc.util.structuredCloneSupport()||"string"==typeof d||(d=JSON.stringify(b)),a.postMessage(d,c)}catch(e){try{a.postMessage(JSON.stringify(b),c)}catch(e){ozpIwc.util.log("Invalid call to window.postMessage: "+e.message)}}},ozpIwc.util.structuredCloneSupport=function(){if(ozpIwc.util=ozpIwc.util||{},void 0!==ozpIwc.util.structuredCloneSupportCache)return ozpIwc.util.structuredCloneSupportCache;var a="postMessage"in window;try{window.postMessage({toString:function(){a=!1}},"*")}catch(b){}return ozpIwc.util.structuredCloneSupportCache=a,ozpIwc.util.structuredCloneSupportCache},ozpIwc.util.structuredCloneSupport.cache=void 0,ozpIwc.util.clone=function(a){if(!Array.isArray(a)&&"object"!=typeof a)return a;try{return JSON.parse(JSON.stringify(a))}catch(b){ozpIwc.log.log(b)}},ozpIwc.util.protoClone=function(a){if(a instanceof Array)return a.slice();if(a instanceof Object){var b=new a.constructor;for(var c in a)b[c]=a.hasOwnProperty(c)?ozpIwc.util.protoClone(a[c]):a[c];return b}return a},ozpIwc.util.parseQueryParams=function(a){a=a||window.location.search;for(var b,c={},d=/\??([^&=]+)=?([^&]*)/g;null!==(b=d.exec(a));)c[b[1]]=decodeURIComponent(b[2]);return c},ozpIwc.util.determineOrigin=function(a){var b=document.createElement("a");b.href=a;var c=b.protocol+"//"+b.hostname;return b.port&&(c+=":"+b.port),c},ozpIwc.util.escapeRegex=function(a){return a.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")},ozpIwc.util.parseOzpUrl=function(a){var b=/^(?:(?:web\+ozp|ozp):\/\/)?([0-9a-zA-Z](?:[-.\w])*)(\/[^?#]*)(\?[^#]*)?(#.*)?$/.exec(decodeURIComponent(a));if(b){var c={dst:b[1],resource:b[2],action:"get"};return c}return null},ozpIwc.util.isIWCPacket=function(a){return"string"!=typeof a.src||"string"!=typeof a.dst||"number"!=typeof a.ver||"string"!=typeof a.msgId?!1:!0},ozpIwc.util.isDirectDescendant=function(a,b){return a.parentNode===b?!0:!1},ozpIwc.util.elementParser=function(a){a=a||{},a.reqAttrs=a.reqAttrs||[],a.optAttrs=a.optAttrs||[],a.reqNodes=a.reqNodes||[],a.optNodes=a.optNodes||[];var b=a.element||{},c={attrs:{},nodes:{}};return a.reqAttrs.forEach(function(a){var d=b.getAttribute(a);d?c.attrs[a]=d:console.error("Required attribute not found,(",a,")")}),a.optAttrs.forEach(function(a){var d=b.getAttribute(a);d&&(c.attrs[a]=d)}),a.reqNodes.forEach(function(a){var d=b.getElementsByTagName(a);c.nodes[a]=c.nodes[a]||[];for(var e in d)ozpIwc.util.isDirectDescendant(d[e],b)&&c.nodes[a].push(d[e]);c.nodes[a].length<=0&&console.error("Required node not found,(",a,")")}),a.optNodes.forEach(function(a){var d=b.getElementsByTagName(a);for(var e in d)ozpIwc.util.isDirectDescendant(d[e],b)&&(c.nodes[a]=c.nodes[a]||[],c.nodes[a].push(d[e]))}),c},ozpIwc.util.camelCased=function(a){return a.charAt(0).toLowerCase()+a.substring(1)},ozpIwc.util.resolveWith=function(a){return new Promise(function(b){b(a)})},ozpIwc.util.rejectWith=function(a){return new Promise(function(b,c){c(a)})};var ozpIwc=ozpIwc||{};ozpIwc.metricsStats=ozpIwc.metricsStats||{},ozpIwc.metricsStats.DEFAULT_POOL_SIZE=1028,ozpIwc.metricsStats.Sample=function(){this.clear()},ozpIwc.metricsStats.Sample.prototype.update=function(a){this.values.push(a)},ozpIwc.metricsStats.Sample.prototype.clear=function(){this.values=[],this.count=0},ozpIwc.metricsStats.Sample.prototype.size=function(){return this.values.length},ozpIwc.metricsStats.Sample.prototype.getValues=function(){return this.values},ozpIwc.metricsStats.UniformSample=ozpIwc.util.extend(ozpIwc.metricsStats.Sample,function(a){ozpIwc.metricsStats.Sample.apply(this),this.limit=a||ozpIwc.metricsStats.DEFAULT_POOL_SIZE}),ozpIwc.metricsStats.UniformSample.prototype.update=function(a){if(this.count++,this.size()<this.limit)this.values.push(a);else{var b=parseInt(Math.random()*this.count);b<this.limit&&(this.values[b]=a)}};var ozpIwc=ozpIwc||{};ozpIwc.metricsStats=ozpIwc.metricsStats||{},ozpIwc.metricsStats.BinaryHeap=function(a){this.content=[],this.scoreFunction=a},ozpIwc.metricsStats.BinaryHeap.prototype={clone:function(){var a=new ozpIwc.metricsStats.BinaryHeap(this.scoreFunction);return a.content=JSON.parse(JSON.stringify(this.content)),a},push:function(a){this.content.push(a),this.bubbleUp(this.content.length-1)},peek:function(){return this.content[0]},pop:function(){var a=this.content[0],b=this.content.pop();return this.content.length>0&&(this.content[0]=b,this.sinkDown(0)),a},remove:function(a){for(var b=this.content.length,c=0;b>c;c++)if(this.content[c]===a){var d=this.content.pop();return c!==b-1&&(this.content[c]=d,this.scoreFunction(d)<this.scoreFunction(a)?this.bubbleUp(c):this.sinkDown(c)),!0}throw new Error("Node not found.")},size:function(){return this.content.length},bubbleUp:function(a){for(var b=this.content[a];a>0;){var c=Math.floor((a+1)/2)-1,d=this.content[c];if(!(this.scoreFunction(b)<this.scoreFunction(d)))break;this.content[c]=b,this.content[a]=d,a=c}},sinkDown:function(a){for(var b=this.content.length,c=this.content[a],d=this.scoreFunction(c);;){var e=2*(a+1),f=e-1,g=null,h=null;if(b>f){var i=this.content[f];h=this.scoreFunction(i),d>h&&(g=f)}if(b>e){var j=this.content[e],k=this.scoreFunction(j);(null===g?d:h)>k&&(g=e)}if(null===g)break;this.content[a]=this.content[g],this.content[g]=c,a=g}}};var ozpIwc=ozpIwc||{};ozpIwc.metricsStats=ozpIwc.metricsStats||{},ozpIwc.metricsStats.DEFAULT_RESCALE_THRESHOLD=36e5,ozpIwc.metricsStats.DEFAULT_DECAY_ALPHA=.015,ozpIwc.metricsStats.ExponentiallyDecayingSample=ozpIwc.util.extend(ozpIwc.metricsStats.Sample,function(a,b){ozpIwc.metricsStats.Sample.apply(this),this.limit=a||ozpIwc.metricsStats.DEFAULT_POOL_SIZE,this.alpha=b||ozpIwc.metricsStats.DEFAULT_DECAY_ALPHA,this.rescaleThreshold=ozpIwc.metricsStats.DEFAULT_RESCALE_THRESHOLD}),ozpIwc.metricsStats.ExponentiallyDecayingSample.prototype.getValues=function(){for(var a,b=[],c=this.values.clone();void 0!==(a=c.pop());)b.push(a.val);return b},ozpIwc.metricsStats.ExponentiallyDecayingSample.prototype.size=function(){return this.values.size()},ozpIwc.metricsStats.ExponentiallyDecayingSample.prototype.newHeap=function(){return new ozpIwc.metricsStats.BinaryHeap(function(a){return a.priority})},ozpIwc.metricsStats.ExponentiallyDecayingSample.prototype.now=function(){return ozpIwc.util.now()},ozpIwc.metricsStats.ExponentiallyDecayingSample.prototype.tick=function(){return this.now()/1e3},ozpIwc.metricsStats.ExponentiallyDecayingSample.prototype.clear=function(){this.values=this.newHeap(),this.count=0,this.startTime=this.tick(),this.nextScaleTime=this.now()+this.rescaleThreshold},ozpIwc.metricsStats.ExponentiallyDecayingSample.prototype.update=function(a,b){void 0===b?b=this.tick():b/=1e3;var c=this.weight(b-this.startTime)/Math.random(),d={val:a,priority:c};if(this.count<this.limit)this.count+=1,this.values.push(d);else{var e=this.values.peek();e.priority<c&&(this.values.push(d),this.values.pop())}this.now()>this.nextScaleTime&&this.rescale()},ozpIwc.metricsStats.ExponentiallyDecayingSample.prototype.weight=function(a){return Math.exp(this.alpha*a)},ozpIwc.metricsStats.ExponentiallyDecayingSample.prototype.rescale=function(){this.nextScaleTime=this.now()+this.rescaleThreshold;var a=this.values.content,b=[],c=this.startTime;this.startTime=this.tick();for(var d=0;d<a.length;d++)b.push({val:a[d].val,priority:a[d].priority*Math.exp(-this.alpha*(this.startTime-c))});this.values.content=b};var ozpIwc=ozpIwc||{};ozpIwc.metricsStats=ozpIwc.metricsStats||{},ozpIwc.metricsStats.M1_ALPHA=1-Math.exp(-5/60),ozpIwc.metricsStats.M5_ALPHA=1-Math.exp(-5/60/5),ozpIwc.metricsStats.M15_ALPHA=1-Math.exp(-5/60/15),ozpIwc.metricsStats.ExponentiallyWeightedMovingAverage=function(a,b){this.alpha=a,this.interval=b||5e3,this.currentRate=null,this.uncounted=0,this.lastTick=ozpIwc.util.now()},ozpIwc.metricsStats.ExponentiallyWeightedMovingAverage.prototype.update=function(a){this.uncounted+=a||1,this.tick()},ozpIwc.metricsStats.ExponentiallyWeightedMovingAverage.prototype.tick=function(){var a=ozpIwc.util.now(),b=a-this.lastTick;if(b>this.interval){this.lastTick=a-b%this.interval;for(var c=Math.floor(b/this.interval),d=0;c>d;++d){var e=this.uncounted/this.interval;this.uncounted=0,null!==this.currentRate?this.currentRate+=this.alpha*(e-this.currentRate):this.currentRate=e}}},ozpIwc.metricsStats.ExponentiallyWeightedMovingAverage.prototype.rate=function(){return 1e3*this.currentRate};var ozpIwc=ozpIwc||{};ozpIwc.metricTypes=ozpIwc.metricTypes||{},ozpIwc.metricTypes.BaseMetric=function(){this.value=0,this.name="",this.unitName=""},ozpIwc.metricTypes.BaseMetric.prototype.get=function(){return this.value},ozpIwc.metricTypes.BaseMetric.prototype.unit=function(a){return a?(this.unitName=a,this):this.unitName},ozpIwc.metricTypes.Counter=ozpIwc.util.extend(ozpIwc.metricTypes.BaseMetric,function(){ozpIwc.metricTypes.BaseMetric.apply(this,arguments),this.value=0}),ozpIwc.metricTypes.Counter.prototype.inc=function(a){return this.value+=a?a:1},ozpIwc.metricTypes.Counter.prototype.dec=function(a){return this.value-=a?a:1},ozpIwc.metricTypes=ozpIwc.metricTypes||{},ozpIwc.metricTypes.Gauge=ozpIwc.util.extend(ozpIwc.metricTypes.BaseMetric,function(a){ozpIwc.metricTypes.BaseMetric.apply(this,arguments),this.callback=a}),ozpIwc.metricTypes.Gauge.prototype.set=function(a){return this.callback=a,this},ozpIwc.metricTypes.Gauge.prototype.get=function(){return this.callback?this.callback():void 0},ozpIwc.metricTypes.Histogram=ozpIwc.util.extend(ozpIwc.metricTypes.BaseMetric,function(){ozpIwc.metricTypes.BaseMetric.apply(this,arguments),this.sample=new ozpIwc.metricsStats.ExponentiallyDecayingSample,this.clear()}),ozpIwc.metricTypes.Histogram.prototype.clear=function(){this.sample.clear(),this.min=this.max=null,this.varianceMean=0,this.varianceM2=0,this.sum=0,this.count=0},ozpIwc.metricTypes.Histogram.prototype.mark=function(a,b){b=b||ozpIwc.util.now(),this.sample.update(a,b),this.max=null===this.max?a:Math.max(this.max,a),this.min=null===this.min?a:Math.min(this.min,a),this.sum+=a,this.count++;var c=a-this.varianceMean;return this.varianceMean+=c/this.count,this.varianceM2+=c*(a-this.varianceMean),this.count},ozpIwc.metricTypes.Histogram.prototype.get=function(){var a=this.sample.getValues().map(function(a){return parseFloat(a)}).sort(function(a,b){return a-b}),b=function(b){var c=b*a.length;if(c>=a.length)return a[a.length-1];c=Math.max(0,c),c=Math.min(c,a.length+1);var d=a[Math.floor(c)-1],e=a[Math.floor(c)];return d+(c-Math.floor(c))*(e-d)};return{percentile10:b(.1),percentile25:b(.25),median:b(.5),percentile75:b(.75),percentile90:b(.9),percentile95:b(.95),percentile99:b(.99),percentile999:b(.999),variance:this.count<1?null:this.varianceM2/(this.count-1),mean:0===this.count?null:this.varianceMean,stdDev:this.count<1?null:Math.sqrt(this.varianceM2/(this.count-1)),count:this.count,sum:this.sum,max:this.max,min:this.min}},ozpIwc.metricTypes.Meter=ozpIwc.util.extend(ozpIwc.metricTypes.BaseMetric,function(){ozpIwc.metricTypes.BaseMetric.apply(this,arguments),this.m1Rate=new ozpIwc.metricsStats.ExponentiallyWeightedMovingAverage(ozpIwc.metricsStats.M1_ALPHA),this.m5Rate=new ozpIwc.metricsStats.ExponentiallyWeightedMovingAverage(ozpIwc.metricsStats.M5_ALPHA),this.m15Rate=new ozpIwc.metricsStats.ExponentiallyWeightedMovingAverage(ozpIwc.metricsStats.M15_ALPHA),this.startTime=ozpIwc.util.now(),this.value=0}),ozpIwc.metricTypes.Meter.prototype.mark=function(a){return a=a||1,this.value+=a,this.m1Rate.update(a),this.m5Rate.update(a),this.m15Rate.update(a),this.value},ozpIwc.metricTypes.Meter.prototype.get=function(){return{rate1m:this.m1Rate.rate(),rate5m:this.m5Rate.rate(),rate15m:this.m15Rate.rate(),rateMean:this.value/(ozpIwc.util.now()-this.startTime)*1e3,count:this.value}},ozpIwc.metricTypes.Meter.prototype.tick=function(){this.m1Rate.tick(),this.m5Rate.tick(),this.m15Rate.tick()},ozpIwc.metricTypes.Timer=ozpIwc.util.extend(ozpIwc.metricTypes.BaseMetric,function(){ozpIwc.metricTypes.BaseMetric.apply(this,arguments),this.meter=new ozpIwc.metricTypes.Meter,this.histogram=new ozpIwc.metricTypes.Histogram}),ozpIwc.metricTypes.Timer.prototype.mark=function(a,b){this.meter.mark(),this.histogram.mark(a,b)},ozpIwc.metricTypes.Timer.prototype.start=function(){var a=this,b=ozpIwc.util.now();return function(){var c=ozpIwc.util.now();a.mark(c-b,c)}},ozpIwc.metricTypes.Timer.prototype.time=function(a){var b=ozpIwc.util.now();try{a()}finally{var c=ozpIwc.util.now();this.mark(c-b,c)}},ozpIwc.metricTypes.Timer.prototype.get=function(){var a=this.histogram.get(),b=this.meter.get();for(var c in b)a[c]=b[c];return a};var ozpIwc=ozpIwc||{};ozpIwc.MetricsRegistry=function(){this.metrics={};var a=this;this.gauge("registry.metrics.types").set(function(){return Object.keys(a.metrics).length})},ozpIwc.MetricsRegistry.prototype.findOrCreateMetric=function(a,b){var c=this.metrics[a];return c?c instanceof b?c:null:(c=this.metrics[a]=new b,c.name=a,c)},ozpIwc.MetricsRegistry.prototype.makeName=function(a){return Array.prototype.slice.call(a).join(".")},ozpIwc.MetricsRegistry.prototype.counter=function(){return this.findOrCreateMetric(this.makeName(arguments),ozpIwc.metricTypes.Counter)},ozpIwc.MetricsRegistry.prototype.meter=function(){return this.findOrCreateMetric(this.makeName(arguments),ozpIwc.metricTypes.Meter)},ozpIwc.MetricsRegistry.prototype.gauge=function(){return this.findOrCreateMetric(this.makeName(arguments),ozpIwc.metricTypes.Gauge)},ozpIwc.MetricsRegistry.prototype.histogram=function(){return this.findOrCreateMetric(this.makeName(arguments),ozpIwc.metricTypes.Histogram)},ozpIwc.MetricsRegistry.prototype.timer=function(){return this.findOrCreateMetric(this.makeName(arguments),ozpIwc.metricTypes.Timer)},ozpIwc.MetricsRegistry.prototype.register=function(a,b){return this.metrics[this.makeName(a)]=b,b},ozpIwc.MetricsRegistry.prototype.toJson=function(){var a={};for(var b in this.metrics){for(var c=b.split("."),d=a;c.length>1;){var e=c.shift();d=d[e]=d[e]||{}}d[c[0]]=this.metrics[b].get()}return a},ozpIwc.MetricsRegistry.prototype.allMetrics=function(){var a=[];for(var b in this.metrics)a.push(this.metrics[b]);return a},ozpIwc.metrics=new ozpIwc.MetricsRegistry;var ozpIwc=ozpIwc||{};ozpIwc.util=ozpIwc.util||{},ozpIwc.util.ajax=function(a){return new Promise(function(b,c){var d=new XMLHttpRequest;d.withCredentials=!0,d.open(a.method,a.href,!0),Array.isArray(a.headers)&&a.headers.forEach(function(a){d.setRequestHeader(a.name,a.value)}),d.onload=function(){try{b({response:JSON.parse(this.responseText),header:ozpIwc.util.ajaxResponseHeaderToJSON(this.getAllResponseHeaders())})}catch(a){200===this.status&&this.responseXML?b({response:this.responseXML,header:ozpIwc.util.ajaxResponseHeaderToJSON(this.getAllResponseHeaders())}):204!==this.status||this.responseText?c(this):b({response:{},header:ozpIwc.util.ajaxResponseHeaderToJSON(this.getAllResponseHeaders())})}},d.onerror=function(){c(this)};try{"POST"===a.method||"PUT"===a.method?d.send(a.data):d.send()}catch(e){c(e)}})},ozpIwc.util.ajaxResponseHeaderToJSON=function(a){var b={};return a.split("\n").forEach(function(a){var c=a.split(":");2===c.length&&(b[c[0].trim()]=c[1].trim())}),b};var ozpIwc=ozpIwc||{};ozpIwc.AsyncAction=function(){this.callbacks={}},ozpIwc.AsyncAction.prototype.when=function(a,b,c){return c=c||this,this.resolution===a?b.apply(c,this.value):this.callbacks[a]=function(){return b.apply(c,arguments)},this},ozpIwc.AsyncAction.prototype.resolve=function(a){if(this.resolution)throw"Cannot resolve an already resolved AsyncAction";var b=this.callbacks[a];return this.resolution=a,this.value=Array.prototype.slice.call(arguments,1),b&&b.apply(this,this.value),this},ozpIwc.AsyncAction.prototype.success=function(a,b){return this.when("success",a,b)},ozpIwc.AsyncAction.prototype.failure=function(a,b){return this.when("failure",a,b)},ozpIwc.AsyncAction.all=function(a){var b=new ozpIwc.AsyncAction,c=a.length,d=this,e=[];return a.forEach(function(a,f){d.isAnAction(a)?a.success(function(a){e[f]=a,0===--c&&b.resolve("success",e)},d).failure(function(a){b.resolve("failure",a)},d):(e[f]=a,0===--c&&b.resolve("success",e))}),b},ozpIwc.AsyncAction.isAnAction=function(a){return ozpIwc.AsyncAction.prototype.isPrototypeOf(a)};var ozpIwc=ozpIwc||{},getStackTrace=function(){var a={};return Error.captureStackTrace(a,getStackTrace),a.stack};ozpIwc.log=ozpIwc.log||{log:function(){window.console&&"function"==typeof window.console.log&&window.console.log.apply(window.console,arguments)},error:function(){window.console&&"function"==typeof window.console.error&&window.console.error.apply(window.console,arguments)}},function(a,b){"use strict";function c(a){return o[n]=d.apply(b,a),n++}function d(a){var c=[].slice.call(arguments,1);return function(){"function"==typeof a?a.apply(b,c):new Function(""+a)()}}function e(a){if(p)setTimeout(d(e,a),0);else{var b=o[a];if(b){p=!0;try{b()}finally{f(a),p=!1}}}}function f(a){delete o[a]}function g(){m=function(){var a=c(arguments);return process.nextTick(d(e,a)),a}}function h(){if(a.postMessage&&!a.importScripts){var b=!0,c=a.onmessage;return a.onmessage=function(){b=!1},a.postMessage("","*"),a.onmessage=c,b}}function i(){var b="setImmediate$"+Math.random()+"$",d=function(c){c.source===a&&"string"==typeof c.data&&0===c.data.indexOf(b)&&e(+c.data.slice(b.length))};a.addEventListener?a.addEventListener("message",d,!1):a.attachEvent("onmessage",d),m=function(){var d=c(arguments);return a.postMessage(b+d,"*"),d}}function j(){var a=new MessageChannel;a.port1.onmessage=function(a){var b=a.data;e(b)},m=function(){var b=c(arguments);return a.port2.postMessage(b),b}}function k(){var a=q.documentElement;m=function(){var b=c(arguments),d=q.createElement("script");return d.onreadystatechange=function(){e(b),d.onreadystatechange=null,a.removeChild(d),d=null},a.appendChild(d),b}}function l(){m=function(){var a=c(arguments);return setTimeout(d(e,a),0),a}}if(!a.setImmediate){var m,n=1,o={},p=!1,q=a.document,r=Object.getPrototypeOf&&Object.getPrototypeOf(a);r=r&&r.setTimeout?r:a,"[object process]"==={}.toString.call(a.process)?g():h()?i():a.MessageChannel?j():q&&"onreadystatechange"in q.createElement("script")?k():l(),r.setImmediate=m,r.clearImmediate=f}}(new Function("return this")());var ozpIwc=ozpIwc||{};ozpIwc.util=ozpIwc.util||{},ozpIwc.util.generateId=function(){return Math.floor(4294967295*Math.random()).toString(16)},ozpIwc.util.setImmediate=function(a){window.setImmediate(a)},ozpIwc.util.arrayContainsAll=function(a,b,c){return c=c||function(a,b){return a===b},b.every(function(b){return a.some(function(a){return c(a,b)})})},ozpIwc.util.objectContainsAll=function(a,b,c){c=c||function(a,b){return a===b};for(var d in b)if(!c(a[d],b[d]))return!1;return!0},ozpIwc.util.openWindow=function(a,b,c){if("object"==typeof b){var d="";for(var e in b)d+=e+"="+encodeURIComponent(b[e])+"&";b=d}window.open(a,b,c)},function(){ozpIwc.BUS_ROOT=window.location.protocol+"//"+window.location.host+window.location.pathname.replace(/[^\/]+$/,"")}(),ozpIwc.util.alert=function(a,b){this.alerts=this.alerts||{},this.alerts[a]?this.alerts[a].error=b:this.alerts[a]={error:b,silence:!1},this.alerts[a].silence||(this.alerts[a].silence=!0,ozpIwc.log.log(a,b))};var ozpIwc=ozpIwc||{};ozpIwc.BasicAuthentication=function(){this.roles={};var a=this;ozpIwc.metrics.gauge("security.authentication.roles").set(function(){return a.getRoleCount()})},ozpIwc.BasicAuthentication.prototype.getRoleCount=function(){return this.roles&&Object.keys(this.roles)?Object.keys(this.roles).length:0},ozpIwc.BasicAuthentication.prototype.login=function(a,b){if(!a)throw"Must supply credentials for login";var c=new ozpIwc.AsyncAction;return b=b||[],c.resolve("success",b)};var ozpIwc=ozpIwc||{};ozpIwc.BasicAuthorization=function(a){a=a||{},this.roles={},this.policies=a.policies||[ozpIwc.abacPolicies.permitWhenObjectHasNoAttributes,ozpIwc.abacPolicies.subjectHasAllObjectAttributes];var b=this;ozpIwc.metrics.gauge("security.authorization.roles").set(function(){return b.getRoleCount()})},ozpIwc.BasicAuthorization.prototype.getRoleCount=function(){return this.roles&&Object.keys(this.roles)?Object.keys(this.roles).length:0},ozpIwc.BasicAuthorization.prototype.implies=function(a,b){return void 0===b||null===b?!0:void 0===a||null===a?!1:(a=Array.isArray(a)?a:[a],b=Array.isArray(b)?b:[b],ozpIwc.util.arrayContainsAll(a,b))},ozpIwc.BasicAuthorization.prototype.isPermitted=function(a){var b=new ozpIwc.AsyncAction,c=this.policies.some(function(b){return"permit"===b.call(this,a)},this);return b.resolve(c?"success":"failure")},ozpIwc=ozpIwc||{},ozpIwc.policyAuth=ozpIwc.policyAuth||{},ozpIwc.policyAuth.PolicyCombining=ozpIwc.policyAuth.PolicyCombining||{},ozpIwc.policyAuth.PolicyCombining["deny-overrides"]=function(a,b){var c,d,e,f=!1;for(var g in a){var h=a[g](b);switch(h){case"Deny":return"Deny";case"Permit":f=!0;break;case"NotApplicable":continue;case"Indeterminate{D}":c=!0;break;case"Indeterminate{P}":d=!0;break;case"Indeterminate{DP}":e=!0;break;default:continue}}return e?"Indeterminate{DP}":c&&(d||f)?"Indeterminate{DP}":c?"Indeterminate{D}":f?"Permit":d?"Indeterminate{P}":"NotApplicable"},ozpIwc.policyAuth.PolicyCombining["permit-overrides"]=function(){},ozpIwc.policyAuth.PolicyCombining["first-applicable"]=function(){},ozpIwc.policyAuth.PolicyCombining["only-one-applicable"]=function(){},ozpIwc.policyAuth.PolicyCombining["ordered-deny-overrides"]=function(){},ozpIwc.policyAuth.PolicyCombining["ordered-permit-overrides"]=function(){},ozpIwc.policyAuth.PolicyCombining["deny-unless-permit"]=function(){},ozpIwc.policyAuth.PolicyCombining["permit-unless-deny"]=function(){},ozpIwc=ozpIwc||{},ozpIwc.policyAuth=ozpIwc.policyAuth||{},ozpIwc.policyAuth.RuleCombining=ozpIwc.policyAuth.RuleCombining||{},ozpIwc.policyAuth.RuleCombining["urn:oasis:names:tc:xacml:3.0:rule-combining-algorithm:deny-overrides"]=function(a,b){var c,d,e,f=!1;for(var g in a){var h=a[g].evaluate(b);switch(h){case"Deny":return"Deny";case"Permit":f=!0;break;case"NotApplicable":continue;case"Indeterminate{D}":c=!0;break;case"Indeterminate{P}":d=!0;break;case"Indeterminate{DP}":e=!0;break;default:continue}}return e?"Indeterminate{DP}":c&&(d||f)?"Indeterminate{DP}":c?"Indeterminate{D}":f?"Permit":d?"Indeterminate{P}":"NotApplicable"},ozpIwc.policyAuth.RuleCombining["urn:oasis:names:tc:xacml:3.0:rule-combining-algorithm:permit-overrides"]=function(){},ozpIwc.policyAuth.RuleCombining["urn:oasis:names:tc:xacml:1.0:rule-combining-algorithm:first-applicable"]=function(){},ozpIwc.policyAuth.RuleCombining["urn:oasis:names:tc:xacml:3.0:rule-combining-algorithm:ordered-deny-overrides"]=function(){},ozpIwc.policyAuth.RuleCombining["urn:oasis:names:tc:xacml:3.0:rule-combining-algorithm:ordered-permit-overrides"]=function(){},ozpIwc.policyAuth.RuleCombining["urn:oasis:names:tc:xacml:3.0:rule-combining-algorithm:deny-unless-permit"]=function(){},ozpIwc.policyAuth.RuleCombining["urn:oasis:names:tc:xacml:3.0:rule-combining-algorithm:permit-unless-deny"]=function(){},ozpIwc=ozpIwc||{},ozpIwc.policyAuth=ozpIwc.policyAuth||{},ozpIwc.policyAuth.BaseElement=function(a){a=a||{}},ozpIwc.policyAuth.BaseElement.prototype.construct=function(a){var b=ozpIwc.util.elementParser({element:a,reqAttrs:this.requiredAttributes,optAttrs:this.optionalAttributes,reqNodes:this.requiredNodes,optNodes:this.optionalNodes});this.constructNodes(b)},ozpIwc.policyAuth.BaseElement.prototype.constructNodes=function(a){a=a||{},a.attrs=a.attrs||{},a.nodes=a.nodes||{};var b;for(var c in a.attrs)b=ozpIwc.util.camelCased(c),this[b]=a.attrs[c];for(var d in a.nodes)if(b=ozpIwc.util.camelCased(d),Array.isArray(this[b]))if(Array.isArray(a.nodes[d]))for(var e in a.nodes[d])this[b].push(new ozpIwc.policyAuth[d]({element:a.nodes[d][e]}));else for(var f in a.nodes[d])this[b].push(new ozpIwc.policyAuth[d]({element:a.nodes[d][f]}));else for(var g in a.nodes[d])this[b]=new ozpIwc.policyAuth[d]({element:a.nodes[d][g]})},ozpIwc.policyAuth.BaseElement.prototype.requiredAttributes=[],ozpIwc.policyAuth.BaseElement.prototype.optionalAttributes=[],ozpIwc.policyAuth.BaseElement.prototype.requiredNodes=[],ozpIwc.policyAuth.BaseElement.prototype.optionalNodes=[],ozpIwc=ozpIwc||{},ozpIwc.policyAuth=ozpIwc.policyAuth||{},ozpIwc.policyAuth.Policy=ozpIwc.util.extend(ozpIwc.policyAuth.BaseElement,function(a){a=a||{},this.policyId=a.policyId,this.version=a.version,this.description=a.description,this.ruleCombiningAlgId=a.ruleCombiningAlgId||this.ruleCombiningAlgId,this.rule=[];for(var b in a.rule)this.rule.push(a.rule[b].evaluate?a.rule[b]:new ozpIwc.policyAuth.Rule(a.rule[b]));this.evaluate=a.evaluate||this.evaluateDefault}),ozpIwc.policyAuth.Policy.prototype.ruleCombiningAlgId="urn:oasis:names:tc:xacml:3.0:rule-combining-algorithm:deny-overrides",ozpIwc.policyAuth.Policy.prototype.evaluateDefault=function(a){return ozpIwc.policyAuth.RuleCombining[this.ruleCombiningAlgId](this.rule,a)},ozpIwc=ozpIwc||{},ozpIwc.policyAuth=ozpIwc.policyAuth||{},ozpIwc.policyAuth.Rule=function(a){a=a||{},this.ruleId=a.ruleId,this.category=a.category,this.setEffect(a.effect)},ozpIwc.policyAuth.Rule.prototype.setEffect=function(a){switch(a){case"Permit":this.effect=a;break;case"Deny":this.effect=a;break;default:this.effect="Permit"}},ozpIwc.policyAuth.Rule.prototype.getNegativeEffect=function(){switch(this.effect){case"Deny":return"Permit";default:return"Deny"}},ozpIwc.policyAuth.Rule.prototype.evaluate=function(a){var b=a.category;for(var c in this.category){if(!b[c])return this.getNegativeEffect();
for(var d in b[c])if(this.category[c][d]){var e=this.category[c][d],f=!1,g=b[c][d];if(g=Array.isArray(g)?g:[g],0===e.length)f=0===e.length?!0:!1;else{f=!0;for(var h in g)e.indexOf(g[h])<0&&(f=!1)}if(!f)return this.getNegativeEffect()}}return this.effect},ozpIwc=ozpIwc||{},ozpIwc.policyAuth=ozpIwc.policyAuth||{},ozpIwc.policyAuth.SecurityAttribute=function(a){a=a||{},this.attributes=a.attributes||{},this.comparator=a.comparator||this.comparator},ozpIwc.policyAuth.SecurityAttribute.prototype.pushIfNotExist=function(a,b,c){if(c=c||this.comparator,b){var d=Array.isArray(b)?b:[b];if(this.attributes[a])for(var e in this.attributes[a])for(var f in d)c(this.attributes[a][e],d[f])||this.attributes[a].push(b);else this.attributes[a]=[],this.attributes[a]=this.attributes[a].concat(d)}},ozpIwc.policyAuth.SecurityAttribute.prototype.clear=function(a){delete this.attributes[a]},ozpIwc.policyAuth.SecurityAttribute.prototype.clearAll=function(){this.attributes={}},ozpIwc.policyAuth.SecurityAttribute.prototype.getAll=function(){return this.attributes},ozpIwc.policyAuth.SecurityAttribute.prototype.comparator=function(a,b){return a===b},ozpIwc=ozpIwc||{},ozpIwc.policyAuth=ozpIwc.policyAuth||{},ozpIwc.policyAuth.PDP=function(a){a=a||{},this.prp=a.prp||new ozpIwc.policyAuth.PRP,this.pip=a.pip||new ozpIwc.policyAuth.PIP,this.policySets=a.policySets||{connectSet:["/policy/connect"],apiSet:["/policy/apiNode"],readSet:["/policy/read"],receiveAsSet:["/policy/receiveAs"],sendAsSet:["/policy/sendAs"]}},ozpIwc.policyAuth.PDP.prototype.isPermitted=function(a){var b=new ozpIwc.AsyncAction,c=this;if(!a)return b.resolve("success",{result:"Permit"});var d=[],e=function(a){b.resolve("failure",a)};return this.formatRequest(a).success(function(f){c.prp.getPolicies(f.policies).success(function(c){var g=ozpIwc.policyAuth.PolicyCombining["deny-overrides"](c,f.category),h={result:g,request:a,formattedRequest:f,formattedPolicies:d};"Permit"===g?b.resolve("success",h):e(h)}).failure(e)}).failure(e),b},ozpIwc.policyAuth.PDP.prototype.formatAttributes=function(a,b){a=Array.isArray(a)?a:[a];var c=new ozpIwc.AsyncAction;b=b||this.pip;var d=[];for(var e in a)d.push(this.formatAttribute(a[e],b));return ozpIwc.AsyncAction.all(d).success(function(a){var b={};for(var d in a)if(Object.keys(a[d]).length>0)for(var e in a[d])b[e]=a[d][e];c.resolve("success",b)}),c},ozpIwc.policyAuth.PDP.prototype.formatAttribute=function(a,b){var c=new ozpIwc.AsyncAction;b=b||this.pip;if(!a)return c.resolve("success");if(a)if("string"==typeof a)b.getAttributes(a).success(function(a){c.resolve("success",a)});else{if(Array.isArray(a))return this.formatAttributes(a,b);if("object"==typeof a){var d=Object.keys(a);for(var e in d){var f=a[d[e]];["string","number","boolean"].indexOf(typeof a[d[e]])>=0&&(a[d[e]]=[f]),a[d[e]]=a[d[e]]||[]}c.resolve("success",a)}}else c.resolve("success",{});return c},ozpIwc.policyAuth.PDP.prototype.formatAction=function(a){var b=[],c=function(a,b){var c;return a["ozp:iwc:action"]&&(c=a["ozp:iwc:action"]),Array.isArray(c)?d(c,b):void(["string","number","boolean"].indexOf(typeof c)>=0&&b.indexOf(c)<0&&b.push(c))},d=function(a,b){for(var e in a)"string"==typeof a[e]?b.indexOf(a[e])<0&&b.push(a[e]):Array.isArray(a[e])?d(a[e],b):"object"==typeof a[e]&&c(a[e],b)};return a&&("string"==typeof a?b.push(a):Array.isArray(a)?d(a,b):"object"==typeof a&&c(a,b)),{"ozp:iwc:action":b}},ozpIwc.policyAuth.PDP.prototype.formatRequest=function(a,b){var c=new ozpIwc.AsyncAction;b=b||this.pip,a=a||{},a.subject=a.subject||{},a.resource=a.resource||{},a.action=a.action||{};var d=[],e=this.formatAttribute(a.subject,b),f=this.formatAttribute(a.resource,b),g=this.formatAction(a.action);return d.push(e,f,g),ozpIwc.AsyncAction.all(d).success(function(b){var d=b[0],e=b[1],f=b[2];c.resolve("success",{category:{subject:d,resource:e,action:f},combiningAlgorithm:a.combiningAlgorithm,policies:a.policies})}).failure(function(a){c.resolve("failure",a)}),c},ozpIwc.policyAuth.PDP.prototype.defaultCombiningAlgorithm="urn:oasis:names:tc:xacml:3.0:policy-combining-algorithm:deny-overrides",ozpIwc.policyAuth.PDP.prototype.formatCategory=function(a,b){var c=new ozpIwc.AsyncAction;return a?(b=b||this.pip,this.formatAttribute(a,b).success(function(a){for(var b in a["ozp:iwc:permissions"])a[b]=a["ozp:iwc:permissions"][b];delete a["ozp:iwc:permissions"],c.resolve("success",a)}).failure(function(a){c.resolve("failure",a)}),c):c.resolve("success")},ozpIwc.policyAuth.PDP.prototype.formatCategories=function(a,b){var c=new ozpIwc.AsyncAction;b=b||this.pip;var d=[],e={};for(var f in a)d.push(this.formatCategory(a[f],b)),e[f]=d.length-1;return ozpIwc.AsyncAction.all(d).success(function(a){var b={},d=Object.keys(e);for(var f in d)b[d[f]]=a[e[d[f]]]||{};c.resolve("success",b)}).failure(function(a){c.resolve("failure",a)}),c},ozpIwc=ozpIwc||{},ozpIwc.policyAuth=ozpIwc.policyAuth||{},ozpIwc.policyAuth.PIP=ozpIwc.util.extend(ozpIwc.policyAuth.SecurityAttribute,function(){ozpIwc.policyAuth.SecurityAttribute.apply(this,arguments)}),ozpIwc.policyAuth.PIP.prototype.getAttributes=function(a){var b=new ozpIwc.AsyncAction,c=this;return this.attributes[a]?b.resolve("success",c.attributes[a]):(ozpIwc.util.ajax({href:a,method:"GET"}).then(function(d){if("object"!=typeof d)return b.resolve("failure","Invalid data loaded from the remote PIP");c.attributes[a]={};for(var e in d)c.attributes[a][e]=Array.isArray(d[e])?d[e]:[d[e]];b.resolve("success",c.attributes[a])})["catch"](function(a){b.resolve("failure",a)}),b)},ozpIwc.policyAuth.PIP.prototype.grantAttributes=function(a,b){var c={};for(var d in b)c[d]=Array.isArray(b[d])?b[d]:[b[d]];this.attributes[a]=c},ozpIwc.policyAuth.PIP.prototype.grantParent=function(a,b){var c=new ozpIwc.AsyncAction;this.attributes[a]=this.attributes[a]||{};var d=this;if(d.attributes[b]){for(var e in d.attributes[b]){d.attributes[a][e]=d.attributes[a][e]||[];for(var f in d.attributes[b][e])d.attributes[a][e].indexOf(d.attributes[b][e][f])<0&&d.attributes[a][e].push(d.attributes[b][e][f])}return c.resolve("success",d.attributes[a])}return d.getAttributes(b).success(function(b){for(var e in b)d.attributes[a].indexOf(b[e])<0&&d.attributes[a].push(b[e]);c.resolve("success",d.attributes[a])}).failure(function(a){c.resolve("failure",a)}),c},ozpIwc=ozpIwc||{},ozpIwc.policyAuth=ozpIwc.policyAuth||{},ozpIwc.policyAuth.PRP=function(a){a=a||{},this.persistentPolicies=a.persistentPolicies||[],this.policyCache=a.policyCache||ozpIwc.policyAuth.defaultPolicies},ozpIwc.policyAuth.PRP.prototype.getPolicies=function(a){var b=new ozpIwc.AsyncAction;a=a||[],a=Array.isArray(a)?a:[a];var c=[],d=this.persistentPolicies.concat(a);for(var e in d)if(this.policyCache[d[e]])c.push(ozpIwc.util.clone(this.policyCache[d[e]]));else{var f=this.fetchPolicy(d[e]);c.push(f)}return 0===c.length?b.resolve("success",[ozpIwc.abacPolicies.permitAll]):ozpIwc.AsyncAction.all(c)},ozpIwc.policyAuth.PRP.prototype.defaultCombiningAlgorithm="urn:oasis:names:tc:xacml:3.0:rule-combining-algorithm:deny-overrides",ozpIwc.policyAuth.PRP.prototype.fetchPolicy=function(a){var b=new ozpIwc.AsyncAction,c=this;return ozpIwc.util.ajax({method:"GET",href:a}).then(function(d){c.policyCache[a]=c.formatPolicy(d.response),b.resolve("success",ozpIwc.util.clone(c.policyCache[a]))})["catch"](function(){b.resolve("success",c.getDenyall(a))}),b},ozpIwc.policyAuth.PRP.prototype.formatPolicy=function(a){return new ozpIwc.policyAuth.Policy(a)},ozpIwc.policyAuth.PRP.prototype.getDenyall=function(a){if(this.policyCache[a])return this.policyCache[a];var b=new ozpIwc.policyAuth.Policy({policyId:a});return b.evaluate=ozpIwc.abacPolicies.denyAll,this.policyCache[a]=b,b},ozpIwc.abacPolicies={},ozpIwc.abacPolicies.permitWhenObjectHasNoAttributes=function(a){return a.object&&0===Object.keys(a.object).length?"Permit":"Undetermined"},ozpIwc.abacPolicies.subjectHasAllObjectAttributes=function(a){if(!a.object)return"Permit";var b=a.subject||{};return ozpIwc.util.objectContainsAll(b,a.object,this.implies)?"Permit":"Deny"},ozpIwc.abacPolicies.permitAll=function(){return"Permit"},ozpIwc.abacPolicies.denyAll=function(){return"Deny"},ozpIwc.abacPolicies.implies=function(a,b){return void 0===b||null===b?!0:void 0===a||null===a?!1:(a=Array.isArray(a)?a:[a],b=Array.isArray(b)?b:[b],ozpIwc.util.arrayContainsAll(a,b))},ozpIwc.abacPolicies.defaultPolicy=function(a,b){return b=Array.isArray(b)?b:[b],ozpIwc.util.arrayContainsAll(b,a.action["ozp:iwc:action"])?ozpIwc.util.objectContainsAll(a.subject,a.resource,ozpIwc.abacPolicies.implies)?"Permit":"Deny":"NotApplicable"},ozpIwc=ozpIwc||{},ozpIwc.policyAuth=ozpIwc.policyAuth||{},ozpIwc.policyAuth.defaultPolicies={},ozpIwc.policyAuth.defaultPolicies["/policy/connect"]=function(a){var b=["connect"],c=["http://localhost:13000","http://localhost:14000","http://localhost:14001","http://localhost:14002","http://localhost:15000","http://localhost:15001","http://localhost:15002","http://localhost:15003","http://localhost:15004","http://localhost:15005","http://localhost:15006","http://localhost:15007","http://ozone-development.github.io"];return ozpIwc.util.arrayContainsAll(b,a.action["ozp:iwc:action"])?ozpIwc.util.arrayContainsAll(c,a.subject["ozp:iwc:origin"])?"Permit":"Deny":"NotApplicable"},ozpIwc.policyAuth.defaultPolicies["/policy/sendAs"]=function(a){return ozpIwc.abacPolicies.defaultPolicy(a,"sendAs")},ozpIwc.policyAuth.defaultPolicies["/policy/receiveAs"]=function(a){return ozpIwc.abacPolicies.defaultPolicy(a,"receiveAs")},ozpIwc.policyAuth.defaultPolicies["/policy/read"]=function(a){return ozpIwc.abacPolicies.defaultPolicy(a,"read")},ozpIwc.policyAuth.defaultPolicies["/policy/apiNode"]=function(a){return ozpIwc.abacPolicies.defaultPolicy(a,"access")};var ozpIwc=ozpIwc||{};ozpIwc.KeyBroadcastLocalStorageLink=function(a){a=a||{},this.prefix=a.prefix||"ozpIwc",this.peer=a.peer||ozpIwc.defaultPeer,this.selfId=a.selfId||this.peer.selfId,this.metricsPrefix="keyBroadcastLocalStorageLink."+this.selfId,this.myKeysTimeout=a.myKeysTimeout||5e3,this.otherKeysTimeout=a.otherKeysTimeout||12e4,this.maxRetries=a.maxRetries||6,this.queueSize=a.queueSize||1024,this.sendQueue=this.sendQueue||[],this.fragments=this.fragments||[],this.fragmentSize=a.fragmentSize||1310720,this.fragmentTimeout=a.fragmentTimeout||1e3,String.prototype.chunk=function(a){for(var b=[],c=0;c<this.length;c+=a)b.push(this.slice(c,c+a));return b};var b,c=this,d=function(a){if(a.newValue){try{b=JSON.parse(a.newValue)}catch(d){return ozpIwc.log.log("Parse error on "+a.newValue),void ozpIwc.metrics.counter(c.metricsPrefix,"packets_parseError").inc()}b.data.fragment?c.handleFragment(b):c.forwardToPeer(b)}};window.addEventListener("storage",d,!1),this.peer.on("send",function(a){c.send(a.packet)}),this.peer.on("beforeShutdown",function(){window.removeEventListener("storage",d)},this)},ozpIwc.KeyBroadcastLocalStorageLink.prototype.forwardToPeer=function(a){this.peer.receive(this.linkId,a),ozpIwc.metrics.counter(this.metricsPrefix,"packets_received").inc(),a.data.time&&ozpIwc.metrics.timer(this.metricsPrefix,"latencyIn").mark(ozpIwc.util.now()-a.data.time)},ozpIwc.KeyBroadcastLocalStorageLink.prototype.handleFragment=function(a){if(!this.peer.haveSeen(a)){var b=a.data.msgId;this.storeFragment(a);var c=this.defragmentPacket(this.fragments[b]);if(c){window.clearTimeout(this.fragments[b].fragmentTimer);var d=this.peer.packetsSeen[c.srcPeer].indexOf(c.sequence);delete this.peer.packetsSeen[c.srcPeer][d],this.forwardToPeer(c),delete this.fragments[b]}}},ozpIwc.KeyBroadcastLocalStorageLink.prototype.storeFragment=function(a){if(!a.data.fragment)return null;var b=a.sequence,c=a.srcPeer,d=a.data.msgId,e=a.data.id,f=a.data.chunk,g=a.data.total;if(void 0===d||void 0===e)return null;if(!this.fragments[d]){this.fragments[d]={},this.fragments[d].chunks=[];var h=this;h.key=d,h.total=g,this.fragments[d].timeoutFunc=function(){ozpIwc.metrics.meter(h.metricsPrefix,"fragments_dropped").mark(h.total),delete h.fragments[h.key]}}return window.clearTimeout(this.fragments[d].fragmentTimer),this.fragments[d].fragmentTimer=window.setTimeout(this.fragments[d].timeoutFunc,this.fragmentTimeout),this.fragments[d].total=g||this.fragments[d].total,this.fragments[d].sequence=void 0!==b?b:this.fragments[d].sequence,this.fragments[d].srcPeer=c||this.fragments[d].srcPeer,this.fragments[d].chunks[e]=f,void 0===this.fragments[d].total||void 0===this.fragments[d].sequence||void 0===this.fragments[d].srcPeer?null:(ozpIwc.metrics.meter(this.metricsPrefix,"fragments_received").mark(),!0)},ozpIwc.KeyBroadcastLocalStorageLink.prototype.defragmentPacket=function(a){if(a.total!==a.chunks.length)return null;try{var b=JSON.parse(a.chunks.join(""));return{defragmented:!0,sequence:a.sequence,srcPeer:a.srcPeer,data:b}}catch(c){return null}},ozpIwc.KeyBroadcastLocalStorageLink.prototype.send=function(a){var b;try{b=JSON.stringify(a.data)}catch(c){ozpIwc.metrics.meter(this.metricsPrefix,"packets_failed").mark();var d=a.msgId||"unknown";return void ozpIwc.log.error("Failed to write packet(msgId="+d+"):"+c.message)}if(b.length<this.fragmentSize)this.queueSend(a);else{var e=b.chunk(this.fragmentSize),f=this;f.data=a.data,delete a.data;for(var g=function(a,b){return b.sequence=f.peer.sequenceCounter++,b.data={fragment:!0,msgId:f.data.msgId,id:h,total:e.length,chunk:a},b},h=0;h<e.length;h++)this.queueSend(g(e[h],a))}},ozpIwc.KeyBroadcastLocalStorageLink.prototype.queueSend=function(a){if(this.sendQueue.length<this.queueSize)for(this.sendQueue=this.sendQueue.concat(a);this.sendQueue.length>0;)this.attemptSend(this.sendQueue.shift());else ozpIwc.metrics.meter(this.metricsPrefix,"packets_failed").mark(),ozpIwc.log.error("Failed to write packet(len="+a.length+"): Send queue full.")},ozpIwc.KeyBroadcastLocalStorageLink.prototype.attemptSend=function(a,b){var c=this.sendImpl(a);if(c){var d=this;b=b||0;var e=Math.max(1,Math.pow(2,b-1))-1;if(!(b<d.maxRetries))return ozpIwc.metrics.meter(this.metricsPrefix,"packets_failed").mark(),ozpIwc.log.error("Failed to write packet(len="+a.length+"):"+c),c;b++,window.setTimeout(function(){d.attemptSend(a,b)},e)}},ozpIwc.KeyBroadcastLocalStorageLink.prototype.sendImpl=function(a){var b;try{var c=JSON.stringify(a);localStorage.setItem("x",c),ozpIwc.metrics.meter(this.metricsPrefix,"packets_sent").mark(),a.data.time&&ozpIwc.metrics.timer(this.metricsPrefix,"latencyOut").mark(ozpIwc.util.now()-a.data.time),localStorage.removeItem("x"),b=null}catch(d){"localStorage is null"===d.message?ozpIwc.util.alert("Cannot locate localStorage. Contact your system administrator.",d):18===d.code?ozpIwc.util.alert("Ozone requires your browser to accept cookies. Contact your system administrator.",d):b=d}finally{return b}};var ozpIwc=ozpIwc||{};ozpIwc.LocalStorageLink=function(a){a=a||{},this.prefix=a.prefix||"ozpIwc",this.peer=a.peer||ozpIwc.defaultPeer,this.selfId=a.selfId||this.peer.selfId,this.myKeysTimeout=a.myKeysTimeout||5e3,this.otherKeysTimeout=a.otherKeysTimeout||12e4;var b=this,c=function(a){var c=b.splitKey(a.key);if(c){var d=JSON.parse(localStorage.getItem(a.key));d?"object"!=typeof d?ozpIwc.metrics.counter("links.localStorage.packets.notAnObject").inc():(ozpIwc.metrics.counter("links.localStorage.packets.receive").inc(),b.peer.receive(b.linkId,d)):ozpIwc.metrics.counter("links.localStorage.packets.vanished").inc()}};window.addEventListener("storage",c,!1),this.peer.on("send",function(a){b.send(a.packet)}),this.peer.on("beforeShutdown",function(){b.cleanKeys(),window.removeEventListener("storage",c)},this),window.setInterval(function(){b.cleanKeys()},250),ozpIwc.metrics.gauge("links.localStorage.buffer").set(function(){for(var a={used:0,max:5242880,bufferLen:0,peerUsage:{},peerPackets:{}},c=0;c<localStorage.length;++c){var d=localStorage.key(c),e=localStorage.getItem(d),f=2*e.length,g=ozpIwc.util.now()-this.myKeysTimeout;a.used+=f;var h=b.splitKey(d);h&&(a.peerUsage[h.id]=a.peerUsage[h.id]?a.peerUsage[h.id]+f:f,a.peerPackets[h.id]=a.peerPackets[h.id]?a.peerPackets[h.id]+1:1,a.bufferLen++,h.createdAt<g&&(a.oldKeysCount++,a.oldKeysSize+=f))}return a})},ozpIwc.LocalStorageLink.prototype.makeKey=function(a){return[this.prefix,this.selfId,ozpIwc.util.now(),a].join("|")},ozpIwc.LocalStorageLink.prototype.splitKey=function(a){var b=a.split("|");return 4===b.length&&b[0]===this.prefix?{id:b[1],createdAt:parseInt(b[2])}:null},ozpIwc.LocalStorageLink.prototype.cleanKeys=function(){for(var a=ozpIwc.util.now(),b=a-this.myKeysTimeout,c=a-this.otherKeysTimeout,d=0;d<localStorage.length;++d){var e=localStorage.key(d),f=this.splitKey(e);f&&(f.id===this.selfId&&f.createdAt<=b||f.createdAt<=c)&&localStorage.removeItem(e)}},ozpIwc.LocalStorageLink.prototype.send=function(a){localStorage.setItem(this.makeKey(a.sequence),JSON.stringify(a)),ozpIwc.metrics.counter("links.localStorage.packets.sent").inc()},ozpIwc.Peer=function(){this.selfId=ozpIwc.util.generateId(),this.metricPrefix="peer."+this.selfId,this.sequenceCounter=0,this.packetsSeen={},this.knownPeers={},this.events=new ozpIwc.Event,this.events.mixinOnOff(this);var a=this;this.unloadListener=function(){a.shutdown()},window.addEventListener("beforeunload",this.unloadListener)},ozpIwc.Peer.maxSeqIdPerSource=500,ozpIwc.Peer.prototype.haveSeen=function(a){if(a.srcPeer===this.selfId)return ozpIwc.metrics.counter(this.metricPrefix,"droppedOwnPacket").inc(),!0;var b=this.packetsSeen[a.srcPeer];return b||(b=this.packetsSeen[a.srcPeer]=[]),b.indexOf(a.sequence)>=0?!0:(b.unshift(a.sequence),b.length>=ozpIwc.Peer.maxSeqIdPerSource&&(b.length=ozpIwc.Peer.maxSeqIdPerSource),!1)},ozpIwc.Peer.prototype.send=function(a){var b={srcPeer:this.selfId,sequence:this.sequenceCounter++,data:a},c=new ozpIwc.CancelableEvent({packet:b});this.events.trigger("preSend",c),c.canceled?ozpIwc.metrics.counter(this.metricPrefix,"sendRejected").inc():(ozpIwc.metrics.counter(this.metricPrefix,"sent").inc(),a.time&&ozpIwc.metrics.timer(this.metricPrefix,"latencyOut").mark(ozpIwc.util.now()-a.time),this.events.trigger("send",{packet:b}))},ozpIwc.Peer.prototype.receive=function(a,b){return this.haveSeen(b)?void ozpIwc.metrics.counter(this.metricPrefix,"dropped").inc():(ozpIwc.metrics.counter(this.metricPrefix,"received").inc(),b.data.time&&ozpIwc.metrics.timer(this.metricPrefix,"latencyIn").mark(ozpIwc.util.now()-b.data.time),void this.events.trigger("receive",{packet:b,linkId:a}))},ozpIwc.Peer.prototype.shutdown=function(){this.events.trigger("beforeShutdown"),window.removeEventListener("beforeunload",this.unloadListener)};var ozpIwc=ozpIwc||{};ozpIwc.Participant=function(){this.events=new ozpIwc.Event,this.events.mixinOnOff(this),this.permissions=new ozpIwc.policyAuth.SecurityAttribute,this.msgId=0,this.sentPacketsMeter=new ozpIwc.metricTypes.Meter,this.receivedPacketsMeter=new ozpIwc.metricTypes.Meter,this.forbiddenPacketsMeter=new ozpIwc.metricTypes.Meter,this.latencyInTimer=new ozpIwc.metricTypes.Meter,this.latencyOutTimer=new ozpIwc.metricTypes.Meter,this.participantType=this.constructor.name,this.heartBeatContentType="application/vnd.ozp-iwc-address-v1+json",this.heartBeatStatus={name:this.name,type:this.participantType||this.constructor.name},this.replyCallbacks={};var a=this;window.addEventListener("beforeunload",function(){a.send=function(b,c){var d=this.fixPacket(b);return c&&(a.replyCallbacks[d.msgId]=c),ozpIwc.Participant.prototype.send.call(a,d),d},a.leaveEventChannel()})},ozpIwc.Participant.prototype.receiveFromRouter=function(a){var b=this,c={subject:this.permissions.getAll(),resource:{"ozp:iwc:receiveAs":a.packet.dst},action:{"ozp:iwc:action":"receiveAs"},policies:ozpIwc.authorization.policySets.receiveAsSet},d=function(){b.forbiddenPacketsMeter.mark(),ozpIwc.metrics.counter("transport.packets.forbidden").inc(),console.error("failure")};ozpIwc.authorization.isPermitted(c,this).success(function(){ozpIwc.authorization.formatCategory(a.packet.permissions).success(function(c){var e={subject:b.permissions.getAll(),resource:c||{},action:{"ozp:iwc:action":"read"},policies:ozpIwc.authorization.policySets.readSet};ozpIwc.authorization.isPermitted(e,b).success(function(){b.receivedPacketsMeter.mark(),a.packet.time&&b.latencyInTimer.mark(ozpIwc.util.now()-a.packet.time),b.receiveFromRouterImpl(a)}).failure(d)}).failure(d)}).failure(d)},ozpIwc.Participant.prototype.receiveFromRouterImpl=function(a){return!a},ozpIwc.Participant.prototype.connectToRouter=function(a,b){this.address=b,this.router=a,this.msgId=0,this.metricRoot=this.name?"participants."+this.name+"."+this.address.split(".").reverse().join("."):"participants."+this.address.split(".").reverse().join("."),this.sentPacketsMeter=ozpIwc.metrics.meter(this.metricRoot,"sentPackets").unit("packets"),this.receivedPacketsMeter=ozpIwc.metrics.meter(this.metricRoot,"receivedPackets").unit("packets"),this.forbiddenPacketsMeter=ozpIwc.metrics.meter(this.metricRoot,"forbiddenPackets").unit("packets"),this.latencyInTimer=ozpIwc.metrics.timer(this.metricRoot,"latencyIn").unit("packets"),this.latencyOutTimer=ozpIwc.metrics.timer(this.metricRoot,"latencyOut").unit("packets"),this.namesResource="/address/"+this.address,this.heartBeatStatus.address=this.address,this.heartBeatStatus.name=this.name,this.heartBeatStatus.type=this.participantType||this.constructor.name,this.events.trigger("connectedToRouter"),this.joinEventChannel()},ozpIwc.Participant.prototype.fixPacket=function(a){return a.src=a.src||this.address,a.ver=a.ver||1,a.msgId=a.msgId||this.generateMsgId(),a.time=a.time||ozpIwc.util.now(),a},ozpIwc.Participant.prototype.send=function(a){var b=this,c={subject:this.permissions.getAll(),resource:{"ozp:iwc:sendAs":a.src},action:{"ozp:iwc:action":"sendAs"},policies:ozpIwc.authorization.policySets.sendAsSet};return a=b.fixPacket(a),ozpIwc.authorization.isPermitted(c,b).success(function(){b.sentPacketsMeter.mark(),a.time&&b.latencyOutTimer.mark(ozpIwc.util.now()-a.time),b.router.send(a,b)}).failure(function(a){console.error("Participant Failed to send a packet:",a)}),a},ozpIwc.Participant.prototype.generateMsgId=function(){return"i:"+this.msgId++},ozpIwc.Participant.prototype.heartbeat=function(){this.router&&this.send({dst:"names.api",resource:this.namesResource,action:"set",entity:this.heartBeatStatus,contentType:this.heartBeatContentType})},ozpIwc.Participant.prototype.joinEventChannel=function(){return this.router?(this.router.registerMulticast(this,["$bus.multicast"]),this.send({dst:"$bus.multicast",action:"connect",entity:{address:this.address,participantType:this.participantType}}),!0):!1},ozpIwc.Participant.prototype.leaveEventChannel=function(){return this.router?(this.send({dst:"$bus.multicast",action:"disconnect",entity:{address:this.address,participantType:this.participantType,namesResource:this.namesResource}}),!0):!1},ozpIwc.InternalParticipant=ozpIwc.util.extend(ozpIwc.Participant,function(a){a=a||{},ozpIwc.Participant.apply(this,arguments),this.replyCallbacks={},this.participantType="internal",this.name=a.name;var b=this;this.on("connectedToRouter",function(){b.permissions.pushIfNotExist("ozp:iwc:address",b.address),b.permissions.pushIfNotExist("ozp:iwc:sendAs",b.address),b.permissions.pushIfNotExist("ozp:iwc:receiveAs",b.address),ozpIwc.metrics.gauge(b.metricRoot,"registeredCallbacks").set(function(){return b.getCallbackCount()})})}),ozpIwc.InternalParticipant.prototype.getCallbackCount=function(){return this.replyCallbacks&&Object.keys(this.replyCallbacks)?Object.keys(this.replyCallbacks).length:0},ozpIwc.InternalParticipant.prototype.receiveFromRouterImpl=function(a){this.receivedPacketsMeter.mark();var b=a.packet;if(b.replyTo&&this.replyCallbacks[b.replyTo]){var c=!1,d=function(){c=!0};this.replyCallbacks[b.replyTo](b,d),c&&this.cancelCallback(b.replyTo)}else"$bus.multicast"===b.dst?this.events.trigger("receiveEventChannelPacket",a):this.events.trigger("receive",a)},ozpIwc.InternalParticipant.prototype.send=function(a,b){var c=this.fixPacket(a);b&&(this.replyCallbacks[c.msgId]=b);var d=this,e=ozpIwc.Participant.prototype.send;return ozpIwc.util.setImmediate(function(){e.call(d,c)}),c},ozpIwc.InternalParticipant.prototype.cancelCallback=function(a){var b=!1;return a&&(delete this.replyCallbacks[a],b=!0),b};var ozpIwc=ozpIwc||{};ozpIwc.TransportPacketContext=function(a){for(var b in a)this[b]=a[b]},ozpIwc.TransportPacketContext.prototype.replyTo=function(a){var b=(new Date).getTime();return a.ver=a.ver||1,a.time=a.time||b,a.replyTo=a.replyTo||this.packet.msgId,a.src=a.src||this.packet.dst,a.dst=a.dst||this.packet.src,this.dstParticipant?this.dstParticipant.send(a):(a.msgId=a.msgId||b,this.router.send(a)),a},ozpIwc.Router=function(a){a=a||{},this.peer=a.peer||ozpIwc.defaultPeer;var b=this;this.selfId=ozpIwc.util.generateId(),this.participants={},ozpIwc.metrics.gauge("transport.participants").set(function(){return Object.keys(b.participants).length}),this.events=new ozpIwc.Event,this.events.mixinOnOff(this),this.peer.on("receive",function(a){b.receiveFromPeer(a.packet)});var c=function(a){var b=a.packet;1!==b.ver&&a.cancel("badVersion"),b.src||a.cancel("nullSource"),b.dst||a.cancel("nullDestination"),a.canceled&&ozpIwc.metrics.counter("transport.packets.invalidFormat").inc()};this.events.on("preSend",c),a.disableBus||(this.participants["$bus.multicast"]=new ozpIwc.MulticastParticipant("$bus.multicast")),this.watchdog=new ozpIwc.RouterWatchdog({router:this,heartbeatFrequency:a.heartbeatFrequency}),this.registerParticipant(this.watchdog),ozpIwc.metrics.gauge("transport.router.participants").set(function(){return b.getParticipantCount()})},ozpIwc.Router.prototype.getParticipantCount=function(){return this.participants&&Object.keys(this.participants)?Object.keys(this.participants).length:0},ozpIwc.Router.prototype.shutdown=function(){this.watchdog.shutdown()},ozpIwc.Router.prototype.registerParticipant=function(a,b){b=b||{};var c;do c=ozpIwc.util.generateId()+"."+this.selfId;while(this.participants.hasOwnProperty(c));var d=new ozpIwc.CancelableEvent({packet:b,registration:b.entity,participant:a});if(this.events.trigger("preRegisterParticipant",d),d.canceled)return ozpIwc.log.log("registeredParticipant[DENIED] origin:"+a.origin+" because "+d.cancelReason),null;this.participants[c]=a,a.connectToRouter(this,c);var e=new ozpIwc.CancelableEvent({packet:b,participant:a});return this.events.trigger("registeredParticipant",e),c},ozpIwc.Router.prototype.deliverLocal=function(a,b){if(!a)throw"Cannot deliver a null packet!";var c=this.participants[a.dst];if(c){var d=new ozpIwc.TransportPacketContext({packet:a,router:this,srcParticipant:b,dstParticipant:c}),e=new ozpIwc.CancelableEvent({packet:a,dstParticipant:c,srcParticipant:b});if(this.events.trigger("preDeliver",e).canceled)return void ozpIwc.metrics.counter("transport.packets.rejected").inc();ozpIwc.metrics.counter("transport.packets.delivered").inc(),c.receiveFromRouter(d)}},ozpIwc.Router.prototype.registerMulticast=function(a,b){var c=this;return b.forEach(function(b){var d=c.participants[b];if(d||(d=c.participants[b]=new ozpIwc.MulticastParticipant(b)),d.addMember(a),a.address){var e=new ozpIwc.CancelableEvent({entity:{group:b,address:a.address}});a.permissions.pushIfNotExist("ozp:iwc:sendAs",b),a.permissions.pushIfNotExist("ozp:iwc:receiveAs",b),c.events.trigger("registeredMulticast",e)}else ozpIwc.log.log("no address for "+a.participantType+" "+a.name+"with address "+a.address+" for group "+b)}),b},ozpIwc.Router.prototype.send=function(a,b){var c=new ozpIwc.CancelableEvent({packet:a,participant:b});return this.events.trigger("preSend",c),c.canceled?void ozpIwc.metrics.counter("transport.packets.sendCanceled"):(ozpIwc.metrics.counter("transport.packets.sent").inc(),this.deliverLocal(a,b),this.events.trigger("send",{packet:a}),void this.peer.send(a))},ozpIwc.Router.prototype.receiveFromPeer=function(a){ozpIwc.metrics.counter("transport.packets.receivedFromPeer").inc();var b=Date.now();ozpIwc.metrics.histogram("transport.packets.latency").mark(b-a.data.time,b);var c=new ozpIwc.CancelableEvent({packet:a.data,rawPacket:a});this.events.trigger("prePeerReceive",c),c.canceled||this.deliverLocal(a.data)};var ozpIwc=ozpIwc||{};ozpIwc.LeaderGroupParticipant=ozpIwc.util.extend(ozpIwc.InternalParticipant,function(a){if(ozpIwc.InternalParticipant.apply(this,arguments),a.states=a.states||{},!a.name)throw"Config must contain a name value";this.name=a.name,this.electionAddress=a.electionAddress||this.name+".election",this.priority=a.priority||ozpIwc.defaultLeaderPriority||-ozpIwc.util.now(),this.priorityLessThan=a.priorityLessThan||function(a,b){return b>a},this.electionTimeout=a.electionTimeout||1e3,this.leaderState="connecting",this.electionQueue=[],this.states=a.states,this.states.leader=this.states.leader||[],this.states.leader=this.states.leader.concat(["leader"]),this.states.member=this.states.member||[],this.states.member=this.states.member.concat(["member"]),this.states.election=this.states.election||[],this.states.election=this.states.election.concat(["election"]),this.states.queueing=this.states.queueing||[],this.states.queueing=this.states.queueing.concat(["connecting","election"]),this.activeStates=a.activeStates||{leader:!1,member:!1,election:!1,queueing:!0},this.changeState("connecting"),this.leader=null,this.leaderPriority=null,this.participantType="leaderGroup",this.name=a.name,this.toggleDrop=!1,this.victoryTS=-Number.MAX_VALUE,this.on("startElection",function(){this.toggleDrop=!1},this),this.on("becameLeader",function(){this.leader=this.address,this.leaderPriority=this.priority,this.electionQueue.forEach(function(a){this.forwardToTarget(a)},this),this.electionQueue=[]},this),this.on("newLeader",function(){this.electionQueue=[]},this);var b=this;window.addEventListener("beforeunload",function(){if(b.priority=-Number.MAX_VALUE,b.activeStates.leader)for(var a in b.router.participants){var c=b.router.participants[a];c.address&&b.events.trigger("receiveEventChannelPacket",{packet:b.fixPacket({dst:"$bus.multicast",action:"disconnect",entity:{address:c.address,participantType:c.participantType,namesResource:c.namesResource}})})}b.events.trigger("unloadState")}),ozpIwc.metrics.gauge("transport.leaderGroup.election").set(function(){var a=b.getElectionQueue();return{queue:a?a.length:0}}),this.on("connectedToRouter",function(){this.router.registerMulticast(this,[this.electionAddress,this.name]);var a=this;ozpIwc.util.setImmediate(function(){a.startElection()})},this),this.on("receive",this.routePacket,this)}),ozpIwc.LeaderGroupParticipant.prototype.getElectionQueue=function(){return this.electionQueue},ozpIwc.LeaderGroupParticipant.prototype.inElection=function(){return!!this.electionTimer||this.activeStates.election},ozpIwc.LeaderGroupParticipant.prototype.isLeader=function(){return this.leader===this.address},ozpIwc.LeaderGroupParticipant.prototype.sendElectionMessage=function(a,b,c){b=b||{};var d=b.state||{},e=b.previousLeader||this.leader,f=b.opponent||"";try{JSON.stringify(d)}catch(g){ozpIwc.log.error(this.name,this.address,"failed to send state.",g),d={}}this.send({src:this.address,dst:this.electionAddress,action:a,entity:{priority:this.priority,state:d,previousLeader:e,opponent:f}},c)},ozpIwc.LeaderGroupParticipant.prototype.sendVictoryMessage=function(){return this.activeStates.leader||this.activeStates.election?this.send({src:this.address,dst:this.electionAddress,action:"victory",entity:{priority:this.priority}}):!1},ozpIwc.LeaderGroupParticipant.prototype.leaderQuery=function(){if(!this.inElection()){this.leaderQueryTimer=window.setTimeout(function(){a.cancelElection(),a.startElection()},this.electionTimeout);var a=this;this.sendElectionMessage("leaderQuery",{},function(b){window.clearTimeout(a.leaderQueryTimer),b.entity.priority>a.priority&&(this.leader=b.src,this.leaderPriority=b.entity.priority,this.victoryTS=b.time,a.events.trigger("newLeaderEvent"),this.stateStore={})})}},ozpIwc.LeaderGroupParticipant.prototype.startElection=function(a){a=a||{};var b=a.state||{},c=a.opponent||"";if(!this.inElection()){this.events.trigger("startElection");var d=this;this.electionTimer=window.setTimeout(function(){d.cancelElection(),d.events.trigger("becameLeaderEvent")
},this.electionTimeout),this.sendElectionMessage("election",{state:b,previousLeader:this.leader,opponent:c})}},ozpIwc.LeaderGroupParticipant.prototype.cancelElection=function(){this.electionTimer&&(window.clearTimeout(this.electionTimer),this.electionTimer=null,this.events.trigger("endElection"))},ozpIwc.LeaderGroupParticipant.prototype.routePacket=function(a){var b=a.packet;if(a.leaderState=this.leaderState,b.src!==this.address)if(b.dst===this.electionAddress){if(b.src===this.address)return;"leaderQuery"===b.action?this.handleLeaderQueryMessage(a):"election"===b.action?this.handleElectionMessage(b):"victory"===b.action&&this.handleVictoryMessage(b)}else this.forwardToTarget(a)},ozpIwc.LeaderGroupParticipant.prototype.forwardToTarget=function(a){return this.activeStates.queueing?void this.electionQueue.push(a):(a.leaderState=this.leaderState,void this.events.trigger("receiveApiPacket",a))},ozpIwc.LeaderGroupParticipant.prototype.handleLeaderQueryMessage=function(a){this.activeStates.leader&&a.replyTo({action:"leaderResponse",entity:{priority:this.priority}})},ozpIwc.LeaderGroupParticipant.prototype.handleElectionMessage=function(a){Object.keys(a.entity.state).length>0&&(this.stateStore=a.entity.state,this.events.trigger("receivedState")),a.entity.previousLeader&&a.entity.previousLeader!==this.address&&(this.previousLeader=a.entity.previousLeader),this.priorityLessThan(a.entity.priority,this.priority)&&this.victoryTS<a.time?(a.entity.priority===-Number.MAX_VALUE?(this.cancelElection(),this.activeStates.election=!1):this.inElection()||(this.electionQueue=[]),this.startElection({opponent:a.src})):this.activeStates.leader?this.sendElectionMessage("election",{previousLeader:this.address}):(this.cancelElection(),this.toggleDrop&&(this.toggleDrop=!1,this.events.trigger("newLeaderEvent")))},ozpIwc.LeaderGroupParticipant.prototype.handleVictoryMessage=function(a){this.priorityLessThan(a.entity.priority,this.priority)?this.startElection({opponent:a.src+"USURPER"}):(this.leader=a.src,this.leaderPriority=a.entity.priority,this.victoryTS=a.time,this.cancelElection(),this.events.trigger("newLeaderEvent"),this.stateStore={})},ozpIwc.LeaderGroupParticipant.prototype.heartbeatStatus=function(){var a=ozpIwc.Participant.prototype.heartbeatStatus.apply(this,arguments);return a.leaderState=this.leaderState,a.leaderPriority=this.priority,a},ozpIwc.LeaderGroupParticipant.prototype.changeState=function(a,b){if(a!==this.leaderState&&this._validateState(a)){for(var c in b)this[c]=b[c];return!0}return!1},ozpIwc.LeaderGroupParticipant.prototype._validateState=function(a){var b={},c=!1;for(var d in this.states)ozpIwc.util.arrayContainsAll(this.states[d],[a])?(b[d]=!0,c=!0):b[d]=!1;return c?(this.activeStates=b,this.leaderState=a,!0):(ozpIwc.log.error(this.address,this.name,"does not have state:",a),!1)};var ozpIwc=ozpIwc||{};ozpIwc.MulticastParticipant=ozpIwc.util.extend(ozpIwc.Participant,function(a){this.address=a,this.name=a,this.participantType="multicast",ozpIwc.Participant.apply(this,arguments),this.members=[],this.namesResource="/multicast/"+this.name,this.heartBeatContentType="application/vnd.ozp-iwc-multicast-address-v1+json",this.heartBeatStatus.members=[],this.on("connectedToRouter",function(){this.namesResource="/multicast/"+this.name},this),this.permissions.pushIfNotExist("ozp:iwc:address",a),this.permissions.pushIfNotExist("ozp:iwc:sendAs",a),this.permissions.pushIfNotExist("ozp:iwc:receiveAs",a)}),ozpIwc.MulticastParticipant.prototype.receiveFromRouterImpl=function(a){return this.receivedPacketsMeter.mark(),this.members.forEach(function(b){a.dstParticipant=b,b.receiveFromRouter(a)}),!1},ozpIwc.MulticastParticipant.prototype.addMember=function(a){this.members.push(a),this.heartBeatStatus.members.push(a.address)};var ozpIwc=ozpIwc||{};ozpIwc.PostMessageParticipant=ozpIwc.util.extend(ozpIwc.Participant,function(a){ozpIwc.Participant.apply(this,arguments),this.origin=this.name=a.origin,this.sourceWindow=a.sourceWindow,this.credentials=a.credentials,this.participantType="postMessageProxy",this.permissions.pushIfNotExist("ozp:iwc:origin",this.origin),this.on("connectedToRouter",function(){this.permissions.pushIfNotExist("ozp:iwc:address",this.address),this.permissions.pushIfNotExist("ozp:iwc:sendAs",this.address),this.permissions.pushIfNotExist("ozp:iwc:receiveAs",this.address)},this),this.heartBeatStatus.origin=this.origin}),ozpIwc.PostMessageParticipant.prototype.receiveFromRouterImpl=function(a){this.receivedPacketsMeter.mark(),this.sendToRecipient(a.packet)},ozpIwc.PostMessageParticipant.prototype.sendToRecipient=function(a){ozpIwc.util.safePostMessage(this.sourceWindow,a,this.origin)},ozpIwc.PostMessageParticipant.prototype.handleTransportPacket=function(a){var b={ver:1,dst:this.address,src:"$transport",replyTo:a.msgId,msgId:this.generateMsgId(),entity:{address:this.address}};this.sendToRecipient(b)},ozpIwc.PostMessageParticipant.prototype.forwardFromPostMessage=function(a,b){return"object"!=typeof a?void ozpIwc.log.error("Unknown packet received: "+JSON.stringify(a)):b.origin!==this.origin?void ozpIwc.metrics.counter("transport."+this.address+".invalidSenderOrigin").inc():(a=this.fixPacket(a),void("$transport"===a.dst?this.handleTransportPacket(a):this.router.send(a,this)))},ozpIwc.PostMessageParticipantListener=function(a){a=a||{},this.participants=[],this.router=a.router||ozpIwc.defaultRouter;var b=this;window.addEventListener("message",function(a){b.receiveFromPostMessage(a)},!1),ozpIwc.metrics.gauge("transport.postMessageListener.participants").set(function(){return b.getParticipantCount()})},ozpIwc.PostMessageParticipantListener.prototype.getParticipantCount=function(){return this.participants?this.participants.length:0},ozpIwc.PostMessageParticipantListener.prototype.findParticipant=function(a){for(var b=0;b<this.participants.length;++b)if(this.participants[b].sourceWindow===a)return this.participants[b]},ozpIwc.PostMessageParticipantListener.prototype.receiveFromPostMessage=function(a){var b=this.findParticipant(a.source),c=a.data;if(a.source!==window){if("string"==typeof a.data)try{c=JSON.parse(a.data)}catch(d){return}var e=function(c){ozpIwc.util.isIWCPacket(c)?b.forwardFromPostMessage(c,a):ozpIwc.log.log("Packet does not meet IWC Packet criteria, dropping.",c)};if(b)e(c);else{var f=this,g={subject:{"ozp:iwc:origin":a.origin},action:{"ozp:iwc:action":"connect"},policies:ozpIwc.authorization.policySets.connectSet};ozpIwc.authorization.isPermitted(g).success(function(){b=new ozpIwc.PostMessageParticipant({origin:a.origin,sourceWindow:a.source,credentials:c.entity}),f.router.registerParticipant(b,c),f.participants.push(b),e(c)}).failure(function(a){console.error("Failed to connect. Could not authorize:",a)})}}},ozpIwc.RouterWatchdog=ozpIwc.util.extend(ozpIwc.InternalParticipant,function(a){ozpIwc.InternalParticipant.apply(this,arguments),this.participantType="routerWatchdog",this.on("connected",function(){this.name=this.router.selfId},this),this.heartbeatFrequency=a.heartbeatFrequency||1e4,this.on("connectedToRouter",this.setupWatches,this)}),ozpIwc.RouterWatchdog.prototype.leaveEventChannel=function(){return this.router?(this.send({dst:"$bus.multicast",action:"disconnect",entity:{address:this.address,participantType:this.participantType,namesResource:this.namesResource}}),this.send({dst:"$bus.multicast",action:"disconnect",entity:{address:this.router.selfId,namesResource:"/router/"+this.router.selfId}}),!0):!1},ozpIwc.RouterWatchdog.prototype.setupWatches=function(){this.name=this.router.selfId;var a=this,b=function(){a.send({dst:"names.api",action:"set",resource:"/router/"+a.router.selfId,contentType:"application/vnd.ozp-iwc-router-v1+json",entity:{address:a.router.selfId,participants:a.router.getParticipantCount(),time:ozpIwc.util.now()}});for(var b in a.router.participants){var c=a.router.participants[b];c.heartBeatStatus.time=ozpIwc.util.now(),c instanceof ozpIwc.MulticastParticipant?c.members.forEach(function(b){a.send({dst:"names.api",resource:c.namesResource+"/"+b.address,action:"set",entity:b.heartBeatStatus,contentType:c.heartBeatContentType})}):c.heartbeat()}};this.timer=window.setInterval(b,this.heartbeatFrequency)},ozpIwc.RouterWatchdog.prototype.shutdown=function(){window.clearInterval(this.timer)},ozpIwc.CommonApiValue=function(a){a=a||{},this.watchers=a.watchers||[],this.resource=a.resource,this.allowedContentTypes=a.allowedContentTypes,this.entity=a.entity,this.contentType=a.contentType,this.permissions=new ozpIwc.policyAuth.SecurityAttribute;for(var b in a.permissions)this.permissions.pushIfNotExist(b,a.permissions[b]);this.version=a.version||0,this.persist=!1,this.deleted=!0},ozpIwc.CommonApiValue.prototype.set=function(a){if(this.isValidContentType(a.contentType)){if(!Array.isArray(a.permissions))for(var b in a.permissions)this.permissions.clear(b),this.permissions.pushIfNotExist(b,a.permissions[b]);this.contentType=a.contentType,this.entity=a.entity,this.version++}},ozpIwc.CommonApiValue.prototype.watch=function(a){this.watchers.push({src:a.src,msgId:a.msgId})},ozpIwc.CommonApiValue.prototype.unwatch=function(a){this.watchers=this.watchers.filter(function(b){return a.replyTo!==b.msgId&&a.src!==b.src})},ozpIwc.CommonApiValue.prototype.eachWatcher=function(a,b){return b=b||this,this.watchers.map(a,b)},ozpIwc.CommonApiValue.prototype.deleteData=function(){this.entity=void 0,this.contentType=void 0,this.permissions.clearAll(),this.version=0,this.deleted=!0},ozpIwc.CommonApiValue.prototype.toPacket=function(a){return a=a||{},a.entity=ozpIwc.util.clone(this.entity),a.contentType=this.contentType,a.permissions=ozpIwc.util.clone(this.permissions.getAll()),a.eTag=this.version,a.resource=this.resource,a},ozpIwc.CommonApiValue.prototype.isValidContentType=function(a){if(this.allowedContentTypes&&this.allowedContentTypes.indexOf(a)<0)throw new ozpIwc.ApiError("badContent","Bad contentType "+a+", expected "+this.allowedContentTypes.join(","));return!0},ozpIwc.CommonApiValue.prototype.snapshot=function(){return this.toPacket()},ozpIwc.CommonApiValue.prototype.changesSince=function(a){return a.eTag===this.version?null:{newValue:ozpIwc.util.clone(this.entity),oldValue:a.entity}},ozpIwc.CommonApiValue.prototype.isUpdateNeeded=function(){return!1},ozpIwc.CommonApiValue.prototype.updateContent=function(){return null},ozpIwc.CommonApiValue.prototype.deserialize=function(a){var b=ozpIwc.util.clone(a);this.entity=b.entity||{},this.contentType=b.contentType||this.contentType;for(var c in b.permissions)this.permissions.pushIfNotExist(c,b.permissions[c]);this.version=b.version||this.version,this.watchers=a.watchers||this.watchers},ozpIwc.CommonApiValue.prototype.serialize=function(){var a={};return a.entity=this.entity,a.contentType=this.contentType,a.permissions=this.permissions.getAll(),a.version=this.version,a.watchers=this.watchers,a},ozpIwc.CommonApiCollectionValue=ozpIwc.util.extend(ozpIwc.CommonApiValue,function(a){ozpIwc.CommonApiValue.apply(this,arguments),this.persist=!1,this.pattern=a.pattern||"",this.pattern.toJSON=RegExp.prototype.toString,this.entity=[]}),ozpIwc.CommonApiCollectionValue.prototype.isUpdateNeeded=function(a){return a.resource.match(this.pattern)},ozpIwc.CommonApiCollectionValue.prototype.updateContent=function(a){this.version++,this.entity=a.map(function(a){return a.resource})},ozpIwc.CommonApiCollectionValue.prototype.set=function(){throw new ozpIwc.ApiError("noPermission","This resource cannot be modified.")},ozpIwc.CommonApiCollectionValue.prototype.deserialize=function(a){ozpIwc.CommonApiValue.prototype.deserialize.apply(this,arguments);var b=ozpIwc.util.clone(a);this.pattern="string"==typeof b.pattern?new RegExp(b.pattern.replace(/^\/|\/$/g,"")):this.pattern,this.pattern.toJSON=RegExp.prototype.toString},ozpIwc.CommonApiCollectionValue.prototype.serialize=function(){var a={};return a.entity=this.entity,a.pattern=this.pattern,a.contentType=this.contentType,a.permissions=this.permissions,a.version=this.version,a.watchers=this.watchers,a},ozpIwc.ApiError=ozpIwc.util.extend(Error,function(a,b){Error.call(this,b),this.name="ApiError",this.errorAction=a,this.message=b}),ozpIwc.CommonApiBase=function(a){a=a||{},this.participant=a.participant,this.participant.on("unloadState",this.unloadState,this),this.participant.on("receiveApiPacket",this.routePacket,this),this.participant.on("becameLeaderEvent",this.becameLeader,this),this.participant.on("newLeaderEvent",this.newLeader,this),this.participant.on("startElection",this.startElection,this),this.participant.on("receiveEventChannelPacket",this.routeEventChannel,this),this.events=new ozpIwc.Event,this.events.mixinOnOff(this),this.dynamicNodes=[],this.data={},this.expectedBranches=1,this.retrievedBranches=0},ozpIwc.CommonApiBase.prototype.findNodeForServerResource=function(a,b,c){var d="/";switch(c.name){case ozpIwc.linkRelPrefix+":intent":a.type&&(d+=a.type,a.action&&(d+="/"+a.action,a.handler&&(d+="/"+a.handler)));break;case ozpIwc.linkRelPrefix+":application":a.id&&(d+="application/"+a.id);break;case ozpIwc.linkRelPrefix+":system":d+="system";break;case ozpIwc.linkRelPrefix+":user":d+="user";break;case ozpIwc.linkRelPrefix+":user-data":a.key&&(d+=a.key);break;default:d+="FIXME_UNKNOWN_ENDPOINT_"+c.name}return"/"===d?null:this.findOrMakeValue({resource:d,entity:{},contentType:a.contentType,children:a.children})},ozpIwc.CommonApiBase.prototype.loadFromServer=function(){return new Promise(function(a){a()})},ozpIwc.CommonApiBase.prototype.loadFromEndpoint=function(a,b){this.expectedBranches=1,this.retrievedBranches=0;var c,d,e=ozpIwc.endpoint(a),f=new Promise(function(a,b){c=a,d=b}),g=this;return e.get("/").then(function(a){var d=a.response,f=a.header;g.loadLinkedObjectsFromServer(e,d,c,b,f),g.updateResourceFromServer(d,d._links.self.href,e,c,f),g.dynamicNodes.forEach(function(a){g.updateDynamicNode(g.data[a])})})["catch"](function(b){ozpIwc.log.error("Could not load from api ("+a+"): "+b.message,b),d("Could not load from api ("+a+"): "+b.message+b)}),f},ozpIwc.CommonApiBase.prototype.updateResourceFromServer=function(a,b,c,d,e){e=e||{},a.contentType=a.contentType||e["Content-Type"]||"application/json";var f;if("string"==typeof a.entity)try{f=JSON.parse(a.entity),a.entity=f}catch(g){}var h=this.findNodeForServerResource(a,b,c);if(h){var i=h.snapshot(),j=ozpIwc.util.clone(a);delete j._links,delete j._embedded,h.deserialize(this.formatServerData(j)),this.notifyWatchers(h,h.changesSince(i)),this.loadLinkedObjectsFromServer(c,a,d)}},ozpIwc.CommonApiBase.prototype.formatServerData=function(a){return{entity:a}},ozpIwc.CommonApiBase.prototype.loadLinkedObjectsFromServer=function(a,b,c,d){if(b){var e=this,f=!0,g=!0,h=0,i=0;if(b._embedded&&b._embedded.item&&(b._embedded.item=Array.isArray(b._embedded.item)?b._embedded.item:[b._embedded.item],f=!1,i="[object Array]"===Object.prototype.toString.call(b._embedded.item)?b._embedded.item.length:1,h+=i),b._links&&b._links.item&&(b._links.item=Array.isArray(b._links.item)?b._links.item:[b._links.item],g=!1,i="[object Array]"===Object.prototype.toString.call(b._links.item)?b._links.item.length:1,h+=i),f&&g)this.retrievedBranches++,this.retrievedBranches>=this.expectedBranches&&c("RESOLVING");else{if(this.expectedBranches+=h-1,b._embedded&&b._embedded.item){var j={};if("[object Array]"===Object.prototype.toString.call(b._embedded.item))for(var k in b._embedded.item)j=b._embedded.item[k],this.updateResourceFromServer(j,j._links.self.href,a,c);else j=b._embedded.item,this.updateResourceFromServer(j,j._links.self.href,a,c)}if(b._links&&b._links.item)if("[object Array]"===Object.prototype.toString.call(b._links.item))b._links.item.forEach(function(b){var f=b.href;a.get(f,d).then(function(b){var d=b.response,g=b.header;e.updateResourceFromServer(d,f,a,c,g)})["catch"](function(a){ozpIwc.log.error("unable to load "+b.href+" because: ",a)})});else{var l=b._links.item.href;a.get(l,d).then(function(b){var d=b.response,f=b.header;e.updateResourceFromServer(d,l,a,c,f)})["catch"](function(a){ozpIwc.log.error("unable to load "+j.href+" because: ",a)})}}}},ozpIwc.CommonApiBase.prototype.makeValue=function(){throw new Error("Subclasses of CommonApiBase must implement the makeValue(packet) function.")},ozpIwc.CommonApiBase.prototype.isPermitted=function(a,b){var c=new ozpIwc.AsyncAction;return ozpIwc.authorization.formatCategory(a.packet.permissions).success(function(a){var d={subject:b.permissions.getAll(),resource:a||{},action:{"ozp:iwc:action":"access"},policies:ozpIwc.authorization.policySets.apiSet};ozpIwc.authorization.isPermitted(d,b).success(function(a){c.resolve("success",a)}).failure(function(a){console.error("Api could not perform action:",a),c.resolve("failure",a)})}).failure(function(a){console.error("Api could not format permission check on packet",a),c.resolve("failure",a)}),c},ozpIwc.CommonApiBase.prototype.notifyWatchers=function(a,b){b&&(this.events.trigger("changedNode",a,b),a.eachWatcher(function(c){var d={dst:c.src,src:this.participant.name,replyTo:c.msgId,response:"changed",resource:a.resource,permissions:a.permissions.getAll(),entity:b};this.participant.send(d)},this))},ozpIwc.CommonApiBase.prototype.findOrMakeValue=function(a){if(null===a.resource||void 0===a.resource)return new ozpIwc.CommonApiValue;var b=this.data[a.resource];return b||(b=this.data[a.resource]=this.makeValue(a)),b},ozpIwc.CommonApiBase.prototype.hasKey=function(a){return a in this.data},ozpIwc.CommonApiBase.prototype.createKey=function(a){a=a||"";var b;do b=a+ozpIwc.util.generateId();while(this.hasKey(b));return b},ozpIwc.CommonApiBase.prototype.routePacket=function(a){var b=a.packet;this.events.trigger("receive",a);var c=this,d=function(b){try{b.apply(c)}catch(d){return d.errorAction||ozpIwc.log.log("Unexpected error:",d),void a.replyTo({response:d.errorAction||"unknownError",entity:d.message})}};if(!("leader"!==a.leaderState&&"actingLeader"!==a.leaderState||b.response&&!b.action)){var e;d(function(){var b=this.findHandler(a);this.validateResource(e,a),e=this.findOrMakeValue(a.packet),this.isPermitted(a,e).success(function(){d(function(){this.validatePreconditions(e,a);var c=e.snapshot();b.call(this,e,a),this.notifyWatchers(e,e.changesSince(c)),this.dynamicNodes.forEach(function(a){this.updateDynamicNode(this.data[a])},this)})},this).failure(function(){a.replyTo({response:"noPerm"}),console.log("failure")})})}},ozpIwc.CommonApiBase.prototype.routeEventChannel=function(a){if(this.participant.activeStates.leader){var b=a.packet;switch(b.action){case"connect":this.handleEventChannelConnect(a);break;case"disconnect":this.handleEventChannelDisconnect(a);break;default:ozpIwc.log.error(this.participant.name,"No handler found for corresponding event channel action: ",b.action)}}},ozpIwc.CommonApiBase.prototype.handleEventChannelDisconnect=function(a){for(var b in this.data)for(var c in this.data[b].watchers)this.data[b].watchers[c].src===a.packet.entity.address&&this.data[b].watchers.splice(c,1);this.handleEventChannelDisconnectImpl(a)},ozpIwc.CommonApiBase.prototype.handleEventChannelConnect=function(a){this.handleEventChannelConnectImpl(a)},ozpIwc.CommonApiBase.prototype.handleEventChannelDisconnectImpl=function(){},ozpIwc.CommonApiBase.prototype.handleEventChannelConnectImpl=function(){},ozpIwc.CommonApiBase.prototype.findHandler=function(a){var b,c=a.packet.action,d=a.packet.resource;return b=null===d||void 0===d?"rootHandle":"handle",c?b+=c.charAt(0).toUpperCase()+c.slice(1).toLowerCase():b="defaultHandler",b&&"function"==typeof this[b]||(b="defaultHandler"),this[b]},ozpIwc.CommonApiBase.prototype.validateResource=function(){return!0},ozpIwc.CommonApiBase.prototype.validatePreconditions=function(a,b){if(b.packet.ifTag&&b.packet.ifTag!==a.version)throw new ozpIwc.ApiError("noMatch","Latest version is "+a.version)},ozpIwc.CommonApiBase.prototype.validateContentType=function(){return!0},ozpIwc.CommonApiBase.prototype.updateDynamicNode=function(a){if(a){var b=[];for(var c in this.data)a.isUpdateNeeded(this.data[c])&&b.push(this.data[c]);if(b){var d=a.snapshot();a.updateContent(b),this.notifyWatchers(a,a.changesSince(d))}}},ozpIwc.CommonApiBase.prototype.addDynamicNode=function(a){this.data[a.resource]=a,this.dynamicNodes.push(a.resource),this.updateDynamicNode(a)},ozpIwc.CommonApiBase.prototype.defaultHandler=function(a,b){b.replyTo({response:"badAction",entity:{action:b.packet.action,originalRequest:b.packet}})},ozpIwc.CommonApiBase.prototype.handleGet=function(a,b){b.replyTo(a.toPacket({response:"ok"}))},ozpIwc.CommonApiBase.prototype.handleSet=function(a,b){a.set(b.packet),b.replyTo({response:"ok"})},ozpIwc.CommonApiBase.prototype.handleDelete=function(a,b){a.deleteData(),b.replyTo({response:"ok"})},ozpIwc.CommonApiBase.prototype.handleWatch=function(a,b){a.watch(b.packet),b.replyTo({response:"ok"})},ozpIwc.CommonApiBase.prototype.handleUnwatch=function(a,b){a.unwatch(b.packet),b.replyTo({response:"ok"})},ozpIwc.CommonApiBase.prototype.unloadState=function(){if(this.participant.activeStates.leader){var a={};for(var b in this.data)a[b]=this.data[b].serialize();this.participant.sendElectionMessage("election",{state:{data:a,dynamicNodes:this.dynamicNodes},previousLeader:this.participant.address}),this.data={}}else this.participant.sendElectionMessage("election")},ozpIwc.CommonApiBase.prototype.setState=function(a){this.data={},this.dynamicNodes=a.dynamicNodes;for(var b in a.data){var c,d=this.dynamicNodes.indexOf(b);d>-1?(c=this.data[b]=new ozpIwc.CommonApiCollectionValue({resource:b}),c.deserialize(a.data[b]),this.updateDynamicNode(c)):(c=this.findOrMakeValue({resource:b,contentType:a.data[b].contentType}),c.deserialize(a.data[b]))}this.dynamicNodes.forEach(function(a){this.updateDynamicNode(this.data[a])},this)},ozpIwc.CommonApiBase.prototype.rootHandleList=function(a,b){b.replyTo({response:"ok",entity:Object.keys(this.data)})},ozpIwc.CommonApiBase.prototype.startElection=function(){this.participant.activeStates.leader?this.participant.changeState("actingLeader"):"leaderSync"===this.participant.leaderState||this.participant.changeState("election")},ozpIwc.CommonApiBase.prototype.becameLeader=function(){this.participant.sendElectionMessage("victory"),"actingLeader"===this.participant.leaderState||"leader"===this.participant.leaderState?this.setToLeader():"election"===this.participant.leaderState&&this.leaderSync()},ozpIwc.CommonApiBase.prototype.newLeader=function(){"actingLeader"===this.participant.leaderState&&this.participant.sendElectionMessage("election",{previousLeader:this.participant.address,state:this.data}),this.participant.changeState("member"),this.participant.events.trigger("newLeader")},ozpIwc.CommonApiBase.prototype.setToLeader=function(){var a=this;ozpIwc.util.setImmediate(function(){a.participant.changeState("leader"),a.participant.events.trigger("becameLeader")})},ozpIwc.CommonApiBase.prototype.leaderSync=function(){this.participant.changeState("leaderSync",{toggleDrop:!0});var a=this;ozpIwc.util.setImmediate(function(){if("leaderSync"===a.participant.leaderState)if(a.participant.stateStore&&Object.keys(a.participant.stateStore).length>0)a.setState(a.participant.stateStore),a.participant.stateStore={},a.setToLeader();else if(a.participant.previousLeader){a.receiveStateTimer=null;var b=function(){a.setState(a.participant.stateStore),a.participant.off("receivedState",b),a.setToLeader(),window.clearInterval(a.receiveStateTimer),a.receiveStateTimer=null};a.participant.on("receivedState",b),a.receiveStateTimer=window.setTimeout(function(){a.participant.stateStore&&Object.keys(a.participant.stateStore).length>0?b():(a.loadFromServer(),ozpIwc.log.log(a.participant.name,"New leader(",a.participant.address,") failed to retrieve state from previous leader(",a.participant.previousLeader,"), so is loading data from server.")),a.participant.off("receivedState",b),a.setToLeader()},250)}else ozpIwc.log.log(a.participant.name,"New leader(",a.participant.address,") is loading data from server."),a.loadFromServer().then(function(){a.setToLeader()},function(b){ozpIwc.log.error(a.participant.name,"New leader(",a.participant.address,") could not load data from server. Error:",b),a.setToLeader()})["catch"](function(a){ozpIwc.log.log(a)})})},ozpIwc.CommonApiBase.prototype.persistNodes=function(){throw new ozpIwc.ApiError("noImplementation","Base class persistence call not implemented.  Use DataApi to persist nodes.")};var ozpIwc=ozpIwc||{};ozpIwc.Endpoint=function(a){this.endpointRegistry=a},ozpIwc.Endpoint.prototype.get=function(a,b){var c=this;return a=a||"",this.endpointRegistry.loadPromise.then(function(){return("/"===a||""===a)&&(a=c.baseUrl),ozpIwc.util.ajax({href:a,method:"GET",headers:b})})},ozpIwc.Endpoint.prototype.put=function(a,b,c){var d=this;return this.endpointRegistry.loadPromise.then(function(){return 0!==a.indexOf(d.baseUrl)&&(a=d.baseUrl+a),ozpIwc.util.ajax({href:a,method:"PUT",data:b,headers:c})})},ozpIwc.Endpoint.prototype["delete"]=function(a,b,c){var d=this;return this.endpointRegistry.loadPromise.then(function(){if(!d.baseUrl)throw Error("The server did not define a relation of type "+this.name+" for retrivieving "+a);return 0!==a.indexOf(d.baseUrl)&&(a=d.baseUrl+a),ozpIwc.util.ajax({href:a,method:"DELETE",headers:c})})},ozpIwc.Endpoint.prototype.saveNodes=function(a){var b="/data";for(var c in a){var d=JSON.stringify(a[c]);this.put(a[c].self||b,d)}},ozpIwc.EndpointRegistry=function(a){a=a||{};var b=a.apiRoot||"/api";this.apiRoot=b,this.endPoints={};var c=this;this.loadPromise=ozpIwc.util.ajax({href:b,method:"GET"}).then(function(a){var b=a.response||{};b._links=b._links||{},b._embedded=b._embedded||{};for(var d in b._links)if("self"!==d){var e=b._links[d].href;Array.isArray(b._links[d])&&(e=b._links[d][0].href),c.endpoint(d).baseUrl=e}for(var f in b._embedded){var g=b._embedded[f]._links.self.href;c.endpoint(f).baseUrl=g}})},ozpIwc.EndpointRegistry.prototype.endpoint=function(a){var b=this.endPoints[a];return b||(b=this.endPoints[a]=new ozpIwc.Endpoint(this),b.name=a),b},ozpIwc.initEndpoints=function(a){var b=new ozpIwc.EndpointRegistry({apiRoot:a});ozpIwc.endpoint=function(a){return b.endpoint(a)}},ozpIwc.DataApi=ozpIwc.util.extend(ozpIwc.CommonApiBase,function(){ozpIwc.CommonApiBase.apply(this,arguments),this.endpointUrl=ozpIwc.linkRelPrefix+":user-data"}),ozpIwc.DataApi.prototype.loadFromServer=function(){return this.loadFromEndpoint(this.endpointUrl)},ozpIwc.DataApi.prototype.makeValue=function(a){return new ozpIwc.DataApiValue(a)},ozpIwc.DataApi.prototype.formatServerData=function(a){return a.entity},ozpIwc.DataApi.prototype.createChild=function(a,b){var c=this.createKey(a.resource+"/"),d=this.findOrMakeValue({resource:c});return d.set(b.packet),d},ozpIwc.DataApi.prototype.handleList=function(a,b){b.replyTo({response:"ok",entity:a.listChildren()})},ozpIwc.DataApi.prototype.handleAddchild=function(a,b){var c=this.createChild(a,b);c&&c.entity&&c.entity.persist&&this.persistNode(c),a.addChild(c.resource),a&&b.packet.entity.persist&&this.persistNode(a),b.replyTo({response:"ok",entity:{resource:c.resource}})},ozpIwc.DataApi.prototype.handleRemovechild=function(a,b){a.removeChild(b.packet.entity.resource),a&&b.packet.entity.persist&&this.persistNode(a);var c=this.findOrMakeValue(b.packet.entity);c&&c.entity&&c.entity.persist&&this.deleteNode(c),b.replyTo({response:"ok"})},ozpIwc.DataApi.prototype.handleSet=function(a,b){ozpIwc.CommonApiBase.prototype.handleSet.apply(this,arguments),a&&b.packet.entity.persist&&this.persistNode(a)},ozpIwc.DataApi.prototype.handleDelete=function(a){a.entity&&a.entity.persist&&this.deleteNode(a),ozpIwc.CommonApiBase.prototype.handleDelete.apply(this,arguments)},ozpIwc.DataApi.prototype.persistNode=function(a){var b=ozpIwc.endpoint(this.endpointUrl),c=a.serialize();delete c.watchers,b.put(a.resource,JSON.stringify(c))},ozpIwc.DataApi.prototype.deleteNode=function(a){var b=ozpIwc.endpoint(this.endpointUrl);b["delete"](a.resource)},ozpIwc.DataApi.prototype.persistNodes=function(){var a=[];for(var b in this.data)this.data[b].dirty===!0&&this.data[b].persist===!0&&(a[a.length]=this.data[b].serialize(),this.data[b].dirty=!1);if(a){var c=ozpIwc.EndpointRegistry.endpoint(this.endpointUrl);c.saveNodes(a)}},ozpIwc.DataApiValue=ozpIwc.util.extend(ozpIwc.CommonApiValue,function(a){ozpIwc.CommonApiValue.apply(this,arguments),a=a||{},this.children=a.children||[],this.persist=a.persist||!0,this.dirty=a.dirty||!0}),ozpIwc.DataApiValue.prototype.addChild=function(a){this.children.indexOf(a)<0&&(this.children.push(a),this.version++),this.dirty=!0},ozpIwc.DataApiValue.prototype.removeChild=function(a){this.dirty=!0;var b=this.children.length;this.children=this.children.filter(function(b){return b!==a}),b!==this.children.length&&this.version++},ozpIwc.DataApiValue.prototype.listChildren=function(){return ozpIwc.util.clone(this.children)},ozpIwc.DataApiValue.prototype.toPacket=function(){var a=ozpIwc.CommonApiValue.prototype.toPacket.apply(this,arguments);return a.links=a.links||{},a.links.children=this.listChildren(),a},ozpIwc.DataApiValue.prototype.changesSince=function(a){var b=ozpIwc.CommonApiValue.prototype.changesSince.apply(this,arguments);return b&&(b.removedChildren=a.links.children.filter(function(a){return this.indexOf(a)<0},this.children),b.addedChildren=this.children.filter(function(a){return this.indexOf(a)<0},a.links.children)),b},ozpIwc.DataApiValue.prototype.deserialize=function(a){ozpIwc.CommonApiValue.prototype.deserialize.apply(this,arguments);var b=ozpIwc.util.clone(a);this.key=b.key||this.key,this.children=b.children||this.children,this.self=b.self||this.self},ozpIwc.DataApiValue.prototype.serialize=function(){var a={};return a.entity=this.entity,a.children=this.children,a.contentType=this.contentType,a.permissions=this.permissions,a.version=this.version,a.self=this.self,a.watchers=this.watchers,a},ozpIwc.IntentsApi=ozpIwc.util.extend(ozpIwc.CommonApiBase,function(){ozpIwc.CommonApiBase.apply(this,arguments),this.addDynamicNode(new ozpIwc.CommonApiCollectionValue({resource:"/ozpIntents/invocations",pattern:/^\/ozpIntents\/invocations\/.*$/,contentType:"application/vnd.ozp-iwc-intent-invocation-list-v1+json"}))}),ozpIwc.IntentsApi.prototype.loadFromServer=function(){return this.loadFromEndpoint(ozpIwc.linkRelPrefix+":intent")},ozpIwc.IntentsApi.prototype.makeValue=function(a){var b=a.resource.split(/\//);b.shift();var c=this,d=function(a){var d=new ozpIwc.IntentsApiTypeValue({resource:a,intentType:b[0]+"/"+b[1]});return c.addDynamicNode(d),d},e=function(a){var e="/"+b[0]+"/"+b[1];c.data[e]||(c.data[e]=d(e));var f=new ozpIwc.IntentsApiDefinitionValue({resource:a,intentType:b[0]+"/"+b[1],intentAction:b[2]});return c.addDynamicNode(f),f},f=function(a){var d="/"+b[0]+"/"+b[1]+"/"+b[2];return c.data[d]||(c.data[d]=e(d)),new ozpIwc.IntentsApiHandlerValue({resource:a,intentType:b[0]+"/"+b[1],intentAction:b[2]})};switch(b.length){case 2:return d(a.resource);case 3:return e(a.resource);case 4:return f(a.resource);default:throw new ozpIwc.ApiError("badResource","Invalid resource: "+a.resource)}},ozpIwc.IntentsApi.prototype.makeIntentInvocation=function(a,b){var c=this.createKey("/ozpIntents/invocations/"),d=new ozpIwc.IntentsApiInFlightIntent({resource:c,invokePacket:b.packet,contentType:a.contentType,type:a.entity.type,action:a.entity.action,entity:b.packet.entity,handlerChoices:a.getHandlers(b)});return this.data[d.resource]=d,d},ozpIwc.IntentsApi.prototype.handleRegister=function(a,b){var c=this.createKey(a.resource+"/"),d=this.findOrMakeValue({resource:c}),e=ozpIwc.util.clone(d);e.permissions=d.permissions.getAll(),b.packet.entity.invokeIntent=b.packet.entity.invokeIntent||{},b.packet.entity.invokeIntent.dst=b.packet.src,b.packet.entity.invokeIntent.replyTo=b.packet.msgId;for(var f in b.packet.entity)e.entity[f]=b.packet.entity[f];d.set(e),b.replyTo({response:"ok",entity:{resource:d.resource}})},ozpIwc.IntentsApi.prototype.handleBroadcast=function(a,b){if("function"!=typeof a.getHandlers)throw new ozpIwc.ApiError("badResource","Resource is not an invokable intent");var c=a.getHandlers(b),d=this;
c.forEach(function(c){var e=d.makeIntentInvocation(a,b),f=e.toPacket();f.entity.handlerChosen={resource:c.resource,reason:"broadcast"},f.entity.state="delivering",e.set(f),d.invokeIntentHandler(c,b,e)})},ozpIwc.IntentsApi.prototype.handleInvoke=function(a,b){if("function"!=typeof a.getHandlers)throw new ozpIwc.ApiError("badResource","Resource is not an invokable intent");var c=a.getHandlers(b),d=this.makeIntentInvocation(a,b);if(1===c.length){var e=d.toPacket();e.entity.handlerChosen={resource:c[0].resource,reason:"onlyOne"},e.entity.state="delivering",d.set(e),this.invokeIntentHandler(c[0],b,d)}else this.chooseIntentHandler(a,b,d)},ozpIwc.IntentsApi.prototype.handleSet=function(a,b){if("application/vnd.ozp-iwc-intent-invocation-v1+json"===b.packet.contentType){var c={response:"badAction",entity:{reason:"cannot drive inFlightIntent state transition",state:a.entity.state,requestedState:b.packet.entity.state}};switch(b.packet.entity.state){case"new":b.replyTo(c);break;case"choosing":this.handleInFlightChoose(a,b);break;case"delivering":b.replyTo({response:"badAction"});break;case"running":this.handleInFlightRunning(a,b);break;case"fail":this.handleInFlightFail(a,b);break;case"complete":this.handleInFlightComplete(a,b);break;default:a.acceptedStates.indexOf(b.packet.entity.state)<0&&b.replyTo(c)}}else ozpIwc.CommonApiBase.prototype.handleSet.apply(this,arguments)},ozpIwc.IntentsApi.prototype.handleDelete=function(a,b){delete this.data[a.resource],b.replyTo({response:"ok"})},ozpIwc.IntentsApi.prototype.invokeIntentHandler=function(a,b,c){c=c||{};var d=a.entity.invokeIntent;d.entity=d.entity||{},d.entity.inFlightIntent=c.resource;var e=this;this.participant.send(d,function(a,c){var d=["src","dst","msgId","replyTo"],f={};for(var g in a)-1===d.indexOf(g)&&(f[g]=a[g]);e.participant.send({replyTo:f.msgId,dst:f.src,response:"ok",entity:f}),b.replyTo(f),c()})},ozpIwc.IntentsApi.prototype.chooseIntentHandler=function(a,b,c){c.entity.state="choosing",ozpIwc.util.openWindow("intentsChooser.html",{"ozpIwc.peer":ozpIwc.BUS_ROOT,"ozpIwc.intentSelection":"intents.api"+c.resource})},ozpIwc.IntentsApi.prototype.handleEventChannelDisconnectImpl=function(a){for(var b in this.data)this.data[b]instanceof ozpIwc.IntentsApiHandlerValue&&this.data[b].entity.invokeIntent.dst===a.packet.entity.address&&delete this.data[b];for(var c in this.dynamicNodes){var d=this.dynamicNodes[c];this.updateDynamicNode(this.data[d])}},ozpIwc.IntentsApi.prototype.handleInFlightChoose=function(a,b){if("choosing"!==a.entity.state)return null;var c=this.data[b.packet.entity.resource];if(!c)return null;if(a.acceptedReasons.indexOf(b.packet.entity.reason)<0)return null;var d=ozpIwc.util.clone(a);d.entity.handlerChosen={resource:b.packet.entity.resource,reason:b.packet.entity.reason},d.entity.state="delivering",a.set(d),this.invokeIntentHandler(c,b,a),b.replyTo({response:"ok"})},ozpIwc.IntentsApi.prototype.handleInFlightRunning=function(a,b){var c=ozpIwc.util.clone(a);c.entity.state="running",c.entity.handler.address=b.packet.entity.address,c.entity.handler.resource=b.packet.entity.resource,a.set(c),b.replyTo({response:"ok"})},ozpIwc.IntentsApi.prototype.handleInFlightFail=function(a,b){var c=a.invokePacket,d=ozpIwc.util.clone(a);d.entity.state=b.packet.entity.state,d.entity.reply.contentType=b.packet.entity.reply.contentType,d.entity.reply.entity=b.packet.entity.reply.entity,a.set(d);var e=a.snapshot();this.handleDelete(a,b),this.notifyWatchers(a,a.changesSince(e)),b.replyTo({response:"ok"}),this.participant.send({replyTo:c.msgId,dst:c.src,response:"ok",entity:{response:a.entity.reply,invoked:!1}})},ozpIwc.IntentsApi.prototype.handleInFlightComplete=function(a,b){var c=a.invokePacket,d=ozpIwc.util.clone(a);d.entity.state=b.packet.entity.state,d.entity.reply.contentType=b.packet.entity.reply.contentType,d.entity.reply.entity=b.packet.entity.reply.entity,a.set(d);var e=a.snapshot();this.handleDelete(a,b),this.notifyWatchers(a,a.changesSince(e)),b.replyTo({response:"ok"}),this.participant.send({replyTo:c.msgId,dst:c.src,response:"ok",entity:{response:a.entity.reply,invoked:!0}})},ozpIwc.IntentsApi.prototype.setState=function(a){this.data={},this.dynamicNodes=a.dynamicNodes;for(var b in a.data){var c=this.findOrMakeValue({resource:b,contentType:a.data[b].contentType});c.deserialize(a.data[b])}this.dynamicNodes.forEach(function(a){this.updateDynamicNode(this.data[a])},this)},ozpIwc.IntentsApiDefinitionValue=ozpIwc.util.extend(ozpIwc.CommonApiValue,function(a){a=a||{},a.allowedContentTypes=["application/vnd.ozp-iwc-intent-definition-v1+json"],a.contentType="application/vnd.ozp-iwc-intent-definition-v1+json",ozpIwc.CommonApiValue.call(this,a),this.pattern=new RegExp(ozpIwc.util.escapeRegex(this.resource)+"/[^/]*"),this.pattern.toJSON=RegExp.prototype.toString,this.handlers=[],this.entity={type:a.intentType,action:a.intentAction,handlers:[]}}),ozpIwc.IntentsApiDefinitionValue.prototype.isUpdateNeeded=function(a){return this.pattern.test(a.resource)},ozpIwc.IntentsApiDefinitionValue.prototype.updateContent=function(a){this.version++,this.handlers=a,this.entity.handlers=a.map(function(a){return a.resource})},ozpIwc.IntentsApiDefinitionValue.prototype.getHandlers=function(){return this.handlers},ozpIwc.IntentsApiDefinitionValue.prototype.deserialize=function(a){var b=ozpIwc.util.clone(a);this.entity=b.entity||{},this.pattern="string"==typeof b.pattern?new RegExp(b.pattern.replace(/^\/|\/$/g,"")):this.pattern,this.pattern.toJSON=RegExp.prototype.toString,this.contentType=b.contentType||this.contentType,this.permissions=b.permissions||this.permissions,this.version=b.version||this.version,this.watchers=b.watchers||this.watchers},ozpIwc.IntentsApiDefinitionValue.prototype.serialize=function(){var a={};return a.entity=this.entity,a.pattern=this.pattern,a.contentType=this.contentType,a.permissions=this.permissions,a.version=this.version,a.watchers=this.watchers,a},ozpIwc.IntentsApiHandlerValue=ozpIwc.util.extend(ozpIwc.CommonApiValue,function(a){a=a||{},a.allowedContentTypes=["application/vnd.ozp-iwc-intent-handler-v1+json"],a.contentType="application/vnd.ozp-iwc-intent-handler-v1+json",ozpIwc.CommonApiValue.apply(this,arguments),this.entity={type:a.intentType,action:a.intentAction}}),ozpIwc.IntentsApiHandlerValue.prototype.getHandlers=function(){return[this]},ozpIwc.IntentsApiHandlerValue.prototype.set=function(a){ozpIwc.CommonApiValue.prototype.set.apply(this,arguments),this.entity.invokeIntent=this.entity.invokeIntent||{},this.entity.invokeIntent.dst=this.entity.invokeIntent.dst||a.src,this.entity.invokeIntent.resource=this.entity.invokeIntent.resource||"/intents"+a.resource,this.entity.invokeIntent.action=this.entity.invokeIntent.action||"invoke"},ozpIwc.IntentsApiInFlightIntent=ozpIwc.util.extend(ozpIwc.CommonApiValue,function(a){a=a||{},a.contentType="application/vnd.ozp-iwc-intent-invocation-v1+json",a.allowedContentTypes=[a.contentType],ozpIwc.CommonApiValue.apply(this,arguments),this.resource=a.resource,this.invokePacket=a.invokePacket,this.entity={intent:{type:a.type,action:a.action},contentType:a.contentType,entity:a.entity,state:"new",status:"ok",handlerChoices:a.handlerChoices||[],handlerChosen:{resource:null,reason:null},handler:{resource:null,address:null},reply:{contentType:null,entity:null}}}),ozpIwc.IntentsApiInFlightIntent.prototype.acceptedReasons=["user","pref","onlyOne","broadcast"],ozpIwc.IntentsApiInFlightIntent.prototype.acceptedStates=["new","choosing","delivering","running","error","complete"],ozpIwc.IntentsApiTypeValue=ozpIwc.util.extend(ozpIwc.CommonApiValue,function(a){a=a||{},a.allowedContentTypes=["application/vnd.ozp-iwc-intent-type-v1+json"],a.contentType="application/vnd.ozp-iwc-intent-type-v1+json",ozpIwc.CommonApiValue.apply(this,arguments),this.pattern=new RegExp(this.resource.replace("$","\\$").replace(".","\\.")+"/[^/]*$"),this.pattern.toJSON=RegExp.prototype.toString,this.entity={type:a.intentType,actions:[]}}),ozpIwc.IntentsApiTypeValue.prototype.isUpdateNeeded=function(a){return this.pattern.test(a.resource)},ozpIwc.IntentsApiTypeValue.prototype.updateContent=function(a){this.version++,this.entity.actions=a.map(function(a){return a.resource})},ozpIwc.IntentsApiTypeValue.prototype.deserialize=function(){ozpIwc.IntentsApiDefinitionValue.prototype.deserialize.apply(this,arguments)},ozpIwc.IntentsApiTypeValue.prototype.serialize=function(){return ozpIwc.IntentsApiDefinitionValue.prototype.serialize.apply(this,arguments)},ozpIwc.NamesApi=ozpIwc.util.extend(ozpIwc.CommonApiBase,function(a){ozpIwc.CommonApiBase.apply(this,arguments),this.heartbeatFrequency=a.heartbeatFrequency||1e4,this.heartbeatDropCount=a.heartbeatDropCount||3,this.on("receive",function(a){var b=a.packet;b.resource&&(b.resource=b.resource.replace(/$\/me^/,a.packet.src))}),this.addDynamicNode(new ozpIwc.CommonApiCollectionValue({resource:"/address",pattern:/^\/address\/.*$/,contentType:"application/vnd.ozp-iwc-address-list-v1+json"})),this.addDynamicNode(new ozpIwc.CommonApiCollectionValue({resource:"/multicast",pattern:/^\/multicast\/[^\/\n]*$/,contentType:"application/vnd.ozp-iwc-multicast-list-v1+json"})),this.addDynamicNode(new ozpIwc.CommonApiCollectionValue({resource:"/router",pattern:/^\/router\/.*$/,contentType:"application/vnd.ozp-iwc-router-list-v1+json"})),this.addDynamicNode(new ozpIwc.CommonApiCollectionValue({resource:"/api",pattern:/^\/api\/.*$/,contentType:"application/vnd.ozp-iwc-api-list-v1+json"}));var b={resource:"/api/data.api",entity:{actions:["get","set","delete","watch","unwatch","addChild","removeChild","list"]},contentType:"application/vnd.ozp-iwc-api-v1+json"},c=this.findOrMakeValue(b);c.set(b),b={resource:"/api/intents.api",entity:{actions:["get","set","delete","watch","unwatch","register","invoke","broadcast","list"]},contentType:"application/vnd.ozp-iwc-api-v1+json"},c=this.findOrMakeValue(b),c.set(b),b={resource:"/api/names.api",entity:{actions:["get","set","delete","watch","unwatch","list"]},contentType:"application/vnd.ozp-iwc-api-v1+json"},c=this.findOrMakeValue(b),c.set(b),b={resource:"/api/system.api",entity:{actions:["get","set","delete","watch","unwatch","list","launch"]},contentType:"application/vnd.ozp-iwc-api-v1+json"},c=this.findOrMakeValue(b),c.set(b);var d=this;this.dynamicNodes.forEach(function(a){d.updateDynamicNode(d.data[a])}),setInterval(function(){d.removeDeadNodes()},this.heartbeatFrequency)}),ozpIwc.NamesApi.prototype.removeDeadNodes=function(){for(var a in this.data){var b=this.data[a];if(this.dynamicNodes.indexOf(a)<0&&b.entity&&b.entity.time&&ozpIwc.util.now()-b.entity.time>this.heartbeatFrequency*this.heartbeatDropCount){var c=b.snapshot();b.deleteData(),this.notifyWatchers(b,b.changesSince(c)),delete this.data[a],this.dynamicNodes.forEach(function(a){this.updateDynamicNode(this.data[a])},this)}}},ozpIwc.NamesApi.prototype.validateResource=function(a,b){if(b.packet.resource&&!b.packet.resource.match(/^\/(api|address|multicast|router|me)/))throw new ozpIwc.ApiError("badResource","Invalide resource for name.api: "+b.packet.resource)},ozpIwc.NamesApi.prototype.makeValue=function(a){var b=a.resource.split("/"),c={resource:a.resource,contentType:a.contentType};switch(a.contentType){case"application/vnd.ozp-iwc-api-v1+json":c.allowedContentTypes=["application/vnd.ozp-iwc-api-v1+json"];break;case"application/vnd.ozp-iwc-multicast-address-v1+json":if(c.allowedContentTypes=["application/vnd.ozp-iwc-multicast-address-v1+json"],b.length>=3){var d="/"+b[1]+"/"+b[2];this.dynamicNodes.indexOf(d)<0&&this.addDynamicNode(new ozpIwc.CommonApiCollectionValue({resource:d,pattern:new RegExp("^/"+b[1].replace("$","\\$").replace(".","\\.")+"/"+b[2].replace("$","\\$").replace(".","\\.")+"/.*$"),contentType:"application/vnd.ozp-iwc-address-list-v1+json"}))}break;case"application/vnd.ozp-iwc-address-v1+json":c.allowedContentTypes=["application/vnd.ozp-iwc-address-v1+json"];break;case"application/vnd.ozp-iwc-router-v1+json":c.allowedContentTypes=["application/vnd.ozp-iwc-router-v1+json"];break;default:throw new ozpIwc.ApiError("badContent","Not a valid contentType of names.api: "+b[1]+" in "+a.resource)}return new ozpIwc.NamesApiValue(c)},ozpIwc.NamesApi.prototype.handleEventChannelDisconnectImpl=function(a){delete this.data[a.packet.entity.namesResource];for(var b in this.dynamicNodes){var c=this.dynamicNodes[b];this.updateDynamicNode(this.data[c])}},ozpIwc.NamesApiValue=ozpIwc.util.extend(ozpIwc.CommonApiValue,function(a){if(!a||!a.allowedContentTypes)throw new Error("NamesAPIValue must be configured with allowedContentTypes.");ozpIwc.CommonApiValue.apply(this,arguments)});var ozpIwc=ozpIwc||{};ozpIwc.SystemApi=ozpIwc.util.extend(ozpIwc.CommonApiBase,function(){ozpIwc.CommonApiBase.apply(this,arguments),this.addDynamicNode(new ozpIwc.CommonApiCollectionValue({resource:"/application",pattern:/^\/application\/.*$/,contentType:"application/vnd.ozp-iwc-application-list-v1+json"})),this.on("changedNode",this.updateIntents,this)}),ozpIwc.SystemApi.prototype.loadFromServer=function(){var a=this,b=[{name:"Accept",value:"application/vnd.ozp-application-v1+json"}];return new Promise(function(c,d){a.loadFromEndpoint(ozpIwc.linkRelPrefix+":application",b).then(function(){a.loadFromEndpoint(ozpIwc.linkRelPrefix+":user").then(function(){a.loadFromEndpoint(ozpIwc.linkRelPrefix+":system").then(function(){c("system.api load complete")})})})["catch"](function(a){d(a)})})},ozpIwc.SystemApi.prototype.updateIntents=function(a){if(a.getIntentsRegistrations){var b=a.getIntentsRegistrations();b&&b.forEach(function(b){var c=b.icon||a.entity&&a.entity.icons&&a.entity.icons.small?a.entity.icons.small:"",d=b.label||a.entity.name;this.participant.send({dst:"intents.api",src:"system.api",action:"set",resource:"/"+b.type+"/"+b.action+"/system.api"+a.resource.replace(/\//g,"."),contentType:"application/vnd.ozp-iwc-intent-handler-v1+json",entity:{type:b.type,action:b.action,icon:c,label:d,_links:a.entity._links,invokeIntent:{action:"invoke",resource:a.resource}}})},this)}},ozpIwc.SystemApi.prototype.makeValue=function(a){switch(a.contentType){case"application/vnd.ozp-application-v1+json":var b="/system"+a.resource;a.entity=a.entity||{},a.entity.launchDefinition=a.entity.launchDefinition||b;var c=new ozpIwc.SystemApiApplicationValue({resource:a.resource,entity:a.entity,contentType:a.contentType,systemApi:this});return this.participant.send({dst:"intents.api",action:"register",contentType:"application/vnd.ozp-iwc-intent-handler-v1+json",resource:b,entity:{icon:a.entity.icons&&a.entity.icons.small?a.entity.icons.small:"",label:a.entity.name||"",contentType:"application/json",invokeIntent:{dst:"system.api",action:"invoke",resource:a.resource}}},function(a,b){c.entity.launchResource=a.entity.resource,b()}),c;default:return new ozpIwc.CommonApiValue(a)}},ozpIwc.SystemApi.prototype.handleSet=function(a,b){b.replyTo({response:"badAction",entity:{action:b.packet.action,originalRequest:b.packet}})},ozpIwc.SystemApi.prototype.handleDelete=function(a,b){b.replyTo({response:"badAction",entity:{action:b.packet.action,originalRequest:b.packet}})},ozpIwc.SystemApi.prototype.handleLaunch=function(a,b){this.participant.send({dst:"intents.api",contentType:"application/vnd.ozp-iwc-intent-handler-v1+json",action:"invoke",resource:a.entity.launchResource,entity:b.packet.entity}),b.replyTo({response:"ok"})},ozpIwc.SystemApi.prototype.handleInvoke=function(a,b){b.packet.entity&&b.packet.entity.inFlightIntent?(this.launchApplication(a,b.packet.entity.inFlightIntent),b.replyTo({response:"ok"})):b.replyTo({response:"badResource"})},ozpIwc.SystemApi.prototype.launchApplication=function(a,b){var c=["ozpIwc.peer="+encodeURIComponent(ozpIwc.BUS_ROOT),"ozpIwc.inFlightIntent="+encodeURIComponent(b)];ozpIwc.util.openWindow(a.entity.launchUrls["default"],c.join("&"))},ozpIwc.SystemApiApplicationValue=ozpIwc.util.extend(ozpIwc.CommonApiValue,function(a){ozpIwc.CommonApiValue.apply(this,arguments),this.systemApi=a.systemApi}),ozpIwc.SystemApiApplicationValue.prototype.getIntentsRegistrations=function(){return this.entity.intents};var ozpIwc=ozpIwc||{};ozpIwc.ELECTION_TIMEOUT=1e3,ozpIwc.apiRootUrl=ozpIwc.apiRootUrl||"/api",ozpIwc.policyRootUrl=ozpIwc.policyRootUrl||"/policy",ozpIwc.basicAuthUsername=ozpIwc.basicAuthUsername||"",ozpIwc.basicAuthPassword=ozpIwc.basicAuthPassword||"",ozpIwc.linkRelPrefix=ozpIwc.linkRelPrefix||"ozp",ozpIwc.authorization=new ozpIwc.policyAuth.PDP({pip:new ozpIwc.policyAuth.PIP,prp:new ozpIwc.policyAuth.PRP,setsEndpoint:ozpIwc.policyRootUrl}),("undefined"==typeof ozpIwc.enableDefault||ozpIwc.enableDefault)&&(ozpIwc.initEndpoints(ozpIwc.apiRootUrl),ozpIwc.defaultPeer=new ozpIwc.Peer,ozpIwc.defaultLocalStorageLink=new ozpIwc.KeyBroadcastLocalStorageLink({peer:ozpIwc.defaultPeer}),ozpIwc.heartBeatFrequency=1e4,ozpIwc.defaultRouter=new ozpIwc.Router({peer:ozpIwc.defaultPeer,heartbeatFrequency:ozpIwc.heartBeatFrequency}),("undefined"==typeof ozpIwc.runApis||ozpIwc.runApis)&&(ozpIwc.defaultLeadershipStates=function(){return{leader:["actingLeader"],election:["leaderSync","actingLeader"],queueing:["leaderSync"],member:[]}},ozpIwc.initEndpoints(ozpIwc.apiRootUrl||"api"),ozpIwc.namesApi=new ozpIwc.NamesApi({participant:new ozpIwc.LeaderGroupParticipant({name:"names.api",states:ozpIwc.defaultLeadershipStates(),electionTimeout:ozpIwc.ELECTION_TIMEOUT}),heartbeatDropCount:3,heartbeatFrequency:ozpIwc.heartBeatFrequency}),ozpIwc.defaultRouter.registerParticipant(ozpIwc.namesApi.participant),ozpIwc.dataApi=new ozpIwc.DataApi({participant:new ozpIwc.LeaderGroupParticipant({name:"data.api",states:ozpIwc.defaultLeadershipStates(),electionTimeout:ozpIwc.ELECTION_TIMEOUT})}),ozpIwc.defaultRouter.registerParticipant(ozpIwc.dataApi.participant),ozpIwc.intentsApi=new ozpIwc.IntentsApi({participant:new ozpIwc.LeaderGroupParticipant({name:"intents.api",states:ozpIwc.defaultLeadershipStates(),electionTimeout:ozpIwc.ELECTION_TIMEOUT})}),ozpIwc.defaultRouter.registerParticipant(ozpIwc.intentsApi.participant),ozpIwc.systemApi=new ozpIwc.SystemApi({participant:new ozpIwc.LeaderGroupParticipant({name:"system.api",states:ozpIwc.defaultLeadershipStates(),electionTimeout:ozpIwc.ELECTION_TIMEOUT})}),ozpIwc.defaultRouter.registerParticipant(ozpIwc.systemApi.participant)),("undefined"==typeof ozpIwc.acceptPostMessageParticipants||ozpIwc.acceptPostMessageParticipants)&&(ozpIwc.defaultPostMessageParticipantListener=new ozpIwc.PostMessageParticipantListener({router:ozpIwc.defaultRouter})));
//# sourceMappingURL=ozpIwc-bus.min.js.map