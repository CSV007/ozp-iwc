!function(a,b){"use strict";"function"==typeof define&&define.amd?define(b):"object"==typeof exports?module.exports=b():a.returnExports=b()}(this,function(){var a,b=Array,c=b.prototype,d=Object,e=d.prototype,f=Function.prototype,g=String,h=g.prototype,i=Number,j=i.prototype,k=c.slice,l=c.splice,m=c.push,n=c.unshift,o=c.concat,p=f.call,q=Math.max,r=Math.min,s=e.toString,t="function"==typeof Symbol&&"symbol"==typeof Symbol.toStringTag,u=Function.prototype.toString,v=function(a){try{return u.call(a),!0}catch(b){return!1}},w="[object Function]",x="[object GeneratorFunction]";a=function(a){if("function"!=typeof a)return!1;if(t)return v(a);var b=s.call(a);return b===w||b===x};var y,z=RegExp.prototype.exec,A=function(a){try{return z.call(a),!0}catch(b){return!1}},B="[object RegExp]";y=function(a){return"object"!=typeof a?!1:t?A(a):s.call(a)===B};var C,D=String.prototype.valueOf,E=function(a){try{return D.call(a),!0}catch(b){return!1}},F="[object String]";C=function(a){return"string"==typeof a?!0:"object"!=typeof a?!1:t?E(a):s.call(a)===F};var G=function(a){var b,c=d.defineProperty&&function(){try{var a={};d.defineProperty(a,"x",{enumerable:!1,value:a});for(var b in a)return!1;return a.x===a}catch(c){return!1}}();return b=c?function(a,b,c,e){!e&&b in a||d.defineProperty(a,b,{configurable:!0,enumerable:!1,writable:!0,value:c})}:function(a,b,c,d){!d&&b in a||(a[b]=c)},function(c,d,e){for(var f in d)a.call(d,f)&&b(c,f,d[f],e)}}(e.hasOwnProperty),H=function(a){var b=typeof a;return null===a||"object"!==b&&"function"!==b},I={ToInteger:function(a){var b=+a;return b!==b?b=0:0!==b&&b!==1/0&&b!==-(1/0)&&(b=(b>0||-1)*Math.floor(Math.abs(b))),b},ToPrimitive:function(b){var c,d,e;if(H(b))return b;if(d=b.valueOf,a(d)&&(c=d.call(b),H(c)))return c;if(e=b.toString,a(e)&&(c=e.call(b),H(c)))return c;throw new TypeError},ToObject:function(a){if(null==a)throw new TypeError("can't convert "+a+" to object");return d(a)},ToUint32:function(a){return a>>>0}},J=function(){};G(f,{bind:function(b){var c=this;if(!a(c))throw new TypeError("Function.prototype.bind called on incompatible "+c);for(var e,f=k.call(arguments,1),g=function(){if(this instanceof e){var a=c.apply(this,o.call(f,k.call(arguments)));return d(a)===a?a:this}return c.apply(b,o.call(f,k.call(arguments)))},h=q(0,c.length-f.length),i=[],j=0;h>j;j++)m.call(i,"$"+j);return e=Function("binder","return function ("+i.join(",")+"){ return binder.apply(this, arguments); }")(g),c.prototype&&(J.prototype=c.prototype,e.prototype=new J,J.prototype=null),e}});var K=p.bind(e.hasOwnProperty),L=p.bind(e.toString),M=p.bind(h.slice),N=p.bind(h.split),O=b.isArray||function(a){return"[object Array]"===L(a)},P=1!==[].unshift(0);G(c,{unshift:function(){return n.apply(this,arguments),this.length}},P),G(b,{isArray:O});var Q=d("a"),R="a"!==Q[0]||!(0 in Q),S=function(a){var b=!0,c=!0;return a&&(a.call("foo",function(a,c,d){"object"!=typeof d&&(b=!1)}),a.call([1],function(){"use strict";c="string"==typeof this},"x")),!!a&&b&&c};G(c,{forEach:function(b){var c,d=I.ToObject(this),e=R&&C(this)?N(this,""):d,f=-1,g=e.length>>>0;if(arguments.length>1&&(c=arguments[1]),!a(b))throw new TypeError("Array.prototype.forEach callback must be a function");for(;++f<g;)f in e&&("undefined"!=typeof c?b.call(c,e[f],f,d):b(e[f],f,d))}},!S(c.forEach)),G(c,{map:function(c){var d,e=I.ToObject(this),f=R&&C(this)?N(this,""):e,g=f.length>>>0,h=b(g);if(arguments.length>1&&(d=arguments[1]),!a(c))throw new TypeError("Array.prototype.map callback must be a function");for(var i=0;g>i;i++)i in f&&("undefined"!=typeof d?h[i]=c.call(d,f[i],i,e):h[i]=c(f[i],i,e));return h}},!S(c.map)),G(c,{filter:function(b){var c,d,e=I.ToObject(this),f=R&&C(this)?N(this,""):e,g=f.length>>>0,h=[];if(arguments.length>1&&(d=arguments[1]),!a(b))throw new TypeError("Array.prototype.filter callback must be a function");for(var i=0;g>i;i++)i in f&&(c=f[i],("undefined"==typeof d?b(c,i,e):b.call(d,c,i,e))&&m.call(h,c));return h}},!S(c.filter)),G(c,{every:function(b){var c,d=I.ToObject(this),e=R&&C(this)?N(this,""):d,f=e.length>>>0;if(arguments.length>1&&(c=arguments[1]),!a(b))throw new TypeError("Array.prototype.every callback must be a function");for(var g=0;f>g;g++)if(g in e&&!("undefined"==typeof c?b(e[g],g,d):b.call(c,e[g],g,d)))return!1;return!0}},!S(c.every)),G(c,{some:function(b){var c,d=I.ToObject(this),e=R&&C(this)?N(this,""):d,f=e.length>>>0;if(arguments.length>1&&(c=arguments[1]),!a(b))throw new TypeError("Array.prototype.some callback must be a function");for(var g=0;f>g;g++)if(g in e&&("undefined"==typeof c?b(e[g],g,d):b.call(c,e[g],g,d)))return!0;return!1}},!S(c.some));var T=!1;c.reduce&&(T="object"==typeof c.reduce.call("es5",function(a,b,c,d){return d})),G(c,{reduce:function(b){var c=I.ToObject(this),d=R&&C(this)?N(this,""):c,e=d.length>>>0;if(!a(b))throw new TypeError("Array.prototype.reduce callback must be a function");if(0===e&&1===arguments.length)throw new TypeError("reduce of empty array with no initial value");var f,g=0;if(arguments.length>=2)f=arguments[1];else for(;;){if(g in d){f=d[g++];break}if(++g>=e)throw new TypeError("reduce of empty array with no initial value")}for(;e>g;g++)g in d&&(f=b(f,d[g],g,c));return f}},!T);var U=!1;c.reduceRight&&(U="object"==typeof c.reduceRight.call("es5",function(a,b,c,d){return d})),G(c,{reduceRight:function(b){var c=I.ToObject(this),d=R&&C(this)?N(this,""):c,e=d.length>>>0;if(!a(b))throw new TypeError("Array.prototype.reduceRight callback must be a function");if(0===e&&1===arguments.length)throw new TypeError("reduceRight of empty array with no initial value");var f,g=e-1;if(arguments.length>=2)f=arguments[1];else for(;;){if(g in d){f=d[g--];break}if(--g<0)throw new TypeError("reduceRight of empty array with no initial value")}if(0>g)return f;do g in d&&(f=b(f,d[g],g,c));while(g--);return f}},!U);var V=c.indexOf&&-1!==[0,1].indexOf(1,2);G(c,{indexOf:function(a){var b=R&&C(this)?N(this,""):I.ToObject(this),c=b.length>>>0;if(0===c)return-1;var d=0;for(arguments.length>1&&(d=I.ToInteger(arguments[1])),d=d>=0?d:q(0,c+d);c>d;d++)if(d in b&&b[d]===a)return d;return-1}},V);var W=c.lastIndexOf&&-1!==[0,1].lastIndexOf(0,-3);G(c,{lastIndexOf:function(a){var b=R&&C(this)?N(this,""):I.ToObject(this),c=b.length>>>0;if(0===c)return-1;var d=c-1;for(arguments.length>1&&(d=r(d,I.ToInteger(arguments[1]))),d=d>=0?d:c-Math.abs(d);d>=0;d--)if(d in b&&a===b[d])return d;return-1}},W);var X=function(){var a=[1,2],b=a.splice();return 2===a.length&&O(b)&&0===b.length}();G(c,{splice:function(a,b){return 0===arguments.length?[]:l.apply(this,arguments)}},!X);var Y=function(){var a={};return c.splice.call(a,0,0,1),1===a.length}();G(c,{splice:function(a,b){if(0===arguments.length)return[];var c=arguments;return this.length=q(I.ToInteger(this.length),0),arguments.length>0&&"number"!=typeof b&&(c=k.call(arguments),c.length<2?m.call(c,this.length-a):c[1]=I.ToInteger(b)),l.apply(this,c)}},!Y);var Z=function(){var a=new b(1e5);return a[8]="x",a.splice(1,1),7===a.indexOf("x")}(),$=function(){var a=256,b=[];return b[a]="a",b.splice(a+1,0,"b"),"a"===b[a]}();G(c,{splice:function(a,b){for(var c,d=I.ToObject(this),e=[],f=I.ToUint32(d.length),h=I.ToInteger(a),i=0>h?q(f+h,0):r(h,f),j=r(q(I.ToInteger(b),0),f-i),l=0;j>l;)c=g(i+l),K(d,c)&&(e[l]=d[c]),l+=1;var m,n=k.call(arguments,2),o=n.length;if(j>o){for(l=i;f-j>l;)c=g(l+j),m=g(l+o),K(d,c)?d[m]=d[c]:delete d[m],l+=1;for(l=f;l>f-j+o;)delete d[l-1],l-=1}else if(o>j)for(l=f-j;l>i;)c=g(l+j-1),m=g(l+o-1),K(d,c)?d[m]=d[c]:delete d[m],l-=1;l=i;for(var p=0;p<n.length;++p)d[l]=n[p],l+=1;return d.length=f-j+o,e}},!Z||!$);var _=!{toString:null}.propertyIsEnumerable("toString"),aa=function(){}.propertyIsEnumerable("prototype"),ba=!K("x","0"),ca=function(a){var b=a.constructor;return b&&b.prototype===a},da={$window:!0,$console:!0,$parent:!0,$self:!0,$frames:!0,$frameElement:!0,$webkitIndexedDB:!0,$webkitStorageInfo:!0},ea=function(){if("undefined"==typeof window)return!1;for(var a in window)if(!da["$"+a]&&K(window,a)&&null!==window[a]&&"object"==typeof window[a])try{ca(window[a])}catch(b){return!0}return!1}(),fa=function(a){if("undefined"==typeof window||!ea)return ca(a);try{return ca(a)}catch(b){return!1}},ga=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],ha=ga.length,ia=function(b){var c=L(b),d="[object Arguments]"===c;return d||(d=!O(b)&&null!==b&&"object"==typeof b&&"number"==typeof b.length&&b.length>=0&&a(b.callee)),d};G(d,{keys:function(b){var c=a(b),d=ia(b),e=null!==b&&"object"==typeof b,f=e&&C(b);if(!e&&!c&&!d)throw new TypeError("Object.keys called on a non-object");var h=[],i=aa&&c;if(f&&ba||d)for(var j=0;j<b.length;++j)m.call(h,g(j));if(!d)for(var k in b)i&&"prototype"===k||!K(b,k)||m.call(h,g(k));if(_)for(var l=fa(b),n=0;ha>n;n++){var o=ga[n];l&&"constructor"===o||!K(b,o)||m.call(h,o)}return h}});var ja=d.keys&&function(){return 2===d.keys(arguments).length}(1,2),ka=d.keys;G(d,{keys:function(a){return ka(ia(a)?k.call(a):a)}},!ja);var la=-621987552e5,ma="-000001",na=Date.prototype.toISOString&&-1===new Date(la).toISOString().indexOf(ma),oa=Date.prototype.toISOString&&"1969-12-31T23:59:59.999Z"!==new Date(-1).toISOString();G(Date.prototype,{toISOString:function(){var a,b,c,d,e;if(!isFinite(this))throw new RangeError("Date.prototype.toISOString called on non-finite value.");for(d=this.getUTCFullYear(),e=this.getUTCMonth(),d+=Math.floor(e/12),e=(e%12+12)%12,a=[e+1,this.getUTCDate(),this.getUTCHours(),this.getUTCMinutes(),this.getUTCSeconds()],d=(0>d?"-":d>9999?"+":"")+M("00000"+Math.abs(d),d>=0&&9999>=d?-4:-6),b=a.length;b--;)c=a[b],10>c&&(a[b]="0"+c);return d+"-"+k.call(a,0,2).join("-")+"T"+k.call(a,2).join(":")+"."+M("000"+this.getUTCMilliseconds(),-3)+"Z"}},na||oa);var pa=function(){try{return Date.prototype.toJSON&&null===new Date(NaN).toJSON()&&-1!==new Date(la).toJSON().indexOf(ma)&&Date.prototype.toJSON.call({toISOString:function(){return!0}})}catch(a){return!1}}();pa||(Date.prototype.toJSON=function(b){var c=d(this),e=I.ToPrimitive(c);if("number"==typeof e&&!isFinite(e))return null;var f=c.toISOString;if(!a(f))throw new TypeError("toISOString property is not callable");return f.call(c)});var qa=1e15===Date.parse("+033658-09-27T01:46:40.000Z"),ra=!isNaN(Date.parse("2012-04-04T24:00:00.500Z"))||!isNaN(Date.parse("2012-11-31T23:59:59.000Z"))||!isNaN(Date.parse("2012-12-31T23:59:60.000Z")),sa=isNaN(Date.parse("2000-01-01T00:00:00.000Z"));(!Date.parse||sa||ra||!qa)&&(Date=function(a){var b=function(c,d,e,f,h,i,j){var k,l=arguments.length;return k=this instanceof a?1===l&&g(c)===c?new a(b.parse(c)):l>=7?new a(c,d,e,f,h,i,j):l>=6?new a(c,d,e,f,h,i):l>=5?new a(c,d,e,f,h):l>=4?new a(c,d,e,f):l>=3?new a(c,d,e):l>=2?new a(c,d):l>=1?new a(c):new a:a.apply(this,arguments),G(k,{constructor:b},!0),k},c=new RegExp("^(\\d{4}|[+-]\\d{6})(?:-(\\d{2})(?:-(\\d{2})(?:T(\\d{2}):(\\d{2})(?::(\\d{2})(?:(\\.\\d{1,}))?)?(Z|(?:([-+])(\\d{2}):(\\d{2})))?)?)?)?$"),d=[0,31,59,90,120,151,181,212,243,273,304,334,365],e=function(a,b){var c=b>1?1:0;return d[b]+Math.floor((a-1969+c)/4)-Math.floor((a-1901+c)/100)+Math.floor((a-1601+c)/400)+365*(a-1970)},f=function(b){return i(new a(1970,0,1,0,0,0,b))};for(var h in a)K(a,h)&&(b[h]=a[h]);G(b,{now:a.now,UTC:a.UTC},!0),b.prototype=a.prototype,G(b.prototype,{constructor:b},!0);var j=function(b){var d=c.exec(b);if(d){var g,h=i(d[1]),j=i(d[2]||1)-1,k=i(d[3]||1)-1,l=i(d[4]||0),m=i(d[5]||0),n=i(d[6]||0),o=Math.floor(1e3*i(d[7]||0)),p=Boolean(d[4]&&!d[8]),q="-"===d[9]?1:-1,r=i(d[10]||0),s=i(d[11]||0);return(m>0||n>0||o>0?24:25)>l&&60>m&&60>n&&1e3>o&&j>-1&&12>j&&24>r&&60>s&&k>-1&&k<e(h,j+1)-e(h,j)&&(g=60*(24*(e(h,j)+k)+l+r*q),g=1e3*(60*(g+m+s*q)+n)+o,p&&(g=f(g)),g>=-864e13&&864e13>=g)?g:NaN}return a.parse.apply(this,arguments)};return G(b,{parse:j}),b}(Date)),Date.now||(Date.now=function(){return(new Date).getTime()});var ta=j.toFixed&&("0.000"!==8e-5.toFixed(3)||"1"!==.9.toFixed(0)||"1.25"!==1.255.toFixed(2)||"1000000000000000128"!==0xde0b6b3a7640080.toFixed(0)),ua={base:1e7,size:6,data:[0,0,0,0,0,0],multiply:function(a,b){for(var c=-1,d=b;++c<ua.size;)d+=a*ua.data[c],ua.data[c]=d%ua.base,d=Math.floor(d/ua.base)},divide:function(a){for(var b=ua.size,c=0;--b>=0;)c+=ua.data[b],ua.data[b]=Math.floor(c/a),c=c%a*ua.base},numToString:function(){for(var a=ua.size,b="";--a>=0;)if(""!==b||0===a||0!==ua.data[a]){var c=g(ua.data[a]);""===b?b=c:b+=M("0000000",0,7-c.length)+c}return b},pow:function Fa(a,b,c){return 0===b?c:b%2===1?Fa(a,b-1,c*a):Fa(a*a,b/2,c)},log:function(a){for(var b=0,c=a;c>=4096;)b+=12,c/=4096;for(;c>=2;)b+=1,c/=2;return b}};G(j,{toFixed:function(a){var b,c,d,e,f,h,j,k;if(b=i(a),b=b!==b?0:Math.floor(b),0>b||b>20)throw new RangeError("Number.toFixed called with invalid number of decimals");if(c=i(this),c!==c)return"NaN";if(-1e21>=c||c>=1e21)return g(c);if(d="",0>c&&(d="-",c=-c),e="0",c>1e-21)if(f=ua.log(c*ua.pow(2,69,1))-69,h=0>f?c*ua.pow(2,-f,1):c/ua.pow(2,f,1),h*=4503599627370496,f=52-f,f>0){for(ua.multiply(0,h),j=b;j>=7;)ua.multiply(1e7,0),j-=7;for(ua.multiply(ua.pow(10,j,1),0),j=f-1;j>=23;)ua.divide(1<<23),j-=23;ua.divide(1<<j),ua.multiply(1,1),ua.divide(2),e=ua.numToString()}else ua.multiply(0,h),ua.multiply(1<<-f,0),e=ua.numToString()+M("0.00000000000000000000",2,2+b);return b>0?(k=e.length,e=b>=k?d+M("0.0000000000000000000",0,b-k+2)+e:d+M(e,0,k-b)+"."+M(e,k-b)):e=d+e,e}},ta),2!=="ab".split(/(?:ab)*/).length||4!==".".split(/(.?)(.?)/).length||"t"==="tesst".split(/(s)*/)[1]||4!=="test".split(/(?:)/,-1).length||"".split(/.?/).length||".".split(/()()/).length>1?!function(){var a="undefined"==typeof/()??/.exec("")[1];h.split=function(b,c){var d=this;if("undefined"==typeof b&&0===c)return[];if(!y(b))return N(this,b,c);var e,f,g,h,i=[],j=(b.ignoreCase?"i":"")+(b.multiline?"m":"")+(b.unicode?"u":"")+(b.sticky?"y":""),l=0,n=new RegExp(b.source,j+"g");d+="",a||(e=new RegExp("^"+n.source+"$(?!\\s)",j));var o="undefined"==typeof c?-1>>>0:I.ToUint32(c);for(f=n.exec(d);f&&(g=f.index+f[0].length,!(g>l&&(m.call(i,M(d,l,f.index)),!a&&f.length>1&&f[0].replace(e,function(){for(var a=1;a<arguments.length-2;a++)"undefined"==typeof arguments[a]&&(f[a]=void 0)}),f.length>1&&f.index<d.length&&m.apply(i,k.call(f,1)),h=f[0].length,l=g,i.length>=o)));)n.lastIndex===f.index&&n.lastIndex++,f=n.exec(d);return l===d.length?(h||!n.test(""))&&m.call(i,""):m.call(i,M(d,l)),i.length>o?M(i,0,o):i}}():"0".split(void 0,0).length&&(h.split=function(a,b){return"undefined"==typeof a&&0===b?[]:N(this,a,b)});var va=h.replace,wa=function(){var a=[];return"x".replace(/x(.)?/g,function(b,c){m.call(a,c)}),1===a.length&&"undefined"==typeof a[0]}();wa||(h.replace=function(b,c){var d=a(c),e=y(b)&&/\)[*?]/.test(b.source);if(d&&e){var f=function(a){var d=arguments.length,e=b.lastIndex;b.lastIndex=0;var f=b.exec(a)||[];return b.lastIndex=e,m.call(f,arguments[d-2],arguments[d-1]),c.apply(this,f)};return va.call(this,b,f)}return va.call(this,b,c)});var xa=h.substr,ya="".substr&&"b"!=="0b".substr(-1);G(h,{substr:function(a,b){var c=a;return 0>a&&(c=q(this.length+a,0)),xa.call(this,c,b)}},ya);var za="	\n\f\r   ᠎             　\u2028\u2029\ufeff",Aa="​",Ba="["+za+"]",Ca=new RegExp("^"+Ba+Ba+"*"),Da=new RegExp(Ba+Ba+"*$"),Ea=h.trim&&(za.trim()||!Aa.trim());G(h,{trim:function(){if("undefined"==typeof this||null===this)throw new TypeError("can't convert "+this+" to object");return g(this).replace(Ca,"").replace(Da,"")}},Ea),(8!==parseInt(za+"08")||22!==parseInt(za+"0x16"))&&(parseInt=function(a){var b=/^0[xX]/;return function(c,d){var e=g(c).trim(),f=i(d)||(b.test(e)?16:10);return a(e,f)}}(parseInt))}),function(a,b){"use strict";"function"==typeof define&&define.amd?define(b):"object"==typeof exports?module.exports=b():a.returnExports=b()}(this,function(){var a,b,c,d,e=Function.prototype.call,f=Object.prototype,g=e.bind(f.hasOwnProperty),h=e.bind(f.propertyIsEnumerable),i=g(f,"__defineGetter__");i&&(a=e.bind(f.__defineGetter__),b=e.bind(f.__defineSetter__),c=e.bind(f.__lookupGetter__),d=e.bind(f.__lookupSetter__)),Object.getPrototypeOf||(Object.getPrototypeOf=function(a){var b=a.__proto__;return b||null===b?b:a.constructor?a.constructor.prototype:f});var j=function(a){try{return a.sentinel=0,0===Object.getOwnPropertyDescriptor(a,"sentinel").value}catch(b){return!1}};if(Object.defineProperty){var k=j({}),l="undefined"==typeof document||j(document.createElement("div"));if(!l||!k)var m=Object.getOwnPropertyDescriptor}if(!Object.getOwnPropertyDescriptor||m){var n="Object.getOwnPropertyDescriptor called on a non-object: ";Object.getOwnPropertyDescriptor=function(a,b){if("object"!=typeof a&&"function"!=typeof a||null===a)throw new TypeError(n+a);if(m)try{return m.call(Object,a,b)}catch(e){}var j;if(!g(a,b))return j;if(j={enumerable:h(a,b),configurable:!0},i){var k=a.__proto__,l=a!==f;l&&(a.__proto__=f);var o=c(a,b),p=d(a,b);if(l&&(a.__proto__=k),o||p)return o&&(j.get=o),p&&(j.set=p),j}return j.value=a[b],j.writable=!0,j}}if(Object.getOwnPropertyNames||(Object.getOwnPropertyNames=function(a){return Object.keys(a)}),!Object.create){var o,p=!({__proto__:null}instanceof Object),q=function(){if(!document.domain)return!1;try{return!!new ActiveXObject("htmlfile")}catch(a){return!1}},r=function(){var a,b;return b=new ActiveXObject("htmlfile"),b.write("<script></script>"),b.close(),a=b.parentWindow.Object.prototype,b=null,a},s=function(){var a,b=document.createElement("iframe"),c=document.body||document.documentElement;return b.style.display="none",c.appendChild(b),b.src="javascript:",a=b.contentWindow.Object.prototype,c.removeChild(b),b=null,a};o=p||"undefined"==typeof document?function(){return{__proto__:null}}:function(){var a=q()?r():s();delete a.constructor,delete a.hasOwnProperty,delete a.propertyIsEnumerable,delete a.isPrototypeOf,delete a.toLocaleString,delete a.toString,delete a.valueOf,a.__proto__=null;var b=function(){};return b.prototype=a,o=function(){return new b},new b},Object.create=function(a,b){var c,d=function(){};if(null===a)c=o();else{if("object"!=typeof a&&"function"!=typeof a)throw new TypeError("Object prototype may only be an Object or null");d.prototype=a,c=new d,c.__proto__=a}return void 0!==b&&Object.defineProperties(c,b),c}}var t=function(a){try{return Object.defineProperty(a,"sentinel",{}),"sentinel"in a}catch(b){return!1}};if(Object.defineProperty){var u=t({}),v="undefined"==typeof document||t(document.createElement("div"));if(!u||!v)var w=Object.defineProperty,x=Object.defineProperties}if(!Object.defineProperty||w){var y="Property description must be an object: ",z="Object.defineProperty called on non-object: ",A="getters & setters can not be defined on this javascript engine";Object.defineProperty=function(e,g,h){if("object"!=typeof e&&"function"!=typeof e||null===e)throw new TypeError(z+e);if("object"!=typeof h&&"function"!=typeof h||null===h)throw new TypeError(y+h);if(w)try{return w.call(Object,e,g,h)}catch(j){}if("value"in h)if(i&&(c(e,g)||d(e,g))){var k=e.__proto__;e.__proto__=f,delete e[g],e[g]=h.value,e.__proto__=k}else e[g]=h.value;else{if(!i&&("get"in h||"set"in h))throw new TypeError(A);"get"in h&&a(e,g,h.get),"set"in h&&b(e,g,h.set)}return e}}(!Object.defineProperties||x)&&(Object.defineProperties=function(a,b){if(x)try{return x.call(Object,a,b)}catch(c){}return Object.keys(b).forEach(function(c){"__proto__"!==c&&Object.defineProperty(a,c,b[c])}),a}),Object.seal||(Object.seal=function(a){if(Object(a)!==a)throw new TypeError("Object.seal can only be called on Objects.");return a}),Object.freeze||(Object.freeze=function(a){if(Object(a)!==a)throw new TypeError("Object.freeze can only be called on Objects.");return a});try{Object.freeze(function(){})}catch(B){Object.freeze=function(a){return function(b){return"function"==typeof b?b:a(b)}}(Object.freeze)}Object.preventExtensions||(Object.preventExtensions=function(a){if(Object(a)!==a)throw new TypeError("Object.preventExtensions can only be called on Objects.");return a}),Object.isSealed||(Object.isSealed=function(a){if(Object(a)!==a)throw new TypeError("Object.isSealed can only be called on Objects.");return!1}),Object.isFrozen||(Object.isFrozen=function(a){if(Object(a)!==a)throw new TypeError("Object.isFrozen can only be called on Objects.");return!1}),Object.isExtensible||(Object.isExtensible=function(a){if(Object(a)!==a)throw new TypeError("Object.isExtensible can only be called on Objects.");for(var b="";g(a,b);)b+="?";a[b]=!0;var c=g(a,b);return delete a[b],c})}),function(){var a,b,c,d;!function(){var e={},f={};a=function(a,b,c){e[a]={deps:b,callback:c}},d=c=b=function(a){function c(b){if("."!==b.charAt(0))return b;for(var c=b.split("/"),d=a.split("/").slice(0,-1),e=0,f=c.length;f>e;e++){var g=c[e];if(".."===g)d.pop();else{if("."===g)continue;d.push(g)}}return d.join("/")}if(d._eak_seen=e,f[a])return f[a];if(f[a]={},!e[a])throw new Error("Could not find module "+a);for(var g,h=e[a],i=h.deps,j=h.callback,k=[],l=0,m=i.length;m>l;l++)"exports"===i[l]?k.push(g={}):k.push(b(c(i[l])));var n=j.apply(this,k);return f[a]=g||n}}(),a("promise/all",["./utils","exports"],function(a,b){"use strict";function c(a){var b=this;if(!d(a))throw new TypeError("You must pass an array to all.");return new b(function(b,c){function d(a){return function(b){f(a,b)}}function f(a,c){h[a]=c,0===--i&&b(h)}var g,h=[],i=a.length;0===i&&b([]);for(var j=0;j<a.length;j++)g=a[j],g&&e(g.then)?g.then(d(j),c):f(j,g)})}var d=a.isArray,e=a.isFunction;b.all=c}),a("promise/asap",["exports"],function(a){"use strict";function b(){return function(){process.nextTick(e)}}function c(){var a=0,b=new i(e),c=document.createTextNode("");return b.observe(c,{characterData:!0}),function(){c.data=a=++a%2}}function d(){return function(){j.setTimeout(e,1)}}function e(){for(var a=0;a<k.length;a++){var b=k[a],c=b[0],d=b[1];c(d)}k=[]}function f(a,b){var c=k.push([a,b]);1===c&&g()}var g,h="undefined"!=typeof window?window:{},i=h.MutationObserver||h.WebKitMutationObserver,j="undefined"!=typeof global?global:void 0===this?window:this,k=[];g="undefined"!=typeof process&&"[object process]"==={}.toString.call(process)?b():i?c():d(),a.asap=f}),a("promise/config",["exports"],function(a){"use strict";function b(a,b){return 2!==arguments.length?c[a]:void(c[a]=b)}var c={instrument:!1};a.config=c,a.configure=b}),a("promise/polyfill",["./promise","./utils","exports"],function(a,b,c){"use strict";function d(){var a;a="undefined"!=typeof global?global:"undefined"!=typeof window&&window.document?window:self;var b="Promise"in a&&"resolve"in a.Promise&&"reject"in a.Promise&&"all"in a.Promise&&"race"in a.Promise&&function(){var b;return new a.Promise(function(a){b=a}),f(b)}();b||(a.Promise=e)}var e=a.Promise,f=b.isFunction;c.polyfill=d}),a("promise/promise",["./config","./utils","./all","./race","./resolve","./reject","./asap","exports"],function(a,b,c,d,e,f,g,h){"use strict";function i(a){if(!v(a))throw new TypeError("You must pass a resolver function as the first argument to the promise constructor");if(!(this instanceof i))throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.");this._subscribers=[],j(a,this)}function j(a,b){function c(a){o(b,a)}function d(a){q(b,a)}try{a(c,d)}catch(e){d(e)}}function k(a,b,c,d){var e,f,g,h,i=v(c);if(i)try{e=c(d),g=!0}catch(j){h=!0,f=j}else e=d,g=!0;n(b,e)||(i&&g?o(b,e):h?q(b,f):a===D?o(b,e):a===E&&q(b,e))}function l(a,b,c,d){var e=a._subscribers,f=e.length;e[f]=b,e[f+D]=c,e[f+E]=d}function m(a,b){for(var c,d,e=a._subscribers,f=a._detail,g=0;g<e.length;g+=3)c=e[g],d=e[g+b],k(b,c,d,f);a._subscribers=null}function n(a,b){var c,d=null;try{if(a===b)throw new TypeError("A promises callback cannot return that same promise.");if(u(b)&&(d=b.then,v(d)))return d.call(b,function(d){return c?!0:(c=!0,void(b!==d?o(a,d):p(a,d)))},function(b){return c?!0:(c=!0,void q(a,b))}),!0}catch(e){return c?!0:(q(a,e),!0)}return!1}function o(a,b){a===b?p(a,b):n(a,b)||p(a,b)}function p(a,b){a._state===B&&(a._state=C,a._detail=b,t.async(r,a))}function q(a,b){a._state===B&&(a._state=C,a._detail=b,t.async(s,a))}function r(a){m(a,a._state=D)}function s(a){m(a,a._state=E)}var t=a.config,u=(a.configure,b.objectOrFunction),v=b.isFunction,w=(b.now,c.all),x=d.race,y=e.resolve,z=f.reject,A=g.asap;t.async=A;var B=void 0,C=0,D=1,E=2;i.prototype={constructor:i,_state:void 0,_detail:void 0,_subscribers:void 0,then:function(a,b){var c=this,d=new this.constructor(function(){});if(this._state){var e=arguments;t.async(function(){k(c._state,d,e[c._state-1],c._detail)})}else l(this,d,a,b);return d},"catch":function(a){return this.then(null,a)}},i.all=w,i.race=x,i.resolve=y,i.reject=z,h.Promise=i}),a("promise/race",["./utils","exports"],function(a,b){"use strict";function c(a){var b=this;if(!d(a))throw new TypeError("You must pass an array to race.");return new b(function(b,c){for(var d,e=0;e<a.length;e++)d=a[e],d&&"function"==typeof d.then?d.then(b,c):b(d)})}var d=a.isArray;b.race=c}),a("promise/reject",["exports"],function(a){"use strict";function b(a){var b=this;return new b(function(b,c){c(a)})}a.reject=b}),a("promise/resolve",["exports"],function(a){"use strict";function b(a){if(a&&"object"==typeof a&&a.constructor===this)return a;var b=this;return new b(function(b){b(a)})}a.resolve=b}),a("promise/utils",["exports"],function(a){"use strict";function b(a){return c(a)||"object"==typeof a&&null!==a}function c(a){return"function"==typeof a}function d(a){return"[object Array]"===Object.prototype.toString.call(a)}var e=Date.now||function(){return(new Date).getTime()};a.objectOrFunction=b,a.isFunction=c,a.isArray=d,a.now=e}),b("promise/polyfill").polyfill()}();var ozpIwc=ozpIwc||{};ozpIwc.apiMap={"data.api":{address:"data.api",actions:["get","set","delete","watch","unwatch","list","bulkGet","addChild","removeChild"]},"intents.api":{address:"intents.api",actions:["get","set","delete","watch","unwatch","list","bulkGet","register","invoke","broadcast"]},"names.api":{address:"names.api",actions:["get","set","delete","watch","unwatch","list","bulkGet"]},"system.api":{address:"system.api",actions:["get","set","delete","watch","unwatch","list","bulkGet","launch"]},"locks.api":{address:"locks.api",actions:["get","watch","unwatch","list","lock","unlock"]}},ozpIwc.ApiPromiseMixin=function(a,b){b="undefined"==typeof b||b,a.address=a.address||"$nobody",a.connect=a.connect||function(){return a.connectPromise=Promise.resolve(),a.connectPromise},a.events||(a.events=new ozpIwc.Event,a.events.mixinOnOff(a));var c=ozpIwc.ApiPromiseMixin.getCore();for(var d in c)a[d]=c[d];a.readLaunchParams(window.name),a.readLaunchParams(window.location.search),a.readLaunchParams(window.location.hash),ozpIwc.ApiPromiseMixin.registerEvents(a),a.constructApiFunctions(),b&&a.connect()},ozpIwc.ApiPromiseMixin.registerEvents=function(a){a.on("disconnect",function(){a.promiseCallbacks={},a.registeredCallbacks={},window.removeEventListener("message",a.postMessageHandler,!1),a.connectPromise=null})},ozpIwc.ApiPromiseMixin.getCore=function(){return{promiseCallbacks:{},msgIdSequence:0,receivedPackets:0,receivedBytes:0,sentPackets:0,sentBytes:0,startTime:ozpIwc.util.now(),apiMap:ozpIwc.apiMap||{},wrapperMap:{},preconnectionQueue:[],launchParams:{},watchMsgMap:{},registeredCallbacks:{},launchedIntents:[],isConnected:function(){return"$nobody"!==this.address},readLaunchParams:function(a){for(var b,c=/ozpIwc.(\w+)=([^&#]+)/g;null!==(b=c.exec(a));){var d=decodeURIComponent(b[2]);try{d=JSON.parse(d)}catch(e){}this.launchParams[b[1]]=d}},receiveFromRouterImpl:function(a){var b=!1,c=a.packet||a;if("$transport"===c.src||c.replyTo&&this.promiseCallbacks[c.replyTo]){var d=!1,e=function(){d=!0};this.promiseCallbacks[c.replyTo](c,e),d&&(this.cancelPromiseCallback(c.replyTo),b=!0)}if(!b&&c.replyTo&&this.registeredCallbacks[c.replyTo]){var f=!1,g=function(){f=!0};b=this.registeredCallbacks[c.replyTo](c,g),f&&(this.watchMsgMap[c.replyTo]&&"watch"===this.watchMsgMap[c.replyTo].action&&this.api(this.watchMsgMap[c.replyTo].dst).unwatch(this.watchMsgMap[c.replyTo].resource),this.cancelRegisteredCallback(c.replyTo))}b||this.events.trigger("receive",a)},constructApiFunctions:function(){for(var a in this.apiMap){var b=this.apiMap[a],c=b.address.replace(".api","");this.hasOwnProperty(c)&&this.apiMap[a].functionName!==c||!function(a,b){a[c]=function(){return a.api(b)},a.apiMap[b]=a.apiMap[b]||{},a.apiMap[b].functionName=c,a.updateApi(b)}(this,b.address)}},gatherApiInformation:function(){var a=this;return this.send({dst:"names.api",action:"get",resource:"/api"}).then(function(a){if("ok"===a.response)return a.entity;throw a.response}).then(function(b){var c=[];return b.forEach(function(b){var d=a.send({dst:"names.api",action:"get",resource:b}).then(function(c){if("ok"!==c.response)throw c.response;var d=b.replace("/api/","");a.apiMap[d]=a.apiMap[d]||{},a.apiMap[d].address=d,a.apiMap[d].actions=c.entity.actions});c.push(d)}),Promise.all(c)})},cancelPromiseCallback:function(a){var b=!1;return a&&(delete this.promiseCallbacks[a],b=!0),b},cancelRegisteredCallback:function(a){var b=!1;return a&&(delete this.registeredCallbacks[a],delete this.watchMsgMap[a],b=!0),b},on:function(a,b){return"connected"===a&&this.isConnected()?void b(this):this.events.on.apply(this.events,arguments)},off:function(a,b){return this.events.off.apply(this.events,arguments)},intentInvocationHandling:function(a,b,c){var d,e,f=this;return c=c||function(){},b=b||{},e=b.entity?Promise.resolve(b):f.send({dst:"intents.api",action:"get",resource:b.resource}),e.then(function(b){return d=b,f.send({dst:"intents.api",contentType:d.contentType,action:"set",resource:d.resource,entity:{handler:{resource:a.resource,address:f.address},state:"running"}})}).then(function(){return c(d.entity)}).then(function(a){return f.send({dst:"intents.api",contentType:d.contentType,action:"set",resource:d.resource,entity:{reply:{entity:a||{},contentType:d.entity.intent.type},state:"complete"}})})["catch"](function(a){return ozpIwc.log.log("Error in handling intent: ",a," -- Reporting error on in-flight intent node:",d.resource),f.send({dst:"intents.api",contentType:d.contentType,action:"set",resource:d.resource,entity:{reply:{entity:a||{},contentType:d.entity.intent.type},state:"error"}})})},api:function(a){return this.wrapperMap[a]||this.updateApi(a)},updateApi:function(a){var b=function(a,b){return function(c,d,e){var f=a(c,d,e),g=f.packet;if("intents.api"===g.dst&&"register"===g.action)for(var h in b.launchedIntents){var i="/"+b.launchedIntents[h].entity.intent.type+"/"+b.launchedIntents[h].entity.intent.action;c===i&&(b.intentInvocationHandling(g,b.launchedIntents[h].resource,f.callback),delete b.launchedIntents[h])}return b.send(g,f.callback)}},c=function(a,b,c){return function(d,e,f){"function"==typeof e&&(f=e,e={});var g={dst:a,action:b,resource:d,entity:{}};for(var h in e)g[h]=e[h];var i,j,k=new Promise(function(a,b){i=a,j=b});return k.packet=c.fixPacket(g),k.callback=f,k.res=i,k.rej=j,k}},d=this.wrapperMap[a]||{};if(this.apiMap.hasOwnProperty(a)){var e=this.apiMap[a];d={},d.messageBuilder={},d.messageBuilder.bulkSend=function(a,b){var c={dst:e.address,action:"bulkSend",resource:"/",entity:a};return{packet:c,callback:b}},d.bulkSend=function(a,b){return function(c){var d=a(c);return b.send(d.packet,d.callback)}}(d.messageBuilder.bulkSend,this);for(var f=0;f<e.actions.length;++f){var g=e.actions[f];d.messageBuilder[g]=c(e.address,g,this),d[g]=b(d.messageBuilder[g],this)}this.wrapperMap[a]=d}return d.apiName=a,d},fixPacket:function(a){var b={ver:1,src:a.src||this.address,msgId:a.msgId||"p:"+this.msgIdSequence++,time:a.time||(new Date).getTime()};for(var c in a)b[c]=a[c]||b[c];return"$nobody"===b.src&&(b.src=this.address),b},registerResponses:function(a,b,c,d){var e=this;b&&(this.registeredCallbacks[a.msgId]=function(c,d){return"$transport"===c.src||/(ok).*/.test(c.response)||/(bad|no).*/.test(c.response)?!1:(c.entity&&c.entity.inFlightIntent?e.intentInvocationHandling(a,c.entity.inFlightIntent,b):b(c,d),!0)}),"none"!==a.respondOn&&(this.promiseCallbacks[a.msgId]=function(a,b){"$transport"===a.src||/(ok).*/.test(a.response)?(b(),
c(a)):/(bad|no).*/.test(a.response)&&(b(),d(a))}),"watch"===a.action?this.watchMsgMap[a.msgId]=a:"unwatch"===a.action&&a.replyTo&&this.cancelRegisteredCallback(a.replyTo),"bulkSend"===a.action&&a.entity.forEach(function(a){e.registerResponses(a.packet,a.callback,a.res,a.rej)})},send:function(a,b,c,d){if(this.sendingBlocked)return Promise.resolve({response:"dropped"});var e=c,f=d,g=new Promise(function(a,b){e||f||(e=a,f=b)});if(!this.isConnected()&&"$transport"!==a.dst)return this.preconnectionQueue.push({fields:a,callback:b,promiseRes:e,promiseRej:f}),g;var h=this.fixPacket(a);return this.registerResponses(h,b,e,f),this.sendImpl(h),this.sentBytes+=h.length,this.sentPackets++,g},afterConnected:function(){var a=this;return a.preconnectionQueue.forEach(function(b){a.send(b.fields,b.callback,b.promiseRes,b.promiseRej)}),a.preconnectionQueue=[],!a.launchParams.inFlightIntent||a.internal?(a.events.trigger("connected"),Promise.resolve()):a.intents().get(a.launchParams.inFlightIntent).then(function(b){if(b&&b.entity&&b.entity.intent){a.launchedIntents.push(b);var c=b.entity.entity||{};if("ok"===b.response)for(var d in c)a.launchParams[d]=c[d];a.intents().set(a.launchParams.inFlightIntent,{entity:{state:"complete"}})}a.events.trigger("connected")})["catch"](function(b){ozpIwc.log.error(a.launchParams.inFlightIntent," not handled, reason: ",b),a.events.trigger("connected")})}}};var ozpIwc=ozpIwc||{};ozpIwc.Event=function(){this.events={}},ozpIwc.Event.prototype.on=function(a,b,c){var d=b;return c&&(d=function(){b.apply(c,arguments)},d.ozpIwcDelegateFor=b),this.events[a]=this.events[a]||[],this.events[a].push(d),d},ozpIwc.Event.prototype.off=function(a,b){this.events[a]=(this.events[a]||[]).filter(function(a){return a!==b&&a.ozpIwcDelegateFor!==b})},ozpIwc.Event.prototype.trigger=function(a){var b=Array.prototype.slice.call(arguments,1);b.length<1&&b.push(new ozpIwc.CancelableEvent);var c=this.events[a]||[];return c.forEach(function(a){a.apply(this,b)}),b[0]},ozpIwc.Event.prototype.mixinOnOff=function(a){var b=this;a.on=function(){return b.on.apply(b,arguments)},a.off=function(){return b.off.apply(b,arguments)}},ozpIwc.CancelableEvent=function(a){a=a||{};for(var b in a)this[b]=a[b];this.canceled=!1,this.cancelReason=null},ozpIwc.CancelableEvent.prototype.cancel=function(a){return a=a||"Unknown",this.canceled=!0,this.cancelReason=a,this},window.console&&console.log||(console={log:function(){},debug:function(){},info:function(){},warn:function(){},error:function(){}});var getStackTrace=function(){var a={};return Error.captureStackTrace(a,getStackTrace),a.stack};ozpIwc.log=ozpIwc.log||{NONE:{logLevel:!0,severity:0,name:"NONE"},DEFAULT:{logLevel:!0,severity:1,name:"DEFAULT"},ERROR:{logLevel:!0,severity:3,name:"ERROR"},INFO:{logLevel:!0,severity:6,name:"INFO"},DEBUG:{logLevel:!0,severity:7,name:"DEBUG"},ALL:{logLevel:!0,severity:10,name:"ALL"},threshold:3,setThreshold:function(a){if("number"==typeof a)ozpIwc.log.threshold=a;else{if("number"!=typeof a.severity)throw new TypeError("Threshold must be a number or one of the ozpIwc.log constants.  Instead got"+a);ozpIwc.log.threshold=a.severity}},log:function(a){a.logLevel===!0&&"number"==typeof a.severity?ozpIwc.log.logMsg(a,Array.prototype.slice.call(arguments,1)):ozpIwc.log.logMsg(ozpIwc.log.DEFAULT,Array.prototype.slice.call(arguments,0))},logMsg:function(a,b){if(!(a.severity>ozpIwc.log.threshold)&&console&&console.log){var c=b.reduce(function(a,b){return b instanceof Error?a+b.toString()+(b.stack?" -- "+b.stack:""):"object"==typeof b?a+JSON.stringify(b,null,2):a+b},"["+a.name+"] ");console.log(c)}},error:function(){ozpIwc.log.logMsg(ozpIwc.log.ERROR,Array.prototype.slice.call(arguments,0))},debug:function(){ozpIwc.log.logMsg(ozpIwc.log.DEBUG,Array.prototype.slice.call(arguments,0))},info:function(){ozpIwc.log.logMsg(ozpIwc.log.INFO,Array.prototype.slice.call(arguments,0))}},ozpIwc.object={eachEntry:function(a,b,c){var d=[];for(var e in a)d.push(b.call(c,e,a[e],a.hasOwnProperty(e)));return d},values:function(a,b){b=b||function(a,b){return!0};var c=[];for(var d in a)b(d,a[d])&&c.push(a[d]);return c}},ozpIwc.packetRouter=ozpIwc.packetRouter||{},ozpIwc.packetRouter.uriTemplate=function(a){var b=[],c="^"+a.replace(/\{.+?\}|[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,function(a){if(1===a.length)return"\\"+a;var c=a.indexOf(":");return c>0?(b.push(a.slice(1,c)),"("+a.slice(c+1,-1)+")"):(b.push(a.slice(1,-1)),"([^/]+)")})+"$",d=new RegExp(c);return function(a){var c=d.exec(a);if(!c)return null;for(var e={},f=1;f<c.length;++f)e[b[f-1]]=c[f];return e}},ozpIwc.PacketRouter=function(){this.routes={},this.defaultRoute=function(){return!1},this.defaultSelf=this},ozpIwc.PacketRouter.prototype.declareRoute=function(a,b,c){if(!a||!a.action||!a.resource)throw new Error("Bad route declaration: "+JSON.stringify(a,null,2));a.handler=b,a.filters=a.filters||[],a.handlerSelf=c,a.uriTemplate=ozpIwc.packetRouter.uriTemplate(a.resource);var d=ozpIwc.util.ensureArray(a.action);return d.forEach(function(b){this.routes.hasOwnProperty(b)||(this.routes[b]=[]),this.routes[b].push(a)},this),this},ozpIwc.PacketRouter.prototype.filterChain=function(a,b,c,d,e,f){if(!f.length)return d.handler.call(e,a,b,c);var g=f.shift(),h=this,i=!1,j=g.call(e,a,b,c,function(){return i=!0,h.filterChain(a,b,c,d,e,f)});return i?ozpIwc.log.debug("Filter returned ",j):ozpIwc.log.info("Filter did not call next() and did not throw an exception",g),j},ozpIwc.PacketRouter.prototype.routePacket=function(a,b,c,d){d=d||{};var e=d.action||a.action,f=d.resource||a.resource;if(!e||!f)return b.defaultRouteCause="nonRoutablePacket",this.defaultRoute.call(c,a,b,{});if(b=b||{},c=c||this.defaultSelf,!this.routes.hasOwnProperty(e))return b.defaultRouteCause="noAction",this.defaultRoute.call(c,a,b,{});for(var g=this.routes[e],h=0;h<g.length;++h){var i=g[h];if(i){var j=i.uriTemplate(f);if(j){c=i.handlerSelf||c;var k=i.filters.slice();return this.filterChain(a,b,j,i,c,k)}}}return b.defaultRouteCause="noResource",this.defaultRoute.call(c,a,b,{})},ozpIwc.PacketRouter.prototype.declareDefaultRoute=function(a){this.defaultRoute=a},ozpIwc.PacketRouter.mixin=function(a){var b=new ozpIwc.PacketRouter,c=Object.getPrototypeOf(a.prototype);c&&c.routePacket?b.defaultRoute=function(a,b){return c.routePacket.apply(this,arguments)}:b.defaultRoute=function(a,b){return this.defaultRoute?this.defaultRoute.apply(this,arguments):!1},a.declareRoute=function(a,c){b.declareRoute(a,c)},a.prototype.routePacket=function(a,c){return b.routePacket(a,c,this)}},ozpIwc.util=ozpIwc.util||{},ozpIwc.util.now=function(){return(new Date).getTime()},ozpIwc.util.resolveUriTemplate=function(a,b,c){var d={"+":function(a){return a},"":function(a){return encodeURIComponent(a)}},e=a.replace(/\{([\+\#\.\/\;\?\&]?)(.+?)\}/g,function(a,e,f){return d[e](b[f]||c[f])}),f=e.indexOf("://");return f>0&&(f+=3),e.replace(/\/\//g,function(a,b){return b>f?"/":a})},ozpIwc.util.eventListeners={},ozpIwc.util.addEventListener=function(a,b){var c=ozpIwc.util.eventListeners[a];c||(c=ozpIwc.util.eventListeners[a]=[]),c.push(b),window.addEventListener(a,b)},ozpIwc.util.removeEventListener=function(a,b){var c=ozpIwc.util.eventListeners[a];c&&(ozpIwc.util.eventListeners[a]=c.filter(function(a){return a!==b})),window.removeEventListener(a,b)},ozpIwc.util.purgeEventListeners=function(){ozpIwc.object.eachEntry(ozpIwc.util.eventListeners,function(a,b){b.forEach(function(b){window.removeEventListener(a,b)})}),ozpIwc.util.eventListeners={}},ozpIwc.util.extend=function(a,b){if(!a||!a.prototype)throw ozpIwc.log.error("Cannot create a new class for ",b," due to invalid baseclass:",a),new Error("Cannot create a new class due to invalid baseClass.  Dependency not loaded first?");return b.prototype=Object.create(a.prototype),b.prototype.constructor=b,b},ozpIwc.util.safePostMessage=function(a,b,c){try{var d=b;ozpIwc.util.structuredCloneSupport()||"string"==typeof d||(d=JSON.stringify(b)),a.postMessage(d,c)}catch(e){try{a.postMessage(JSON.stringify(b),c)}catch(e){ozpIwc.log.debug("Invalid call to window.postMessage: "+e.message)}}},ozpIwc.util.structuredCloneSupport=function(){if(ozpIwc.util=ozpIwc.util||{},void 0!==ozpIwc.util.structuredCloneSupportCache)return ozpIwc.util.structuredCloneSupportCache;var a="postMessage"in window;try{window.postMessage({toString:function(){a=!1}},"*")}catch(b){}return ozpIwc.util.structuredCloneSupportCache=a,ozpIwc.util.structuredCloneSupportCache},ozpIwc.util.structuredCloneSupport.cache=void 0,ozpIwc.util.clone=function(a){if(!Array.isArray(a)&&"object"!=typeof a)return a;try{return JSON.parse(JSON.stringify(a))}catch(b){ozpIwc.log.log(b)}},ozpIwc.util.parseQueryParams=function(a){a=a||window.location.search;for(var b,c={},d=/\??([^&=]+)=?([^&]*)/g;null!==(b=d.exec(a));)c[b[1]]=decodeURIComponent(b[2]);return c},ozpIwc.util.addQueryParams=function(a,b){if("string"!=typeof a)throw new Error("url should be a string.");var c={};switch(typeof b){case"object":if(Array.isArray(b)){if(0===b.length)return a;for(var d in b)if("string"==typeof b[d]){var e=ozpIwc.util.parseQueryParams(b[d]);for(var f in e)c[f]=e[f]}}else{if(0===Object.keys(b).length)return a;c=b}break;case"undefined":return a;default:if(0===b.length)return a;c=ozpIwc.util.parseQueryParams(b)}var g="",h=a.split("#");if(h.length>2)throw new Error("Invalid url.");a=h[0],g=h[1]||"",a+=-1===a.indexOf("?")?"?":"&";var i="";for(var j in c)a+=i+j+"="+c[j],i="&";return g.length>0&&(a+="#"+g),a},ozpIwc.util.protocolPorts={"http:":"80","https:":"443","ws:":"80","wss:":"443"},ozpIwc.util.determineOrigin=function(a){var b=document.createElement("a");if(b.href=a,b.origin)return b.origin;var c=b.protocol+"//"+b.hostname;return b.port&&ozpIwc.util.protocolPorts[b.protocol]!==b.port&&(c+=":"+b.port),c},ozpIwc.util.escapeRegex=function(a){return a.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")},ozpIwc.util.parseOzpUrl=function(a){var b=/^(?:(?:web\+ozp|ozp):\/\/)?([0-9a-zA-Z](?:[-.\w])*)(\/[^?#]*)(\?[^#]*)?(#.*)?$/.exec(decodeURIComponent(a));if(b){var c={dst:b[1],resource:b[2],action:"get"};return c}return null},ozpIwc.util.isIWCPacket=function(a){return"string"!=typeof a.src||"string"!=typeof a.dst||"number"!=typeof a.ver||"string"!=typeof a.msgId?!1:!0},ozpIwc.util.getInternetExplorerVersion=function(){var a,b,c=-1;return"Microsoft Internet Explorer"===navigator.appName?(a=navigator.userAgent,b=/MSIE ([0-9]{1,}[\.0-9]{0,})/,null!==b.exec(a)&&(c=parseFloat(RegExp.$1))):"Netscape"===navigator.appName&&(a=navigator.userAgent,b=/Trident\/.*rv:([0-9]{1,}[\.0-9]{0,})/,null!==b.exec(a)&&(c=parseFloat(RegExp.$1))),c},ozpIwc.util.prerender=function(){return new Promise(function(a,b){void 0===document.visibilityState||"prerender"!==document.visibilityState&&"unload"!==document.visibilityState?a():document.addEventListener("visibilitychange",function c(b){"prerender"!==document.visibilityState&&(document.removeEventListener(c),a())})})};var ozpIwc=ozpIwc||{};ozpIwc.metricsStats=ozpIwc.metricsStats||{},ozpIwc.metricsStats.DEFAULT_POOL_SIZE=1028,ozpIwc.metricsStats.Sample=function(){this.clear()},ozpIwc.metricsStats.Sample.prototype.update=function(a){this.values.push(a)},ozpIwc.metricsStats.Sample.prototype.clear=function(){this.values=[],this.count=0},ozpIwc.metricsStats.Sample.prototype.size=function(){return this.values.length},ozpIwc.metricsStats.Sample.prototype.getValues=function(){return this.values},ozpIwc.metricsStats.UniformSample=ozpIwc.util.extend(ozpIwc.metricsStats.Sample,function(a){ozpIwc.metricsStats.Sample.apply(this),this.limit=a||ozpIwc.metricsStats.DEFAULT_POOL_SIZE}),ozpIwc.metricsStats.UniformSample.prototype.update=function(a){if(this.count++,this.size()<this.limit)this.values.push(a);else{var b=parseInt(Math.random()*this.count);b<this.limit&&(this.values[b]=a)}};var ozpIwc=ozpIwc||{};ozpIwc.metricsStats=ozpIwc.metricsStats||{},ozpIwc.metricsStats.BinaryHeap=function(a){this.content=[],this.scoreFunction=a},ozpIwc.metricsStats.BinaryHeap.prototype={clone:function(){var a=new ozpIwc.metricsStats.BinaryHeap(this.scoreFunction);return a.content=JSON.parse(JSON.stringify(this.content)),a},push:function(a){this.content.push(a),this.bubbleUp(this.content.length-1)},peek:function(){return this.content[0]},pop:function(){var a=this.content[0],b=this.content.pop();return this.content.length>0&&(this.content[0]=b,this.sinkDown(0)),a},remove:function(a){for(var b=this.content.length,c=0;b>c;c++)if(this.content[c]===a){var d=this.content.pop();return c!==b-1&&(this.content[c]=d,this.scoreFunction(d)<this.scoreFunction(a)?this.bubbleUp(c):this.sinkDown(c)),!0}throw new Error("Node not found.")},size:function(){return this.content.length},bubbleUp:function(a){for(var b=this.content[a];a>0;){var c=Math.floor((a+1)/2)-1,d=this.content[c];if(!(this.scoreFunction(b)<this.scoreFunction(d)))break;this.content[c]=b,this.content[a]=d,a=c}},sinkDown:function(a){for(var b=this.content.length,c=this.content[a],d=this.scoreFunction(c);;){var e=2*(a+1),f=e-1,g=null,h=null;if(b>f){var i=this.content[f];h=this.scoreFunction(i),d>h&&(g=f)}if(b>e){var j=this.content[e],k=this.scoreFunction(j);(null===g?d:h)>k&&(g=e)}if(null===g)break;this.content[a]=this.content[g],this.content[g]=c,a=g}}};var ozpIwc=ozpIwc||{};ozpIwc.metricsStats=ozpIwc.metricsStats||{},ozpIwc.metricsStats.DEFAULT_RESCALE_THRESHOLD=36e5,ozpIwc.metricsStats.DEFAULT_DECAY_ALPHA=.015,ozpIwc.metricsStats.ExponentiallyDecayingSample=ozpIwc.util.extend(ozpIwc.metricsStats.Sample,function(a,b){ozpIwc.metricsStats.Sample.apply(this),this.limit=a||ozpIwc.metricsStats.DEFAULT_POOL_SIZE,this.alpha=b||ozpIwc.metricsStats.DEFAULT_DECAY_ALPHA,this.rescaleThreshold=ozpIwc.metricsStats.DEFAULT_RESCALE_THRESHOLD}),ozpIwc.metricsStats.ExponentiallyDecayingSample.prototype.getValues=function(){for(var a,b=[],c=this.values.clone();void 0!==(a=c.pop());)b.push(a.val);return b},ozpIwc.metricsStats.ExponentiallyDecayingSample.prototype.size=function(){return this.values.size()},ozpIwc.metricsStats.ExponentiallyDecayingSample.prototype.newHeap=function(){return new ozpIwc.metricsStats.BinaryHeap(function(a){return a.priority})},ozpIwc.metricsStats.ExponentiallyDecayingSample.prototype.now=function(){return ozpIwc.util.now()},ozpIwc.metricsStats.ExponentiallyDecayingSample.prototype.tick=function(){return this.now()/1e3},ozpIwc.metricsStats.ExponentiallyDecayingSample.prototype.clear=function(){this.values=this.newHeap(),this.count=0,this.startTime=this.tick(),this.nextScaleTime=this.now()+this.rescaleThreshold},ozpIwc.metricsStats.ExponentiallyDecayingSample.prototype.update=function(a,b){void 0===b?b=this.tick():b/=1e3;var c=this.weight(b-this.startTime)/Math.random(),d={val:a,priority:c};if(this.count<this.limit)this.count+=1,this.values.push(d);else{var e=this.values.peek();e.priority<c&&(this.values.push(d),this.values.pop())}this.now()>this.nextScaleTime&&this.rescale()},ozpIwc.metricsStats.ExponentiallyDecayingSample.prototype.weight=function(a){return Math.exp(this.alpha*a)},ozpIwc.metricsStats.ExponentiallyDecayingSample.prototype.rescale=function(){this.nextScaleTime=this.now()+this.rescaleThreshold;var a=this.values.content,b=[],c=this.startTime;this.startTime=this.tick();for(var d=0;d<a.length;d++)b.push({val:a[d].val,priority:a[d].priority*Math.exp(-this.alpha*(this.startTime-c))});this.values.content=b};var ozpIwc=ozpIwc||{};ozpIwc.metricsStats=ozpIwc.metricsStats||{},ozpIwc.metricsStats.M1_ALPHA=1-Math.exp(-5/60),ozpIwc.metricsStats.M5_ALPHA=1-Math.exp(-5/60/5),ozpIwc.metricsStats.M15_ALPHA=1-Math.exp(-5/60/15),ozpIwc.metricsStats.ExponentiallyWeightedMovingAverage=function(a,b){this.alpha=a,this.interval=b||5e3,this.currentRate=null,this.uncounted=0,this.lastTick=ozpIwc.util.now()},ozpIwc.metricsStats.ExponentiallyWeightedMovingAverage.prototype.update=function(a){this.uncounted+=a||1,this.tick()},ozpIwc.metricsStats.ExponentiallyWeightedMovingAverage.prototype.tick=function(){var a=ozpIwc.util.now(),b=a-this.lastTick;if(b>this.interval){this.lastTick=a-b%this.interval;for(var c=Math.floor(b/this.interval),d=0;c>d;++d){var e=this.uncounted/this.interval;this.uncounted=0,null!==this.currentRate?this.currentRate+=this.alpha*(e-this.currentRate):this.currentRate=e}}},ozpIwc.metricsStats.ExponentiallyWeightedMovingAverage.prototype.rate=function(){return 1e3*this.currentRate};var ozpIwc=ozpIwc||{};ozpIwc.metricTypes=ozpIwc.metricTypes||{},ozpIwc.metricTypes.BaseMetric=function(){this.value=0,this.name="",this.unitName=""},ozpIwc.metricTypes.BaseMetric.prototype.get=function(){return this.value},ozpIwc.metricTypes.BaseMetric.prototype.unit=function(a){return a?(this.unitName=a,this):this.unitName},ozpIwc.metricTypes.Counter=ozpIwc.util.extend(ozpIwc.metricTypes.BaseMetric,function(){ozpIwc.metricTypes.BaseMetric.apply(this,arguments),this.value=0}),ozpIwc.metricTypes.Counter.prototype.inc=function(a){return this.value+=a?a:1},ozpIwc.metricTypes.Counter.prototype.dec=function(a){return this.value-=a?a:1},ozpIwc.metricTypes=ozpIwc.metricTypes||{},ozpIwc.metricTypes.Gauge=ozpIwc.util.extend(ozpIwc.metricTypes.BaseMetric,function(a){ozpIwc.metricTypes.BaseMetric.apply(this,arguments),this.callback=a}),ozpIwc.metricTypes.Gauge.prototype.set=function(a){return this.callback=a,this},ozpIwc.metricTypes.Gauge.prototype.get=function(){return this.callback?this.callback():void 0},ozpIwc.metricTypes.Histogram=ozpIwc.util.extend(ozpIwc.metricTypes.BaseMetric,function(){ozpIwc.metricTypes.BaseMetric.apply(this,arguments),this.sample=new ozpIwc.metricsStats.ExponentiallyDecayingSample,this.clear()}),ozpIwc.metricTypes.Histogram.prototype.clear=function(){this.sample.clear(),this.min=this.max=null,this.varianceMean=0,this.varianceM2=0,this.sum=0,this.count=0},ozpIwc.metricTypes.Histogram.prototype.mark=function(a,b){b=b||ozpIwc.util.now(),this.sample.update(a,b),this.max=null===this.max?a:Math.max(this.max,a),this.min=null===this.min?a:Math.min(this.min,a),this.sum+=a,this.count++;var c=a-this.varianceMean;return this.varianceMean+=c/this.count,this.varianceM2+=c*(a-this.varianceMean),this.count},ozpIwc.metricTypes.Histogram.prototype.get=function(){var a=this.sample.getValues().map(function(a){return parseFloat(a)}).sort(function(a,b){return a-b}),b=function(b){var c=b*a.length;if(c>=a.length)return a[a.length-1];c=Math.max(0,c),c=Math.min(c,a.length+1);var d=a[Math.floor(c)-1],e=a[Math.floor(c)];return d+(c-Math.floor(c))*(e-d)};return{percentile10:b(.1),percentile25:b(.25),median:b(.5),percentile75:b(.75),percentile90:b(.9),percentile95:b(.95),percentile99:b(.99),percentile999:b(.999),variance:this.count<1?null:this.varianceM2/(this.count-1),mean:0===this.count?null:this.varianceMean,stdDev:this.count<1?null:Math.sqrt(this.varianceM2/(this.count-1)),count:this.count,sum:this.sum,max:this.max,min:this.min}},ozpIwc.metricTypes.Meter=ozpIwc.util.extend(ozpIwc.metricTypes.BaseMetric,function(){ozpIwc.metricTypes.BaseMetric.apply(this,arguments),this.m1Rate=new ozpIwc.metricsStats.ExponentiallyWeightedMovingAverage(ozpIwc.metricsStats.M1_ALPHA),this.m5Rate=new ozpIwc.metricsStats.ExponentiallyWeightedMovingAverage(ozpIwc.metricsStats.M5_ALPHA),this.m15Rate=new ozpIwc.metricsStats.ExponentiallyWeightedMovingAverage(ozpIwc.metricsStats.M15_ALPHA),this.startTime=ozpIwc.util.now(),this.value=0}),ozpIwc.metricTypes.Meter.prototype.mark=function(a){return a=a||1,this.value+=a,this.m1Rate.update(a),this.m5Rate.update(a),this.m15Rate.update(a),this.value},ozpIwc.metricTypes.Meter.prototype.get=function(){return{rate1m:this.m1Rate.rate(),rate5m:this.m5Rate.rate(),rate15m:this.m15Rate.rate(),rateMean:this.value/(ozpIwc.util.now()-this.startTime)*1e3,count:this.value}},ozpIwc.metricTypes.Meter.prototype.tick=function(){this.m1Rate.tick(),this.m5Rate.tick(),this.m15Rate.tick()},ozpIwc.metricTypes.Timer=ozpIwc.util.extend(ozpIwc.metricTypes.BaseMetric,function(){ozpIwc.metricTypes.BaseMetric.apply(this,arguments),this.meter=new ozpIwc.metricTypes.Meter,this.histogram=new ozpIwc.metricTypes.Histogram}),ozpIwc.metricTypes.Timer.prototype.mark=function(a,b){this.meter.mark(),this.histogram.mark(a,b)},ozpIwc.metricTypes.Timer.prototype.start=function(){var a=this,b=ozpIwc.util.now();return function(){var c=ozpIwc.util.now();a.mark(c-b,c)}},ozpIwc.metricTypes.Timer.prototype.time=function(a){var b=ozpIwc.util.now();try{a()}finally{var c=ozpIwc.util.now();this.mark(c-b,c)}},ozpIwc.metricTypes.Timer.prototype.get=function(){var a=this.histogram.get(),b=this.meter.get();for(var c in b)a[c]=b[c];return a};var ozpIwc=ozpIwc||{};ozpIwc.MetricsRegistry=function(){this.metrics={};var a=this;this.gauge("registry.metrics.types").set(function(){return Object.keys(a.metrics).length})},ozpIwc.MetricsRegistry.prototype.findOrCreateMetric=function(a,b){var c=this.metrics[a];return c?c instanceof b?c:null:(c=this.metrics[a]=new b,c.name=a,c)},ozpIwc.MetricsRegistry.prototype.makeName=function(a){return Array.prototype.slice.call(a).join(".")},ozpIwc.MetricsRegistry.prototype.counter=function(a){return this.findOrCreateMetric(this.makeName(arguments),ozpIwc.metricTypes.Counter)},ozpIwc.MetricsRegistry.prototype.meter=function(a){return this.findOrCreateMetric(this.makeName(arguments),ozpIwc.metricTypes.Meter)},ozpIwc.MetricsRegistry.prototype.gauge=function(a){return this.findOrCreateMetric(this.makeName(arguments),ozpIwc.metricTypes.Gauge)},ozpIwc.MetricsRegistry.prototype.histogram=function(a){return this.findOrCreateMetric(this.makeName(arguments),ozpIwc.metricTypes.Histogram)},ozpIwc.MetricsRegistry.prototype.timer=function(a){return this.findOrCreateMetric(this.makeName(arguments),ozpIwc.metricTypes.Timer)},ozpIwc.MetricsRegistry.prototype.register=function(a,b){return this.metrics[this.makeName(a)]=b,b},ozpIwc.MetricsRegistry.prototype.toJson=function(){var a={};for(var b in this.metrics){for(var c=b.split("."),d=a;c.length>1;){var e=c.shift();d=d[e]=d[e]||{}}d[c[0]]=this.metrics[b].get()}return a},ozpIwc.MetricsRegistry.prototype.allMetrics=function(){var a=[];for(var b in this.metrics)a.push(this.metrics[b]);return a},ozpIwc.metrics=new ozpIwc.MetricsRegistry,ozpIwc.util=ozpIwc.util||{},ozpIwc.util.ajax=function(a){return new Promise(function(b,c){var d=["PUT","POST","PATCH"],e=new XMLHttpRequest;e.open(a.method,a.href,!0),e.withCredentials=!0;var f=!0;Array.isArray(a.headers)&&a.headers.forEach(function(a){"Content-Type"===a.name&&(f=!1),e.setRequestHeader(a.name,a.value)}),d.indexOf(a.method)>=0&&f&&e.setRequestHeader("Content-Type","text/plain;charset=UTF-8"),e.onload=function(){if(2===Math.floor(this.status/100)){var a;try{a=JSON.parse(this.responseText)}catch(d){a=this.reponseText||this.responseXML}b({response:a,header:ozpIwc.util.ajaxResponseHeaderToJSON(this.getAllResponseHeaders())})}else c(this)},e.onerror=function(a){c(this)};try{"POST"===a.method||"PUT"===a.method?e.send(a.data):e.send()}catch(g){c(g)}})},ozpIwc.util.ajaxResponseHeaderToJSON=function(a){var b={};return a.split("\n").forEach(function(a){var c=a.split(":");2===c.length&&(b[c[0].trim()]=c[1].trim())}),b},ozpIwc.AjaxPersistenceQueue=function(a){a=a||{},this.poolSize=a.poolSize||1,this.syncPool=[];for(var b=0;b<this.poolSize;++b)this.syncPool.push(Promise.resolve());this.nextSlot=0,this.queuedSyncs={}},ozpIwc.AjaxPersistenceQueue.prototype.doSync=function(a,b){var c=b.getSelfUri();if(!c)return Promise.resolve();if(b.deleted)return ozpIwc.util.ajax({href:c,method:"DELETE"});var d=b.serializedEntity();return"string"!=typeof d&&(d=JSON.stringify(d)),ozpIwc.log.debug("PUT "+c,d),ozpIwc.util.ajax({href:c,method:"PUT",data:d,headers:[{name:"Content-Type",value:b.serializedContentType()}]}).then(function(a){ozpIwc.log.debug("  saving to "+c,a)},function(a){ozpIwc.log.error("  FAILED saving to "+c,a)})},ozpIwc.AjaxPersistenceQueue.prototype.queueNode=function(a,b){var c=this;return this.queuedSyncs[a]||(this.nextSlot=(this.nextSlot+1)%this.poolSize,this.syncPool[this.nextSlot]=this.queuedSyncs[a]=this.syncPool[this.nextSlot].then(function(){return delete c.queuedSyncs[a],c.doSync(a,b)})),this.queuedSyncs[a]},ozpIwc.AsyncAction=function(){this.callbacks={}},ozpIwc.AsyncAction.prototype.when=function(a,b,c){return c=c||this,this.resolution===a?b.apply(c,this.value):this.callbacks[a]=function(){return b.apply(c,arguments)},this},ozpIwc.AsyncAction.prototype.resolve=function(a){if(this.resolution)throw"Cannot resolve an already resolved AsyncAction";var b=this.callbacks[a];return this.resolution=a,this.value=Array.prototype.slice.call(arguments,1),b&&b.apply(this,this.value),this},ozpIwc.AsyncAction.prototype.success=function(a,b){return this.when("success",a,b)},ozpIwc.AsyncAction.prototype.failure=function(a,b){return this.when("failure",a,b)},ozpIwc.AsyncAction.all=function(a){var b=new ozpIwc.AsyncAction,c=a.length,d=this,e=[];return a.forEach(function(a,f){d.isAnAction(a)?a.success(function(a){e[f]=a,0===--c&&b.resolve("success",e)},d).failure(function(a){b.resolve("failure",a)},d):(e[f]=a,0===--c&&b.resolve("success",e))}),b},ozpIwc.AsyncAction.isAnAction=function(a){return ozpIwc.AsyncAction.prototype.isPrototypeOf(a)},function(a,b){"use strict";function c(a){return o[n]=d.apply(b,a),n++}function d(a){var c=[].slice.call(arguments,1);return function(){"function"==typeof a?a.apply(b,c):new Function(""+a)()}}function e(a){if(p)setTimeout(d(e,a),0);else{var b=o[a];if(b){p=!0;try{b()}finally{f(a),p=!1}}}}function f(a){delete o[a]}function g(){m=function(){var a=c(arguments);return process.nextTick(d(e,a)),a}}function h(){if(a.postMessage&&!a.importScripts){var b=!0,c=a.onmessage;return a.onmessage=function(){b=!1},a.postMessage("","*"),a.onmessage=c,b}}function i(){var b="setImmediate$"+Math.random()+"$",d=function(c){c.source===a&&"string"==typeof c.data&&0===c.data.indexOf(b)&&e(+c.data.slice(b.length))};a.addEventListener?a.addEventListener("message",d,!1):a.attachEvent("onmessage",d),m=function(){var d=c(arguments);return a.postMessage(b+d,"*"),d}}function j(){var a=new MessageChannel;a.port1.onmessage=function(a){var b=a.data;e(b)},m=function(){var b=c(arguments);return a.port2.postMessage(b),b}}function k(){var a=q.documentElement;m=function(){var b=c(arguments),d=q.createElement("script");return d.onreadystatechange=function(){e(b),d.onreadystatechange=null,a.removeChild(d),d=null},a.appendChild(d),b}}function l(){m=function(){var a=c(arguments);return setTimeout(d(e,a),0),a}}if(!a.setImmediate){var m,n=1,o={},p=!1,q=a.document,r=Object.getPrototypeOf&&Object.getPrototypeOf(a);r=r&&r.setTimeout?r:a,"[object process]"==={}.toString.call(a.process)?g():h()?i():a.MessageChannel?j():q&&"onreadystatechange"in q.createElement("script")?k():l(),r.setImmediate=m,r.clearImmediate=f}}(new Function("return this")()),ozpIwc.util=ozpIwc.util||{},ozpIwc.util.generateId=function(){return Math.floor(4294967295*Math.random()).toString(16)},ozpIwc.util.setImmediate=function(a){window.setImmediate(a)},ozpIwc.util.arrayContainsAll=function(a,b,c){return c=c||function(a,b){return a===b},b.every(function(b){return a.some(function(a){return c(a,b)})})},ozpIwc.util.objectContainsAll=function(a,b,c){c=c||function(a,b){return a===b};for(var d in b)if(!c(a[d],b[d]))return!1;return!0},ozpIwc.util.openWindow=function(a,b,c){if("object"==typeof b){var d="";for(var e in b)d+=e+"="+encodeURIComponent(b[e])+"&";b=d}try{window.open(a,b,c)}catch(f){window.open(a+"?"+b,null,c)}},function(){ozpIwc.BUS_ROOT=window.location.protocol+"//"+window.location.host+window.location.pathname.replace(/[^\/]+$/,""),ozpIwc.INTENT_CHOOSER_FEATURES="width=330,height=500"}(),ozpIwc.util.alert=function(a,b){this.alerts=this.alerts||{},this.alerts[a]?this.alerts[a].error=b:this.alerts[a]={error:b,silence:!1},this.alerts[a].silence||(this.alerts[a].silence=!0,ozpIwc.log.log(a,b))},ozpIwc.util.ensureArray=function(a){return Array.isArray(a)?a:[a]},ozpIwc=ozpIwc||{},ozpIwc.policyAuth=ozpIwc.policyAuth||{},ozpIwc.policyAuth.SecurityAttribute=function(a){a=a||{},this.attributes=a.attributes||{},this.comparator=a.comparator||this.comparator},ozpIwc.policyAuth.SecurityAttribute.prototype.pushIfNotExist=function(a,b,c){if(c=c||this.comparator,b){var d=ozpIwc.util.ensureArray(b);if(this.attributes[a])for(var e in d){var f=!0;for(var g in this.attributes[a])if(c(this.attributes[a][g],d[e])){f=!1;break}f&&this.attributes[a].push(d[e])}else this.attributes[a]=[],this.attributes[a]=this.attributes[a].concat(d)}},ozpIwc.policyAuth.SecurityAttribute.prototype.clear=function(a){delete this.attributes[a]},ozpIwc.policyAuth.SecurityAttribute.prototype.clearAll=function(){this.attributes={}},ozpIwc.policyAuth.SecurityAttribute.prototype.getAll=function(){return this.attributes},ozpIwc.policyAuth.SecurityAttribute.prototype.comparator=function(a,b){return a===b},ozpIwc=ozpIwc||{},ozpIwc.policyAuth=ozpIwc.policyAuth||{},ozpIwc.policyAuth.PDP=function(a){a=a||{},this.prp=a.prp||new ozpIwc.policyAuth.PRP,this.pip=a.pip||new ozpIwc.policyAuth.PIP,this.policySets=a.policySets||{connectSet:["policy://ozpIwc/connect"],apiSet:["policy://policy/apiNode"],readSet:["policy://policy/read"],receiveAsSet:["policy://policy/receiveAs"],sendAsSet:["policy://policy/sendAs"]}},ozpIwc.policyAuth.PDP.prototype.isPermitted=function(a){var b=new ozpIwc.AsyncAction,c=this;if(!a)return b.resolve("success",{result:"Permit"});var d=function(a){b.resolve("failure",a)};return this.formatRequest(a).success(function(e){c.prp.getPolicies(e.policies).success(function(c){var f=ozpIwc.policyAuth.PolicyCombining[e.combiningAlgorithm](c,e.category),g={result:f,request:a,formattedRequest:e};"Permit"===f?b.resolve("success",g):d(g)}).failure(d)}).failure(d),b},ozpIwc.policyAuth.PDP.prototype.formatAttributes=function(a,b){a=ozpIwc.util.ensureArray(a);var c=new ozpIwc.AsyncAction;b=b||this.pip;var d=[];for(var e in a)d.push(this.formatAttribute(a[e],b));return ozpIwc.AsyncAction.all(d).success(function(a){var b={};for(var d in a)if(Object.keys(a[d]).length>0)for(var e in a[d])b[e]=a[d][e];c.resolve("success",b)}),c},ozpIwc.policyAuth.PDP.prototype.formatAttribute=function(a,b){var c=new ozpIwc.AsyncAction;if(b=b||this.pip,!a)return c.resolve("success");if(a)if("string"==typeof a)b.getAttributes(a).success(function(a){c.resolve("success",a)});else{if(Array.isArray(a))return this.formatAttributes(a,b);if("object"==typeof a){var d=Object.keys(a);for(var e in d){var f=a[d[e]];["string","number","boolean"].indexOf(typeof a[d[e]])>=0&&(a[d[e]]=[f]),a[d[e]]=a[d[e]]||[]}c.resolve("success",a)}}else c.resolve("success",{});return c},ozpIwc.policyAuth.PDP.prototype.formatAction=function(a){var b=[],c=function(a,b){var c;return a["ozp:iwc:action"]&&(c=a["ozp:iwc:action"]),Array.isArray(c)?d(c,b):void(["string","number","boolean"].indexOf(typeof c)>=0&&b.indexOf(c)<0&&b.push(c))},d=function(a,b){for(var e in a)"string"==typeof a[e]?b.indexOf(a[e])<0&&b.push(a[e]):Array.isArray(a[e])?d(a[e],b):"object"==typeof a[e]&&c(a[e],b)};return a&&("string"==typeof a?b.push(a):Array.isArray(a)?d(a,b):"object"==typeof a&&c(a,b)),{"ozp:iwc:action":b}},ozpIwc.policyAuth.PDP.prototype.formatRequest=function(a,b){var c=new ozpIwc.AsyncAction;b=b||this.pip,a=a||{},a.subject=a.subject||{},a.resource=a.resource||{},a.action=a.action||{},a.combiningAlgorithm=a.combiningAlgorithm||this.defaultCombiningAlgorithm;var d=[],e=this.formatAttribute(a.subject,b),f=this.formatAttribute(a.resource,b),g=this.formatAction(a.action);return d.push(e,f,g),ozpIwc.AsyncAction.all(d).success(function(b){var d=b[0],e=b[1],f=b[2];c.resolve("success",{category:{subject:d,resource:e,action:f},combiningAlgorithm:a.combiningAlgorithm,policies:a.policies})}).failure(function(a){c.resolve("failure",a)}),c},ozpIwc.policyAuth.PDP.prototype.defaultCombiningAlgorithm="deny-overrides",ozpIwc.policyAuth.PDP.prototype.formatCategory=function(a,b){var c=new ozpIwc.AsyncAction;return a?(b=b||this.pip,this.formatAttribute(a,b).success(function(a){for(var b in a["ozp:iwc:permissions"])a[b]=a["ozp:iwc:permissions"][b];delete a["ozp:iwc:permissions"],c.resolve("success",a)}).failure(function(a){c.resolve("failure",a)}),c):c.resolve("success")},ozpIwc.policyAuth.PDP.prototype.formatCategories=function(a,b){
var c=new ozpIwc.AsyncAction;b=b||this.pip;var d=[],e={};for(var f in a)d.push(this.formatCategory(a[f],b)),e[f]=d.length-1;return ozpIwc.AsyncAction.all(d).success(function(a){var b={},d=Object.keys(e);for(var f in d)b[d[f]]=a[e[d[f]]]||{};c.resolve("success",b)}).failure(function(a){c.resolve("failure",a)}),c},ozpIwc=ozpIwc||{},ozpIwc.policyAuth=ozpIwc.policyAuth||{},ozpIwc.policyAuth.PIP=ozpIwc.util.extend(ozpIwc.policyAuth.SecurityAttribute,function(a){ozpIwc.policyAuth.SecurityAttribute.apply(this,arguments)}),ozpIwc.policyAuth.PIP.prototype.getAttributes=function(a){var b=new ozpIwc.AsyncAction,c=this;return this.attributes[a]?b.resolve("success",c.attributes[a]):(ozpIwc.util.ajax({href:a,method:"GET"}).then(function(d){if("object"!=typeof d)return b.resolve("failure","Invalid data loaded from the remote PIP");c.attributes[a]={};for(var e in d)c.attributes[a][e]=ozpIwc.util.ensureArray(d[e]);b.resolve("success",c.attributes[a])})["catch"](function(a){b.resolve("failure",a)}),b)},ozpIwc.policyAuth.PIP.prototype.grantAttributes=function(a,b){var c={};for(var d in b)c[d]=ozpIwc.util.ensureArray(b[d]);this.attributes[a]=c},ozpIwc.policyAuth.PIP.prototype.grantParent=function(a,b){var c=new ozpIwc.AsyncAction;this.attributes[a]=this.attributes[a]||{};var d=this;if(d.attributes[b]){for(var e in d.attributes[b]){d.attributes[a][e]=d.attributes[a][e]||[];for(var f in d.attributes[b][e])d.attributes[a][e].indexOf(d.attributes[b][e][f])<0&&d.attributes[a][e].push(d.attributes[b][e][f])}return c.resolve("success",d.attributes[a])}return d.getAttributes(b).success(function(b){for(var e in b)d.attributes[a].indexOf(b[e])<0&&d.attributes[a].push(b[e]);c.resolve("success",d.attributes[a])}).failure(function(a){c.resolve("failure",a)}),c},ozpIwc.policyAuth.PIP.prototype.combineAttributeValues=function(a,b,c){return[b,c]},ozpIwc.policyAuth.PIP.prototype.attributeUnion=function(a,b){var c={};return ozpIwc.object.eachEntry(a,function(a,b){Array.isArray(b)?c[a]=b.slice():c[a]=b}),ozpIwc.object.eachEntry(b,function(a,b){a in c?Array.isArray(c[a])?c[a]=c[a].concat(b):c[a]=this.combineAttributeValues(c[a],b):c[a]=b},this),c},ozpIwc.ozpIwcPolicies={},ozpIwc.ozpIwcPolicies.permitWhenObjectHasNoAttributes=function(a){return a.object&&0===Object.keys(a.object).length?"Permit":"Undetermined"},ozpIwc.ozpIwcPolicies.subjectHasAllObjectAttributes=function(a){if(!a.object)return"Permit";var b=a.subject||{};return ozpIwc.util.objectContainsAll(b,a.object,this.implies)?"Permit":"Deny"},ozpIwc.ozpIwcPolicies.permitAll=function(){return"Permit"},ozpIwc.ozpIwcPolicies.denyAll=function(){return"Deny"},ozpIwc.ozpIwcPolicies.implies=function(a,b){return void 0===b||null===b?!0:void 0===a||null===a?!1:(a=ozpIwc.util.ensureArray(a),b=ozpIwc.util.ensureArray(b),ozpIwc.util.arrayContainsAll(a,b))},ozpIwc.ozpIwcPolicies.defaultPolicy=function(a,b){return b=ozpIwc.util.ensureArray(b),ozpIwc.util.arrayContainsAll(b,a.action["ozp:iwc:action"])?ozpIwc.util.objectContainsAll(a.subject,a.resource,ozpIwc.ozpIwcPolicies.implies)?"Permit":"Deny":"NotApplicable"},ozpIwc.ozpIwcPolicies.defaultPolicies={},ozpIwc.ozpIwcPolicies.defaultPolicies["policy://ozpIwc/connect"]=function(a){var b=["connect"];return ozpIwc.util.arrayContainsAll(b,a.action["ozp:iwc:action"])?"Permit":"NotApplicable"},ozpIwc.ozpIwcPolicies.defaultPolicies["policy://policy/sendAs"]=function(a){return ozpIwc.ozpIwcPolicies.defaultPolicy(a,"sendAs")},ozpIwc.ozpIwcPolicies.defaultPolicies["policy://policy/receiveAs"]=function(a){return ozpIwc.ozpIwcPolicies.defaultPolicy(a,"receiveAs")},ozpIwc.ozpIwcPolicies.defaultPolicies["policy://policy/read"]=function(a){return ozpIwc.ozpIwcPolicies.defaultPolicy(a,"read")},ozpIwc.ozpIwcPolicies.defaultPolicies["policy://policy/apiNode"]=function(a){return ozpIwc.ozpIwcPolicies.defaultPolicy(a,"access")},ozpIwc=ozpIwc||{},ozpIwc.policyAuth=ozpIwc.policyAuth||{},ozpIwc.policyAuth.PolicyCombining=ozpIwc.policyAuth.PolicyCombining||{},ozpIwc.policyAuth.PolicyCombining["deny-overrides"]=function(a,b){var c,d,e,f=!1;for(var g in a){var h=a[g](b);switch(h){case"Deny":return"Deny";case"Permit":f=!0;break;case"NotApplicable":continue;case"Indeterminate{D}":c=!0;break;case"Indeterminate{P}":d=!0;break;case"Indeterminate{DP}":e=!0;break;default:continue}}return e?"Indeterminate{DP}":c&&(d||f)?"Indeterminate{DP}":c?"Indeterminate{D}":f?"Permit":d?"Indeterminate{P}":"NotApplicable"},ozpIwc.policyAuth.PolicyCombining["permit-overrides"]=function(){},ozpIwc.policyAuth.PolicyCombining["first-applicable"]=function(){},ozpIwc.policyAuth.PolicyCombining["only-one-applicable"]=function(){},ozpIwc.policyAuth.PolicyCombining["ordered-deny-overrides"]=function(){},ozpIwc.policyAuth.PolicyCombining["ordered-permit-overrides"]=function(){},ozpIwc.policyAuth.PolicyCombining["deny-unless-permit"]=function(){},ozpIwc.policyAuth.PolicyCombining["permit-unless-deny"]=function(){},ozpIwc=ozpIwc||{},ozpIwc.policyAuth=ozpIwc.policyAuth||{},ozpIwc.policyAuth.PRP=function(a){a=a||{},this.persistentPolicies=a.persistentPolicies||[],this.policyCache=a.policyCache||ozpIwc.ozpIwcPolicies.defaultPolicies},ozpIwc.policyAuth.PRP.prototype.getPolicies=function(a){var b=new ozpIwc.AsyncAction;a=a||[],a=ozpIwc.util.ensureArray(a);var c=[],d=this.persistentPolicies.concat(a);for(var e in d)if(this.policyCache[d[e]])c.push(ozpIwc.util.clone(this.policyCache[d[e]]));else{var f=this.fetchPolicy(d[e]);c.push(f)}return 0===c.length?b.resolve("success",[ozpIwc.ozpIwcPolicies.permitAll]):ozpIwc.AsyncAction.all(c)},ozpIwc.policyAuth.PRP.prototype.defaultCombiningAlgorithm="urn:oasis:names:tc:xacml:3.0:rule-combining-algorithm:deny-overrides",ozpIwc.policyAuth.PRP.prototype.fetchPolicy=function(a){var b=new ozpIwc.AsyncAction,c=this;return ozpIwc.util.ajax({method:"GET",href:a}).then(function(d){c.policyCache[a]=c.formatPolicy(d.response),b.resolve("success",ozpIwc.util.clone(c.policyCache[a]))})["catch"](function(d){b.resolve("success",c.getDenyall(a))}),b},ozpIwc.policyAuth.PRP.prototype.formatPolicy=function(a){return new ozpIwc.policyAuth.Policy(a)},ozpIwc.policyAuth.PRP.prototype.getDenyall=function(a){return this.policyCache[a]?this.policyCache[a]:(this.policyCache[a]=ozpIwc.ozpIwcPolicies.denyAll,this.policyCache[a])},ozpIwc.KeyBroadcastLocalStorageLink=function(a){a=a||{},this.prefix=a.prefix||"ozpIwc",this.peer=a.peer||ozpIwc.defaultPeer,this.selfId=a.selfId||this.peer.selfId,this.metricsPrefix="keyBroadcastLocalStorageLink."+this.selfId,this.droppedFragmentsCounter=ozpIwc.metrics.counter(this.metricsPrefix,"fragmentsDropped"),this.fragmentsReceivedCounter=ozpIwc.metrics.counter(this.metricsPrefix,"fragmentsReceived"),this.packetsSentCounter=ozpIwc.metrics.counter(this.metricsPrefix,"packetsSent"),this.packetsReceivedCounter=ozpIwc.metrics.counter(this.metricsPrefix,"packetsReceived"),this.packetParseErrorCounter=ozpIwc.metrics.counter(this.metricsPrefix,"packetsParseError"),this.packetsFailedCounter=ozpIwc.metrics.counter(this.metricsPrefix,"packetsFailed"),this.latencyInTimer=ozpIwc.metrics.timer(this.metricsPrefix,"latencyIn"),this.latencyOutTimer=ozpIwc.metrics.timer(this.metricsPrefix,"latencyOut"),this.myKeysTimeout=a.myKeysTimeout||5e3,this.otherKeysTimeout=a.otherKeysTimeout||12e4,this.maxRetries=a.maxRetries||6,this.queueSize=a.queueSize||1024,this.sendQueue=this.sendQueue||[],this.fragments=this.fragments||[],this.fragmentSize=a.fragmentSize||1310720,this.fragmentTimeout=a.fragmentTimeout||1e3,String.prototype.chunk=function(a){for(var b=[],c=0;c<this.length;c+=a)b.push(this.slice(c,c+a));return b};var b,c=this,d=function(a){if(a.newValue){try{b=JSON.parse(a.newValue)}catch(d){return ozpIwc.log.log("Parse error on "+a.newValue),void c.packetParseErrorCounter.inc()}b.data.fragment?c.handleFragment(b):c.forwardToPeer(b)}};ozpIwc.util.getInternetExplorerVersion()>=0?window.setTimeout(function(){ozpIwc.util.addEventListener("storage",d)},500):ozpIwc.util.addEventListener("storage",d),this.peer.on("send",function(a){c.send(a.packet)}),this.peer.on("beforeShutdown",function(){ozpIwc.util.removeEventListener("storage",d)},this)},ozpIwc.KeyBroadcastLocalStorageLink.prototype.forwardToPeer=function(a){this.peer.receive(this.linkId,a),this.packetsReceivedCounter.inc(),a.data.time&&this.latencyInTimer.mark(ozpIwc.util.now()-a.data.time)},ozpIwc.KeyBroadcastLocalStorageLink.prototype.handleFragment=function(a){if(!this.peer.haveSeen(a)){var b=a.data.msgId;this.storeFragment(a);var c=this.defragmentPacket(this.fragments[b]);if(c){window.clearTimeout(this.fragments[b].fragmentTimer);var d=this.peer.packetsSeen[c.srcPeer].indexOf(c.sequence);delete this.peer.packetsSeen[c.srcPeer][d],this.forwardToPeer(c),delete this.fragments[b]}}},ozpIwc.KeyBroadcastLocalStorageLink.prototype.storeFragment=function(a){if(!a.data.fragment)return null;var b=a.sequence,c=a.srcPeer,d=a.data.msgId,e=a.data.id,f=a.data.chunk,g=a.data.total;if(void 0===d||void 0===e)return null;if(!this.fragments[d]){this.fragments[d]={},this.fragments[d].chunks=[];var h=this;h.key=d,h.total=g,this.fragments[d].timeoutFunc=function(){h.droppedFragmentsCounter.inc(h.total),delete h.fragments[h.key]}}return window.clearTimeout(this.fragments[d].fragmentTimer),this.fragments[d].fragmentTimer=window.setTimeout(this.fragments[d].timeoutFunc,this.fragmentTimeout),this.fragments[d].total=g||this.fragments[d].total,this.fragments[d].sequence=void 0!==b?b:this.fragments[d].sequence,this.fragments[d].srcPeer=c||this.fragments[d].srcPeer,this.fragments[d].chunks[e]=f,void 0===this.fragments[d].total||void 0===this.fragments[d].sequence||void 0===this.fragments[d].srcPeer?null:(this.fragmentsReceivedCounter.inc(),!0)},ozpIwc.KeyBroadcastLocalStorageLink.prototype.defragmentPacket=function(a){if(a.total!==a.chunks.length)return null;try{var b=JSON.parse(a.chunks.join(""));return{defragmented:!0,sequence:a.sequence,srcPeer:a.srcPeer,data:b}}catch(c){return null}},ozpIwc.KeyBroadcastLocalStorageLink.prototype.send=function(a){var b;try{b=JSON.stringify(a.data)}catch(c){this.packetsFailedCounter.inc();var d=a.msgId||"unknown";return void ozpIwc.log.error("Failed to write packet(msgId="+d+"):"+c.message)}if(b.length<this.fragmentSize)this.queueSend(a);else{var e=b.chunk(this.fragmentSize),f=this;f.data=a.data,delete a.data;for(var g=function(a,b){return b.sequence=f.peer.sequenceCounter++,b.data={fragment:!0,msgId:f.data.msgId,id:h,total:e.length,chunk:a},b},h=0;h<e.length;h++)this.queueSend(g(e[h],a))}},ozpIwc.KeyBroadcastLocalStorageLink.prototype.queueSend=function(a){if(this.sendQueue.length<this.queueSize)for(this.sendQueue=this.sendQueue.concat(a);this.sendQueue.length>0;)this.attemptSend(this.sendQueue.shift());else this.packetsFailedCounter.inc(),ozpIwc.log.error("Failed to write packet(len="+a.length+"): Send queue full.")},ozpIwc.KeyBroadcastLocalStorageLink.prototype.attemptSend=function(a,b){var c=this.sendImpl(a);if(c){var d=this;b=b||0;var e=Math.max(1,Math.pow(2,b-1))-1;if(!(b<d.maxRetries))return this.packetsFailedCounter.inc(),ozpIwc.log.error("Failed to write packet(len="+a.length+"):"+c),c;b++,window.setTimeout(function(){d.attemptSend(a,b)},e)}},ozpIwc.KeyBroadcastLocalStorageLink.prototype.sendImpl=function(a){var b;try{var c=JSON.stringify(a);localStorage.setItem("x",c),this.packetsSentCounter.inc(),a.data.time&&this.latencyOutTimer.mark(ozpIwc.util.now()-a.data.time),localStorage.removeItem("x"),b=null}catch(d){"localStorage is null"===d.message?ozpIwc.util.alert("Cannot locate localStorage. Contact your system administrator.",d):18===d.code?ozpIwc.util.alert("Ozone requires your browser to accept cookies. Contact your system administrator.",d):b=d}finally{return b}},ozpIwc.Peer=function(){this.selfId=ozpIwc.util.generateId(),this.metricPrefix="peer."+this.selfId,this.sequenceCounter=0,this.packetsSeen={},this.knownPeers={},this.events=new ozpIwc.Event,this.events.mixinOnOff(this);var a=this;this.unloadListener=function(){a.shutdown()},ozpIwc.util.addEventListener("beforeunload",this.unloadListener)},ozpIwc.Peer.maxSeqIdPerSource=500,ozpIwc.Peer.prototype.haveSeen=function(a){if(a.srcPeer===this.selfId)return ozpIwc.metrics.counter(this.metricPrefix,"droppedOwnPacket").inc(),!0;var b=this.packetsSeen[a.srcPeer];return b||(b=this.packetsSeen[a.srcPeer]=[]),b.indexOf(a.sequence)>=0?!0:(b.unshift(a.sequence),b.length>=ozpIwc.Peer.maxSeqIdPerSource&&(b.length=ozpIwc.Peer.maxSeqIdPerSource),!1)},ozpIwc.Peer.prototype.send=function(a){var b={srcPeer:this.selfId,sequence:this.sequenceCounter++,data:a},c=new ozpIwc.CancelableEvent({packet:b});this.events.trigger("preSend",c),c.canceled?ozpIwc.metrics.counter(this.metricPrefix,"sendRejected").inc():(ozpIwc.metrics.counter(this.metricPrefix,"sent").inc(),a.time&&ozpIwc.metrics.timer(this.metricPrefix,"latencyOut").mark(ozpIwc.util.now()-a.time),this.events.trigger("send",{packet:b}))},ozpIwc.Peer.prototype.receive=function(a,b){return this.haveSeen(b)?void ozpIwc.metrics.counter(this.metricPrefix,"dropped").inc():(ozpIwc.metrics.counter(this.metricPrefix,"received").inc(),b.data.time&&ozpIwc.metrics.timer(this.metricPrefix,"latencyIn").mark(ozpIwc.util.now()-b.data.time),void this.events.trigger("receive",{packet:b,linkId:a}))},ozpIwc.Peer.prototype.shutdown=function(){this.events.trigger("beforeShutdown"),ozpIwc.util.removeEventListener("beforeunload",this.unloadListener)},ozpIwc.Participant=function(){this.events=new ozpIwc.Event,this.events.mixinOnOff(this),this.permissions=new ozpIwc.policyAuth.SecurityAttribute,this.msgId=0,this.sentPacketsMeter=new ozpIwc.metricTypes.Meter,this.receivedPacketsMeter=new ozpIwc.metricTypes.Meter,this.forbiddenPacketsMeter=new ozpIwc.metricTypes.Meter,this.latencyInTimer=new ozpIwc.metricTypes.Meter,this.latencyOutTimer=new ozpIwc.metricTypes.Meter,this.participantType=this.constructor.name,this.heartBeatContentType="application/vnd.ozp-iwc-address-v1+json",this.heartBeatStatus={name:this.name,type:this.participantType||this.constructor.name},this.replyCallbacks={};var a=this;ozpIwc.util.addEventListener("beforeunload",function(){a.send=function(b,c){var d=this.fixPacket(b);return c&&(a.replyCallbacks[d.msgId]=c),ozpIwc.Participant.prototype.send.call(a,d),d},a.leaveEventChannel()})},ozpIwc.Participant.prototype.receiveFromRouter=function(a){var b=this,c={subject:this.permissions.getAll(),resource:{"ozp:iwc:receiveAs":a.packet.dst},action:{"ozp:iwc:action":"receiveAs"},policies:ozpIwc.authorization.policySets.receiveAsSet},d=function(a){b.forbiddenPacketsMeter.mark(),ozpIwc.metrics.counter("transport.packets.forbidden").inc(),console.error("failure",a)};ozpIwc.authorization.isPermitted(c,this).success(function(){ozpIwc.authorization.formatCategory(a.packet.permissions).success(function(c){var e={subject:b.permissions.getAll(),resource:c||{},action:{"ozp:iwc:action":"read"},policies:ozpIwc.authorization.policySets.readSet};ozpIwc.authorization.isPermitted(e,b).success(function(c){b.receivedPacketsMeter.mark(),a.packet.time&&b.latencyInTimer.mark(ozpIwc.util.now()-a.packet.time),b.receiveFromRouterImpl(a)}).failure(d)}).failure(d)}).failure(d)},ozpIwc.Participant.prototype.receiveFromRouterImpl=function(a){return!a},ozpIwc.Participant.prototype.connectToRouter=function(a,b){this.address=b,this.router=a,this.msgId=0,this.name?this.metricRoot="participants."+this.name+"."+this.address.split(".").reverse().join("."):this.metricRoot="participants."+this.address.split(".").reverse().join("."),this.sentPacketsMeter=ozpIwc.metrics.meter(this.metricRoot,"sentPackets").unit("packets"),this.receivedPacketsMeter=ozpIwc.metrics.meter(this.metricRoot,"receivedPackets").unit("packets"),this.forbiddenPacketsMeter=ozpIwc.metrics.meter(this.metricRoot,"forbiddenPackets").unit("packets"),this.latencyInTimer=ozpIwc.metrics.timer(this.metricRoot,"latencyIn").unit("packets"),this.latencyOutTimer=ozpIwc.metrics.timer(this.metricRoot,"latencyOut").unit("packets"),this.namesResource="/address/"+this.address,this.heartBeatStatus.address=this.address,this.heartBeatStatus.name=this.name,this.heartBeatStatus.type=this.participantType||this.constructor.name,this.events.trigger("connectedToRouter"),this.joinEventChannel()},ozpIwc.Participant.prototype.fixPacket=function(a){return a.src=a.src||this.address,a.ver=a.ver||1,a.msgId=a.msgId||this.generateMsgId(),a.time=a.time||ozpIwc.util.now(),a},ozpIwc.Participant.prototype.send=function(a){var b=this,c={subject:this.permissions.getAll(),resource:{"ozp:iwc:sendAs":a.src},action:{"ozp:iwc:action":"sendAs"},policies:ozpIwc.authorization.policySets.sendAsSet};return a=b.fixPacket(a),ozpIwc.authorization.isPermitted(c,b).success(function(c){b.sentPacketsMeter.mark(),a.time&&b.latencyOutTimer.mark(ozpIwc.util.now()-a.time),b.router.send(a,b)}).failure(function(c){console.error("Participant "+b.address+" failed to send a packet:",c,a)}),a},ozpIwc.Participant.prototype.generateMsgId=function(){return"i:"+this.msgId++},ozpIwc.Participant.prototype.heartbeat=function(){if(this.router){var a=this.heartBeatStatus;return a.time=ozpIwc.util.now(),this.fixPacket({dst:"names.api",resource:this.namesResource,action:"set",entity:a,contentType:this.heartBeatContentType,respondOn:"none"})}},ozpIwc.Participant.prototype.joinEventChannel=function(){return this.router?(this.router.registerMulticast(this,["$bus.multicast"]),this.send({dst:"$bus.multicast",action:"connect",entity:{address:this.address,participantType:this.participantType}}),!0):!1},ozpIwc.Participant.prototype.leaveEventChannel=function(){return this.router?(this.send({dst:"$bus.multicast",action:"disconnect",entity:{address:this.address,participantType:this.participantType,namesResource:this.namesResource}}),!0):!1},ozpIwc.InternalParticipant=ozpIwc.util.extend(ozpIwc.Participant,function(a){a=a||{},ozpIwc.Participant.apply(this,arguments),this.replyCallbacks={},this.participantType="internal",this.name=a.name;var b=this;this.on("connectedToRouter",function(){b.permissions.pushIfNotExist("ozp:iwc:address",b.address),b.permissions.pushIfNotExist("ozp:iwc:sendAs",b.address),b.permissions.pushIfNotExist("ozp:iwc:receiveAs",b.address),ozpIwc.metrics.gauge(b.metricRoot,"registeredCallbacks").set(function(){return b.getCallbackCount()})})}),ozpIwc.InternalParticipant.prototype.getCallbackCount=function(){return this.replyCallbacks&&Object.keys(this.replyCallbacks)?Object.keys(this.replyCallbacks).length:0},ozpIwc.InternalParticipant.prototype.receiveFromRouterImpl=function(a){var b=a.packet;if(b.replyTo&&this.replyCallbacks[b.replyTo]){var c=!1,d=function(){c=!0};this.replyCallbacks[b.replyTo](b,d),c&&this.cancelCallback(b.replyTo)}else this.events.trigger("receive",a)},ozpIwc.InternalParticipant.prototype.send=function(a,b){var c=this.fixPacket(a);b&&(this.replyCallbacks[c.msgId]=b);var d=this,e=ozpIwc.Participant.prototype.send;return ozpIwc.util.setImmediate(function(){e.call(d,c)}),c},ozpIwc.InternalParticipant.prototype.cancelCallback=function(a){var b=!1;return a&&(delete this.replyCallbacks[a],b=!0),b},ozpIwc.TransportPacketContext=function(a){for(var b in a)this[b]=a[b]},ozpIwc.TransportPacketContext.prototype.makeReplyTo=function(a){var b=(new Date).getTime();return a.ver=a.ver||1,a.time=a.time||b,a.replyTo=a.replyTo||this.packet.msgId,a.src=a.src||this.packet.dst,a.dst=a.dst||this.packet.src,a},ozpIwc.TransportPacketContext.prototype.replyTo=function(a){return this.shouldReply(a)?(a=this.makeReplyTo(a),this.dstParticipant?this.dstParticipant.send(a):(a.msgId=a.msgId||ozpIwc.util.now(),this.router.send(a)),a):void 0},ozpIwc.TransportPacketContext.prototype.shouldReply=function(a){switch(this.packet=this.packet||{},this.packet.respondOn=this.packet.respondOn||"all",this.packet.respondOn){case"none":return!1;case"error":return/(bad|no).*/.test(a.response);default:return!0}},ozpIwc.Router=function(a){a=a||{},this.peer=a.peer||ozpIwc.defaultPeer;var b=this;this.selfId=ozpIwc.util.generateId(),this.participants={},ozpIwc.metrics.gauge("transport.participants").set(function(){return Object.keys(b.participants).length}),this.events=new ozpIwc.Event,this.events.mixinOnOff(this),this.peer.on("receive",function(a){b.receiveFromPeer(a.packet)});var c=function(a){var b=a.packet;1!==b.ver&&a.cancel("badVersion"),b.src||a.cancel("nullSource"),b.dst||a.cancel("nullDestination"),a.canceled&&ozpIwc.metrics.counter("transport.packets.invalidFormat").inc()};this.events.on("preSend",c),a.disableBus||(this.participants["$bus.multicast"]=new ozpIwc.MulticastParticipant("$bus.multicast")),this.watchdog=new ozpIwc.RouterWatchdog({router:this,heartbeatFrequency:a.heartbeatFrequency,autoConnect:!1}),this.registerParticipant(this.watchdog),this.recursionDepth=0,ozpIwc.metrics.gauge("transport.router.participants").set(function(){return b.getParticipantCount()})},ozpIwc.Router.prototype.getParticipantCount=function(){return this.participants&&Object.keys(this.participants)?Object.keys(this.participants).length:0},ozpIwc.Router.prototype.shutdown=function(){this.watchdog.shutdown()},ozpIwc.Router.prototype.registerParticipant=function(a,b){b=b||{};var c;do c=ozpIwc.util.generateId()+"."+this.selfId;while(this.participants.hasOwnProperty(c));var d=new ozpIwc.CancelableEvent({packet:b,registration:b.entity,participant:a});if(this.events.trigger("preRegisterParticipant",d),d.canceled)return ozpIwc.log.log("registeredParticipant[DENIED] origin:"+a.origin+" because "+d.cancelReason),null;this.participants[c]=a,a.connectToRouter(this,c),this.send(a.heartbeat(),a);var e=new ozpIwc.CancelableEvent({packet:b,participant:a});return this.events.trigger("registeredParticipant",e),c},ozpIwc.Router.prototype.deliverLocal=function(a,b){if(!a)throw"Cannot deliver a null packet!";var c=this.participants[a.dst];if(c){this.recursionDepth++,this.recursionDepth>10&&console.log("Recursing more than 10 levels deep on ",a);try{var d=new ozpIwc.TransportPacketContext({packet:a,router:this,srcParticipant:b,dstParticipant:c}),e=new ozpIwc.CancelableEvent({packet:a,dstParticipant:c,srcParticipant:b});if(this.events.trigger("preDeliver",e).canceled)return void ozpIwc.metrics.counter("transport.packets.rejected").inc();ozpIwc.metrics.counter("transport.packets.delivered").inc(),c.receiveFromRouter(d)}finally{this.recursionDepth--}}},ozpIwc.Router.prototype.registerMulticast=function(a,b){var c=this;return b.forEach(function(b){var d=c.participants[b];if(d||(d=c.participants[b]=new ozpIwc.MulticastParticipant(b)),d.addMember(a),a.address){var e=new ozpIwc.CancelableEvent({entity:{group:b,address:a.address}});a.permissions.pushIfNotExist("ozp:iwc:sendAs",b),a.permissions.pushIfNotExist("ozp:iwc:receiveAs",b),c.events.trigger("registeredMulticast",e)}else ozpIwc.log.log("no address for "+a.participantType+" "+a.name+"with address "+a.address+" for group "+b)}),b},ozpIwc.Router.prototype.send=function(a,b){var c=new ozpIwc.CancelableEvent({packet:a,participant:b});return this.events.trigger("preSend",c),c.canceled?void ozpIwc.metrics.counter("transport.packets.sendCanceled"):(ozpIwc.metrics.counter("transport.packets.sent").inc(),this.deliverLocal(a,b),this.events.trigger("send",{packet:a}),void this.peer.send(a))},ozpIwc.Router.prototype.receiveFromPeer=function(a){ozpIwc.metrics.counter("transport.packets.receivedFromPeer").inc();var b=Date.now();ozpIwc.metrics.histogram("transport.packets.latency").mark(b-a.data.time,b);var c=new ozpIwc.CancelableEvent({packet:a.data,rawPacket:a});this.events.trigger("prePeerReceive",c),c.canceled||this.deliverLocal(a.data)},ozpIwc.ClientParticipant=ozpIwc.util.extend(ozpIwc.Participant,function(a){a=a||{},ozpIwc.Participant.apply(this,arguments),this.participantType="internalClient",this.internal=a.internal||!1,this.name=a.name,this.router=a.router||ozpIwc.defaultRouter;var b=this;this.on("connectedToRouter",function(){b.permissions.pushIfNotExist("ozp:iwc:address",b.address),b.permissions.pushIfNotExist("ozp:iwc:sendAs",b.address),b.permissions.pushIfNotExist("ozp:iwc:receiveAs",b.address),ozpIwc.metrics.gauge(b.metricRoot,"registeredCallbacks").set(function(){return b.replyCallbacks&&Object.keys(b.replyCallbacks)?Object.keys(b.replyCallbacks).length:0})}),ozpIwc.ApiPromiseMixin(this,a.autoConnect)}),ozpIwc.ClientParticipant.prototype.connect=function(){if(!this.connectPromise){var a=this;this.connectPromise=new Promise(function(b,c){b(a.router.registerParticipant(a))}).then(function(b){return a.afterConnected(b)})}return this.connectPromise},ozpIwc.ClientParticipant.prototype.sendImpl=ozpIwc.Participant.prototype.send,ozpIwc.consensus=ozpIwc.consensus||{},ozpIwc.consensus.BaseConsensus=function(a){a=a||{};var b=this;if(!a.name)throw"Consensus module expects a name.";this.name=a.name,this.participant=a.participant||new ozpIwc.ClientParticipant(a),this.consensusAddress=a.consensusAddress||this.name+".consensus",this.router=a.router||ozpIwc.defaultRouter,this.events=new ozpIwc.Event,this.events.mixinOnOff(this),this.state="unknown",this.participant.on("connectedToRouter",function(){b.participant.permissions.pushIfNotExist("ozp:iwc:address",[b.participant.address,b.consensusAddress]),b.participant.permissions.pushIfNotExist("ozp:iwc:sendAs",[b.participant.address,b.consensusAddress]),b.participant.permissions.pushIfNotExist("ozp:iwc:receiveAs",[b.participant.address,b.consensusAddress])}),this.router.registerMulticast(this.participant,[this.consensusAddress]),this.participant.on("receive",this.routePacket,this)},ozpIwc.consensus.BaseConsensus.prototype.routePacket=function(a){throw"routePacket is to be overridden by consensus implementation"},ozpIwc.consensus.BaseConsensus.prototype.onBecomeCoordinator=function(){throw"onBecomeCoordinator is to be overridden by consensus implementation"},ozpIwc.consensus.BaseConsensus.prototype.onBecomeMember=function(){throw"onBecomeMember is to be overridden by consensus implementation"},ozpIwc.consensus.BaseConsensus.prototype.changeState=function(a){this.state!==a&&(this.state=a,this.events.trigger("changedState",this.state))},ozpIwc.consensus=ozpIwc.consensus||{},ozpIwc.consensus.Bully=ozpIwc.util.extend(ozpIwc.consensus.BaseConsensus,function(a){ozpIwc.consensus.BaseConsensus.apply(this,arguments),this.consensusId=a.consensusId||-ozpIwc.util.now(),this.coordinatorTimeoutHeartbeat=a.heartbeat||ozpIwc.ELECTION_TIMEOUT,this.coordinatorIntervalHeartbeat=this.coordinatorTimeoutHeartbeat/2,this.gatherLogs=a.gatherLogs||function(){},this.restartCoordinatorTimeout(1e3),this.sendQueryMessage()}),ozpIwc.consensus.Bully.prototype.routePacket=function(a){var b=a.packet||{};if(b.dst===this.consensusAddress&&b.src!==this.participant.address)switch(b.action){case"election":this.onElectionMessage(b);break;case"acknowledge":this.onAckMessage(b);break;case"victory":this.onVictoryMessage(b);break;case"query":this.onQueryMessage(b)}},ozpIwc.consensus.Bully.prototype.sendElectionMessage=function(){this.participant.send({dst:this.consensusAddress,action:"election",entity:{consensusId:this.consensusId}})},ozpIwc.consensus.Bully.prototype.sendAckMessage=function(a){this.participant.send({dst:this.consensusAddress,action:"acknowledge",entity:{consensusId:this.consensusId,replyTo:{consensusId:a}}})},ozpIwc.consensus.Bully.prototype.sendVictoryMessage=function(){var a=this.gatherLogs();this.participant.send({dst:this.consensusAddress,action:"victory",entity:{consensusId:this.consensusId,logs:a}})},ozpIwc.consensus.Bully.prototype.sendQueryMessage=function(){this.participant.send({dst:this.consensusAddress,action:"query",entity:{consensusId:this.consensusId}})},ozpIwc.consensus.Bully.prototype.onElectionMessage=function(a){var b=a.entity;if(!b.consensusId)throw"Non-formatted election message received.";var c=b.consensusId;return c>this.consensusId?(this.cancelElection(),window.clearTimeout(this.coordinatorTimeout),void window.clearInterval(this.coordinatorInterval)):(this.cancelElection(),void this.startElection())},ozpIwc.consensus.Bully.prototype.onAckMessage=function(a){var b=a.entity,c=b.replyTo||{};if(!c.consensusId)throw"Non-formatted acknowledge message received.";var d=c.consensusId;d===this.consensusId&&this.cancelElection()},ozpIwc.consensus.Bully.prototype.onVictoryMessage=function(a){var b=a.entity;if(!b.consensusId)throw"Non-formatted election message received.";var c=b.consensusId;return c>this.consensusId?(this.cancelElection(),b.logs&&this.events.trigger("receivedLogs",b.logs),void this.restartCoordinatorTimeout()):void this.startElection()},ozpIwc.consensus.Bully.prototype.onQueryMessage=function(a){var b=a.entity;if(!b.consensusId)throw"Non-formatted election message received.";return this.coordinatorInterval?void this.sendVictoryMessage():void 0},ozpIwc.consensus.Bully.prototype.restartCoordinatorTimeout=function(a){a=a||this.coordinatorTimeoutHeartbeat;var b=this;window.clearTimeout(this.coordinatorTimeout),this.changeState("member"),this.coordinatorTimeout=window.setTimeout(function(){b.onCoordinatorTimeout(a)},a)},ozpIwc.consensus.Bully.prototype.onCoordinatorTimeout=function(a){this.startElection(a)},ozpIwc.consensus.Bully.prototype.onBecomeCoordinator=function(){var a=this;window.clearInterval(this.coordinatorInterval),this.sendVictoryMessage(a.lastElection),this.changeState("coordinator"),this.coordinatorInterval=window.setInterval(function(){a.sendVictoryMessage(a.lastElection)},this.coordinatorIntervalHeartbeat)},ozpIwc.consensus.Bully.prototype.startElection=function(a){a=a||this.coordinatorTimeoutHeartbeat;var b=this;window.clearTimeout(this.electionTimeout),this.electionTimeout=window.setTimeout(function(){b.onBecomeCoordinator()},a),b.sendElectionMessage()},ozpIwc.consensus.Bully.prototype.cancelElection=function(){window.clearTimeout(this.electionTimeout)},ozpIwc.MulticastParticipant=ozpIwc.util.extend(ozpIwc.Participant,function(a){this.address=a,this.name=a,this.participantType="multicast",ozpIwc.Participant.apply(this,arguments),this.members=[],this.namesResource="/multicast/"+this.name,this.heartBeatContentType="application/vnd.ozp-iwc-multicast-address-v1+json",this.heartBeatStatus.members=[],this.on("connectedToRouter",function(){this.namesResource="/multicast/"+this.name},this),this.permissions.pushIfNotExist("ozp:iwc:address",a),this.permissions.pushIfNotExist("ozp:iwc:sendAs",a),this.permissions.pushIfNotExist("ozp:iwc:receiveAs",a)}),ozpIwc.MulticastParticipant.prototype.receiveFromRouterImpl=function(a){return this.receivedPacketsMeter.mark(),this.members.forEach(function(b){a.dstParticipant=b,b.receiveFromRouter(a)}),!1},ozpIwc.MulticastParticipant.prototype.addMember=function(a){this.members.push(a),this.heartBeatStatus.members.push(a.address)};var ozpIwc=ozpIwc||{};ozpIwc.PostMessageParticipant=ozpIwc.util.extend(ozpIwc.Participant,function(a){ozpIwc.Participant.apply(this,arguments),this.origin=this.name=a.origin,this.sourceWindow=a.sourceWindow,this.credentials=a.credentials,this.readyPromise=a.ready||Promise.resolve(),this.participantType="postMessageProxy",this.permissions.pushIfNotExist("ozp:iwc:origin",this.origin),this.on("connectedToRouter",function(){this.permissions.pushIfNotExist("ozp:iwc:address",this.address),this.permissions.pushIfNotExist("ozp:iwc:sendAs",this.address),this.permissions.pushIfNotExist("ozp:iwc:receiveAs",this.address)},this),this.heartBeatStatus.origin=this.origin}),ozpIwc.PostMessageParticipant.prototype.receiveFromRouterImpl=function(a){this.sendToRecipient(a.packet)},ozpIwc.PostMessageParticipant.prototype.sendToRecipient=function(a){ozpIwc.util.safePostMessage(this.sourceWindow,a,this.origin)},ozpIwc.PostMessageParticipant.prototype.handleTransportPacket=function(a){var b={ver:1,dst:this.address,src:"$transport",replyTo:a.msgId,msgId:this.generateMsgId(),entity:{address:this.address}},c=this;this.readyPromise.then(function(){c.sendToRecipient(b)})},ozpIwc.PostMessageParticipant.prototype.forwardFromPostMessage=function(a,b){return"object"!=typeof a?void ozpIwc.log.error("Unknown packet received: "+JSON.stringify(a)):b.origin!==this.origin?void ozpIwc.metrics.counter("transport."+this.address+".invalidSenderOrigin").inc():(a=this.fixPacket(a),
void("$transport"===a.dst?this.handleTransportPacket(a):this.router.send(a,this)))},ozpIwc.PostMessageParticipantListener=function(a){a=a||{},this.participants=[],this.router=a.router||ozpIwc.defaultRouter,this.readyPromise=a.ready||Promise.resolve();var b=this;ozpIwc.util.addEventListener("message",function(a){b.receiveFromPostMessage(a)}),ozpIwc.metrics.gauge("transport.postMessageListener.participants").set(function(){return b.getParticipantCount()})},ozpIwc.PostMessageParticipantListener.prototype.getParticipantCount=function(){return this.participants?this.participants.length:0},ozpIwc.PostMessageParticipantListener.prototype.findParticipant=function(a){for(var b=0;b<this.participants.length;++b)if(this.participants[b].sourceWindow===a)return this.participants[b]},ozpIwc.PostMessageParticipantListener.prototype.receiveFromPostMessage=function(a){var b=this.findParticipant(a.source),c=a.data;if(a.source!==window){if("string"==typeof a.data)try{c=JSON.parse(a.data)}catch(d){return}var e=function(c){ozpIwc.util.isIWCPacket(c)?b.forwardFromPostMessage(c,a):ozpIwc.log.log("Packet does not meet IWC Packet criteria, dropping.",c)};if(b)e(c);else{var f=this,g={subject:{"ozp:iwc:origin":a.origin},action:{"ozp:iwc:action":"connect"},policies:ozpIwc.authorization.policySets.connectSet};ozpIwc.authorization.isPermitted(g).success(function(){b=new ozpIwc.PostMessageParticipant({origin:a.origin,sourceWindow:a.source,credentials:c.entity,ready:f.readyPromise}),f.router.registerParticipant(b,c),f.participants.push(b),e(c)}).failure(function(a){console.error("Failed to connect. Could not authorize:",a)})}}},ozpIwc.RouterWatchdog=ozpIwc.util.extend(ozpIwc.ClientParticipant,function(a){ozpIwc.ClientParticipant.apply(this,arguments),this.internal=!0,this.participantType="routerWatchdog",this.heartbeatFrequency=a.heartbeatFrequency||1e4,this.on("connectedToRouter",this.setupWatches,this)}),ozpIwc.RouterWatchdog.prototype.leaveEventChannel=function(){return this.router?(this.send({dst:"$bus.multicast",action:"disconnect",entity:{address:this.address,participantType:this.participantType,namesResource:this.namesResource}}),this.send({dst:"$bus.multicast",action:"disconnect",entity:{address:this.router.selfId,namesResource:"/router/"+this.router.selfId}}),!0):!1},ozpIwc.RouterWatchdog.prototype.setupWatches=function(){this.name=this.router.selfId;var a=this,b=function(){var b=[],c=a.names().messageBuilder.set("/router/"+a.router.selfId,{contentType:"application/vnd.ozp-iwc-router-v1+json",entity:{address:a.router.selfId,participants:a.router.getParticipantCount(),time:ozpIwc.util.now()},respondOn:"none"});b.push(c);for(var d in a.router.participants){var e=a.router.participants[d];e.heartBeatStatus.time=ozpIwc.util.now(),e instanceof ozpIwc.MulticastParticipant?e.members.forEach(function(d){c=a.names().messageBuilder.set(e.namesResource+"/"+d.address,{entity:d.heartBeatStatus,contentType:e.heartBeatContentType,respondOn:"none"}),b.push(c)}):b.push({packet:e.heartbeat(),callback:void 0,res:function(){},rej:function(){}})}a.names().bulkSend(b)};this.timer=window.setInterval(b,this.heartbeatFrequency)},ozpIwc.RouterWatchdog.prototype.shutdown=function(){window.clearInterval(this.timer)},ozpIwc.ApiBase=function(a){if(!a.name)throw Error("API must be configured with a name");this.participant=a.participant||new ozpIwc.ClientParticipant({internal:!0}),this.name=a.name,this.coordinationAddress="coord."+this.name,this.events=new ozpIwc.Event,this.events.mixinOnOff(this),this.endpoints=[],this.data={},this.watchers={},this.collectors=[],this.changeList={},this.leaderState="member",this.router=a.router||ozpIwc.defaultRouter,this.router.registerMulticast(this.participant,[this.name,this.coordinationAddress]);var b=this;this.participant.on("receive",function(a){b.receivePacketContext(a)}),this.logPrefix="["+this.name+"/"+this.participant.address+"] ",ozpIwc.util.addEventListener("beforeunload",function(){b.shutdown()}),this.transitionToMemberReady(),this.queueForCoordination(a.leaderPromise)},ozpIwc.ApiBase.prototype.queueForCoordination=function(a){var b=this;this.participant.send({dst:"locks.api",resource:"/mutex/"+this.name,action:"watch"},function(a){b.handleLockChange(a)}),this.leaderPromise=a||this.participant.send({dst:"locks.api",resource:"/mutex/"+this.name,action:"lock"}),this.leaderPromise.then(function(a){ozpIwc.log.info("["+b.name+"]["+b.participant.address+"] Now operating");var c,d=new Promise(function(a,b){c=a});return window.setTimeout(function(){c()},1e3),d}).then(function(){b.transitionToLoading()}),this.leaderPromise["catch"](function(a){console.error("Error registering for leader mutex [address="+b.participant.address+",api="+b.name+"]",a)})},ozpIwc.ApiBase.prototype.handleLockChange=function(a,b){a=a||{},a.entity=a.entity||{},a.entity.oldValue=a.entity.oldValue||{},a.entity.newValue=a.entity.newValue||{};var c=a.entity.oldValue.owner||{},d=a.entity.newValue.owner||{};c.src===this.participant.address&&d.src!==this.participant.address&&(this.broadcastDeathScream(this.createDeathScream()),this.leaderState="member",this.transitionToMemberReady(),this.queueForCoordination(),b())},ozpIwc.ApiBase.prototype.createKey=function(a){a=a||"";var b;do b=a+ozpIwc.util.generateId();while(b in this.data);return b},ozpIwc.ApiBase.prototype.createdHandler=function(a){this.updateCollections()},ozpIwc.ApiBase.prototype.changedHandler=function(a,b,c){var d=ozpIwc.Lifespan.getLifespanFunctionality(a.lifespan);d.shouldPersist()&&this.persistenceQueue.queueNode(this.name+"/"+a.resource,a)},ozpIwc.ApiBase.prototype.disconnectHandler=function(a){var b=this;ozpIwc.object.eachEntry(b.data,function(c,d){var e=ozpIwc.Lifespan.getLifespanFunctionality(d.lifespan);e.shouldDelete(d.lifespan,a)&&(b.markForChange(d),d.markAsDeleted())}),b.resolveChangedNodes()},ozpIwc.ApiBase.prototype.createDeathScream=function(){return{watchers:this.watchers,collectors:this.collectors,data:ozpIwc.object.eachEntry(this.data,function(a,b){return b.serializeLive()}),timestamp:ozpIwc.util.now()}},ozpIwc.ApiBase.prototype.getPreference=function(a){return this.participant.send({dst:"data.api",resource:"/ozp/iwc/"+this.name+"/"+a,action:"get"}).then(function(a){return a.entity})},ozpIwc.ApiBase.prototype.initializeData=function(a){if(a=a||{watchers:{},collectors:[],data:[]},this.watchers=a.watchers,this.collectors=a.collectors,a.data.forEach(function(a){this.createNode({resource:a.resource}).deserializeLive(a)},this),this.updateCollections(),this.endpoints){var b=this;return Promise.all(this.endpoints.map(function(a){var c=ozpIwc.endpoint(a.link);return b.loadFromEndpoint(c,a.headers)["catch"](function(a){ozpIwc.log.error(b.logPrefix,"load from endpoint ",a," failed: ",a)})}))}return Promise.resolve()},ozpIwc.ApiBase.prototype.createNode=function(a,b){var c=this.createNodeObject(a,b);return this.data[c.resource]=c,this.events.trigger("createdNode",c),c},ozpIwc.ApiBase.prototype.createNodeObject=function(a,b){return b?new b(a):new ozpIwc.ApiNode(a)},ozpIwc.ApiBase.prototype.transitionToLoading=function(){var a=this;return"member"!==this.leaderState?(ozpIwc.log.error(this.logPrefix+"transition to loading called in an invalide state:",this.leaderState),Promise.reject(this.logPrefix+"transition to loading called in an invalide state:",this.leaderState)):(ozpIwc.log.debug(this.logPrefix+"transitioning to loading"),this.leaderState="loading",this.initializeData(this.deathScream).then(function(){a.transitionToLeader()},function(b){ozpIwc.log.error(a.logPrefix+"Failed to load data due to ",b),a.shutdown()}))},ozpIwc.ApiBase.prototype.transitionToLeader=function(){return"loading"!==this.leaderState?void ozpIwc.log.error(this.logPrefix+"transition to leader called in an invalid state:",this.leaderState):(ozpIwc.log.debug(this.logPrefix+"transitioning to leader"),this.leaderState="leader",this.broadcastLeaderReady(),this.deliverRequestQueue(),this.on("createdNode",this.createdHandler,this),this.on("changed",this.changedHandler,this),void this.on("addressDisconnects",this.disconnectHandler,this))},ozpIwc.ApiBase.prototype.shutdown=function(){"leader"===this.leaderState&&this.broadcastDeathScream(this.createDeathScream()),this.participant.send({dst:"locks.api",resource:"/mutex/"+this.name,action:"unlock"})},ozpIwc.ApiBase.prototype.transitionToMemberReady=function(a){return"member"===this.leaderState?(this.deathScream=a,this.off("createdNode",this.createdHandler),this.off("changed",this.changedHandler),this.off("addressDisconnects",this.disconnectHandler),this.enableRequestQueue(),Promise.resolve()):void 0},ozpIwc.ApiBase.prototype.transitionToMemberDormant=function(){return"member"===this.leaderState?(this.deathScream=null,this.flushRequestQueue(),Promise.resolve()):void 0},ozpIwc.ApiBase.prototype.checkAuthorization=function(a,b,c,d){return!0},ozpIwc.ApiBase.prototype.matchingNodes=function(a){return ozpIwc.object.values(this.data,function(b,c){return 0===c.resource.indexOf(a)&&!c.deleted})},ozpIwc.ApiBase.prototype.markForChange=function(){for(var a=0;a<arguments.length;++a)if(Array.isArray(arguments[a]))this.markForChange(arguments[a]);else{var b=arguments[a].resource||""+arguments[a];if(this.changeList.hasOwnProperty(b))continue;var c=this.data[b];this.changeList[b]=c?c.snapshot():{}}},ozpIwc.ApiBase.prototype.addWatcher=function(a,b){var c=this.watchers[a];Array.isArray(c)||(c=this.watchers[a]=[]),c.push(b)},ozpIwc.ApiBase.prototype.removeWatcher=function(a,b){var c=this.watchers[a];c&&(this.watchers[a]=c.filter(function(a){return a.src===b.src&&a.replyTo===b.msgId}))},ozpIwc.ApiBase.prototype.addCollector=function(a){var b=this.collectors.indexOf(a);0>b&&this.collectors.push(a);var c=this.data[a];c&&this.updateCollectionNode(c)},ozpIwc.ApiBase.prototype.removeCollector=function(a){var b=this.collectors.indexOf(a.resource);b>-1&&this.collectors.splice(b,1)},ozpIwc.ApiBase.prototype.resolveChangedNode=function(a,b,c){var d=this.data[a],e=this.watchers[a]||[];if(d){var f=d.changesSince(b);if(f){var g=ozpIwc.authorization.pip.attributeUnion(f.oldValue.permissions,f.newValue.permissions),h={oldValue:f.oldValue.entity,newValue:f.newValue.entity,oldCollection:f.oldValue.collection,newCollection:f.newValue.collection,deleted:d.deleted};this.events.trigger("changed",d,h,c),e.forEach(function(a){this.participant.send({src:this.participant.name,dst:a.src,replyTo:a.replyTo,response:"changed",resource:d.resource,permissions:g,contentType:d.contentType,entity:h})},this)}}},ozpIwc.ApiBase.prototype.resolveChangedNodes=function(a){this.updateCollections(),ozpIwc.object.eachEntry(this.changeList,function(b,c){this.resolveChangedNode(b,c,a)},this),this.changeList={}},ozpIwc.ApiBase.prototype.updateCollections=function(){for(var a in this.collectors){var b=this.data[this.collectors[a]];this.updateCollectionNode(b)}},ozpIwc.ApiBase.prototype.updateCollectionNode=function(a){if(a){if(a.deleted)return void this.removeCollector(a.resource);var b=this.matchingNodes(a.pattern).filter(function(a){return!a.deleted}).map(function(a){return a.resource});a.collection=a.collection||[],ozpIwc.util.arrayContainsAll(a.collection,b)&&ozpIwc.util.arrayContainsAll(b,a.collection)||(this.markForChange(a),a.collection=b,a.version++)}},ozpIwc.ApiBase.prototype.send=function(a){return a.src=this.name,this.participant.send(a)},ozpIwc.ApiBase.prototype.receivePacketContext=function(a){return a.packet.src===this.participant.address?Promise.resolve():a.packet.dst===this.coordinationAddress?this.receiveCoordinationPacket(a):"$bus.multicast"===a.packet.dst?this.receiveBusPacket(a):this.receiveRequestPacket(a)},ozpIwc.ApiBase.prototype.receiveBusPacket=function(a){var b=a.packet;switch(b.action){case"connect":this.events.trigger("addressConnects",b.entity.address,b);break;case"disconnect":this.removeDeadWatchers(b.entity.address),this.events.trigger("addressDisconnects",b.entity.address,b)}return Promise.resolve()},ozpIwc.ApiBase.prototype.removeDeadWatchers=function(a){var b=a.length;ozpIwc.object.eachEntry(this.watchers,function(c,d){for(var e in d)d[e].src.substr(-b)===a&&d.splice(e,1)})},ozpIwc.ApiBase.prototype.receiveRequestPacket=function(a){var b=a.packet;if(this.isRequestQueueing)return this.requestQueue.push(a),Promise.resolve();if("leader"!==this.leaderState)return Promise.resolve();var c=this;return new Promise(function(d,e){try{a.node=c.data[b.resource],d(c.routePacket(b,a))}catch(f){e(f)}}).then(function(b){b&&(b.response=b.response||"ok",a.replyTo(b)),c.resolveChangedNodes(a)},function(d){d&&d.errorAction||ozpIwc.log.error(c.logPrefix,"Unexpected error: ",d," packet= ",b);var e={src:c.name,response:d.errorAction||"errorUnknown",entity:d.message};a.replyTo(e)})},ozpIwc.ApiBase.prototype.defaultRoute=function(a,b){switch(b.defaultRouteCause){case"nonRoutablePacket":return;case"noAction":throw new ozpIwc.BadActionError(a);case"noResource":throw new ozpIwc.BadResourceError(a);default:throw new ozpIwc.BadRequestError(a)}},ozpIwc.ApiBase.prototype.enableRequestQueue=function(){this.isRequestQueueing=!0,this.requestQueue=[]},ozpIwc.ApiBase.prototype.deliverRequestQueue=function(){this.isRequestQueueing=!1,this.requestQueue.forEach(this.receiveRequestPacket,this),this.requestQueue=[]},ozpIwc.ApiBase.prototype.flushRequestQueue=function(){this.isRequestQueueing=!1,this.requestQueue=[]},ozpIwc.ApiBase.prototype.enableSendQueue=function(){this.isSendQueueing=!0,this.sendQueue=[]},ozpIwc.ApiBase.prototype.deliverSendQueue=function(){this.isSendQueueing=!1,this.sendQueue.forEach(this.participant.send,this.participant),this.sendQueue=[]},ozpIwc.ApiBase.prototype.flushSendQueue=function(){this.isSendQueueing=!1,this.sendQueue=[]},ozpIwc.ApiBase.prototype.broadcastLeaderReady=function(){this.participant.send({dst:this.coordinationAddress,action:"announceLeader"})},ozpIwc.ApiBase.prototype.broadcastDeathScream=function(a){this.participant.send({dst:this.coordinationAddress,action:"deathScream",entity:a})},ozpIwc.ApiBase.prototype.receiveCoordinationPacket=function(a){var b=a.packet;switch(b.action){case"announceLeader":return this.transitionToMemberDormant();case"deathScream":return this.transitionToMemberReady(b.entity);default:return ozpIwc.log.error("Unknown coordination packet: ",b),Promise.reject(new Error("Unknown action: "+b.action+" in "+JSON.stringify(a)))}},ozpIwc.ApiBase.prototype.loadFromEndpoint=function(a,b){var c=this;return ozpIwc.log.debug(c.logPrefix+" loading from ",a.name," -- ",a.baseUrl),a.get("/").then(function(d){var e=d.response,f=ozpIwc.util.ensureArray(e._embedded&&e._embedded.item||[]),g=ozpIwc.util.ensureArray(e._links&&e._links.item||[]);f.forEach(function(a){c.createNode({serializedEntity:a})}),ozpIwc.log.debug(c.logPrefix+" processed "+f.length+" items embedded in the endoint");var h=g.map(function(a){return a.href});return h=h.filter(function(a){return 0===ozpIwc.object.values(c.data,function(b,c){return c.self===a}).length}),ozpIwc.log.debug(c.logPrefix+" loading "+h.length+" linked items"),Promise.all(h.map(function(d){return a.get(d,b).then(function(a){var b=a.header["Content-Type"]||"";b=b.split(";")[0],c.createNode({serializedEntity:a.response,serializedContentType:b})})["catch"](function(a){ozpIwc.log.info(c.logPrefix+"Could not load from "+d+" -- ",a)})}))})["catch"](function(b){ozpIwc.log.info(c.logPrefix+" couldn't load from endpoint "+a.name+" -- ",b)})},ozpIwc.ApiBase.prototype.getCollection=function(a){return a?this.matchingNodes(a).filter(function(a){return!a.deleted}).map(function(a){return a.resource}):[]},ozpIwc.ApiBase.defaultHandler={get:function(a,b,c){var d=b.node.toPacket();return d.collection=this.getCollection(d.pattern),d},set:function(a,b,c){return b.node.set(a),{response:"ok"}},"delete":function(a,b,c){return b.node&&b.node.markAsDeleted(a),{response:"ok"}},list:function(a,b,c){var d=this.matchingNodes(a.resource).filter(function(a){return a.deleted?!1:!0}).map(function(a){return a.resource});return{contentType:"application/json",entity:d}},bulkGet:function(a,b,c){var d=this,e=this.matchingNodes(a.resource).map(function(a){var b=a.toPacket();return b.collection=d.getCollection(b.pattern),b});return{contentType:"application/json",entity:e}},watch:function(a,b,c){if(this.addWatcher(a.resource,{src:a.src,replyTo:a.msgId}),this.addCollector(a.resource),b.node){var d=b.node.toPacket();return d.collection=this.getCollection(d.pattern),d}return{response:"ok"}},unwatch:function(a,b,c){return this.removeWatcher(a.resource,a),this.watchers[a.resource]&&0===this.watchers[a.resource].length&&this.removeCollector(a.resource),{response:"ok"}}},ozpIwc.ApiBase.allActions=Object.keys(ozpIwc.ApiBase.defaultHandler),ozpIwc.createApi=function(a){var b=ozpIwc.util.extend(ozpIwc.ApiBase,function(){return ozpIwc.ApiBase.apply(this,arguments),a.apply(this,arguments)});return ozpIwc.PacketRouter.mixin(b),b.useDefaultRoute=function(a,c){c=c||"{resource:.*}",a=ozpIwc.util.ensureArray(a),a.forEach(function(a){var d=ozpIwc.standardApiFilters.forAction(a);b.declareRoute({action:a,resource:c,filters:d?d():[]},ozpIwc.ApiBase.defaultHandler[a])})},b.declareRoute({action:["bulkSend"],resource:"{resource:.*}",filters:[]},function(a,b,c){var d=a.entity||[],e=this;return d.forEach(function(a){var b=new ozpIwc.TransportPacketContext({packet:a.packet,router:e.router,srcParticipant:a.packet.src,dstParticipant:e.address});e.receiveRequestPacket(b)}),{response:"ok"}}),b},ozpIwc.ApiError=ozpIwc.util.extend(Error,function(a,b){Error.call(this,b),this.name="ApiError",this.errorAction=a,this.message=b}),ozpIwc.ApiError.prototype.toString=function(){return this.name+":"+JSON.stringify(this.message)},ozpIwc.ApiError.subclass=function(a){return ozpIwc.util.extend(ozpIwc.ApiError,function(b){ozpIwc.ApiError.call(this,a,b),this.name=a+"Error"})},ozpIwc.BadActionError=ozpIwc.ApiError.subclass("badAction"),ozpIwc.BadResourceError=ozpIwc.ApiError.subclass("badResource"),ozpIwc.BadRequestError=ozpIwc.ApiError.subclass("badRequest"),ozpIwc.BadContentError=ozpIwc.ApiError.subclass("badContent"),ozpIwc.BadStateError=ozpIwc.ApiError.subclass("badState"),ozpIwc.NoActionError=ozpIwc.ApiError.subclass("noAction"),ozpIwc.NoResourceError=ozpIwc.ApiError.subclass("noResource"),ozpIwc.NoMatchError=ozpIwc.ApiError.subclass("noMatch"),ozpIwc.NoPermissionError=ozpIwc.ApiError.subclass("noPermission"),ozpIwc.apiFilter={createResource:function(a){return a?function(b,c,d,e){return c.node||(c.node=this.data[b.resource]=new a({resource:b.resource,pattern:b.pattern,lifespan:b.lifespan,src:b.src})),e()}:function(a,b,c,d){return b.node||(b.node=this.createNode({resource:a.resource,pattern:a.pattern,lifespan:a.lifespan,src:a.src})),d()}},markAsCollector:function(){return function(a,b,c,d){return this.addCollector(a.resource),d()}},requireResource:function(){return function(a,b,c,d){if(!b.node||b.node.deleted)throw new ozpIwc.NoResourceError(a);return d()}},checkAuthorization:function(a){return function(b,c,d,e){return this.checkAuthorization(c.node,c,b,a||b.action),e()}},nullFilter:function(a,b,c,d){return d()},checkContentType:function(a){return a?(a=ozpIwc.util.ensureArray(a),function(b,c,d,e){if(!a.some(function(c){return c===b.contentType||"[object RegExp]"===Object.prototype.toString.call(a)&&c.test(b.contentType)}))throw new ozpIwc.BadContentError({provided:b.contentType,allowedTypes:a});return e()}):ozpIwc.apiFilter.nullFilter},markResourceAsChanged:function(){return function(a,b,c,d){return this.markForChange(a),d()}},fixPattern:function(){return function(a,b,c,d){var e;return b.node&&(e=b.node.pattern),a.resource&&(a.pattern=a.pattern||e||a.resource+"/"),d()}},checkVersion:function(){return function(a,b,c,d){if(a.ifTag&&a.ifTag!==b.node.version)throw new ozpIwc.NoMatchError({expectedVersion:a.ifTag,actualVersion:b.node.version});return d()}}},ozpIwc.standardApiFilters={forAction:function(a){return ozpIwc.standardApiFilters[a+"Filters"]},setFilters:function(a,b){return[ozpIwc.apiFilter.createResource(a),ozpIwc.apiFilter.checkAuthorization(),ozpIwc.apiFilter.checkContentType(b),ozpIwc.apiFilter.checkVersion(),ozpIwc.apiFilter.markResourceAsChanged()]},deleteFilters:function(){return[ozpIwc.apiFilter.checkAuthorization(),ozpIwc.apiFilter.checkVersion(),ozpIwc.apiFilter.markResourceAsChanged()]},getFilters:function(){return[ozpIwc.apiFilter.requireResource(),ozpIwc.apiFilter.checkAuthorization()]},createAndCollectFilters:function(a,b){return[ozpIwc.apiFilter.fixPattern(),ozpIwc.apiFilter.createResource(a),ozpIwc.apiFilter.checkAuthorization(),ozpIwc.apiFilter.checkContentType(b),ozpIwc.apiFilter.checkVersion()]}},ozpIwc.ApiNode=function(a){a=a||{},this.resource=a.resource,this.allowedContentTypes=a.allowedContentTypes,this.entity=a.entity,this.contentType=a.contentType,a.uriTemplate&&(this.uriTemplate=a.uriTemplate),this.permissions={},this.version=a.version||1;var b=ozpIwc.Lifespan.getLifespan(a.lifespan);if(b?this.lifespan=b:this.lifespan=new ozpIwc.Lifespan.Ephemeral,this.deleted=!1,this.pattern=a.pattern,this.collection=[],this.self=a.self,a.serializedEntity&&this.deserializedEntity(a.serializedEntity,a.serializedContentType),!this.resource)throw new Error("ApiNode requires a resource")},ozpIwc.ApiNode.prototype.getSelfUri=function(){if(this.self)return this.self;if(this.uriTemplate&&ozpIwc.uriTemplate){var a=ozpIwc.uriTemplate(this.uriTemplate);a&&(this.self=ozpIwc.util.resolveUriTemplate(a,this))}return this.self},ozpIwc.ApiNode.prototype.serializeLive=function(){return this.toPacket({deleted:this.deleted,pattern:this.pattern,collection:this.collection,lifespan:this.lifespan,allowedContentTypes:this.allowedContentTypes,_links:{self:{href:this.self}}})},ozpIwc.ApiNode.prototype.deserializeLive=function(a,b){a.contentType=a.contentType||b,this.set(a),a._links&&a._links.self&&(this.self=a._links.self.href),this.resource||(this.resource=a.resource||this.resourceFallback(a)),this.deleted=a.deleted,this.lifespan=a.lifespan,this.allowedContentTypes=a.allowedContentTypes,this.pattern=a.pattern,this.collection=a.collection},ozpIwc.ApiNode.prototype.deserializeResourceFromContentType=function(a){a._links&&a._links.self&&(this.resource=a._links.self.href.replace(ozpIwc.apiRootUrl,""))},ozpIwc.ApiNode.prototype.serializedEntity=function(){return JSON.stringify(this.entity)},ozpIwc.ApiNode.prototype.serializedContentType=function(){return this.contentType},ozpIwc.ApiNode.prototype.deserializedEntity=function(a,b){if("string"==typeof a&&(a=JSON.parse(a)),this.entity=a,this.contentType=b,this.entity&&this.entity._links){var c=this.entity._links;!this.self&&c.self&&(this.self=c.self.href),this.resource||(c["ozp:iwcSelf"]?this.resource=c["ozp:iwcSelf"].href.replace(/web\+ozp:\/\/[^/]+/,""):this.resource=this.resourceFallback(a))}},ozpIwc.ApiNode.prototype.resourceFallback=function(a){},ozpIwc.ApiNode.prototype.toPacket=function(a){return a=a||{},a.entity=ozpIwc.util.clone(this.entity),a.lifespan=this.lifespan,a.contentType=this.contentType,a.permissions=this.permissions,a.eTag=this.version,a.resource=this.resource,a.pattern=this.pattern,a.collection=this.collection,a},ozpIwc.ApiNode.prototype.set=function(a){if(!Array.isArray(a.permissions))for(var b in a.permissions)this.permissions.clear(b),this.permissions.pushIfNotExist(b,a.permissions[b]);this.lifespan=ozpIwc.Lifespan.getLifespan(a.lifespan)||this.lifespan,this.contentType=a.contentType,this.entity=a.entity,this.pattern=a.pattern||this.pattern,this.deleted=!1,a.eTag?this.version=a.eTag:this.version++},ozpIwc.ApiNode.prototype.markAsDeleted=function(a){this.version++,this.deleted=!0,this.entity=null,this.pattern=null,this.collection=null},ozpIwc.ApiNode.prototype.addWatch=function(a){this.watchers.push(a)},ozpIwc.ApiNode.prototype.removeWatch=function(a){this.watchers=this.watchers.filter(a)},ozpIwc.ApiNode.prototype.snapshot=function(){return this.toPacket()},ozpIwc.ApiNode.prototype.changesSince=function(a){return a.eTag===this.version?null:{newValue:this.toPacket(),oldValue:a}},ozpIwc.Endpoint=function(a){this.endpointRegistry=a},ozpIwc.Endpoint.prototype.get=function(a,b){var c=this;return a=a||"",this.endpointRegistry.loadPromise.then(function(){if(!c.endpointRegistry.loaded)throw Error("Endpoint "+c.endpointRegistry.apiRoot+" could not be reached. Skipping GET of "+a);return("/"===a||""===a)&&(a=c.baseUrl),a?ozpIwc.util.ajax({href:a,method:"GET",headers:b}):Promise.reject()})},ozpIwc.Endpoint.prototype.put=function(a,b,c){var d=this;return this.endpointRegistry.loadPromise.then(function(){return 0!==a.indexOf(d.baseUrl)&&(a=d.baseUrl+a),ozpIwc.util.ajax({href:a,method:"PUT",data:b,headers:c})})},ozpIwc.Endpoint.prototype["delete"]=function(a,b,c){var d=this;return this.endpointRegistry.loadPromise.then(function(){if(!d.baseUrl)throw Error("The server did not define a relation of type "+this.name+" for retrivieving "+a);return 0!==a.indexOf(d.baseUrl)&&(a=d.baseUrl+a),ozpIwc.util.ajax({href:a,method:"DELETE",headers:c})})},ozpIwc.Endpoint.prototype.saveNodes=function(a){var b="/data";for(var c in a){var d=JSON.stringify(a[c]);this.put(a[c].self||b,d)}},ozpIwc.EndpointRegistry=function(a){a=a||{};var b=a.apiRoot||"/api";this.apiRoot=b,this.endPoints={},this.template={};var c=this;this.loadPromise=ozpIwc.util.ajax({href:b,method:"GET"}).then(function(a){c.loaded=!0;var b=a.response||{};b._links=b._links||{},b._embedded=b._embedded||{};for(var d in b._links)if("self"!==d){var e=b._links[d];Array.isArray(b._links[d])&&(e=b._links[d][0].href),e.templated?c.template[d]=e.href:c.endpoint(d).baseUrl=e.href}for(var f in b._embedded){var g=b._embedded[f]._links.self.href;c.endpoint(f).baseUrl=g}c.template["ozp:data-item"]||(c.template["ozp:data-item"]=c.endpoint("ozp:user-data").baseUrl+"/{+resource}")})["catch"](function(a){ozpIwc.log.debug(Error("Endpoint "+c.apiRoot+" "+a.statusText+". Status: "+a.status)),c.loaded=!1})},ozpIwc.EndpointRegistry.prototype.endpoint=function(a){var b=this.endPoints[a];return b||(b=this.endPoints[a]=new ozpIwc.Endpoint(this),b.name=a),b},ozpIwc.initEndpoints=function(a){var b=new ozpIwc.EndpointRegistry({apiRoot:a});ozpIwc.endpoint=function(a){return b.endpoint(a)},ozpIwc.uriTemplate=function(a){return b.template[a]}},ozpIwc.LocksApi=ozpIwc.util.extend(ozpIwc.ApiBase,function(a){if(!a.name)throw Error("API must be configured with a name");this.name="locks.api",this.events=new ozpIwc.Event,this.events.mixinOnOff(this),this.router=a.router||ozpIwc.defaultRouter,this.endpoints=[],this.data={},this.watchers={},this.collectors=[],this.changeList={},this.enableRequestQueue(),this.enableSendQueue(),this.consensusConfiguration(a),this.participantConfiguration(a),this.on("addressDisconnects",this.unlockAll,this),this.logPrefix="["+this.name+"/"+this.participant.address+"] ",this.leaderState="loading",this.transitionToLeader();var b=this;ozpIwc.util.addEventListener("beforeunload",function(){b.shutdown()})}),ozpIwc.PacketRouter.mixin(ozpIwc.LocksApi),ozpIwc.LocksApi.prototype.transitionToLeader=function(){return"loading"!==this.leaderState?void ozpIwc.log.error(this.logPrefix+"transition to leader called in an invalid state:",this.leaderState):(ozpIwc.log.debug(this.logPrefix+"transitioning to leader"),this.leaderState="leader",void this.broadcastLeaderReady())},ozpIwc.LocksApi.prototype.consensusConfiguration=function(a){this.consensusMember=a.consensusMember||new ozpIwc.consensus.Bully({name:this.name,router:this.router,gatherLogs:function(){return b.createDeathScream()}});var b=this;this.consensusMember.on("receivedLogs",this.handleLogs,this),this.consensusMember.on("changedState",this.handleConsensusState,this)},ozpIwc.LocksApi.prototype.participantConfiguration=function(a){this.participant=new ozpIwc.ClientParticipant({internal:!0}),this.participant.on("receive",function(a){this.receivePacketContext(a)},this),this.router.registerMulticast(this.participant,[this.name]),"coordinator"===this.consensusMember.state&&this.deliverRequestQueue()},ozpIwc.LocksApi.prototype.unlockAll=function(a){var b=this;ozpIwc.object.eachEntry(this.data,function(c,d){b.updateLock(d,d.unlock({src:a}))})},ozpIwc.LocksApi.prototype.cleanup=function(){var a={};ozpIwc.object.eachEntry(this.data,function(b,c){var d=c.entity.queue||[];d.forEach(function(b){a[b.src]=!0})});var b=this;this.participant.names().bulkGet("/address").then(function(b){b.entity.forEach(function(b){b.entity.time&&b.entity.time+ozpIwc.heartBeatFrequency>ozpIwc.util.now()&&(a[b.entity.address]=!1)})}).then(function(){ozpIwc.object.eachEntry(a,function(a,c){c&&b.unlockAll(a)})})},ozpIwc.LocksApi.prototype.handleConsensusState=function(a){switch(ozpIwc.log.info("["+this.participant.address+"] State: ",a),a){case"coordinator":this.deliverRequestQueue(),this.deliverSendQueue();break;default:this.participant.sendingBlocked=!0,this.flushSendQueue()}},ozpIwc.LocksApi.prototype.handleLogs=function(a){if(!this.initialized){this.initialized=!0;var b=a.timestamp;this.initializeData(a),this.deliverRequestQueue(b)}},ozpIwc.LocksApi.prototype.createNodeObject=function(a){return new ozpIwc.LocksNode(a)},ozpIwc.LocksApi.prototype.shutdown=function(){"leader"===this.leaderState&&this.broadcastDeathScream(this.createDeathScream()),this.participant.send({dst:"locks.api",resource:"/mutex/"+this.name,action:"unlock"})},ozpIwc.LocksApi.useDefaultRoute=function(a,b){b=b||"{resource:.*}",a=ozpIwc.util.ensureArray(a);var c=this;a.forEach(function(a){var d=ozpIwc.standardApiFilters.forAction(a);c.declareRoute({action:a,resource:b,filters:d?d():[]},ozpIwc.ApiBase.defaultHandler[a])})},ozpIwc.LocksApi.useDefaultRoute(["bulkGet","list","get","watch","unwatch"]),ozpIwc.LocksApi.declareRoute({action:["bulkSend"],resource:"{resource:.*}",filters:[]},function(a,b,c){var d=a.entity||[],e=this;return d.forEach(function(a){var b=new ozpIwc.TransportPacketContext({packet:a.packet,router:e.router,srcParticipant:a.packet.src,dstParticipant:e.address});e.receiveRequestPacket(b)}),{response:"ok"}}),ozpIwc.LocksApi.declareRoute({action:"lock",resource:"/mutex/{name}",filters:ozpIwc.standardApiFilters.setFilters(ozpIwc.LocksNode)},function(a,b,c){b.node&&this.updateLock(b.node,b.node.lock({src:a.src,msgId:a.msgId}))}),ozpIwc.LocksApi.declareRoute({action:"unlock",resource:"/mutex/{name}",filters:ozpIwc.standardApiFilters.setFilters(ozpIwc.LocksNode)},function(a,b,c){a.entity=a.entity||{},ozpIwc.log.info("[locks.api"+b.node.resource+"][UNLOCK]: ",a.src),b.node&&this.updateLock(b.node,b.node.unlock({src:a.entity.src||a.src,msgId:a.entity.msgId||a.msgId}))}),ozpIwc.LocksApi.prototype.updateLock=function(a,b){if(b){ozpIwc.log.info("[locks.api"+a.resource+"][NEW LEADER]",b);var c={dst:b.src,src:this.participant.name,replyTo:b.msgId,response:"ok",resource:a.resource};this.isSendQueueing?this.sendQueue.push(c):this.participant.send(c)}else ozpIwc.log.info("[locks.api"+a.resource+"][SAME LEADER] queue:",JSON.stringify(a.entity.queue))},ozpIwc.LocksNode=ozpIwc.util.extend(ozpIwc.ApiNode,function(a){ozpIwc.ApiNode.apply(this,arguments),this.entity={owner:null,queue:[]}}),ozpIwc.LocksNode.prototype.lock=function(a){this.entity.queue=this.entity.queue||[];for(var b in this.entity.queue){var c=this.entity.queue[b];if(c.src===a.src&&c.msgId===a.msgId)return null}return this.entity.queue.push(a),this.entity.owner=this.entity.owner||{},ozpIwc.util.objectContainsAll(this.entity.owner,this.entity.queue[0])?null:(this.entity.owner=this.entity.queue[0],a.eTag?this.version=a.eTag:this.version++,this.entity.owner)},ozpIwc.LocksNode.prototype.unlock=function(a){return this.entity.queue=this.entity.queue.filter(function(b){return!ozpIwc.util.objectContainsAll(b,a)}),ozpIwc.util.objectContainsAll(this.entity.owner,this.entity.queue[0])?(0===this.entity.queue.length&&(a.eTag?this.version=a.eTag:this.version++,this.entity.owner=null),null):(this.entity.owner=this.entity.queue[0],a.eTag?this.version=a.eTag:this.version++,this.entity.owner)},ozpIwc.DataNode=ozpIwc.util.extend(ozpIwc.ApiNode,function(a){ozpIwc.ApiNode.apply(this,arguments);var b=ozpIwc.Lifespan.getLifespan(a.lifespan);
b?this.lifespan=b:this.lifespan=new ozpIwc.Lifespan.Persistent}),ozpIwc.DataNode.prototype.uriTemplate="ozp:data-item",ozpIwc.DataNode.prototype.serializedEntity=function(){return JSON.stringify({key:this.resource,entity:this.entity,collection:this.collection,pattern:this.pattern,contentType:this.contentType,permissions:this.permissions,version:this.version,_links:{self:{href:this.self}}})},ozpIwc.DataNode.prototype.serializedContentType=function(){return"application/vnd.ozp-iwc-data-object+json"},ozpIwc.DataNode.prototype.deserializedEntity=function(a,b){var c;c="string"==typeof a.entity?JSON.parse(a.entity):a.entity,this.entity=c.entity,this.collection=c.collection,this.pattern=c.pattern,this.contentType=c.contentType,this.permissions=c.permissions,this.version=c.version,c._links=c._links||{},c._links.self&&(this.self=c._links.self.href),this.resource||(c._links["ozp:iwcSelf"]?this.resource=c._links["ozp:iwcSelf"].href.replace(/web\+ozp:\/\/[^/]+/,""):this.resource=this.resourceFallback(c))},ozpIwc.DataNode.prototype.resourceFallback=function(a){return a.key?("/"===a.key.charAt(0)?"":"/")+a.key:void 0},ozpIwc.IntentsInFlightNode=ozpIwc.util.extend(ozpIwc.ApiNode,function(a){if(a=a||{},ozpIwc.ApiNode.apply(this,arguments),this.lifespan=new ozpIwc.Lifespan.Bound({addresses:[a.src]}),!a.invokePacket)throw new ozpIwc.BadContentError("In flight intent requires an invocation packet");if(!Array.isArray(a.handlerChoices)||a.handlerChoices<1)throw new ozpIwc.BadContentError("No handlers available");this.entity={intent:{type:a.type,action:a.action},invokePacket:a.invokePacket,contentType:a.invokePacket.contentType,entity:a.invokePacket.entity,state:"init",status:"ok",handlerChoices:a.handlerChoices,handler:{resource:null,address:null},reply:null}}),ozpIwc.IntentHandlerNode=ozpIwc.util.extend(ozpIwc.ApiNode,function(a){ozpIwc.ApiNode.apply(this,arguments),this.lifespan=new ozpIwc.Lifespan.Bound({addresses:[a.src]}),this.entity=a.entity||{}}),ozpIwc.IntentHandlerNode.prototype.set=function(a){var b=a.src;if(a.entity&&a.entity.invokeIntent&&a.entity.invokeIntent.dst&&(b=a.entity.invokeIntent.dst),!b)throw ozpIwc.log.error("Handler lacks a invokeIntent.dst",a),new ozpIwc.BadContentError("Intent handler must supply invokeIntent.dst");ozpIwc.ApiNode.prototype.set.apply(this,arguments),this.entity.invokeIntent=this.entity.invokeIntent||{},this.entity.invokeIntent.dst=b,this.entity.replyTo=a.msgId},ozpIwc.IntentHandlerNode.prototype.resourceFallback=function(a){switch(this.contentType){case"application/vnd.ozp-intents-v1+json":return"/"+a.intent.type+"/"+a.intent.action}},ozpIwc.Lifespan=ozpIwc.Lifespan||{},ozpIwc.Lifespan.getLifespan=function(a){if(a){if("string"==typeof a){var b=a;a={type:b}}if(a.type)return a.type=a.type.charAt(0).toUpperCase()+a.type.slice(1),a}},ozpIwc.Lifespan.getLifespanFunctionality=function(a){switch(a.type){case"Ephemeral":return ozpIwc.Lifespan.ephemeralFunctionality;case"Persistent":return ozpIwc.Lifespan.persistentFunctionality;case"Bound":return ozpIwc.Lifespan.boundFunctionality;default:ozpIwc.Error("Received a malformed Lifespan, resource will be dropped: ",a)}},ozpIwc.Lifespan.ephemeralFunctionality={shouldPersist:function(){return!1},shouldDelete:function(){return!1}},ozpIwc.Lifespan.persistentFunctionality={shouldPersist:function(){return!0},shouldDelete:function(){return!1}},ozpIwc.Lifespan.boundFunctionality={shouldPersist:function(){return!1},shouldDelete:function(a,b){var c=b.length;for(var d in a.addresses)if(!a.addresses[d]||a.addresses[d].substr(-c)===b)return!0;return!1}},ozpIwc.Lifespan.Persistent=function(){this.type="Persistent"},ozpIwc.Lifespan.Ephemeral=function(){this.type="Ephemeral"},ozpIwc.Lifespan.Bound=function(a){a=a||{},this.type="Bound",this.addresses=a.addresses||[]},ozpIwc.NamesNode=ozpIwc.util.extend(ozpIwc.ApiNode,function(a){ozpIwc.ApiNode.apply(this,arguments),this.lifespan=new ozpIwc.Lifespan.Bound({addresses:[a.src]}),this.entity=a.entity||{}}),ozpIwc.SystemNode=ozpIwc.util.extend(ozpIwc.ApiNode,function(a){ozpIwc.ApiNode.apply(this,arguments)}),ozpIwc.SystemNode.prototype.resourceFallback=function(a){switch(this.contentType){case"application/vnd.ozp-application-v1+json":return"/application/"+a.id}},ozpIwc.DataApi=ozpIwc.createApi(function(a){this.persistenceQueue=a.persistenceQueue||new ozpIwc.AjaxPersistenceQueue,this.endpoints=[{link:ozpIwc.linkRelPrefix+":user-data",headers:[]}]}),ozpIwc.DataApi.prototype.createNodeObject=function(a){return new ozpIwc.DataNode(a)},ozpIwc.DataApi.useDefaultRoute(ozpIwc.ApiBase.allActions),ozpIwc.DataApi.addChildFilters=function(){var a,b=ozpIwc.standardApiFilters.createAndCollectFilters(ozpIwc.DataNode);return b.unshift(function(b,c,d,e){return a=b.pattern,b.pattern=null,e()}),b.push(function(b,c,d,e){return c.node.set({pattern:b.pattern}),b.pattern=a,e()}),b},ozpIwc.DataApi.declareRoute({action:["addChild"],resource:"{resource:.*}",filters:ozpIwc.DataApi.addChildFilters()},function(a,b,c){var d=this.createKey(b.node.pattern);a.resource=d,a.pattern=a.pattern||d+"/";var e=this.createNode({resource:d},ozpIwc.DataNode);return this.markForChange(e),e.set(a),{response:"ok",entity:{resource:e.resource}}}),ozpIwc.DataApi.declareRoute({action:["removeChild"],resource:"{resource:.*}",filters:ozpIwc.standardApiFilters.deleteFilters()},function(a,b,c){return a.entity&&a.entity.resource&&(a.resource=a.entity.resource,b.node=this.data[a.resource],b.node&&(this.markForChange(b.node),b.node.markAsDeleted(a))),{response:"ok"}}),ozpIwc.InFlightIntentFSM={},ozpIwc.InFlightIntentFSM.events=new ozpIwc.Event,ozpIwc.InFlightIntentFSM.events.mixinOnOff(ozpIwc.InFlightIntentFSM),ozpIwc.InFlightIntentFSM.states={},ozpIwc.InFlightIntentFSM.states.init=function(){var a=this.entity.handlerChoices||[],b={};return 1===a.length?(b.handler={resource:a[0].resource,reason:"onlyOne"},b.state="delivering"):a.length>1?b.state="choosing":(b.state="error",b.error="noChoices"),ozpIwc.InFlightIntentFSM.transition(this,{entity:b})},ozpIwc.InFlightIntentFSM.states.error=function(a){return this.entity=this.entity||{},this.entity.reply=a.error,this.entity.state="error",this.version++,ozpIwc.InFlightIntentFSM.stateEvent(this)},ozpIwc.InFlightIntentFSM.states.delivering=function(a){if(!a.handler||!a.handler.resource||!a.handler.reason)throw new ozpIwc.BadStateError("Choosing state requires a resource and reason");return this.entity.handler=a.handler,this.entity.state="delivering",this.version++,ozpIwc.InFlightIntentFSM.stateEvent(this)},ozpIwc.InFlightIntentFSM.states.running=function(a){if(!a.handler||!a.handler.address)throw new ozpIwc.BadContentError("Entity lacks a 'handler.address' field");return this.entity.handler.address=a.handler.address,this.entity.state="running",this.version++,ozpIwc.InFlightIntentFSM.stateEvent(this)},ozpIwc.InFlightIntentFSM.states.choosing=function(){return this.entity.state="choosing",this.version++,ozpIwc.InFlightIntentFSM.stateEvent(this)},ozpIwc.InFlightIntentFSM.states.complete=function(a){return this.entity.reply=a.reply,this.entity.state="complete",this.version++,ozpIwc.InFlightIntentFSM.stateEvent(this)},ozpIwc.InFlightIntentFSM.stateTransitions={init:{init:ozpIwc.InFlightIntentFSM.states.init,error:ozpIwc.InFlightIntentFSM.states.error,delivering:ozpIwc.InFlightIntentFSM.states.delivering,choosing:ozpIwc.InFlightIntentFSM.states.choosing},choosing:{error:ozpIwc.InFlightIntentFSM.states.error,delivering:ozpIwc.InFlightIntentFSM.states.delivering,complete:ozpIwc.InFlightIntentFSM.states.complete},delivering:{error:ozpIwc.InFlightIntentFSM.states.error,running:ozpIwc.InFlightIntentFSM.states.running,complete:ozpIwc.InFlightIntentFSM.states.complete},running:{error:ozpIwc.InFlightIntentFSM.states.error,complete:ozpIwc.InFlightIntentFSM.states.complete},complete:{},error:{}},ozpIwc.InFlightIntentFSM.transition=function(a,b){if(b=b||{entity:{state:"init"}},!b.entity||!b.entity.state)throw new ozpIwc.BadContentError("Entity lacks a 'state' field");if(a.deleted)throw new ozpIwc.BadContentError("Already handled.");var c=ozpIwc.InFlightIntentFSM.stateTransitions[a.entity.state];if(!c)return ozpIwc.InFlightIntentFSM.states.error.call(a,{entity:{error:"Inflight intent is in an invalid state.  Cannot proceed."}});if(c=c[b.entity.state],!c)throw new ozpIwc.BadStateError("In-flight intent cannot transition from "+a.entity.state+" to "+b.entity.state);return c.call(a,b.entity)},ozpIwc.InFlightIntentFSM.stateEvent=function(a){return a.entity&&a.entity.state&&ozpIwc.InFlightIntentFSM.events.trigger(a.entity.state,a),a},ozpIwc.IntentsApi=ozpIwc.createApi(function(a){this.persistenceQueue=a.persistenceQueue||new ozpIwc.AjaxPersistenceQueue,this.endpoints=[{link:ozpIwc.linkRelPrefix+":intent",headers:[]}]}),ozpIwc.IntentsApi.prototype.initializeData=function(a){if(a=a||{watchers:{},collectors:[],data:[]},this.watchers=a.watchers,this.collectors=a.collectors,a.data.forEach(function(a){0===a.resource.indexOf("/inFlightIntent")?(a.entity=a.entity||{},a.entity.dState=a.entity.state,a.entity.state="deserialize",this.createNode({resource:a.resource,invokePacket:{},handlerChoices:[0,1],state:"deserialize"},ozpIwc.IntentsInFlightNode).deserializeLive(a)):this.createNode({resource:a.resource}).deserializeLive(a)},this),this.updateCollections(),this.endpoints){var b=this;return Promise.all(this.endpoints.map(function(a){var c=ozpIwc.endpoint(a.link);return b.loadFromEndpoint(c,a.headers)["catch"](function(a){ozpIwc.log.error(b.logPrefix,"load from endpoint ",a," failed: ",a)})}))}return Promise.resolve()},ozpIwc.IntentsApi.useDefaultRoute(["bulkGet","list"]),ozpIwc.IntentsApi.useDefaultRoute(["watch","unwatch","delete"],"/inFlightIntent/{id}"),ozpIwc.IntentsApi.prototype.invokeIntentHandler=function(a,b,c,d,e){var f=this,g=new ozpIwc.IntentsInFlightNode({resource:this.createKey("/inFlightIntent/"),src:a.src,invokePacket:a,type:b,action:c,handlerChoices:d,pattern:e});return this.data[g.resource]=g,this.addCollector(g.resource),this.data[g.resource]=ozpIwc.InFlightIntentFSM.transition(g),this.handleInflightIntentState(g).then(function(){return{entity:{inFlightIntent:f.data[g.resource].toPacket()}}})},ozpIwc.IntentsApi.prototype.handleInflightIntentState=function(a){switch(a.entity.state){case"choosing":return this.handleChoosing(a);case"delivering":this.handleDelivering(a);break;case"complete":this.handleComplete(a)}return Promise.resolve(a)},ozpIwc.IntentsApi.prototype.handleChoosing=function(a){var b=function(a){var b=function(b){var c=ozpIwc.util.clone(b.entity.invokeIntent);return c.entity=c.entity||{},c.replyTo=b.entity.replyTo,c.entity.inFlightIntent=a.toPacket(),c.entity.force=11===ozpIwc.util.getInternetExplorerVersion(),d.invokeIntentHandler(c,"/inFlightIntent/chooser","choose",[b],"/inFlightIntent/chooser/choose/").then(function(a){var b=a.entity.inFlightIntent;if(b.entity=b.entity||{},"complete"===b.entity.state)return!0;if("error"===b.entity.state)throw"err";var c,d,e=new Promise(function(a,b){c=a,d=b}),f=function(a){a.resource===b.resource&&(ozpIwc.InFlightIntentFSM.off("complete",f),c(!0))},g=function(a){a.resource===b.resource&&(ozpIwc.InFlightIntentFSM.off("error",g),d("err"))};return ozpIwc.InFlightIntentFSM.on("complete",f),ozpIwc.InFlightIntentFSM.on("error",g),e})},c=function(a){return a.length>0?b(a[0]).then(function(){return Promise.resolve()})["catch"](function(b){return a.shift(),c(a)}):Promise.reject("no choosers.")},e=d.matchingNodes("/inFlightIntent/chooser/choose/");return c(e)},c=function(c){return ozpIwc.log.log("Picking chooser because",c),b(a)["catch"](function(b){11!==ozpIwc.util.getInternetExplorerVersion()?(ozpIwc.log.log("launching popup chooser because: ",b),ozpIwc.util.openWindow(ozpIwc.intentsChooserUri,{"ozpIwc.peer":ozpIwc.BUS_ROOT,"ozpIwc.intentSelection":"intents.api"+a.resource},ozpIwc.INTENT_CHOOSER_FEATURES)):(ozpIwc.log.error("Failed to handle intent choosing: Internet Explorer 11 is not supported for the default intent chooser."),a=ozpIwc.InFlightIntentFSM.transition(a,{state:"error"}))})},d=this;return this.getPreference(a.entity.intent.type+"/"+a.entity.intent.action).then(function(b){return b in d.data?(a=ozpIwc.InFlightIntentFSM.transition(a,{entity:{state:"delivering",handler:{resource:b,reason:"remembered"}}}),d.handleInflightIntentState(a)):c()})["catch"](c)},ozpIwc.IntentsApi.prototype.handleDelivering=function(a){var b=this.data[a.entity.handler.resource],c=ozpIwc.util.clone(b.entity.invokeIntent);return c.entity=c.entity||{},c.replyTo=b.entity.replyTo,c.entity.inFlightIntent=a.toPacket(),ozpIwc.log.log(this.logPrefix+"delivering intent:",c),this.send(c)},ozpIwc.IntentsApi.prototype.handleComplete=function(a){a.entity.invokePacket&&a.entity.invokePacket.src&&a.entity.reply&&this.send({dst:a.entity.invokePacket.src,replyTo:a.entity.invokePacket.msgId,contentType:a.entity.reply.contentType,response:"complete",entity:a.entity.reply.entity}),a.markAsDeleted()},ozpIwc.IntentsApi.declareRoute({action:"set",resource:"/inFlightIntent/{id}",filters:ozpIwc.standardApiFilters.setFilters(ozpIwc.IntentsInFlightNode)},function(a,b,c){return b.node=ozpIwc.InFlightIntentFSM.transition(b.node,a),this.handleInflightIntentState(b.node).then(function(){return{response:"ok"}})}),ozpIwc.IntentsApi.useDefaultRoute(["get","delete","watch","unwatch"],"/{major}/{minor}/{action}/{handlerId}"),ozpIwc.IntentsApi.declareRoute({action:"invoke",resource:"/{major}/{minor}/{action}/{handlerId}",filters:[]},function(a,b,c){return this.invokeIntentHandler(a,c.major+"/"+c.minor,c.action,[b.node])}),ozpIwc.IntentsApi.declareRoute({action:"set",resource:"/{major}/{minor}/{action}/{handlerId}",filters:ozpIwc.standardApiFilters.setFilters(ozpIwc.IntentHandlerNode,"application/vnd.ozp-iwc-intent-handler-v1+json")},function(a,b,c){return b.node.set(a),{response:"ok"}}),ozpIwc.IntentsApi.registerDefinitionFilter=function(a,b){var c=function(a,b,c,d){return b.node.entity||b.node.set({entity:{type:c.major+"/"+c.minor,action:c.action}}),this.addCollector(b.node.resource),d()},d=ozpIwc.standardApiFilters.setFilters(a,b);return d.unshift(ozpIwc.apiFilter.fixPattern()),d.push(c),d},ozpIwc.IntentsApi.registerHandlerFilter=function(a,b){var c=function(a,b,c,d){return a.resource="/"+c.major+"/"+c.minor+"/"+c.action,b.node=this.data[a.resource],d()},d=function(a,b,c,d){return a.resource="/"+c.major+"/"+c.minor+"/"+c.action+"/"+c.handlerId,b.node=this.data[a.resource],d()},e=ozpIwc.IntentsApi.registerDefinitionFilter(null,"application/vnd.ozp-iwc-intent-handler-v1+json");e.unshift(c);var f=ozpIwc.standardApiFilters.setFilters(a,b);return f.unshift(d),e.push.apply(e,f),e},ozpIwc.IntentsApi.declareRoute({action:"register",resource:"/{major}/{minor}/{action}",filters:ozpIwc.IntentsApi.registerDefinitionFilter(null,"application/vnd.ozp-iwc-intent-handler-v1+json")},function(a,b,c){var d=this.createNode({resource:this.createKey(b.node.resource+"/"),src:a.src},ozpIwc.IntentHandlerNode);return d.set(a),ozpIwc.log.debug(this.logPrefix+" registered ",b.node),{response:"ok",entity:{resource:d.resource}}}),ozpIwc.IntentsApi.declareRoute({action:"register",resource:"/{major}/{minor}/{action}/{handlerId}",filters:ozpIwc.IntentsApi.registerHandlerFilter(null,"application/vnd.ozp-iwc-intent-handler-v1+json")},function(a,b,c){return b.node.set(a),ozpIwc.log.debug(this.logPrefix+" registered ",b.node),{response:"ok",entity:{resource:b.node.resource}}}),ozpIwc.IntentsApi.declareRoute({action:"invoke",resource:"/{major}/{minor}/{action}",filters:ozpIwc.standardApiFilters.getFilters()},function(a,b,c){return this.invokeIntentHandler(a,c.major+"/"+c.minor,c.action,this.matchingNodes(b.node.pattern),b.node.pattern)}),ozpIwc.IntentsApi.useDefaultRoute(["delete","watch","unwatch","get"],"/{major}/{minor}/{action}"),ozpIwc.IntentsApi.declareRoute({action:["set","delete"],resource:"/{major}/{minor}",filters:[]},function(a,b,c){throw new ozpIwc.NoPermissionError(a)}),ozpIwc.IntentsApi.declareRoute({action:"get",resource:"/{major}/{minor}",filters:[]},function(a,b,c){return b.node?b.node.toPacket():{response:"ok",entity:{type:c.major+"/"+c.minor,actions:this.matchingNodes(a.resource).map(function(a){return a.entity.action})}}}),ozpIwc.IntentsApi.declareRoute({action:"broadcast",resource:"/{major}/{minor}/{action}",filters:ozpIwc.standardApiFilters.getFilters()},function(a,b,c){for(var d in b.node.collection)this.invokeIntentHandler(a,c.major+"/"+c.minor,c.action,this.matchingNodes(b.node.collection[d]),b.node.collection[d]);return{response:"ok",entity:{handlers:b.node.collection}}}),ozpIwc.NamesApi=ozpIwc.createApi(function(a){for(var b in ozpIwc.apiMap){var c=ozpIwc.apiMap[b],d="/api/"+c.address;this.data[d]=new ozpIwc.ApiNode({resource:d,entity:{actions:c.actions},contentType:"application/vnd.ozp-iwc-api-v1+json"})}var e=this;this.on("addressDisconnects",function(a){var b=a.length;ozpIwc.object.eachEntry(e.data,function(c,d){c.substr(-b)===a&&(e.markForChange(d),d.markAsDeleted())})}),this.leaderPromise.then(function(){window.setInterval(function(){e.checkForNonresponsives()},ozpIwc.heartBeatFrequency)})}),ozpIwc.NamesApi.prototype.checkForNonresponsives=function(){var a=this;this.matchingNodes("/address").forEach(function(b){var c=ozpIwc.util.now()-b.entity.time;c>3*ozpIwc.heartBeatFrequency&&(console.log("["+b.resource+"] [Removing] Time since update:",ozpIwc.util.now()-b.entity.time),a.participant.send({dst:"$bus.multicast",action:"disconnect",entity:b.entity}),b.markAsDeleted())})},ozpIwc.NamesApi.useDefaultRoute(["list","bulkGet"],"{c:/}"),ozpIwc.NamesApi.useDefaultRoute(["list","bulkGet"],"{c:/(?:api|address|multicast|router).*}"),ozpIwc.NamesApi.declareRoute({action:["set","delete"],resource:"/{collection:api|address|multicast|router}",filters:[]},function(a,b,c){throw new ozpIwc.NoPermissionError(a)}),ozpIwc.NamesApi.declareRoute({action:"get",resource:"/{collection:api|address|multicast|router}",filters:[]},function(a,b,c){return{contentType:"application/json",entity:this.matchingNodes(a.resource).map(function(a){return a.resource})}}),ozpIwc.NamesApi.useDefaultRoute(["get","delete","watch","unwatch"],"/api/{addr}"),ozpIwc.NamesApi.declareRoute({action:"set",resource:"/api/{addr}",filters:ozpIwc.standardApiFilters.setFilters(ozpIwc.ApiNode,"application/vnd.ozp-iwc-api-v1+json")},function(a,b,c){return b.node.set(a),{response:"ok"}}),ozpIwc.NamesApi.useDefaultRoute(["get","delete","watch","unwatch"],"/address/{addr}"),ozpIwc.NamesApi.declareRoute({action:"set",resource:"/address/{addr}",filters:ozpIwc.standardApiFilters.setFilters(ozpIwc.NamesNode,"application/vnd.ozp-iwc-address-v1+json")},function(a,b,c){return b.node.set(a),{response:"ok"}}),ozpIwc.NamesApi.useDefaultRoute(["get","delete","watch","unwatch"],"/multicast/{group}"),ozpIwc.NamesApi.useDefaultRoute(["get","delete","watch","unwatch"],"/multicast/{group}/{memberAddr}"),ozpIwc.NamesApi.declareRoute({action:"set",resource:"/multicast/{addr}",filters:ozpIwc.standardApiFilters.setFilters(ozpIwc.ApiNode,"application/vnd.ozp-iwc-multicast-address-v1+json")},function(a,b,c){return b.node.set(a),{response:"ok"}}),ozpIwc.NamesApi.declareRoute({action:"set",resource:"/multicast/{group}/{member}",filters:ozpIwc.standardApiFilters.setFilters(ozpIwc.NamesNode,"application/vnd.ozp-iwc-multicast-address-v1+json")},function(a,b,c){return b.node.set(a),{response:"ok"}}),ozpIwc.NamesApi.useDefaultRoute(["get","delete","watch","unwatch"],"/router/{addr}"),ozpIwc.NamesApi.declareRoute({action:"set",resource:"/router/{addr}",filters:ozpIwc.standardApiFilters.setFilters(ozpIwc.NamesNode,"application/vnd.ozp-iwc-router-v1+json")},function(a,b,c){return b.node.set(a),{response:"ok"}}),ozpIwc.SystemApi=ozpIwc.createApi(function(a){this.endpoints=[{link:ozpIwc.linkRelPrefix+":application",headers:[{name:"Accept",value:"application/vnd.ozp-application-v1+json"}]},{link:ozpIwc.linkRelPrefix+":user",headers:[]},{link:ozpIwc.linkRelPrefix+":system",headers:[]}];var b=this;this.on("createdNode",this.updateIntents,this),this.leaderPromise.then(function(){ozpIwc.log.debug("System.api registering for the launch intent");var a={contentType:"application/vnd.ozp-iwc-intent-handler-v1+json",entity:{type:"application/vnd.ozp-iwc-launch-data-v1+json",action:"run",label:"Open in new tab",invokeIntent:{dst:"system.api",action:"invoke",resource:"/launchNewWindow"}}};return b.participant.intents().register("/application/vnd.ozp-iwc-launch-data-v1+json/run/system.api",a)["catch"](function(a){ozpIwc.log.error("System.api failed to register for launch intent: ",a)})})}),ozpIwc.SystemApi.prototype.updateIntents=function(a){if(a.entity&&a.entity.intents){var b=[];return a.entity.intents.forEach(function(c){var d=c.icon||a.entity&&a.entity.icons&&a.entity.icons.small?a.entity.icons.small:"",e=c.label||a.entity.name,f="/"+c.type+"/"+c.action+"/system.api"+a.resource.replace(/\//g,"."),g={contentType:"application/vnd.ozp-iwc-intent-handler-v1+json",entity:{type:c.type,action:c.action,icon:d,label:e,_links:a.entity._links,invokeIntent:{action:"launch",resource:a.resource}}};b.push(this.participant.intents().messageBuilder.set(f,g))},this),this.participant.intents().bulkSend(b).then(function(a){return Promise.all(b)})}},ozpIwc.SystemApi.useDefaultRoute(["bulkGet","list"]),ozpIwc.SystemApi.declareRoute({action:"get",resource:"/{collection:user|application|system}",filters:[]},function(a,b,c){return{contentType:"application/json",entity:this.matchingNodes(a.resource).map(function(a){return a.resource})}}),ozpIwc.SystemApi.useDefaultRoute(["get","watch","unwatch"],"/user"),ozpIwc.SystemApi.declareRoute({action:["set","delete"],resource:"/user",filters:[]},function(a,b,c){throw new ozpIwc.BadActionError(a)}),ozpIwc.SystemApi.useDefaultRoute(["get","watch","unwatch"],"/system"),ozpIwc.SystemApi.declareRoute({action:["set","delete"],resource:"/system",filters:[]},function(a,b,c){throw new ozpIwc.BadActionError(a)}),ozpIwc.SystemApi.useDefaultRoute(["get","watch","unwatch"],"/application/{id}"),ozpIwc.SystemApi.declareRoute({action:["set","delete"],resource:"/application/{id}",filters:[]},function(a,b,c){throw new ozpIwc.BadActionError(a)}),ozpIwc.SystemApi.declareRoute({action:["launch"],resource:"/application/{id}",filters:ozpIwc.standardApiFilters.getFilters()},function(a,b,c){return ozpIwc.log.info(this.logPrefix+" launching ",a.entity),this.participant.send({dst:"intents.api",contentType:"application/vnd.ozp-iwc-intent-handler-v1+json",action:"invoke",resource:"/application/vnd.ozp-iwc-launch-data-v1+json/run",entity:{url:b.node.entity.launchUrls["default"],applicationId:b.node.resource,launchData:a.entity,id:b.node.entity.id}}),{response:"ok"}}),ozpIwc.SystemApi.declareRoute({action:["invoke"],resource:"/launchNewWindow",filters:[]},function(a,b,c){return ozpIwc.log.info(this.logPrefix+" handling launchdata ",a.entity),a.entity&&a.entity.inFlightIntent?(ozpIwc.util.openWindow(a.entity.inFlightIntent.entity.entity.url,{"ozpIwc.peer":ozpIwc.BUS_ROOT,"ozpIwc.inFlightIntent":a.entity.inFlightIntent}),{response:"ok"}):{response:"badResource"}}),ozpIwc.SystemApi.prototype.createNodeObject=function(a){return new ozpIwc.SystemNode(a)};var ozpIwc=ozpIwc||{};ozpIwc.version="1.0.3",ozpIwc.log.threshold=6,ozpIwc.ELECTION_TIMEOUT=3e3,ozpIwc.heartBeatFrequency=1e3,ozpIwc.apiRootUrl=ozpIwc.apiRootUrl||"/",ozpIwc.policyRootUrl=ozpIwc.policyRootUrl||"/policy",ozpIwc.basicAuthUsername=ozpIwc.basicAuthUsername||"",ozpIwc.basicAuthPassword=ozpIwc.basicAuthPassword||"",ozpIwc.linkRelPrefix=ozpIwc.linkRelPrefix||"ozp",ozpIwc.intentsChooserUri="intentsChooser.html",function(){var a=ozpIwc.util.parseQueryParams();if(a.log)try{console.log("Setting log level to ",a.log),ozpIwc.log.setThreshold(ozpIwc.log[a.log.toUpperCase()])}catch(b){}}(),ozpIwc._busInit=function(){},ozpIwc.authorization=new ozpIwc.policyAuth.PDP({pip:new ozpIwc.policyAuth.PIP,prp:new ozpIwc.policyAuth.PRP,setsEndpoint:ozpIwc.policyRootUrl});var enablePostMessageParticipants=function(){};("undefined"==typeof ozpIwc.enableDefault||ozpIwc.enableDefault)&&(ozpIwc.initEndpoints(ozpIwc.apiRootUrl||"api"),ozpIwc.defaultPeer=new ozpIwc.Peer,ozpIwc.defaultLocalStorageLink=new ozpIwc.KeyBroadcastLocalStorageLink({peer:ozpIwc.defaultPeer}),ozpIwc.defaultRouter=new ozpIwc.Router({peer:ozpIwc.defaultPeer,heartbeatFrequency:ozpIwc.heartBeatFrequency}),("undefined"==typeof ozpIwc.acceptPostMessageParticipants||ozpIwc.acceptPostMessageParticipants)&&(ozpIwc.defaultPostMessageParticipantListener=new ozpIwc.PostMessageParticipantListener({router:ozpIwc.defaultRouter,ready:new Promise(function(a){enablePostMessageParticipants=a})})),ozpIwc._busInit=function(){("undefined"==typeof ozpIwc.runApis||ozpIwc.runApis)&&(ozpIwc.locksApi=new ozpIwc.LocksApi({name:"locks.api"}),ozpIwc.namesApi=new ozpIwc.NamesApi({name:"names.api"}),ozpIwc.dataApi=new ozpIwc.DataApi({name:"data.api"}),ozpIwc.intentsApi=new ozpIwc.IntentsApi({name:"intents.api"}),ozpIwc.systemApi=new ozpIwc.SystemApi({name:"system.api"})),enablePostMessageParticipants()}),ozpIwc.util.prerender().then(ozpIwc._busInit);
//# sourceMappingURL=ozpIwc-bus.min.js.map