<!DOCTYPE html>
<html>
<head>
    <title>Choose an Intent</title>
    <script type="text/javascript">
        ozpIwc= {
            runApis:false,
            acceptPostMessageParticipants:false
        };
// Not used by the Intents Chooser
        //ozpIwc.apiRootUrl = "api";
    </script>
    <script type="text/javascript" src="js/ozpIwc-bus.js"></script>
    <script type="text/javascript" src="js/defaultWiring.js"></script>
    <style>
        .icon {
            height: 32px;
            width: 32px;
            display: block;
        }
        button {
            text-align: center;
        }
        </style>
  </head>
  <body>
      <div id="handlerList">
          
      </div>
    
      <script type="text/javascript">
        var client=new ozpiwc.internalparticipant({'name':"intentschooser"});
        ozpiwc.defaultrouter.registerparticipant(client);

        function failure(msg) {
            document.getelementbyid("handlerlist").textcontent=msg;
        }

        function handleselection(handler,intentinvocation){

            client.send({
                dst: "intents.api",
                action: "choose",
                contenttype: intentinvocation.contenttype,
                resource: intentinvocation.resource,
                entity: {
                    resource: handler.resource,
                    reason: "user"
                }
            },function(reply) {
                console.log(reply);
                if(reply.response === "ok"){
                    window.close();
                }
            });
        }
        function showhandlers(handlers,intentinvocation) {
            handlers.foreach(function(h) {
                var handler = h;
                var button=document.createelement("button");
                var icon=document.createelement("img");
                icon.setattribute("src",handler.entity.icon);
                icon.setattribute("alt",handler.entity.label);
                icon.setattribute("class","icon");
                button.appendchild(icon);
                button.appendchild(document.createtextnode(handler.entity.label));
                button.addeventlistener("click",function(evt) {
                    evt.preventdefault();
                    console.log("executing ", handler);
                    handleselection(handler,intentinvocation);
                });
                document.getelementbyid("handlerlist").appendchild(button);
            });
        }

        var m=/ozpiwc.intentselection=([^&#]+)/.exec(window.name);

        if(!m) {
            failure("this page is intended to be launch only by the ozone platform intents api.");
        }
        var loc=ozpiwc.util.parseozpurl(m[1]);

        client.send(loc,function(reply) {
            if(reply.response!=="ok") {
                failure();
                return;
            }
            showhandlers(reply.entity.handlerchoices,reply);
        });
        
        
        
        
        
    </script>      
  </body>
</html>
